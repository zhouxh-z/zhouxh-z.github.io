<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>å¹¶å‘ç¼–ç¨‹ ä¹‹ å†çœ‹ synchronized</title>
      <link href="/2021/12/22/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%B9%8B-%E5%86%8D%E7%9C%8B-synchronized/"/>
      <url>/2021/12/22/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%B9%8B-%E5%86%8D%E7%9C%8B-synchronized/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ä»å®¢æˆ·ç«¯å‘é€createæ¶ˆæ¯åˆ°èŠ‚ç‚¹åˆ›å»ºï¼Œæºç åˆ†æ</title>
      <link href="/2021/09/23/%E4%BB%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E9%80%81create%E6%B6%88%E6%81%AF%E5%88%B0%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BA%EF%BC%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
      <url>/2021/09/23/%E4%BB%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E9%80%81create%E6%B6%88%E6%81%AF%E5%88%B0%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BA%EF%BC%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡è¾ƒç¡¬ï¼Œç»“åˆzookeeperæºç é£Ÿç”¨æ›´ä½³å“¦ï¼zookeeper æºç å¯ä»¥ç›´æ¥ä»<a href="https://github.com/apache/zookeeper">github</a>ä¸‹è½½ç¼–è¯‘ï¼</p><p>zookeeper æœ‰ä¸¤ç§é€šä¿¡æ–¹å¼ï¼šnettyã€Nioï¼›æœ¬æ–‡æ˜¯åŸºäº Netty æºç è¿›è¡Œçš„è§£è¯»ï¼</p><p>å»ºè®®å…ˆé˜…è¯»<a href="https://juejin.cn/post/6996844613377982494"># é›†ç¾¤æ¨¡å¼ zookeeper å¯åŠ¨æ—¶åšäº†è¿™äº›äº‹ï¼</a></p><h2 id="zk-å’‹ä¿è¯é›†ç¾¤å„å‰¯æœ¬çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ"><a href="#zk-å’‹ä¿è¯é›†ç¾¤å„å‰¯æœ¬çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ" class="headerlink" title="zk å’‹ä¿è¯é›†ç¾¤å„å‰¯æœ¬çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ"></a>zk å’‹ä¿è¯é›†ç¾¤å„å‰¯æœ¬çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ</h2><p>zookeeper åŸºäº <strong>ZAB åè®®</strong> å®ç°äº†ä¸€ç§ä¸»å¤‡æ¨¡å¼çš„ç³»ç»Ÿæ¶æ„æ¥ä¿è¯é›†ç¾¤å„å‰¯æœ¬çš„æ•°æ®ä¸€è‡´æ€§ï¼</p><p><strong>ZAB åè®®</strong>ï¼šä¸º Zookeeper ä¸“é—¨è®¾è®¡çš„ä¸€ç§æ”¯æŒ <strong>å´©æºƒæ¢å¤</strong> å’Œ <strong>åŸå­å¹¿æ’­</strong> çš„åè®®ï¼</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c25afebb02a4560a483e2cff4495212~tplv-k3u1fbpfcp-watermark.image" alt="ZAB.png"></p><p>å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ°zkæœåŠ¡ç«¯æ—¶ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯å†™å…¥æ•°æ®éƒ½æ˜¯å†™å…¥åˆ°LeaderèŠ‚ç‚¹ï¼ˆå¦‚æœè¯·æ±‚è¢«å‘åˆ° follower èŠ‚ç‚¹ï¼Œä¼šè¢«è½¬å‘åˆ° leader èŠ‚ç‚¹ï¼‰ï¼Œç”±leaderèŠ‚ç‚¹å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šï¼Œä»è€Œä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼›</p><p>ä»leaderå¤åˆ¶åˆ°followerçš„è¿‡ç¨‹æœ‰ç‚¹ç±»ä¼¼ ä¸¤é˜¶æ®µæäº¤(2PC)ï¼ŒleaderèŠ‚ç‚¹å‘é€æ•°æ®åŒ…ç»™å…¶ä»–followerèŠ‚ç‚¹ï¼ŒfollowerèŠ‚ç‚¹ç¡®è®¤æ¥æ”¶åè¿”å›ACKï¼Œå¦‚æœfollowè¿”å›çš„ACK + leaderæœ¬èº«çš„ACKï¼Œè¶…è¿‡æ‰€æœ‰æŠ•ç¥¨èŠ‚ç‚¹çš„ä¸€åŠï¼Œè¿™ä¸ªè¯·æ±‚å°±ä¼šè¢«commitï¼Œå¹¶å†™å…¥zkå†…å­˜ä¸­ï¼</p><h2 id="zk-åŸå­å¹¿æ’­è¯¦ç»†æµç¨‹"><a href="#zk-åŸå­å¹¿æ’­è¯¦ç»†æµç¨‹" class="headerlink" title="zk åŸå­å¹¿æ’­è¯¦ç»†æµç¨‹"></a>zk <strong>åŸå­å¹¿æ’­</strong>è¯¦ç»†æµç¨‹</h2><p>ZAB åè®®çš„æ¶ˆæ¯å¹¿æ’­è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªåŸå­å¹¿æ’­åè®®ï¼Œç±»ä¼¼ä¸€ä¸ª ä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹<br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a31ea85092640a78d5d31b613f705f6~tplv-k3u1fbpfcp-watermark.image" alt="zk åŸå­å¹¿æ’­.png"></p><blockquote><p>æºç åˆ†ææ˜¯æŒ‰ä»£ç é¡ºåºåˆ†æçš„ï¼Œã€ã€‘ä¸ºæœ¬æ–‡çš„æºç ç ”è¯»å†…å®¹ç›®å½•ç¼–å·ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡é€»è¾‘è·³è½¬å­¦ä¹ </p><ol><li>å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯æ—¶ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯å†™å…¥æ•°æ®éƒ½æ˜¯å†™å…¥åˆ°LeaderèŠ‚ç‚¹ï¼ˆå¦‚æœè¯·æ±‚è¢«å‘åˆ° follower èŠ‚ç‚¹ï¼Œä¼šè¢«è½¬å‘åˆ° leader èŠ‚ç‚¹ï¼‰ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼šä¸€ &lt;1ã€2&gt; + 2.2.1 ã€‘  </li><li>leader æ¥æ”¶åˆ°è¯·æ±‚ï¼Œå°†è¯·æ±‚å°è£…æˆä¸€ä¸ªäº‹åŠ¡ proposal ï¼Œå¹¶å‘é€ç»™æ‰€æœ‰ follower èŠ‚ç‚¹ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.1.1 + 2.1.2 + 2.1.3&lt;2.1.3.1ã€2.1.3.2&gt;ã€‘</li><li>leader å°†æ•°æ®å†™å…¥è‡ªèº«çš„æœ¬åœ°æ–‡ä»¶ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.1.3.3ã€‘</li><li>leader ç»™è‡ªå·±è®°ä¸€æ¬¡ACKç¡®è®¤ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.1.3.3ã€‘</li><li>follower æ¥æ”¶åˆ° leader å‘é€çš„ proposal åï¼Œå°†æ•°æ®å†™å…¥è‡ªèº«çš„æœ¬åœ°æ–‡ä»¶ä¸­ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.2.1 + 2.2.2 + 2.2.3ã€‘</li><li>follower å†™å…¥æˆåŠŸåç»™ leader èŠ‚ç‚¹å‘é€ä¸€ä¸ªACKç¡®è®¤è¯·æ±‚ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.2.5ã€‘</li><li>leader æ¥æ”¶åˆ°ACKç¡®è®¤è¯·æ±‚æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦æ”¶åˆ°äº†è¿‡åŠçš„æŠ•ç¥¨èŠ‚ç‚¹ï¼ˆleader+followerï¼‰çš„ACKç¡®è®¤è¯·æ±‚ï¼›å¦‚æœè¿‡åŠï¼Œå‘é€commitè¯·æ±‚ç»™followerèŠ‚ç‚¹ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.1.4ã€‘</li><li>leader èŠ‚ç‚¹å°†æ•°æ®å†™å…¥ observer èŠ‚ç‚¹ä¿å­˜ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.1.4ã€‘</li><li>leader èŠ‚ç‚¹å°†æ•°æ®å†™å…¥å†…å­˜ä¸­ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.1.4ã€‘</li><li>follower èŠ‚ç‚¹æ¥æ”¶åˆ° leader çš„ commit è¯·æ±‚åï¼Œå°†æ•°æ®å†™å…¥å†…å­˜ï¼›<br>ã€æºç ç ”è¯»ç›®å½•ï¼š2.2.2 + 2.2.3ã€‘ï¼›</li></ol></blockquote><h2 id="æµ‹è¯•ç±»"><a href="#æµ‹è¯•ç±»" class="headerlink" title="æµ‹è¯•ç±»"></a>æµ‹è¯•ç±»</h2><p>çŸ¥é“åŸºæœ¬æµç¨‹åï¼Œæˆ‘ä»¬ä»å¦‚ä¸‹å•å…ƒæµ‹è¯•æ–¹æ³•å¼€å§‹åˆ†ææºç ï¼Œçœ‹çœ‹ zookeeper ä»å®¢æˆ·ç«¯å‘é€createæ¶ˆæ¯åˆ°èŠ‚ç‚¹åˆ›å»ºåˆ°åº•æ€ä¹ˆå®ç°çš„ï¼</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException<span class="token punctuation">,</span> KeeperException <span class="token punctuation">{</span>    ZooKeeper zk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token number">2183</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    zk<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/foo_2"</span><span class="token punctuation">,</span> <span class="token string">"foobar1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> CreateMode<span class="token punctuation">.</span>PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="ä¸€ã€å®¢æˆ·ç«¯å‘é€è¯·æ±‚"><a href="#ä¸€ã€å®¢æˆ·ç«¯å‘é€è¯·æ±‚" class="headerlink" title="ä¸€ã€å®¢æˆ·ç«¯å‘é€è¯·æ±‚"></a>ä¸€ã€å®¢æˆ·ç«¯å‘é€è¯·æ±‚</h2><h3 id="1-åˆå§‹åŒ–-zk"><a href="#1-åˆå§‹åŒ–-zk" class="headerlink" title="1. åˆå§‹åŒ– zk"></a>1. åˆå§‹åŒ– zk</h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/828efb16094543abac5b863b1671d3f9~tplv-k3u1fbpfcp-watermark.image" alt="zk å®¢æˆ·ç«¯å‘é€æ•°æ®åˆ°æœåŠ¡ç«¯ (1).png"></p><pre class=" language-java"><code class="language-java">ZooKeeper zk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token number">2183</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">public</span> <span class="token function">ZooKeeper</span><span class="token punctuation">(</span>Â·Â·Â·Â·<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>    cnxn <span class="token operator">=</span> <span class="token function">createConnection</span><span class="token punctuation">(</span>        connectStringParser<span class="token punctuation">.</span><span class="token function">getChrootPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        hostProvider<span class="token punctuation">,</span>        sessionTimeout<span class="token punctuation">,</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>clientConfig<span class="token punctuation">,</span>        watcher<span class="token punctuation">,</span>        <span class="token function">getClientCnxnSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        canBeReadOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>    cnxn<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>zookeeper åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡è°ƒç”¨ <strong>createConnection</strong>åˆå§‹åŒ–äº†ä¸€ä¸ª zk è¿æ¥å¯¹è±¡<strong>ClientCnxn</strong><br>ï¼Œ<strong>ClientCnxn</strong>åœ¨åˆå§‹åŒ–æ—¶ new äº†ä¸¤ä¸ªçº¿ç¨‹ï¼ˆSendThreadã€EventThreadï¼‰ï¼›</p><p>å¹¶åœ¨ <strong>cnxn.start()</strong> å¯åŠ¨è¿™ä¸¤ä¸ªçº¿ç¨‹ï¼›</p><pre class=" language-java"><code class="language-java"><span class="token keyword">this</span><span class="token punctuation">.</span>sendThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendThread</span><span class="token punctuation">(</span>clientCnxnSocket<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="2-å‘é€è¯·æ±‚"><a href="#2-å‘é€è¯·æ±‚" class="headerlink" title="2. å‘é€è¯·æ±‚"></a>2. å‘é€è¯·æ±‚</h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d76b63fd10f4fbd9f2925e2c85d700e~tplv-k3u1fbpfcp-watermark.image" alt="zk å®¢æˆ·ç«¯å‘é€æ•°æ®åˆ°æœåŠ¡ç«¯.png"> </p><p><strong>å‘é€è¿‡ç¨‹</strong></p><ol><li><p>zookeeper å°†create æ–¹æ³•çš„å‚æ•°å°è£…æˆ <strong>Request</strong> ;</p><pre class=" language-java"><code class="language-java">zk<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/foo_2"</span><span class="token punctuation">,</span> <span class="token string">"foobar1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> CreateMode<span class="token punctuation">.</span>PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">public</span> String <span class="token function">create</span><span class="token punctuation">(</span>Â·Â·Â·<span class="token punctuation">)</span> <span class="token keyword">throws</span> KeeperException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å°è£… CreateRequest</span>    RequestHeader h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    h<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>createMode<span class="token punctuation">.</span><span class="token function">isContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> ZooDefs<span class="token punctuation">.</span>OpCode<span class="token punctuation">.</span>createContainer <span class="token operator">:</span> ZooDefs<span class="token punctuation">.</span>OpCode<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span>    CreateRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    CreateResponse response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    request<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    request<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>createMode<span class="token punctuation">.</span><span class="token function">toFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    request<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>serverPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    request<span class="token punctuation">.</span><span class="token function">setAcl</span><span class="token punctuation">(</span>acl<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// é€šè¿‡è¿æ¥å™¨å‘é€ CreateRequest</span>    ReplyHeader r <span class="token operator">=</span> cnxn<span class="token punctuation">.</span><span class="token function">submitRequest</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cnxn<span class="token punctuation">.</span>chrootPath <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>cnxn<span class="token punctuation">.</span>chrootPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li><li><p>é€šè¿‡ submitRequest() è°ƒç”¨ queuePacket() å°† Request åŠ å…¥åˆ° <strong>ClientCnxn.outgoingQueue</strong> é˜Ÿåˆ—ä¸­;</p></li><li><p>å‘ç®¡é“å†™ä¸€ä¸ªå­—èŠ‚ï¼Œä»è€Œå”¤é†’é˜»å¡åœ¨selectorä¸Šçš„çº¿ç¨‹ï¼Œè¯¥å­—èŠ‚åªä¸ºè§¦å‘ netty/nio çš„å†™äº‹ä»¶ï¼Œä»è€Œè®© sendThread() è¯»å–é˜Ÿåˆ—ä¸­çš„æ•°æ®åŒ…ã€zk åº•å±‚ä½¿ç”¨netty/Nioé€šä¿¡ï¼Œå¦‚æœæ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œnetty/Nio ä¼šé˜»å¡åœ¨selectorä¸Šç­‰å¾…äº‹ä»¶å‘ç”Ÿï¼Œæ­¤å¤„å‘é€ä¸€ä¸ªç©ºå­—èŠ‚ï¼Œå°±æ˜¯ä¸ºäº†å”¤é†’netty/Nioçš„selectorã€‘ </p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> ReplyHeader <span class="token function">submitRequest</span><span class="token punctuation">(</span>Â·Â·Â·<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>    ReplyHeader r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplyHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Packet packet <span class="token operator">=</span> <span class="token function">queuePacket</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>r<span class="token punctuation">,</span>request<span class="token punctuation">,</span>response<span class="token punctuation">,</span> null<span class="token punctuation">,</span>null<span class="token punctuation">,</span>null<span class="token punctuation">,</span>null<span class="token punctuation">,</span>        watchRegistration<span class="token punctuation">,</span>watchDeregistration<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// çœç•¥éä¸»çº¿ä»£ç </span>    <span class="token keyword">return</span> r<span class="token punctuation">;</span><span class="token punctuation">}</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">public</span> Packet <span class="token function">queuePacket</span><span class="token punctuation">(</span>Â·Â·Â·<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Packet packet <span class="token operator">=</span> null<span class="token punctuation">;</span>    packet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Packet</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> r<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> watchRegistration<span class="token punctuation">)</span><span class="token punctuation">;</span>    packet<span class="token punctuation">.</span>cb <span class="token operator">=</span> cb<span class="token punctuation">;</span>    packet<span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx<span class="token punctuation">;</span>    packet<span class="token punctuation">.</span>clientPath <span class="token operator">=</span> clientPath<span class="token punctuation">;</span>    packet<span class="token punctuation">.</span>serverPath <span class="token operator">=</span> serverPath<span class="token punctuation">;</span>    packet<span class="token punctuation">.</span>watchDeregistration <span class="token operator">=</span> watchDeregistration<span class="token punctuation">;</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†ä»£ç  </span>        <span class="token comment" spellcheck="true">// å°† Request åŠ å…¥åˆ° outgoingQueue é˜Ÿåˆ—ä¸­;</span>       outgoingQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å‘channel ä¸­å†™ä¸€ä¸ªç©ºå­—èŠ‚ï¼Œå”¤é†’ SendThread ä¸­çš„ selector</span>    sendThread<span class="token punctuation">.</span><span class="token function">getClientCnxnSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">packetAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> packet<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre></li><li><p>zookeeper åˆå§‹åŒ–ä¸­ç”Ÿæˆçš„ <strong>SendThread</strong> çº¿ç¨‹ä¼šä»è¿™ä¸ªé˜Ÿåˆ—ä¸­è¯»å– Request å‘é€åˆ°æœåŠ¡ç«¯ï¼›</p><p> SendThread.run() æ–¹æ³•ä¸­æœ‰æ¯”è¾ƒå¤šçš„åˆ†æ”¯ä»£ç ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹è¿™ä¸¤ä¸ªå…³é”®æ–¹æ³•ï¼›</p><pre class=" language-java"><code class="language-java">clientCnxnSocket<span class="token punctuation">.</span><span class="token function">introduce</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> sessionId<span class="token punctuation">,</span> outgoingQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>clientCnxnSocket<span class="token punctuation">.</span><span class="token function">doTransport</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> pendingQueue<span class="token punctuation">,</span> ClientCnxn<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p> åœ¨<strong>2</strong>ä¸­æˆ‘ä»¬å‘é€çš„è¯·æ±‚è¢«åŠ å…¥åˆ° <strong>outgoingQueue</strong> é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ—¶å±äº ClientCnxn å¯¹è±¡ï¼›<br>  introduce æ–¹æ³•å°†è¿™ä¸ªé˜Ÿåˆ—èµ‹å€¼ç»™ clientCnxnSocketï¼Œä»¥ä¾¿åç»­åœ¨ doTransport æ–¹æ³•ä¸­è°ƒç”¨ï¼›</p><pre class=" language-java"><code class="language-java">clientCnxnSocket<span class="token punctuation">.</span><span class="token function">introduce</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> sessionId<span class="token punctuation">,</span> outgoingQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">void</span> <span class="token function">introduce</span><span class="token punctuation">(</span>ClientCnxn<span class="token punctuation">.</span>SendThread sendThread<span class="token punctuation">,</span> <span class="token keyword">long</span> sessionId<span class="token punctuation">,</span> LinkedBlockingDeque<span class="token operator">&lt;</span>Packet<span class="token operator">></span> outgoingQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>sendThread <span class="token operator">=</span> sendThread<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>sessionId <span class="token operator">=</span> sessionId<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>outgoingQueue <span class="token operator">=</span> outgoingQueue<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p> doTransport æ–¹æ³•ï¼Œæ˜¯çœŸæ­£å°†è¯·æ±‚é€šè¿‡ Netty/NIO å†™ç»™æœåŠ¡ç«¯çš„æ–¹æ³•ï¼›ï¼ˆä»¥ä¸‹æ˜¯ClientCnxnSocketNettyæºç ï¼‰</p><pre class=" language-java"><code class="language-java">clientCnxnSocket<span class="token punctuation">.</span><span class="token function">doTransport</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> pendingQueue<span class="token punctuation">,</span> ClientCnxn<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">void</span> <span class="token function">doTransport</span><span class="token punctuation">(</span><span class="token keyword">int</span> waitTimeOut<span class="token punctuation">,</span>Queue<span class="token operator">&lt;</span>Packet<span class="token operator">></span> pendingQueue<span class="token punctuation">,</span>ClientCnxn cnxn<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// çœç•¥éä¸»çº¿ä»£ç </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>head <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">doWrite</span><span class="token punctuation">(</span>pendingQueue<span class="token punctuation">,</span> head<span class="token punctuation">,</span> cnxn<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token function">updateNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span>Queue<span class="token operator">&lt;</span>Packet<span class="token operator">></span> pendingQueue<span class="token punctuation">,</span> Packet p<span class="token punctuation">,</span> ClientCnxn cnxn<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">updateNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> anyPacketsSent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> WakeupPacket<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>requestHeader <span class="token operator">!=</span> null<span class="token punctuation">)</span>                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ZooDefs<span class="token punctuation">.</span>OpCode<span class="token punctuation">.</span>ping<span class="token punctuation">)</span>                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ZooDefs<span class="token punctuation">.</span>OpCode<span class="token punctuation">.</span>auth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// ç»™è¯·æ±‚è®¾ç½® Xid</span>                p<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">setXid</span><span class="token punctuation">(</span>cnxn<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>pendingQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    pendingQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// å‘é€è¯·æ±‚</span>            <span class="token function">sendPktOnly</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            anyPacketsSent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p> æœ€ç»ˆé€šè¿‡Nettyçš„ channel å°†æ•°æ®å‘é€åˆ°å®¢æˆ·ç«¯<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/15a667bde76f4911b98ff03445c5452d~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p></li></ol><h2 id="äºŒã€æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚"><a href="#äºŒã€æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚" class="headerlink" title="äºŒã€æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚"></a>äºŒã€æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚</h2><h3 id="1-å¦‚ä½•æ¥æ”¶è¯·æ±‚ï¼Ÿ"><a href="#1-å¦‚ä½•æ¥æ”¶è¯·æ±‚ï¼Ÿ" class="headerlink" title="1. å¦‚ä½•æ¥æ”¶è¯·æ±‚ï¼Ÿ"></a>1. å¦‚ä½•æ¥æ”¶è¯·æ±‚ï¼Ÿ</h3><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fcefe84b37d84d6ea14afbdcdca29829~tplv-k3u1fbpfcp-watermark.image" alt="æœåŠ¡ç«¯æ¥æ”¶æ¶ˆæ¯.png"><br>åœ¨<a href="https://juejin.cn/post/6996844613377982494"># é›†ç¾¤æ¨¡å¼ zookeeper å¯åŠ¨æ—¶åšäº†è¿™äº›äº‹ï¼</a>è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è¯´è¿‡ zookeeper æœåŠ¡ç«¯åœ¨å¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ–å¹¶å¯åŠ¨äº†ä¸€ä¸ªNettyæœåŠ¡å™¨ã€NettyServerCnxnFactoryã€‘ï¼Œç”¨äºæ¥æ”¶å®¢æˆ·ç«¯/å…¶ä»–èŠ‚ç‚¹çš„è¯·æ±‚ã€Netty å¤„ç†è¯·æ±‚ç±»ï¼šCnxnChannelHandlerã€‘</p><ol><li>zkå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼Œé€šè¿‡æœåŠ¡ç«¯ CnxnChannelHandler.channelRead() æ–¹æ³•ï¼Œé€šè¿‡cnxn.processMessage((ByteBuf) msg) â†’ receiveMessage(buf) â†’ zks.processPacket(this, bb) â†’ submitRequest(si) â†’ enqueueRequest(si) â†’ requestThrottler.submitRequest(si);<br> ä»¥ä¸Šè¿™æ®µä»£ç ä¸»è¦æ˜¯å¯¹requestçš„è§£æå¹¶æ²¡æœ‰è¿‡äºå¤æ‚çš„é€»è¾‘ï¼Œè¿™è¾¹åªåšè®°å½•å°±ä¸èµ˜è¿°äº†ï¼›</li><li>æœåŠ¡ç«¯è·å–è¯·æ±‚ä¹‹åï¼Œä¼šé€šè¿‡ requestThrottler.submitRequest(si) æ–¹æ³•å°†è§£æå‡ºæ¥çš„è¯·æ±‚åŠ å…¥åˆ° RequestThrottler.<strong>submittedRequests</strong> ;<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submitRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>stopping<span class="token punctuation">)</span> <span class="token punctuation">{</span>        LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Shutdown in progress. Request cannot be processed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dropRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        request<span class="token punctuation">.</span>requestThrottleQueueTime <span class="token operator">=</span> Time<span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        submittedRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li><li>RequestThrottler çº¿ç¨‹çš„ run æ–¹æ³•ä¼šä»<strong>2</strong>ä¸­è®¾ç½®çš„<strong>submittedRequests</strong>é˜Ÿåˆ—ä¸­è·å–è¯·æ±‚ï¼Œå¹¶é€šè¿‡<strong>submitRequestNow</strong>æ–¹æ³•ï¼Œå°†è¯·æ±‚æäº¤ç»™zkè¯·æ±‚å¤„ç†è´£ä»»é“¾<strong>RequestProcessor</strong> <strong>RequestThrottler çº¿ç¨‹</strong>ï¼šzkæœåŠ¡ç«¯åœ¨é€‰ä¸¾å®Œ leader ä¹‹åï¼Œleader / followerèŠ‚ç‚¹ åˆ†åˆ«åœ¨ leader.lead() / follower.followLeader()æ–¹æ³•ä¸­è°ƒç”¨ <strong>zk.startup()</strong> å®ä¾‹åŒ–å¹¶å¯åŠ¨ RequestThrottler çº¿ç¨‹ï¼›<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// çœç•¥éä¸»çº¿ä»£ç </span>            Request request <span class="token operator">=</span> submittedRequests<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// çœç•¥éä¸»çº¿ä»£ç </span>                zks<span class="token punctuation">.</span><span class="token function">submitRequestNow</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ol><h3 id="2-å¦‚ä½•å¤„ç†è¯·æ±‚ï¼Ÿ"><a href="#2-å¦‚ä½•å¤„ç†è¯·æ±‚ï¼Ÿ" class="headerlink" title="2. å¦‚ä½•å¤„ç†è¯·æ±‚ï¼Ÿ"></a>2. å¦‚ä½•å¤„ç†è¯·æ±‚ï¼Ÿ</h3><p>zookeeper åœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå°†è¯·æ±‚æäº¤åˆ°è´£ä»»é“¾<strong>RequestProcessor</strong>å¤„ç†ï¼›ä¸”ä¸åŒå±æ€§çš„èŠ‚ç‚¹ï¼ˆleader/followerï¼‰å®ä¾‹åŒ–äº†ä¸åŒçš„è´£ä»»é“¾ï¼›</p><p>zkæœåŠ¡ç«¯åœ¨é€‰ä¸¾å®Œ leader ä¹‹åï¼Œleader / followerèŠ‚ç‚¹ åˆ†åˆ«åœ¨ leader.lead() / follower.followLeader()æ–¹æ³•ä¸­è°ƒç”¨ **zk.startup()**ï¼Œstartup()è°ƒç”¨äº† ZooKeeperServer.<strong>setupRequestProcessors()</strong> ;</p><p>ZooKeeperServer æ ¹æ®èŠ‚ç‚¹ä¸åŒå­˜åœ¨ä¸åŒå®ç°ï¼›<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af0c23ac63884364b7505bd55bc10e3f~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p><h4 id="2-1-leader-èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ"><a href="#2-1-leader-èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ" class="headerlink" title="2.1_ leader èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ"></a>2.1_ leader èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ</h4><pre class=" language-java"><code class="language-java">LeaderZooKeeperServerğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    RequestProcessor finalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    RequestProcessor toBeAppliedProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Leader<span class="token punctuation">.</span>ToBeAppliedRequestProcessor</span><span class="token punctuation">(</span>finalProcessor<span class="token punctuation">,</span> <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    commitProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitProcessor</span><span class="token punctuation">(</span>toBeAppliedProcessor<span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function">getZooKeeperServerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    commitProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ProposalRequestProcessor proposalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProposalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> commitProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>    proposalProcessor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    prepRequestProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrepRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> proposalProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>    prepRequestProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    firstProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LeaderRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> prepRequestProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setupContainerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5fbe40ed919e4fe7ab504cdd8be71d8b~tplv-k3u1fbpfcp-watermark.image" alt="leaderè´£ä»»é“¾.png"></p><p>leader èŠ‚ç‚¹æ„å»ºäº†ä»¥ä¸Šè´£ä»»é“¾ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è´£ä»»é“¾çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½åšäº†ä»€ä¹ˆï¼›</p><h5 id="2-1-1-LeaderRequestProcessor"><a href="#2-1-1-LeaderRequestProcessor" class="headerlink" title="2.1.1_ LeaderRequestProcessor"></a>2.1.1_ LeaderRequestProcessor</h5><p>LeaderRequestProcessor çš„ä»»åŠ¡æ¯”è¾ƒç®€å•ï¼š</p><ol><li><p>åˆ¤æ–­è¯·æ±‚ä¼šè¯æ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸçš„è¯æŠ›å‡ºå¼‚å¸¸ï¼›</p></li><li><p>è°ƒç”¨è´£ä»»é“¾çš„ä¸‹ä¸€ä¸ªæ–¹æ³•ï¼›</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RequestProcessorException <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lzks<span class="token punctuation">.</span><span class="token function">authWriteRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> Request upgradeRequest <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token keyword">try</span> <span class="token punctuation">{</span>     upgradeRequest <span class="token operator">=</span> lzks<span class="token punctuation">.</span><span class="token function">checkUpgradeSession</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> ke<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradeRequest <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>     nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>upgradeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h5 id="2-1-2-PrepRequestProcessor"><a href="#2-1-2-PrepRequestProcessor" class="headerlink" title="2.1.2_ PrepRequestProcessor"></a>2.1.2_ PrepRequestProcessor</h5><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/157ddcc8c9c240589caf10b7a6a20b1c~tplv-k3u1fbpfcp-watermark.image" alt="æœªå‘½åæ–‡ä»¶ (2).png"><br>è´£ä»»é“¾çš„ processRequest æ–¹æ³•ï¼Œåªæ˜¯å°†è¯·æ±‚åŠ å…¥åˆ° submittedRequests é˜Ÿåˆ—ä¸­ï¼›</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token punctuation">{</span> request<span class="token punctuation">.</span>prepQueueStartTime <span class="token operator">=</span> Time<span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> submittedRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span> ServerMetrics<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>PREP_PROCESSOR_QUEUED<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ä½†æ˜¯PrepRequestProcessor æœ¬è´¨æ˜¯ä¸€ä¸ª Threadï¼Œåœ¨åˆ›å»ºè´£ä»»é“¾æ—¶ï¼Œå¯åŠ¨äº†è¯¥çº¿ç¨‹ï¼›</p></li></ol><p>PrepRequestProcessor.run() å°†ä» submittedRequests é˜Ÿåˆ—ä¸­è·å–è¯·æ±‚å¹¶å¤„ç†ï¼›</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// çœç•¥äº†éƒ¨åˆ†éä¸»çº¿ä»£ç </span>            Request request <span class="token operator">=</span> submittedRequests<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            request<span class="token punctuation">.</span>prepStartTime <span class="token operator">=</span> Time<span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">pRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">pRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RequestProcessorException <span class="token punctuation">{</span>    request<span class="token punctuation">.</span><span class="token function">setHdr</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>    request<span class="token punctuation">.</span><span class="token function">setTxn</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">isThrottled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// æ ¹æ®è¯·æ±‚ç±»å‹çš„ä¸åŒï¼ˆcreate/delete/updateï¼‰ï¼Œå¯¹è¯·æ±‚è¿›è¡Œå°è£…å’Œç‰¹æ®Šå¤„ç†</span>      <span class="token comment" spellcheck="true">// æœ€ç»ˆå°†è¯·æ±‚æ”¾å…¥zks.outstandingChanges</span>      <span class="token function">pRequestHelper</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ç»™è¯·æ±‚è®¾ç½®ä¸€ä¸ª zxid </span>    request<span class="token punctuation">.</span>zxid <span class="token operator">=</span> zks<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è°ƒç”¨ä¸‹ä¸€ä¸ªæ¥å£</span>    nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>pRequestHelperï¼š</p><ol><li>æ ¹æ®è¯·æ±‚ç±»å‹çš„ä¸åŒï¼ˆcreate/delete/updateï¼‰ï¼Œå¯¹è¯·æ±‚è¿›è¡Œå°è£…</li><li>æ ¡éªŒè¯·æ±‚æ˜¯å¦åˆç†ï¼šæœªå®šä¹‰çš„è¯·æ±‚ã€å‚æ•°ä¸åˆç†</li><li>æ£€æŸ¥ä¸Šçº§è·¯å¾„æ˜¯å¦å­˜åœ¨</li><li>æ£€æŸ¥ACL</li><li> æ£€æŸ¥è·¯å¾„æ˜¯å¦åˆæ³•</li><li> å°†è¯·æ±‚è£…å…¥ <strong>outstandingChanges</strong> é˜Ÿåˆ—<br>ç„¶åç»™è¯·æ±‚è®¾ç½®Zxidï¼Œå¹¶è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨<h5 id="2-1-3-proposalProcessor-ï¼ˆé‡ç‚¹-ï¼‰"><a href="#2-1-3-proposalProcessor-ï¼ˆé‡ç‚¹-ï¼‰" class="headerlink" title="2.1.3_ proposalProcessor ï¼ˆé‡ç‚¹*ï¼‰"></a>2.1.3_ proposalProcessor ï¼ˆé‡ç‚¹*ï¼‰</h5>è¿™ä¸ªå¤„ç†å™¨æ˜¯zookeeperæ•°æ®æ–‡ä»¶åŒæ­¥å’Œæœ¬åœ°äº‹åŠ¡å†™å…¥çš„å…³é”®ï¼ˆå¯ä»¥ç†è§£ä¸ºä¸¤é˜¶æ®µæäº¤çš„ç¬¬ä¸€é˜¶æ®µï¼‰<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/202884eb804740a0847b0b1ba4cadb75~tplv-k3u1fbpfcp-watermark.image" alt="ProposalRequestProcessor (2).png"></li><li>è°ƒç”¨è´£ä»»é“¾çš„ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼›</li><li>é€šè¿‡ LearnerHandler å°†è¯·æ±‚å‘é€åˆ° follower èŠ‚ç‚¹</li><li>å¯ç”¨ SyncRequestProcessor -&gt; AckRequestProcessor è´£ä»»é“¾å°†æ•°æ®å†™å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶åˆ¤æ–­æ˜¯å¦åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹è¿”å›ACKç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æœè¶…è¿‡åŠæ•°ï¼Œåˆ™æäº¤æ•°æ®å†™å…¥å†…å­˜ï¼›</li></ol><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RequestProcessorException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦æ˜¯leaderçš„åŒæ­¥è¯·æ±‚</span>    <span class="token comment" spellcheck="true">// ç”±äºæœ¬æ¬¡æˆ‘ä»¬å®¢æˆ·ç«¯ç›´æ¥å‘é€æ¶ˆæ¯åˆ°leaderèŠ‚ç‚¹ï¼Œ</span>    <span class="token comment" spellcheck="true">// æ‰€ä»¥ request instanceof LearnerSyncRequest = falseï¼›</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token keyword">instanceof</span> <span class="token class-name">LearnerSyncRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        zks<span class="token punctuation">.</span><span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LearnerSyncRequest<span class="token punctuation">)</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ˜¯å¦éœ€è¦è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldForwardToNextProcessor</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getHdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å¤„ç†è¯·æ±‚</span>                zks<span class="token punctuation">.</span><span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">propose</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XidRolloverException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// å†™æœ¬åœ°æ–‡ä»¶åŒæ­¥</span>            syncProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h6 id="2-1-3-1-shouldForwardToNextProcessor-request"><a href="#2-1-3-1-shouldForwardToNextProcessor-request" class="headerlink" title="2.1.3.1_ shouldForwardToNextProcessor(request)"></a>2.1.3.1_ shouldForwardToNextProcessor(request)</h6><p>shouldForwardToNextProcessor(request) é»˜è®¤æƒ…å†µä¸‹ä¸ºtrueï¼›</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// forwardLearnerRequestsToCommitProcessorDisabled é»˜è®¤ä¸ºfalseï¼Œ </span><span class="token comment" spellcheck="true">// éœ€è¦é…ç½® zookeeper.forward_learner_requests_to_commit_processor_disabled = true æ‰èƒ½æ›´æ”¹</span><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">shouldForwardToNextProcessor</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forwardLearnerRequestsToCommitProcessorDisabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">LearnerHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        ServerMetrics<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>REQUESTS_NOT_FORWARDED_TO_COMMIT_PROCESSOR<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>nextProcessor.processRequest(request)è°ƒç”¨ä¸‹ä¸€ä¸ª CommitProcessor å¤„ç†å™¨ï¼›</p><h6 id="2-1-3-2-zks-getLeader-propose-request"><a href="#2-1-3-2-zks-getLeader-propose-request" class="headerlink" title="2.1.3.2_ zks.getLeader().propose(request);"></a>2.1.3.2_ zks.getLeader().propose(request);</h6><p>é€šè¿‡ LearnerHandler å°†è¯·æ±‚å‘é€åˆ° follower èŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†è¯·æ±‚åŠ å…¥åˆ° outstandingProposals é˜Ÿåˆ—ä¸­ï¼›</p><ul><li><p>å°†è¯·æ±‚å°è£…æˆ QuorumPacketï¼Œå¹¶é€šè¿‡å¾ªç¯å°†è¯·æ±‚å‘é€åˆ° LearnerHandler.queuedPackets é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†ï¼› </p><p>  å¹¶å°†è¯·æ±‚åŠ å…¥åˆ° outstandingProposals é˜Ÿåˆ—ä¸­</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Proposal <span class="token function">propose</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> XidRolloverException <span class="token punctuation">{</span>  <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> SerializeUtils<span class="token punctuation">.</span><span class="token function">serializeRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>  proposalStats<span class="token punctuation">.</span><span class="token function">setLastBufferSize</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>  QuorumPacket pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span>Leader<span class="token punctuation">.</span>PROPOSAL<span class="token punctuation">,</span> request<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> data<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>  Proposal p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proposal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  p<span class="token punctuation">.</span>packet <span class="token operator">=</span> pp<span class="token punctuation">;</span>  p<span class="token punctuation">.</span>request <span class="token operator">=</span> request<span class="token punctuation">;</span>  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      p<span class="token punctuation">.</span><span class="token function">addQuorumVerifier</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†éä¸»çº¿ä»£ç </span>      lastProposed <span class="token operator">=</span> p<span class="token punctuation">.</span>packet<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      outstandingProposals<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lastProposed<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">sendPacket</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> p<span class="token punctuation">;</span><span class="token punctuation">}</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">void</span> <span class="token function">sendPacket</span><span class="token punctuation">(</span>QuorumPacket qp<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>forwardingFollowers<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span>LearnerHandler f <span class="token operator">:</span> forwardingFollowers<span class="token punctuation">)</span> <span class="token punctuation">{</span>          f<span class="token punctuation">.</span><span class="token function">queuePacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">void</span> <span class="token function">queuePacket</span><span class="token punctuation">(</span>QuorumPacket p<span class="token punctuation">)</span> <span class="token punctuation">{</span>  queuedPackets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre></li><li><p>LearnerHandler æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼ŒLearnerHandler.run() æ–¹æ³•ä¸­è°ƒç”¨äº† startSendingPackets() å°†æ•°æ®ä» LearnerHandler.queuedPackets é˜Ÿåˆ—å–å‡ºï¼Œå¹¶å‘é€åˆ° follower èŠ‚ç‚¹ï¼›</p></li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">startSendingPackets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sendingThreadStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// å‘é€è¯·æ±‚æ•°æ®åŒ…åˆ°followerèŠ‚ç‚¹</span>                    <span class="token function">sendPackets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sendingThreadStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendPackets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            QuorumPacket p<span class="token punctuation">;</span>            p <span class="token operator">=</span> queuedPackets<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                bufferedOutput<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                p <span class="token operator">=</span> queuedPackets<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Leader<span class="token punctuation">.</span>PROPOSAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>                syncLimitCheck<span class="token punctuation">.</span><span class="token function">updateProposal</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†éä¸»çº¿ä»£ç </span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                lastZxid <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            oa<span class="token punctuation">.</span><span class="token function">writeRecord</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            packetsSent<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            messageTracker<span class="token punctuation">.</span><span class="token function">trackSent</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h6 id="2-1-3-3-syncProcessor-processRequest-request"><a href="#2-1-3-3-syncProcessor-processRequest-request" class="headerlink" title="2.1.3.3 syncProcessor.processRequest(request);"></a>2.1.3.3 syncProcessor.processRequest(request);</h6><p>å¯ç”¨ SyncRequestProcessor -&gt; AckRequestProcessor è´£ä»»é“¾ï¼›</p><ul><li><p>SyncRequestProcessor å°†æ•°æ®å†™å…¥æ–‡ä»¶ç³»ç»Ÿï¼›</p><ul><li><p>processRequest æ–¹æ³•å°†è¯·æ±‚å†™å…¥åˆ° queuedRequests é˜Ÿåˆ—ä¸­</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> Request request<span class="token punctuation">)</span> <span class="token punctuation">{</span>queuedRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre></li><li><p>SyncRequestProcessor.run(); </p><p>zks.getZKDatabase().append(si) å°†æ•°æ®å†™å…¥å¿«ç…§å¯¹è±¡ï¼› </p><p>zks.takeSnapshot() å°†æ•°æ®åºåˆ—åŒ–åˆ°zkåº•å±‚çš„DataTreeå¯¹è±¡ä¸­ï¼›  </p><p>flush() ä¸­æœ‰ä¸ªcommitæ–¹æ³•ï¼ŒçœŸæ­£å°†æ•°æ®å†™å…¥æ–‡ä»¶ï¼›ç„¶åè°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨ AckRequestProcessorï¼›</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// çœç•¥å¤§é‡éä¸»çº¿ä»£ç </span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Request si <span class="token operator">=</span> queuedRequests<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>pollTime<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// zks.getZKDatabase().append(si) æŠŠè¯·æ±‚append åˆ°å¿«ç…§å¯¹è±¡ä¸­</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token punctuation">.</span><span class="token function">isThrottled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> zks<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">resetSnapshotStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    zks<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>snapThreadMutex<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        <span class="token keyword">new</span> <span class="token class-name">ZooKeeperThread</span><span class="token punctuation">(</span><span class="token string">"Snapshot Thread"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token keyword">try</span> <span class="token punctuation">{</span>                                    <span class="token comment" spellcheck="true">// è¿™é‡Œå°†æ•°æ®åºåˆ—åŒ–åˆ°zkåº•å±‚çš„DataTreeå¯¹è±¡ä¸­</span>                                    zks<span class="token punctuation">.</span><span class="token function">takeSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                    LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Unexpected exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                                    snapThreadMutex<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token punctuation">}</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            toFlush<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> RequestProcessorException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æäº¤å†™å¿«ç…§æ–‡ä»¶</span>    zks<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nextProcessor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>toFlush<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>toFlush<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> Request i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>toFlush<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nextProcessor <span class="token keyword">instanceof</span> <span class="token class-name">Flushable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">(</span><span class="token punctuation">(</span>Flushable<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextProcessor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ul></li><li><p>AckRequestProcessor åˆ¤æ–­æ˜¯å¦åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹è¿”å›ACKç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æœè¶…è¿‡åŠæ•°ï¼Œåˆ™æäº¤æ•°æ®å†™å…¥å†…å­˜</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token punctuation">{</span>    QuorumPeer self <span class="token operator">=</span> leader<span class="token punctuation">.</span>self<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>self <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        leader<span class="token punctuation">.</span><span class="token function">processAck</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>  ä»è¿‡ç¨‹ <strong>2</strong> è®¾ç½®çš„ outstandingProposals ä¸­è·å–è¯·æ±‚ï¼Œå°è¯•æäº¤ï¼› </p><p>  åˆ¤æ–­æ”¶åˆ°çš„ACKæ¶ˆæ¯æ˜¯å¦è¶…è¿‡é›†ç¾¤èŠ‚ç‚¹çš„ä¸€åŠï¼›  </p><p>  å¦‚æœè¶…è¿‡ä¸€åŠåˆ™æäº¤ï¼›</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">processAck</span><span class="token punctuation">(</span><span class="token keyword">long</span> sid<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span> SocketAddress followerAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Proposal p <span class="token operator">=</span> outstandingProposals<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>    p<span class="token punctuation">.</span><span class="token function">addAck</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å°è¯•æäº¤</span>    <span class="token keyword">boolean</span> hasCommitted <span class="token operator">=</span> <span class="token function">tryToCommit</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> zxid<span class="token punctuation">,</span> followerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasCommitted <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>request <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">getHdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> OpCode<span class="token punctuation">.</span>reconfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> curZxid <span class="token operator">=</span> zxid<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>allowedToCommit <span class="token operator">&amp;&amp;</span> hasCommitted <span class="token operator">&amp;&amp;</span> p <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            curZxid<span class="token operator">++</span><span class="token punctuation">;</span>            p <span class="token operator">=</span> outstandingProposals<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>curZxid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                hasCommitted <span class="token operator">=</span> <span class="token function">tryToCommit</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> curZxid<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">tryToCommit</span><span class="token punctuation">(</span>Proposal p<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span> SocketAddress followerAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­æ”¶åˆ°çš„ACKæ¶ˆæ¯æ˜¯å¦è¶…è¿‡é›†ç¾¤èŠ‚ç‚¹çš„ä¸€åŠ</span>    <span class="token comment" spellcheck="true">// ç”±äºfollowerèŠ‚ç‚¹è¿˜æ²¡æœ‰è¿”å›ACKæ¶ˆæ¯æ‰€ä»¥æ­¤å¤„ç›´æ¥è¿”å›ï¼›</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">.</span><span class="token function">hasAllQuorums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    outstandingProposals<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>request <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        toBeApplied<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>request <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">getHdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> OpCode<span class="token punctuation">.</span>reconfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†éæœ¬æ¬¡ä¸»çº¿ä»£ç </span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        p<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">logLatency</span><span class="token punctuation">(</span>ServerMetrics<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>QUORUM_ACK_LATENCY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">commit</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">inform</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å°†è¯·æ±‚å‘é€åˆ° commitProcessor çš„ committedRequests é˜Ÿåˆ—ä¸­ï¼›</span>    zk<span class="token punctuation">.</span>commitProcessor<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>  æ­¤æ—¶ç”±äº follower èŠ‚ç‚¹æ”¶åˆ° proposal è¯·æ±‚ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è¿”å›ACKæ¶ˆæ¯ï¼Œæ‰€ä»¥ tryToCommit è¿”å›falseï¼›è¿™è¾¹é€»è¾‘ä¹Ÿå°±ç»“æŸäº†ï¼›ç­‰å¾… follower èŠ‚ç‚¹è¿”å›ACKåä¼šå†æ¬¡è°ƒç”¨è¯¥æ–¹æ³•ï¼›</p><p>  å¦‚æœ follower èŠ‚ç‚¹+ leader èŠ‚ç‚¹ è¶…è¿‡åŠæ•°ï¼Œåˆ™ p.hasAllQuorums() = trueï¼Œåç»­é€»è¾‘ç»§ç»­æ‰§è¡Œï¼Œæˆ‘ä»¬å‘é€çš„æ˜¯create è¯·æ±‚ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œ <strong>commit(zxid); inform(p)</strong> ä»¥åŠ zk.commitProcessor.commit(p.request)ï¼›  </p><p>  commit(zxid)ï¼šleader ä¼šå‘é€ä¸€ä¸ª commit è¯·æ±‚ï¼Œæºå¸¦zxidï¼Œåˆ° follower èŠ‚ç‚¹ï¼ŒfollowerèŠ‚ç‚¹æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œä¼šå°†ä¹‹å‰åœ¨<strong>2. zks.getLeader().propose(request);</strong> ä¸­ leader å‘é€ç»™ follower èŠ‚ç‚¹çš„æ•°æ®å†™å…¥åˆ°è‡ªå·±çš„å†…å­˜ä¸­ï¼ˆè¯¥é€»è¾‘åœ¨åç»­followerèŠ‚ç‚¹å¤„ç†è¿‡ç¨‹ä¸­ä¼šè®²åˆ°ï¼‰</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        lastCommitted <span class="token operator">=</span> zxid<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    QuorumPacket qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span>Leader<span class="token punctuation">.</span>COMMIT<span class="token punctuation">,</span> zxid<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sendPacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span>    ServerMetrics<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>COMMIT_COUNT<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>  inform(p)ï¼šä¼šå°†è¯·æ±‚å‘é€åˆ°obseverèŠ‚ç‚¹ä¿å­˜èµ·æ¥ï¼›</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">inform</span><span class="token punctuation">(</span>Proposal proposal<span class="token punctuation">)</span> <span class="token punctuation">{</span>    QuorumPacket qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span>Leader<span class="token punctuation">.</span>INFORM<span class="token punctuation">,</span> proposal<span class="token punctuation">.</span>request<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span>         proposal<span class="token punctuation">.</span>packet<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sendObserverPacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>  zk.commitProcessor.commit(p.request)ï¼šå°†è¯·æ±‚å‘é€åˆ° commitProcessor çš„ committedRequests é˜Ÿåˆ—ä¸­ï¼›è¯¥é˜Ÿåˆ—ä¼šåœ¨ commitProcessorçš„ run æ–¹æ³•ä¸­æ¶ˆè´¹ï¼›</p><h5 id="2-1-4-CommitProcessor"><a href="#2-1-4-CommitProcessor" class="headerlink" title="2.1.4_ CommitProcessor"></a>2.1.4_ CommitProcessor</h5><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44bb14257b874e4786b18dea617dad4b~tplv-k3u1fbpfcp-watermark.image" alt="CommitProcessor.png"><br>æ€»çš„æ¥è¯´ CommitProcessor åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼ŒCommitProcessor æ¥æ”¶åˆ° leader è®¤ä¸ºå¯ä»¥æäº¤çš„è¯·æ±‚ï¼Œå°†è¯·æ±‚è¿›è¡Œç®€å•å¤„ç†åï¼Œè½¬å‘ç»™ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼›</p></li></ul><p>ä½†æ˜¯ç”±äº zk è¿½æ±‚æ•ˆç‡ï¼Œä»£ç ä¸­å­˜åœ¨å¤§é‡çš„çº¿ç¨‹å’Œé˜Ÿåˆ—ï¼Œå¯¼è‡´æ¯”è¾ƒéš¾è¯»ï¼›</p><ol><li><p>LearnerHandler çº¿ç¨‹çš„ run æ–¹æ³• ä¸­å­˜åœ¨ä¸€ä¸ªæ­»å¾ªç¯ï¼Œæ— é™ç­‰å¾…æ¥æ”¶ SendAckRequestProcessor å‘é€çš„ ACK æ¶ˆæ¯ï¼›</p><p>å½“æ¥æ”¶åˆ° ACK è¯·æ±‚æ—¶ï¼Œä¼šè°ƒç”¨ processAck()ï¼› åç»­é€»è¾‘ä¸ <strong>2.1.3.3</strong> ä¸­çš„ AckRequestProcessor å¤„ç†å™¨ç›¸åŒï¼›</p><pre class=" language-java"><code class="language-java"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ia<span class="token punctuation">.</span><span class="token function">readRecord</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    messageTracker<span class="token punctuation">.</span><span class="token function">trackReceived</span><span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ByteBuffer bb<span class="token punctuation">;</span>    <span class="token keyword">long</span> sessionId<span class="token punctuation">;</span>    <span class="token keyword">int</span> cxid<span class="token punctuation">;</span>    <span class="token keyword">int</span> type<span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> Leader<span class="token punctuation">.</span>ACK<span class="token operator">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>learnerType <span class="token operator">==</span> LearnerType<span class="token punctuation">.</span>OBSERVER<span class="token punctuation">)</span> <span class="token punctuation">{</span>            LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Received ACK from Observer {}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        syncLimitCheck<span class="token punctuation">.</span><span class="token function">updateAck</span><span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        learnerMaster<span class="token punctuation">.</span><span class="token function">processAck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sid<span class="token punctuation">,</span> qp<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sock<span class="token punctuation">.</span><span class="token function">getLocalSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// çœç•¥å…¶ä»–ä¸ç›¸å¹²çš„ case</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p> åœ¨åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹æ¥æ”¶åˆ°è¯·æ±‚å¹¶å‘é€ ACK åï¼Œä¼šå°†è¯·æ±‚é€šè¿‡ zk.commitProcessor.commit(p.request); å†™å…¥åˆ° CommitProcessor.committedRequests é˜Ÿåˆ—ä¸­ï¼›</p></li><li><p>CommitProcessor.processRequest(); </p><p>å°†è¯·æ±‚åŠ å…¥ queuedRequests å’Œ queuedWriteRequests é˜Ÿåˆ—</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token punctuation">{</span>    queuedRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯å†™è¯·æ±‚</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needCommit</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        queuedWriteRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>        numWriteQueuedRequests<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        numReadQueuedRequests<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre></li><li><p>CommitProcessor ä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œrun() æ–¹æ³•æ¯”è¾ƒé•¿ï¼Œç¯‡å¹…åŸå› ç›´æ¥ç»™å‡ºå¤§è‡´é€»è¾‘ï¼›</p><ol><li>é˜Ÿåˆ—ä¸ºç©ºï¼Œçº¿ç¨‹ wait()ï¼›ã€CommitProcessor.processRequest() ä¸­çš„ wakeup() å”¤é†’ã€‘</li><li>è¯·æ±‚ä¸ºå†™è¯·æ±‚ï¼Œå°†è¯·æ±‚å†™å…¥ pendingRequests ä¸­ï¼›ã€ç±»å‹Map&lt;sessionId,Queue&gt;ã€‘<br> å¦åˆ™ç›´æ¥è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼›</li><li>æ ¹æ®committedRequests æ˜¯å¦ç©ºï¼Œè®¾ç½® commitIsWaiting å±æ€§ï¼›<br> ç©º falseï¼Œéç©º trueï¼›</li><li>ä» committedRequests å’Œ queuedWriteRequests ä¸­å–å‡ºä¸€ä¸ªè¯·æ±‚ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªè¯·æ±‚ï¼›<br> æ˜¯ç»§ç»­ï¼Œå¦ breakï¼›</li><li>ä» pendingRequests ä¸­æ ¹æ® request.sessionId è·å–ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¹¶ä»è¯¥é˜Ÿåˆ—å¤´éƒ¨å–å‡ºä¸€ä¸ª requestï¼›</li><li>æœ€åé€šè¿‡ processWrite(request) å°†è¯·æ±‚å‘é€ç»™ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼›</li></ol></li></ol><h5 id="2-1-5-ToBeAppliedRequestProcessor"><a href="#2-1-5-ToBeAppliedRequestProcessor" class="headerlink" title="2.1.5_ ToBeAppliedRequestProcessor"></a>2.1.5_ ToBeAppliedRequestProcessor</h5><p>è¯¥å¤„ç†å™¨ä¸»è¦åŠŸèƒ½å°±æ˜¯ï¼Œå°†å¤„ç†è¿‡çš„è¯·æ±‚ä»é˜Ÿåˆ— toBeApplied ä¸­åˆ é™¤ï¼›å¹¶è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼›</p><p>toBeApplied é˜Ÿåˆ—ä¸­çš„è¯·æ±‚æ˜¯åœ¨ tryCommit() æ–¹æ³•ä¸­ï¼Œleaderåˆ¤æ–­å¯ä»¥æäº¤åå†™å…¥çš„ï¼›</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RequestProcessorException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨</span>    next<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getHdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> zxid <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Iterator<span class="token operator">&lt;</span>Proposal<span class="token operator">></span> iter <span class="token operator">=</span> leader<span class="token punctuation">.</span>toBeApplied<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Proposal p <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>request <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>request<span class="token punctuation">.</span>zxid <span class="token operator">==</span> zxid<span class="token punctuation">)</span> <span class="token punctuation">{</span>                iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h5 id="2-1-6-FinalRequestProcessor"><a href="#2-1-6-FinalRequestProcessor" class="headerlink" title="2.1.6_ FinalRequestProcessor"></a>2.1.6_ FinalRequestProcessor</h5><p>å°†è¯·æ±‚å†™å…¥åˆ°zk è‡ªå¸¦çš„æ•°æ®ç»“æ„ DataTree ä¸­ï¼Œå¹¶æ ¹æ®è¯·æ±‚ç±»å‹è¿”å›ä¸ä¸€æ ·çš„å“åº”å†…å®¹ï¼›</p><h4 id="2-2-follower-èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ"><a href="#2-2-follower-èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ" class="headerlink" title="2.2_ follower èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ"></a>2.2_ follower èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ</h4><p>follower èŠ‚ç‚¹åˆå§‹åŒ–äº†ä¸¤ä¸ªè°ƒç”¨é“¾ï¼›<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/838dce21beb943b48e258ca39b7ac0ee~tplv-k3u1fbpfcp-watermark.image" alt="æœªå‘½åæ–‡ä»¶ (3).png"></p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6904213790c74002802c6e3df5ff94b9~tplv-k3u1fbpfcp-watermark.image" alt="æœªå‘½åæ–‡ä»¶ (4).png"></p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    RequestProcessor finalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    commitProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitProcessor</span><span class="token punctuation">(</span>finalProcessor<span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function">getZooKeeperServerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    commitProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    firstProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FollowerRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> commitProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span>FollowerRequestProcessor<span class="token punctuation">)</span> firstProcessor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    syncProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendAckRequestProcessor</span><span class="token punctuation">(</span><span class="token function">getFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    syncProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h5 id="2-2-1-FollowerRequestProcessor"><a href="#2-2-1-FollowerRequestProcessor" class="headerlink" title="2.2.1_ FollowerRequestProcessor"></a>2.2.1_ FollowerRequestProcessor</h5><ol><li><p>FollowerRequestProcessor.processRequest() å°†è¯·æ±‚å†™å…¥ queuedRequests é˜Ÿåˆ—ä¸­</p><pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkForUpgrade<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>finished<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>checkForUpgrade<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Request upgradeRequest <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                upgradeRequest <span class="token operator">=</span> zks<span class="token punctuation">.</span><span class="token function">checkUpgradeSession</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> ke<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradeRequest <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                queuedRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>upgradeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        queuedRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li><li><p>FollowerRequestProcessor.run()</p><p>follower èŠ‚ç‚¹åœ¨è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨å‰ï¼Œä¼šåˆ¤æ–­æ˜¯å¦æ˜¯ leader èŠ‚ç‚¹å‘é€è¿‡æ¥çš„æ¶ˆæ¯ï¼›å¦‚æœä¸æ˜¯ï¼Œå°†è¯·æ±‚è½¬å‘ç»™ leader èŠ‚ç‚¹ï¼›å¦åˆ™è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨ CommitProcessor</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>finished<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Request request <span class="token operator">=</span> queuedRequests<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å°è¯•è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨</span>            <span class="token function">maybeSendRequestToNextProcessor</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æ ¹æ®è¯·æ±‚çš„ç±»å‹ï¼Œå°†è¯·æ±‚è½¬å‘ç»™ leader</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>sync<span class="token operator">:</span>                zks<span class="token punctuation">.</span>pendingSyncs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>                zks<span class="token punctuation">.</span><span class="token function">getFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>create<span class="token operator">:</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>create2<span class="token operator">:</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>createTTL<span class="token operator">:</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>createContainer<span class="token operator">:</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>delete<span class="token operator">:</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>deleteContainer<span class="token operator">:</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>setData<span class="token operator">:</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>reconfig<span class="token operator">:</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>setACL<span class="token operator">:</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>multi<span class="token operator">:</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>check<span class="token operator">:</span>                zks<span class="token punctuation">.</span><span class="token function">getFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>createSession<span class="token operator">:</span>            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>closeSession<span class="token operator">:</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">isLocalSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    zks<span class="token punctuation">.</span><span class="token function">getFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>ğŸ‘‡ğŸ‘‡ğŸ‘‡<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">maybeSendRequestToNextProcessor</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RequestProcessorException <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>skipLearnerRequestToNextProcessor <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span><span class="token function">isFromLearner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        ServerMetrics<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>SKIP_LEARNER_REQUEST_TO_NEXT_PROCESSOR_COUNT<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h5 id="2-2-2-CommitProcessor"><a href="#2-2-2-CommitProcessor" class="headerlink" title="2.2.2_ CommitProcessor"></a>2.2.2_ CommitProcessor</h5><p>åŒ leader èŠ‚ç‚¹çš„ CommitProcessor ä¸€è‡´</p></li></ol><h5 id="2-2-3-FinalRequestProcessor"><a href="#2-2-3-FinalRequestProcessor" class="headerlink" title="2.2.3_ FinalRequestProcessor"></a>2.2.3_ FinalRequestProcessor</h5><p>åŒ leader èŠ‚ç‚¹çš„ FinalRequestProcessor ä¸€è‡´</p><h5 id="2-2-4-SyncRequestProcessor"><a href="#2-2-4-SyncRequestProcessor" class="headerlink" title="2.2.4_ SyncRequestProcessor"></a>2.2.4_ SyncRequestProcessor</h5><p>åŒ leader èŠ‚ç‚¹çš„ SyncRequestProcessor ä¸€è‡´</p><h5 id="2-2-5-SendAckRequestProcessor"><a href="#2-2-5-SendAckRequestProcessor" class="headerlink" title="2.2.5_ SendAckRequestProcessor"></a>2.2.5_ SendAckRequestProcessor</h5><p>leader èŠ‚ç‚¹çš„AckRequestProcessor æ˜¯ç›´æ¥è°ƒç”¨leader èŠ‚ç‚¹çš„tryToCommit() æ–¹æ³•ï¼›</p><p>follower èŠ‚ç‚¹ SendAckRequestProcessor éœ€è¦å°†Ackæ¶ˆæ¯å‘é€åˆ°leaderèŠ‚ç‚¹è¿›è¡Œç»Ÿè®¡å¤„ç†ï¼›</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request si<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">.</span>type <span class="token operator">!=</span> OpCode<span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>        QuorumPacket qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span>Leader<span class="token punctuation">.</span>ACK<span class="token punctuation">,</span> si<span class="token punctuation">.</span><span class="token function">getHdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            learner<span class="token punctuation">.</span><span class="token function">writePacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// çœç•¥å¼‚å¸¸å¤„ç†ä»£ç </span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>åœ¨çº¿è¹²èµç¯èŠ‚ </p><p>è€æ¿ï¼ç‚¹ä¸ªèµå‘—ï¼ï¼<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3179ae7cb2248c887f59094056ace83~tplv-k3u1fbpfcp-watermark.image" alt="1631955135(1).png"></p>]]></content>
      
      
      <categories>
          
          <category> æºç ç ”è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zookeeper å¯åŠ¨è¿‡ç¨‹/leader é€‰ä¸¾</title>
      <link href="/2021/08/16/zookeeper/"/>
      <url>/2021/08/16/zookeeper/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬ç¯‡åšæ–‡ç»“åˆzookeeperæºç é£Ÿç”¨æ›´ä½³å“¦ï¼zookeeper æºç å¯ä»¥ç›´æ¥ä»<a href="https://github.com/apache/zookeeper">github</a>ä¸‹è½½ç¼–è¯‘ï¼</p><h2 id="zookeeper-é›†ç¾¤æ¨¡å¼ä¸‹åšäº†å“ªäº›äº‹æƒ…ï¼Ÿ"><a href="#zookeeper-é›†ç¾¤æ¨¡å¼ä¸‹åšäº†å“ªäº›äº‹æƒ…ï¼Ÿ" class="headerlink" title="zookeeper é›†ç¾¤æ¨¡å¼ä¸‹åšäº†å“ªäº›äº‹æƒ…ï¼Ÿ"></a>zookeeper é›†ç¾¤æ¨¡å¼ä¸‹åšäº†å“ªäº›äº‹æƒ…ï¼Ÿ</h2><ol><li>åˆå§‹åŒ–é€šä¿¡æ–¹å¼ netty/NIOï¼Œå¹¶åœ¨åç»­å¯åŠ¨</li><li>åˆå§‹åŒ–zookeeperä¿å­˜è‡ªèº«ä¿¡æ¯çš„zookeeperèŠ‚ç‚¹</li><li>å¯åŠ¨å†…åµŒçš„ jetty æœåŠ¡å™¨ï¼ˆé€šè¿‡jettyçš„startæ–¹æ³•ï¼Œæœ¬æ–‡ä¸ä½œèµ˜è¿°ï¼‰</li><li>é€‰ä¸¾å‡º leader *</li></ol><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬é¡ºç€æºç å›¾ï¼Œä»æºç å‡ºå‘çœ‹çœ‹zookeeperåˆ°åº•æ˜¯å¦‚ä½•å¯åŠ¨çš„ã€‚<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/56c338fc326e4f338653a7cc8ddc4623~tplv-k3u1fbpfcp-watermark.image" alt="zookeeper å¯åŠ¨ + leaderé€‰ä¸¾.png"></p><p>zookeeper é›†ç¾¤å¯åŠ¨å…¥å£ï¼šQuorumPeerMain.main(); </p><p>mainæ–¹æ³•ä¸­è°ƒç”¨ initializeAndRun() è§£æzookeeperé…ç½®æ–‡ä»¶ï¼Œå¦‚æœé…ç½®æ–‡ä»¶ä¸­é…ç½®äº†é›†ç¾¤ï¼Œåˆ™æ‰§è¡Œ runFromConfig() æ–¹æ³•ï¼›</p><p>æ‰€æœ‰å…³é”®æ€§çš„ä»£ç éƒ½åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä»”ç»†ç ”ç©¶è¿™ä¸ªæ–¹æ³•åæˆ‘ä»¬å‘ç°ä»¥ä¸‹å…³é”®æ€§ä»£ç </p><h3 id="1ã€-åˆå§‹åŒ–é€šä¿¡æ–¹å¼-netty-NIOï¼Œå¹¶åœ¨åç»­å¯åŠ¨"><a href="#1ã€-åˆå§‹åŒ–é€šä¿¡æ–¹å¼-netty-NIOï¼Œå¹¶åœ¨åç»­å¯åŠ¨" class="headerlink" title="1ã€ åˆå§‹åŒ–é€šä¿¡æ–¹å¼ netty/NIOï¼Œå¹¶åœ¨åç»­å¯åŠ¨"></a>1ã€ åˆå§‹åŒ–é€šä¿¡æ–¹å¼ netty/NIOï¼Œå¹¶åœ¨åç»­å¯åŠ¨</h3><p>zookeeper ä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼åº”ç”¨çš„é«˜æ€§èƒ½åè°ƒæœåŠ¡ï¼Œå¿…ç„¶éœ€è¦å’Œå…¶ä»–åˆ†å¸ƒå¼åº”ç”¨ç›¸äº’é€šä¿¡ï¼Œnio/nettyç­‰åŸºäºsocketçš„é€šä¿¡æ–¹å¼æˆä¸ºäº†ä»–çš„ä¸äºŒä¹‹é€‰ã€‚</p><p>zookeeper é»˜è®¤ä½¿ç”¨NIOåšä¸ºé€šä¿¡æ–¹å¼ï¼Œä½†æ˜¯å®˜æ–¹æ¨èä½¿ç”¨nettyã€‚</p><p>ã€QuorumPeerMain.runFromConfig()  ä¸­ä»£ç ã€‘</p><pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getClientPortAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>    cnxnFactory <span class="token operator">=</span> ServerCnxnFactory<span class="token punctuation">.</span><span class="token function">createFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cnxnFactory<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getClientPortAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getMaxClientCnxns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getClientPortListenBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ã€ServerCnxnFactory.createFactory() ä¸­ä»£ç ã€‘</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String ZOOKEEPER_SERVER_CNXN_FACTORY <span class="token operator">=</span> <span class="token string">"zookeeper.serverCnxnFactory"</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">static</span> ServerCnxnFactory <span class="token function">createFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>    String serverCnxnFactoryName <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>ZOOKEEPER_SERVER_CNXN_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>serverCnxnFactoryName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        serverCnxnFactoryName <span class="token operator">=</span> NIOServerCnxnFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        ServerCnxnFactory serverCnxnFactory <span class="token operator">=</span> <span class="token punctuation">(</span>ServerCnxnFactory<span class="token punctuation">)</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>serverCnxnFactoryName<span class="token punctuation">)</span>                                                                       <span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                                                       <span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> serverCnxnFactory<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>zookeeper ä»ç³»ç»Ÿé…ç½®ä¸­å°è¯•è·å– <code>zookeeper.serverCnxnFactory</code> ï¼Œå¦‚æœèƒ½è·å–åˆ°åˆ™ä½¿ç”¨é…ç½®çš„é€šä¿¡æ–¹æ³•ï¼Œå¦åˆ™ä½¿ç”¨NIOServerCnxnFactoryï¼›ç„¶åé€šè¿‡åå°„å®ä¾‹åŒ–ã€‚<strong>æ­¤æ—¶nettyè¿˜æ²¡æœ‰è®¾ç½®ç›‘å¬ç«¯å£ï¼Œæ²¡æœ‰å¼€å§‹äº‹ä»¶ç›‘å¬</strong></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç³»ç»Ÿé…ç½®<code>zookeeper.serverCnxnFactory=org.apache.zookeeper.server.NettyServerCnxnFactory</code>å¯ç”¨ nettyï¼›</p><p>ServerCnxnFactory æœ‰4ç§å®ç°ï¼Œé»˜è®¤ä½¿ç”¨nioï¼Œæ¨èä½¿ç”¨nettyï¼›</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ce4a10c40647479ab508291c5b8c362b~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p><h3 id="2ã€-åˆå§‹åŒ–zookeeperä¿å­˜è‡ªèº«ä¿¡æ¯çš„zookeeperèŠ‚ç‚¹"><a href="#2ã€-åˆå§‹åŒ–zookeeperä¿å­˜è‡ªèº«ä¿¡æ¯çš„zookeeperèŠ‚ç‚¹" class="headerlink" title="2ã€ åˆå§‹åŒ–zookeeperä¿å­˜è‡ªèº«ä¿¡æ¯çš„zookeeperèŠ‚ç‚¹"></a>2ã€ åˆå§‹åŒ–zookeeperä¿å­˜è‡ªèº«ä¿¡æ¯çš„zookeeperèŠ‚ç‚¹</h3><p>ä½¿ç”¨è¿‡zookeeperçš„åŒå­¦åº”è¯¥ä¼šå‘ç°ï¼Œzookeeperåœ¨å¯åŠ¨åï¼Œé»˜è®¤ä¼šæœ‰ä¸€ä¸ªzookeeperèŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹æ˜¯zookeeperç”¨äºå‚¨å­˜è‡ªèº«ä¿¡æ¯çš„ï¼›</p><p>ã€QuorumPeerMain.runFromConfig()  ä¸­ä»£ç ã€‘</p><pre class=" language-java"><code class="language-java">quorumPeer<span class="token punctuation">.</span><span class="token function">setZKDatabase</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ZKDatabase</span><span class="token punctuation">(</span>quorumPeer<span class="token punctuation">.</span><span class="token function">getTxnFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>ZKDatabase  ä¸­é€šè¿‡createDataTree();è°ƒç”¨ new DataTree() æ–°å»ºåˆå§‹åŒ–èŠ‚ç‚¹</p><p>ã€new DataTree() ä¸­ä»£ç ã€‘</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String rootZookeeper <span class="token operator">=</span> <span class="token string">"/"</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String procZookeeper <span class="token operator">=</span> <span class="token string">"/zookeeper"</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String quotaZookeeper <span class="token operator">=</span> <span class="token string">"/zookeeper/quota"</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">final</span> DataNode procDataNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span>1L<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StatPersisted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">final</span> DataNode quotaDataNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span>1L<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StatPersisted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">DataTree</span><span class="token punctuation">(</span>DigestCalculator digestCalculator<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>digestCalculator <span class="token operator">=</span> digestCalculator<span class="token punctuation">;</span>    nodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeHashMapImpl</span><span class="token punctuation">(</span>digestCalculator<span class="token punctuation">)</span><span class="token punctuation">;</span>    nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>    nodes<span class="token punctuation">.</span><span class="token function">putWithoutDigest</span><span class="token punctuation">(</span>rootZookeeper<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>    root<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>procChildZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span>    nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>procZookeeper<span class="token punctuation">,</span> procDataNode<span class="token punctuation">)</span><span class="token punctuation">;</span>    procDataNode<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>quotaChildZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span>    nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>quotaZookeeper<span class="token punctuation">,</span> quotaDataNode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">addConfigNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    nodeDataSize<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">approximateDataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        dataWatches <span class="token operator">=</span> WatchManagerFactory<span class="token punctuation">.</span><span class="token function">createWatchManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        childWatches <span class="token operator">=</span> WatchManagerFactory<span class="token punctuation">.</span><span class="token function">createWatchManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="4ã€é€‰ä¸¾å‡º-leader"><a href="#4ã€é€‰ä¸¾å‡º-leader" class="headerlink" title="4ã€é€‰ä¸¾å‡º leader"></a>4ã€é€‰ä¸¾å‡º leader</h3><p>ç¬¬ä¸€è½®ï¼šzookeeperé›†ç¾¤ä¸­çš„èŠ‚ç‚¹åœ¨å¯åŠ¨æ—¶ï¼Œä¼šå°†è‡ªèº«æ¨ä¸¾ä¸ºleaderã€ç”Ÿæˆä¸€å¼ è‡ªèº«ä¿¡æ¯çš„é€‰ç¥¨(myid+zxid+é€‰ä¸¾å‘¨æœŸ)ã€‘ï¼Œå‘é€ç»™æ‰€æœ‰å…¶ä»–å‚ä¸é€‰ä¸¾çš„èŠ‚ç‚¹ï¼Œè¿™æ˜¯ç¬¬ä¸€è½®ï¼Œè¿™ä¸€è½®è‚¯å®šæ— æ³•é€‰ä¸¾å‡ºleaderï¼›</p><p>ç¬¬äºŒè½®ï¼šåœ¨æ¥å—åˆ°å…¶ä»–èŠ‚ç‚¹çš„é€‰ç¥¨æ—¶ï¼Œå½“å‰èŠ‚ç‚¹ä¼šå°†æ¥æ”¶åˆ°çš„é€‰ç¥¨ å’Œ è‡ªå·±å‘å‡ºçš„é€‰ç¥¨ è¿›è¡Œå¯¹æ¯”ã€å¯¹æ¯”è§„åˆ™ï¼šé€‰ä¸¾å‘¨æœŸæœ€å¤§ &gt; æ•°æ®æœ€æ–° &gt; idæœ€å¤§ã€‘ï¼Œæ ¹æ®é€‰ä¸¾è§„åˆ™åˆ¤æ–­ä¸¤å¼ é€‰ç¥¨çš„ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§é«˜çš„é€‰ç¥¨ä¼šå†æ¬¡è¢«å‘é€å‡ºå»ï¼Œå¹¶è®°å½•åœ¨å½“å‰èŠ‚ç‚¹æœ¬åœ°ç¼“å­˜ä¸­ï¼Œç›´åˆ°é›†ç¾¤åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹çš„é€‰ç¥¨ä¸€è‡´ï¼›</p><p>ã€QuorumPeerMain.runFromConfig()  ä¸­ä»£ç ã€‘</p><pre class=" language-java"><code class="language-java">quorumPeer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>ã€quorumPeer.start()  ä¸­ä»£ç ã€‘</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">loadDataBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">startServerCnxnFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        adminServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AdminServerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token function">startLeaderElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">startJvmPauseMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><code>startServerCnxnFactory()</code> æ–¹æ³•ä¼šè°ƒç”¨ã€<strong>1</strong>ã€‘ä¸­åˆå§‹åŒ–çš„é€šä¿¡ç±»çš„ start æ–¹æ³•ï¼Œå®˜æ–¹æ¨ènettyï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹ä¸‹ NettyServerCnxnFactory</p><p>ã€NettyServerCnxnFactory.statrt() ä¸­ä»£ç ã€‘</p><p>nettyå¼€å¯ç›‘å¬ç«¯å£ï¼Œæ¥å—å®¢æˆ·ç«¯/å…¶ä»–èŠ‚ç‚¹çš„ä¼ è¾“çš„æ•°æ®</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>listenBacklog <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        bootstrap<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span>ChannelOption<span class="token punctuation">.</span>SO_BACKLOG<span class="token punctuation">,</span> listenBacklog<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    parentChannel <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">syncUninterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    localAddress <span class="token operator">=</span> <span class="token punctuation">(</span>InetSocketAddress<span class="token punctuation">)</span> parentChannel<span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ã€startLeaderElection()ã€‘</p><p>å°†è‡ªå·±åšä¸ºleaderï¼Œæ–°å»ºä¸€å¼ é€‰ç¥¨ã€ä¸æ˜¯çœŸæ­£å‘é€å‡ºå»çš„é€‰ç¥¨ï¼Œè¿™æ˜¯å½“å‰èŠ‚ç‚¹å­˜å‚¨çš„è‡ªå·±è®¤ä¸ºçš„ leaderä¿¡æ¯ã€‘ï¼Œå¯ä»¥çœ‹å‡ºé€‰ç¥¨çš„ä¿¡æ¯ã€myid+zxid+é€‰ä¸¾å‘¨æœŸã€‘</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">startLeaderElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPeerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ServerState<span class="token punctuation">.</span>LOOKING<span class="token punctuation">)</span> <span class="token punctuation">{</span>            currentVote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>myid<span class="token punctuation">,</span> <span class="token function">getLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getCurrentEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>electionAlg <span class="token operator">=</span> <span class="token function">createElectionAlgorithm</span><span class="token punctuation">(</span>electionType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>æœ¬è´¨ä¸Š quorumPeer æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥  super.start(); å…¶å®è°ƒç”¨çš„æ˜¯ quorumPeerçš„ run() æ–¹æ³•</p><p>è®©æˆ‘ä»¬çœ‹çœ‹run æ–¹æ³•åˆ°åº•åšäº†ä»€ä¹ˆï¼Œè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œæ­¤å¤„æˆ‘ä»¬åªçœ‹ LOOKING çŠ¶æ€çš„é‡ç‚¹ä»£ç ã€çœç•¥äº†å…¶ä»–çŠ¶æ€çš„ä»£ç ä»¥åŠå¼‚å¸¸å¤„ç†ä»£ç ã€‘</p><p>ã€quorumPeer.run() ä¸­ä»£ç ã€‘</p><pre class=" language-java"><code class="language-java"><span class="token keyword">case</span> LOOKING<span class="token operator">:</span>    Â·Â·Â·Â·Â·Â·    <span class="token function">setCurrentVote</span><span class="token punctuation">(</span><span class="token function">makeLEStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookForLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Â·Â·Â·Â·Â·Â·</code></pre><p>ã€FastLeaderElection.lookForLeader() ä¸­ä»£ç ã€‘</p><p>è¿™æ®µä»£ç åŠ ä¸Šæ³¨é‡Šé•¿è¾¾230è¡Œï¼Œæ­¤å¤„ä¹Ÿåªçœ‹é‡ç‚¹éƒ¨åˆ†ã€‚</p><p><code>updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</code>æ˜¯å°†è‡ªèº«çš„ myid+zxid+é€‰ä¸¾å‘¨æœŸ ä¿å­˜åˆ° FastLeaderElection ç±»å˜é‡ä¸­ï¼›</p><p><code>sendNotifications();</code> å°†æ•°æ®ä¿å­˜åˆ°ä¸€ä¸ª LinkedBlockingQueue ä¸­ï¼Œç„¶åæœ‰å…¶ä»–çº¿ç¨‹å»å‘é€ç»™å…¶ä»–èŠ‚ç‚¹ï¼›</p><p><code>Notification n = recvqueue.poll(notTimeout, TimeUnit.MILLISECONDS);</code> ä¸­çš„ <strong>recvqueue</strong> ã€æ˜¯å®ä¾‹åŒ– quorumPeer æ˜¯æ³¨å†Œçš„ä¸€ä¸ªWorkerReceiver çº¿ç¨‹å»æ¥å—å…¶ä»–èŠ‚ç‚¹å‘é€è¿‡æ¥çš„é€‰ç¥¨ï¼Œä¿å­˜åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­ã€‘</p><p><code>n.electionEpoch &gt; logicalclock.get()</code> æ¯”è¾ƒæ”¶åˆ°çš„é€‰ç¥¨çš„é€‰ä¸¾å‘¨æœŸå’Œè‡ªå·±æœ¬åœ°è®°å½•çš„é€»è¾‘æ—¶é’Ÿï¼›</p><ol><li> å¦‚æœæ¥å—åˆ°çš„é€‰ç¥¨ é€‰ä¸¾å‘¨æœŸæ¯”è¾ƒå¤§ï¼Œæ›´æ–°æœ¬åœ°çš„é€»è¾‘æ—¶é’Ÿï¼Œç„¶åå¯¹æ¯”ä¸¤ä¸ªé€‰ç¥¨</li><li>å¦‚æœæ¥æ”¶åˆ°çš„é€‰ç¥¨ é€‰ä¸¾å‘¨æœŸå°ï¼Œç›´æ¥è·³è¿‡è¿™ä¸ªé€‰ç¥¨</li><li>å¦‚æœç›¸ç­‰ï¼Œå¯¹æ¯”ä¸¤ä¸ªé€‰ç¥¨</li></ol><p><code>totalOrderPredicate(n.leader, n.zxid, n.peerEpoch, getInitId(), getInitLastLoggedZxid(), getPeerEpoch())</code> å°†æ¥æ”¶åˆ°çš„é€‰ç¥¨å’Œå½“å‰é€‰ç¥¨è¿›è¡Œå¯¹æ¯”ã€å¯¹æ¯”è§„åˆ™ï¼šé€‰ä¸¾å‘¨æœŸæœ€å¤§ &gt; æ•°æ®æœ€æ–° &gt; idæœ€å¤§ã€‘ï¼Œå°†æœ€åˆé€‚åšleaderçš„é€‰ç¥¨ï¼Œä¿å­˜åˆ° FastLeaderElection  ç±»å˜é‡ä¸­ï¼›</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/460c9dcda1874785a31f269e18b33d07~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p><p><code>voteSet.hasAllQuorums()</code> ç›´åˆ°æ¥æ”¶åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„é€‰ç¥¨ï¼Œæ­¤æ—¶ FastLeaderElection  ç±»å˜é‡ä¸­ä¿å­˜çš„æ•°æ®å°±æ˜¯æœ€ç»ˆçš„leaderèŠ‚ç‚¹æ•°æ®ï¼Œè¿”å›æœ€ç»ˆèŠ‚ç‚¹æ•°æ®</p><pre class=" language-java"><code class="language-java">Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Vote<span class="token operator">></span> recvset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Vote<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Vote<span class="token operator">></span> outofelection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Vote<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    logicalclock<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">updateProposal</span><span class="token punctuation">(</span><span class="token function">getInitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getInitLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getPeerEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">sendNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Notification n <span class="token operator">=</span> recvqueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>notTimeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> LOOKING<span class="token operator">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch <span class="token operator">></span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            logicalclock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>            recvset<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">totalOrderPredicate</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> <span class="token function">getInitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getInitLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getPeerEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">updateProposal</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">updateProposal</span><span class="token punctuation">(</span><span class="token function">getInitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getInitLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getPeerEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">sendNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch <span class="token operator">&lt;</span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">totalOrderPredicate</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> proposedLeader<span class="token punctuation">,</span> proposedZxid<span class="token punctuation">,</span> proposedEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">updateProposal</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sendNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        recvset<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>sid<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        voteSet <span class="token operator">=</span> <span class="token function">getVoteTracker</span><span class="token punctuation">(</span>recvset<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>proposedLeader<span class="token punctuation">,</span> proposedZxid<span class="token punctuation">,</span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proposedEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>voteSet<span class="token punctuation">.</span><span class="token function">hasAllQuorums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> recvqueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>finalizeWait<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">totalOrderPredicate</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> proposedLeader<span class="token punctuation">,</span> proposedZxid<span class="token punctuation">,</span> proposedEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    recvqueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">setPeerState</span><span class="token punctuation">(</span>proposedLeader<span class="token punctuation">,</span> voteSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                Vote endVote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>proposedLeader<span class="token punctuation">,</span> proposedZxid<span class="token punctuation">,</span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proposedEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">leaveInstance</span><span class="token punctuation">(</span>endVote<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> endVote<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/527c2f267c934d63815e2299e0db8f57~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> æºç ç ”è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¶ˆæ¯é˜Ÿåˆ—[2]--RocketMQ</title>
      <link href="/2021/04/28/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-2-RocketMQ/"/>
      <url>/2021/04/28/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-2-RocketMQ/</url>
      
        <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä»€ä¹ˆç”¨"><a href="#ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä»€ä¹ˆç”¨" class="headerlink" title="ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä»€ä¹ˆç”¨"></a>ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä»€ä¹ˆç”¨</h2><p><a href="https://juejin.cn/post/6937233988821975077">ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—ä»€ä¹ˆç”¨ï¼Ÿ</a></p><h2 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h2><h3 id="RocketMQçš„å·¥ä½œæ¨¡å‹"><a href="#RocketMQçš„å·¥ä½œæ¨¡å‹" class="headerlink" title="RocketMQçš„å·¥ä½œæ¨¡å‹"></a>RocketMQçš„å·¥ä½œæ¨¡å‹</h3><p>ä¸‹å›¾æ˜¯ rocketMQæºç ä¸­ çš„æ¶æ„å›¾  </p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7fc70e3956d44c1cacd04f481557c1af~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p><ul><li><strong>producer</strong>ï¼šç”Ÿäº§è€…</li><li><strong>nameServer</strong>ï¼šè½»é‡çº§çš„æœåŠ¡è·¯ç”±æ³¨å†Œä¸­å¿ƒï¼Œä¸»è¦æä¾›äº†ä¸¤å¤§åŠŸèƒ½ï¼š<ul><li>brokerç®¡ç†ï¼šnameServeræ¥å—brokeré›†ç¾¤çš„æ³¨å†Œï¼Œå¹¶æä¾›å¿ƒè·³æœºåˆ¶ï¼Œæ¥ç¡®å®šbrokeræ˜¯å¦å­˜æ´»</li><li>è·¯ç”±ä¿¡æ¯ç®¡ç†ï¼šä¿å­˜åœ¨brokeré›†ç¾¤çš„æ•´ä¸ªè·¯ç”±ä¿¡æ¯ã€‚ç”Ÿäº§è€…/æ¶ˆè´¹è€…é€šè¿‡nameServerå°±å¯ä»¥çŸ¥é“æ•´ä¸ªbrokeré›†ç¾¤çš„è·¯ç”±ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œæ¶ˆæ¯æŠ•é€’ã€‚<br>nameServeré€šå¸¸ä¹Ÿæ˜¯ä½¿ç”¨é›†ç¾¤çš„éƒ¨ç½²æ–¹å¼ã€é›†ç¾¤ä¸­çš„nameServer ä¸è¿›è¡Œæ•°æ®åŒæ­¥ã€‘ï¼Œborkeré›†ç¾¤ä¼šå‘æ¯ä¸ªnameServeræ³¨å†Œè‡ªå·±çš„è·¯ç”±ä¿¡æ¯ï¼Œè¿™ç¡®ä¿äº†ä¸€å°nameServerå®•æœºçš„æƒ…å†µä¸‹ï¼Œå…¶ä»–nameServerä»å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡ã€‚</li></ul></li><li><strong>broker</strong>ï¼šæ¶ˆæ¯çš„ä¿å­˜å’Œä¼ é€’ï¼Œé€šè¿‡è™šæ‹Ÿtopicå’Œå®é™…çš„queueã€ä¸€ä¸ªtopicä¸‹åŒ…å«å¤šä¸ªqueueã€‘ä¿å­˜æ¶ˆæ¯ã€‚åŒ…å«ä»¥ä¸‹æœåŠ¡<ul><li><code>Remoting Module</code>ï¼šbrokerçš„å­æ¨¡å—ï¼Œç”¨äºå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚</li><li><code>Client Manager</code>ï¼šç®¡ç†å®¢æˆ·ç«¯ï¼ˆç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ï¼‰å¹¶ç»´æŠ¤æ¶ˆè´¹è€…çš„topicè®¢é˜…æƒ…å†µ</li><li><code>Store Service</code>ï¼šæä¾›æ¶ˆæ¯çš„æŒä¹…åŒ–æœåŠ¡</li><li><code>HA Service</code>ï¼šæä¾›ä¸»ä»æ¶ˆæ¯å¤åˆ¶çš„æœåŠ¡</li><li><code>Index Service</code>ï¼šå»ºç«‹æ¶ˆæ¯çš„ç´¢å¼•ï¼Œä¾¿äºæ¶ˆæ¯çš„å¿«é€ŸæŸ¥è¯¢</li></ul></li><li><strong>consumer</strong>ï¼šæ¶ˆè´¹è€…</li></ul><p>å‰é¢çš„æ¶æ„å›¾ï¼Œç¼ºå°‘äº†brokerå†…éƒ¨ç›¸å…³å†…å®¹</p><ul><li><strong>topic</strong>ï¼šbrokerä¸Šçš„é€»è¾‘åˆ†ç»„ï¼Œä»…æ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µã€‚</li><li><strong>message queue</strong>ï¼šbrokerä¸ŠçœŸå®å­˜åœ¨çš„å†…å­˜åŒºåŸŸï¼Œæ¶ˆæ¯çš„æœ€ç»ˆç›®çš„åœ°å’Œæ¶ˆæ¯çš„ä¿å­˜åœ°ã€‚<h3 id="RocketMQçš„7ç§æ¶ˆæ¯"><a href="#RocketMQçš„7ç§æ¶ˆæ¯" class="headerlink" title="RocketMQçš„7ç§æ¶ˆæ¯"></a>RocketMQçš„7ç§æ¶ˆæ¯</h3></li></ul><ol><li>æ™®é€šæ¶ˆæ¯<ul><li>æ™®é€šæ¶ˆæ¯æ ¹æ®ç”Ÿäº§è€…çš„å‘é€æ–¹å¼å¯ä»¥åˆ†æˆï¼šåŒæ­¥ï¼Œå¼‚æ­¥ï¼Œå•å‘æ¶ˆæ¯ä¸‰ç§ã€‚å…¶ä¸­åŒ/å¼‚æ­¥æ¶ˆæ¯ï¼Œéœ€è¦RocketMQçš„ç¡®è®¤å›å¤ï¼Œå•å‘æ¶ˆæ¯æ— éœ€å›å¤ã€‚</li></ul></li><li>é¡ºåºæ¶ˆæ¯<ul><li>é¡ºåºæ¶ˆæ¯ï¼Œå…¶å®æ˜¯ç†ç”¨queue å…ˆè¿›å…ˆå‡ºçš„åŸç†ï¼Œå°†éœ€è¦é¡ºåºæ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œå‘é€åˆ°åŒä¸€ä¸ªqueueä¸­ã€‚åœ¨è¢«æ¶ˆè´¹æ—¶ï¼Œç”±äºå…ˆè¿›å…ˆå‡ºçš„åŸåˆ™ï¼Œç¡®ä¿æ¶ˆæ¯çš„é¡ºåºæ€§ã€‚å®é™…ä¸Šè¿™ä¸ªé¡ºåºåªèƒ½ç¡®ä¿å±€éƒ¨æœ‰åºã€‚</li></ul></li><li>å¹¿æ’­æ¶ˆæ¯<ul><li>æ­£å¦‚å­—é¢æ„æ€ï¼Œæœ‰ä¸€ä¸ªç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œæ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¯ä»¥è¿›è¡Œæ¶ˆè´¹ä¸”äº’ä¸å½±å“ã€‚</li></ul></li><li>å»¶è¿Ÿæ¶ˆæ¯<ul><li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶ï¼Œè®¾ç½®ä¸€ä¸ªå»¶æ—¶ç­‰çº§ï¼Œæ ¹æ® rocketMQ å»¶æ—¶ç­‰çº§é»˜è®¤å¯¹åº”çš„æ—¶é•¿ï¼Œè¿›è¡Œå»¶æ—¶å‘é€ï¼Œæ¶ˆè´¹è€…ç«¯ä¸æ™®é€šæ¶ˆæ¯æ²¡ä»€ä¹ˆåŒºåˆ«</li></ul></li><li>æ‰¹é‡æ¶ˆæ¯<ul><li>ç”Ÿäº§è€…ç«¯åœ¨å‘ç”Ÿæ¶ˆæ¯æ—¶ï¼Œç´¯ç§¯åˆ°ä¸€å®šæ•°é‡åœ¨æ‰¹é‡å‘é€</li></ul></li><li>è¿‡æ»¤æ¶ˆæ¯<ul><li>åœ¨ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶ï¼Œè®¾ç½®è¿‡æ»¤æ¡ä»¶ï¼Œæ¶ˆè´¹è€…ç«¯æ ¹æ®è¿‡æ»¤æ¡ä»¶é€‰æ‹©é€‚åˆè‡ªå·±çš„æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚</li></ul></li><li>äº‹åŠ¡æ¶ˆæ¯<ul><li>ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ä¼šè¢«å‘é€åˆ°<code>TOPIC</code> ä¸º <code>RMQ_SYS_TRANS_HALF_TOPIC</code> å¯¹åº”çš„é˜Ÿåˆ—ä¸­ï¼Œç„¶åæ‰§è¡Œç”Ÿäº§è€…æœ¬åœ°äº‹åŠ¡ï¼Œå¦‚æœæœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸå¹¶è¿”å›æˆåŠŸï¼Œé‚£ä¹ˆä¼šå°†ç”Ÿäº§è€…ä¹‹å‰å‘é€çš„æ¶ˆæ¯ä»<code>RMQ_SYS_TRANS_HALF_TOPIC</code> å¯¹åº”çš„é˜Ÿåˆ—ä¸­ç§»å‡ºï¼Œå¹¶ç§»å…¥ç”Ÿäº§è€…æŒ‡å®šçš„é˜Ÿåˆ—ã€‚å¦åˆ™ç”Ÿäº§è€…å‘é€çš„é˜Ÿåˆ—ä¼šè¢«å›é€€ã€‚</li><li>å½“ç„¶è¿™åªä¿è¯äº†æœ¬åœ°äº‹åŠ¡å’Œæ¶ˆæ¯å†™å…¥çš„äº‹åŠ¡ä¸€è‡´æ€§ï¼Œå¦‚æœéœ€è¦ç¡®ä¿ä¸‹æ¸¸æ¶ˆè´¹è€…ä¹Ÿè¾¾åˆ°ä¸€è‡´æ€§ï¼Œéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡çš„æ”¯æŒã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šæ·˜å®ä¸‹å•ä½†æ˜¯æœªä»˜æ¬¾ï¼Œå­˜åœ¨15åˆ†é’Ÿçš„ç­‰å¾…æ”¯ä»˜æ—¶é•¿ã€‚ä¸‹å•æ—¶ï¼Œå…ˆç»™brokerè¿”å› unknown ä¿¡å·ï¼Œç­‰å¾…mqå›æŸ¥æ”¯ä»˜çŠ¶æ€ï¼Œåˆ¤æ–­15è¿˜æ²¡æœ‰æ”¯ä»˜ï¼Œå–æ¶ˆè®¢å•ã€‚</li></ul> <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aaf620bee284483e9fe9b6aec7904d0e~tplv-k3u1fbpfcp-watermark.image" alt="image.png"><h3 id="RocketMQå’Œspring-bootçš„æ•´åˆ"><a href="#RocketMQå’Œspring-bootçš„æ•´åˆ" class="headerlink" title="RocketMQå’Œspring_bootçš„æ•´åˆ"></a>RocketMQå’Œspring_bootçš„æ•´åˆ</h3>ç¤ºä¾‹ä»£ç å·²ä¸Šä¼ è‡³ <a href="https://github.com/zhouxh-z/spring-boot-rocketmq">GITHUB</a><h4 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h4><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>rocketmq-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h4 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h4><pre class=" language-propertries"><code class="language-propertries">rocketmq.name-server=172.12.11.10:9876rocketmq.producer.group=topic_test-consumerGroup</code></pre><h4 id="ç”Ÿäº§è€…"><a href="#ç”Ÿäº§è€…" class="headerlink" title="ç”Ÿäº§è€…"></a>ç”Ÿäº§è€…</h4></li></ol><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerControl</span> <span class="token punctuation">{</span>    Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>ProducerControl<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Resource</span>    RocketMQTemplate rocketMQTemplate<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * convertAndSend()     *  springbootå¯¹rocketmq API çš„å°è£…     *  æ–¹æ³•å‚æ•°     *      destinationï¼štopic:tag çš„æ‹¼å‡‘ï¼Œåº•å±‚ä¼šæ ¹æ® ":" æ¥åˆ†å‰²     *      payloadï¼šè·è½½ ï¼Œå®é™…å‘é€çš„å†…å®¹     */</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/sendMSG"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> String <span class="token function">sendMSG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ™®é€šæ¶ˆæ¯</span>        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"topic_test:tagXXX"</span><span class="token punctuation">,</span><span class="token string">"hello-world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"æ™®é€šæ¶ˆæ¯å‘é€æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// é¡ºåºæ¶ˆæ¯</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            SendResult sendResult <span class="token operator">=</span> rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSendOrderly</span><span class="token punctuation">(</span><span class="token string">"topic_test"</span><span class="token punctuation">,</span> <span class="token string">"order_message_"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"é¡ºåºæ¶ˆæ¯:{},å‘é€çŠ¶æ€:{}"</span><span class="token punctuation">,</span>sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/**         * å¹¿æ’­æ¶ˆæ¯: å’Œç”Ÿäº§è€…å’Œæ™®é€šå‘æ¶ˆæ¯ä¸€è‡´ï¼Œæ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ—¶ï¼ŒmessageModeléœ€è¦è®¾ç½®ä¸º BROADCASTING å¹¿æ’­æ¨¡å¼         */</span>        <span class="token comment" spellcheck="true">// å»¶è¿Ÿæ¶ˆæ¯--æ¶ˆæ¯å‘é€æ—¶è®¾ç½®å»¶æ—¶ç­‰çº§ delayLevel</span>        <span class="token comment" spellcheck="true">// syncSend(String destination, Message&lt;?> message, long timeout, int delayLevel)</span>        Message delayedMessage <span class="token operator">=</span> MessageBuilder<span class="token punctuation">.</span><span class="token function">createMessage</span><span class="token punctuation">(</span><span class="token string">"delayed_message"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageHeaders</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token string">"topic_test"</span><span class="token punctuation">,</span>delayedMessage<span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"å»¶æ—¶æ¶ˆæ¯å‘é€æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ‰¹é‡æ¶ˆæ¯ï¼šå°†å¤šä¸ªæ¶ˆæ¯åˆå¹¶æˆä¸€ä¸ªæ‰¹é‡æ¶ˆæ¯ï¼Œä¸€æ¬¡å‘é€</span>        List<span class="token operator">&lt;</span>Message<span class="token operator">></span> messageList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Message<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            messageList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>MessageBuilder<span class="token punctuation">.</span><span class="token function">createMessage</span><span class="token punctuation">(</span><span class="token string">"batch_message_"</span><span class="token operator">+</span>i<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageHeaders</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token string">"topic_test"</span><span class="token punctuation">,</span>messageList<span class="token punctuation">)</span><span class="token punctuation">;</span>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"æ‰¹é‡æ¶ˆæ¯å‘é€æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è¿‡æ»¤æ¶ˆæ¯ï¼šä¸»è¦æ˜¯æ¶ˆè´¹è€…ç«¯è¿‡æ»¤ï¼Œè®¾ç½®tag æˆ–è€… sql92 æ¨¡å¼</span>        Message<span class="token operator">&lt;</span>String<span class="token operator">></span> tag_message <span class="token operator">=</span> MessageBuilder<span class="token punctuation">.</span><span class="token function">createMessage</span><span class="token punctuation">(</span><span class="token string">"tag_message"</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">MessageHeaders</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token string">"topic_test:tag_A"</span><span class="token punctuation">,</span>tag_message<span class="token punctuation">)</span><span class="token punctuation">;</span>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"è¿‡æ»¤æ¶ˆæ¯å‘é€æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// äº‹åŠ¡æ¶ˆæ¯</span>        Message message <span class="token operator">=</span> MessageBuilder<span class="token punctuation">.</span><span class="token function">createMessage</span><span class="token punctuation">(</span><span class="token string">"transaction_message"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageHeaders</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span><span class="token string">"topic_test"</span><span class="token punctuation">,</span>message<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"äº‹åŠ¡æ¶ˆæ¯å‘é€æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">getProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"å‘é€æˆåŠŸ"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h5 id="ç”Ÿäº§è€…-äº‹åŠ¡æ¶ˆæ¯ç›‘å¬å™¨-éœ€è¦äº‹åŠ¡æ¶ˆæ¯ï¼Œæ‰éœ€è¦è¿™ä¸ªç±»"><a href="#ç”Ÿäº§è€…-äº‹åŠ¡æ¶ˆæ¯ç›‘å¬å™¨-éœ€è¦äº‹åŠ¡æ¶ˆæ¯ï¼Œæ‰éœ€è¦è¿™ä¸ªç±»" class="headerlink" title="ç”Ÿäº§è€… - äº‹åŠ¡æ¶ˆæ¯ç›‘å¬å™¨(éœ€è¦äº‹åŠ¡æ¶ˆæ¯ï¼Œæ‰éœ€è¦è¿™ä¸ªç±»)"></a>ç”Ÿäº§è€… - äº‹åŠ¡æ¶ˆæ¯ç›‘å¬å™¨(éœ€è¦äº‹åŠ¡æ¶ˆæ¯ï¼Œæ‰éœ€è¦è¿™ä¸ªç±»)</h5><p>executeLocalTransactionï¼š æœ¬åœ°äº‹åŠ¡æ–¹æ³•ï¼Œå¦‚æœæœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œåˆ™è¿”å›successï¼Œé‚£ä¹ˆä¸ä¼šå†è°ƒç”¨å›æŸ¥æ–¹æ³•ï¼ˆcheckLocalTransactionï¼‰ï¼›</p><p>checkLocalTransactionï¼šå¦‚æœæœ¬åœ°äº‹åŠ¡æ–¹æ³•å¤±è´¥ï¼ŒrocketMQä¼šæ‰§è¡Œè¯¥æ–¹æ³•ï¼Œå›æŸ¥æœ¬åœ°äº‹åŠ¡æ˜¯å¦æˆåŠŸã€‚å¦‚æœæˆåŠŸï¼Œæ­£å¸¸å†™å…¥æ¶ˆæ¯åˆ°å¯¹åº”çš„topicä¸­ã€‚</p><pre class=" language-JAVA"><code class="language-JAVA">@RocketMQTransactionListener()public class MyTransactionListener implements RocketMQLocalTransactionListener {    Logger logger = LoggerFactory.getLogger(MyTransactionListener.class);    @Override    public RocketMQLocalTransactionState executeLocalTransaction(Message message, Object o) {        logger.info("executeLocalTransaction:"+message);        // å¦‚æœæœ¬åœ°ä¸šåŠ¡å¤„ç†æˆåŠŸä¸”è¿”å›æˆåŠŸï¼Œåˆ™ä¸ä¼šåœ¨æ‰§è¡Œå›æŸ¥æ–¹æ³• checkLocalTransaction        return RocketMQLocalTransactionState.UNKNOWN;    }    @Override    public RocketMQLocalTransactionState checkLocalTransaction(Message message) {        logger.info("checkLocalTransaction:"+message);        return RocketMQLocalTransactionState.COMMIT;    }}</code></pre><h4 id="æ¶ˆè´¹è€…"><a href="#æ¶ˆè´¹è€…" class="headerlink" title="æ¶ˆè´¹è€…"></a>æ¶ˆè´¹è€…</h4><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>consumerGroup <span class="token operator">=</span> <span class="token string">"topic_test-consumerGroup"</span><span class="token punctuation">,</span> topic <span class="token operator">=</span> <span class="token string">"topic_test"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token punctuation">{</span>    Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>Consumer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"æ¶ˆè´¹æ¶ˆæ¯:"</span><span class="token operator">+</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="æ¶ˆæ¯æŒä¹…åŒ–"><a href="#æ¶ˆæ¯æŒä¹…åŒ–" class="headerlink" title="æ¶ˆæ¯æŒä¹…åŒ–"></a>æ¶ˆæ¯æŒä¹…åŒ–</h3><p>ç”±äºæ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯é æ€§è¦æ±‚ï¼ŒrocketMQçš„æ•°æ®å¿…é¡»è¿›è¡ŒæŒä¹…åŒ–<br>ä¸‹å›¾æ˜¯rocketMQæºç ä¸­æä¾›çš„æ¶ˆæ¯å­˜å‚¨æ¶æ„å›¾<br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/298ab0d578fd44a6b0951baf80f96f77~tplv-k3u1fbpfcp-watermark.image" alt="image.png"><br>æ¶ˆæ¯å­˜å‚¨æ¶æ„å›¾ä¸­ä¸»è¦æœ‰ä¸‹é¢ä¸‰ä¸ªè·Ÿæ¶ˆæ¯å­˜å‚¨ç›¸å…³çš„æ–‡ä»¶æ„æˆã€‚</p><ol><li><p><strong>CommitLog</strong>ï¼šæ¶ˆæ¯ä¸»ä½“ä»¥åŠå…ƒæ•°æ®çš„å­˜å‚¨ä¸»ä½“ï¼Œå­˜å‚¨Producerç«¯å†™å…¥çš„æ¶ˆæ¯ä¸»ä½“å†…å®¹ã€‚é‡‡ç”¨é¡ºåºå†™çš„æ–¹å¼ï¼Œé¢„å…ˆåœ¨ç£ç›˜ä¸­åˆ’å®šä¸€å—å­˜å‚¨ï¼ˆå¤§å°ä¸º1Gï¼‰ï¼Œç„¶åProducerç«¯å†™å…¥æ¶ˆæ¯æ—¶ï¼ŒæŒ‰åºè¿½åŠ åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œç›´åˆ°è¯¥æ–‡ä»¶å­˜å‚¨æ»¡ã€‚å†åˆ’å®šæ–°å­˜å‚¨åŒºåŸŸï¼ˆå¤§å°ä¸º1Gï¼‰ï¼›</p></li><li><p><strong>ConsumeQueue</strong>ï¼šæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œå¼•å…¥çš„ç›®çš„ä¸»è¦æ˜¯æé«˜æ¶ˆæ¯æ¶ˆè´¹çš„æ€§èƒ½ï¼Œç”±äºRocketMQæ˜¯åŸºäºä¸»é¢˜topicçš„è®¢é˜…æ¨¡å¼ï¼Œæ¶ˆæ¯æ¶ˆè´¹æ˜¯é’ˆå¯¹ä¸»é¢˜è¿›è¡Œçš„ï¼Œå¦‚æœè¦éå†commitlogæ–‡ä»¶ä¸­æ ¹æ®topicæ£€ç´¢æ¶ˆæ¯æ˜¯éå¸¸ä½æ•ˆçš„ã€‚Consumerå³å¯æ ¹æ®ConsumeQueueæ¥æŸ¥æ‰¾å¾…æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚å…¶ä¸­ï¼ŒConsumeQueueï¼ˆé€»è¾‘æ¶ˆè´¹é˜Ÿåˆ—ï¼‰ä½œä¸ºæ¶ˆè´¹æ¶ˆæ¯çš„ç´¢å¼•ï¼Œä¿å­˜äº†æŒ‡å®šTopicä¸‹çš„é˜Ÿåˆ—æ¶ˆæ¯åœ¨CommitLogä¸­çš„èµ·å§‹ç‰©ç†åç§»é‡offsetï¼Œæ¶ˆæ¯å¤§å°sizeå’Œæ¶ˆæ¯Tagçš„HashCodeå€¼ã€‚ï¼›</p></li><li><p><strong>IndexFile</strong>ï¼šIndexFileï¼ˆç´¢å¼•æ–‡ä»¶ï¼‰æä¾›äº†ä¸€ç§å¯ä»¥é€šè¿‡keyæˆ–æ—¶é—´åŒºé—´æ¥æŸ¥è¯¢æ¶ˆæ¯çš„æ–¹æ³•ã€‚æ–‡ä»¶åfileNameæ˜¯ä»¥åˆ›å»ºæ—¶çš„æ—¶é—´æˆ³å‘½åçš„ï¼Œå›ºå®šçš„å•ä¸ªIndexFileæ–‡ä»¶å¤§å°çº¦ä¸º400Mï¼Œä¸€ä¸ªIndexFileå¯ä»¥ä¿å­˜ 2000Wä¸ªç´¢å¼•ï¼ŒIndexFileçš„åº•å±‚å­˜å‚¨è®¾è®¡ä¸ºåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­å®ç°HashMapç»“æ„ï¼Œæ•…rocketmqçš„ç´¢å¼•æ–‡ä»¶å…¶åº•å±‚å®ç°ä¸ºhashç´¢å¼•ã€‚</p></li></ol><p>æ ¹ç»ä¸Šé¢æ¶æ„æˆ‘ä»¬å¯ä»¥çŸ¥é“ä»¥ä¸‹å‡ ä¸ªç»“è®º</p><ul><li>consumerQueueå’ŒIndexFileæ–‡ä»¶ä¸­ä¿å­˜éƒ½æ˜¯æ¶ˆæ¯å†commitLogä¸­çš„ç´¢å¼•ï¼Œã€ç´¢å¼•å’Œæ•°æ®åˆ†ç¦»ã€‘</li><li>æ¶ˆæ¯ä»commitlog  â†’  consumerQueueå’ŒIndexFileï¼Œå¿…ç„¶å­˜åœ¨ä¸€ä¸ªåå°è¿›ç¨‹ä¸åœåœ°åˆ†å‘è¯·æ±‚å¹¶å¼‚æ­¥æ„å»ºConsumeQueueï¼ˆé€»è¾‘æ¶ˆè´¹é˜Ÿåˆ—ï¼‰å’ŒIndexFileï¼ˆç´¢å¼•æ–‡ä»¶ï¼‰æ•°æ®</li><li>åŸºäºç£ç›˜æ–‡ä»¶çš„æ“ä½œè¿˜èƒ½æ‹¥æœ‰å¦‚æ­¤é«˜çš„ååé‡ï¼ŒrocketMQ å¯¹æ–‡ä»¶çš„è¯»å†™åšå‡ºäº†å¤§é‡ä¼˜åŒ–<ul><li>åˆ©ç”¨äº†NIOä¸­çš„FileChannelæ¨¡å‹å°†ç£ç›˜ä¸Šçš„ç‰©ç†æ–‡ä»¶ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·æ€çš„å†…å­˜åœ°å€ï¼ˆ<strong>MMAP</strong>ï¼‰ï¼Œå‡å°‘äº†æ–‡ä»¶ä»ç”¨æˆ·æ€å¤åˆ¶åˆ°åº”ç”¨å†…å­˜çš„æ€§èƒ½å¼€é”€ã€‚å°†å¯¹æ–‡ä»¶çš„æ“ä½œè½¬åŒ–ä¸ºç›´æ¥å¯¹å†…å­˜åœ°å€è¿›è¡Œæ“ä½œã€‚</li><li>**é¡µç¼“å­˜ï¼ˆPageCache)**ï¼šéƒ¨åˆ†ç‰¹æ®Šçš„å†…å­˜ç©ºé—´ï¼Œå†æ–‡ä»¶å†™å…¥æ—¶ï¼Œå…ˆå†™äººpageCacheï¼Œç„¶åç”±æ“ä½œç³»ç»Ÿçš„å†…æ ¸çº¿ç¨‹å†™å…¥ç£ç›˜ã€‚<h4 id="ä½•æ—¶æŒä¹…åŒ–"><a href="#ä½•æ—¶æŒä¹…åŒ–" class="headerlink" title="ä½•æ—¶æŒä¹…åŒ–"></a>ä½•æ—¶æŒä¹…åŒ–</h4></li></ul></li></ul><ol><li>MQåœ¨æ¥æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œéœ€è¦å°†æ¶ˆæ¯æŒä¹…åŒ–ï¼Œå¦åˆ™å‡ºç°MQå®•æœºçš„æƒ…å†µï¼Œè¿™æ¡æ¶ˆæ¯ä¹Ÿå°±ä¸¢å¤±äº†</li><li>æ¶ˆè´¹è€…æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯ï¼Œéœ€è¦ç»™è¿™æ¡æ¶ˆæ¯æ ‡è®°ä¸€ä¸ªæ¶ˆè´¹çŠ¶æ€å¹¶æŒä¹…åŒ–ï¼Œå¦åˆ™å½“MQé‡å¯ï¼Œæ ‡è®°ä¸¢å¤±ï¼Œè¿™ä¸ªæ¶ˆæ¯ä¼šè¢«é‡å¤æ¶ˆè´¹ã€‚<h4 id="æŒä¹…åŒ–åˆ°å“ªå„¿"><a href="#æŒä¹…åŒ–åˆ°å“ªå„¿" class="headerlink" title="æŒä¹…åŒ–åˆ°å“ªå„¿"></a>æŒä¹…åŒ–åˆ°å“ªå„¿</h4>rocketMQ æŒä¹…åŒ–çš„æ–‡ä»¶ä¿å­˜è·¯å¾„éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®š<br>é…ç½®æ–‡ä»¶åœ°å€ï¼š/rocketmq-all-4.3.2-bin-release/conf/<br>æ ¹æ®rocketMQçš„å¯åŠ¨æ–¹å¼ï¼Œé€‰æ‹©å¼‚æ­¥æˆ–è€…åŒæ­¥é…ç½®æ–‡ä»¶<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#å­˜å‚¨è·¯å¾„</span><span class="token attr-name">storePathRootDir</span><span class="token punctuation">=</span><span class="token attr-value">/opt/store</span><span class="token comment" spellcheck="true">#commitLog å­˜å‚¨è·¯å¾„</span><span class="token attr-name">storePathCommitLog</span><span class="token punctuation">=</span><span class="token attr-value">/opt/store/commitlog</span><span class="token comment" spellcheck="true">#æ¶ˆè´¹é˜Ÿåˆ—å­˜å‚¨è·¯å¾„å­˜å‚¨è·¯å¾„</span><span class="token attr-name">storePathConsumeQueue</span><span class="token punctuation">=</span><span class="token attr-value">/opt/store/consumequeue</span><span class="token comment" spellcheck="true">#æ¶ˆæ¯ç´¢å¼•å­˜å‚¨è·¯å¾„</span><span class="token attr-name">storePathIndex</span><span class="token punctuation">=</span><span class="token attr-value">/opt/store/index</span><span class="token comment" spellcheck="true">#checkpoint æ–‡ä»¶å­˜å‚¨è·¯å¾„</span><span class="token attr-name">storeCheckpoint</span><span class="token punctuation">=</span><span class="token attr-value">/opt/store/checkpoint</span><span class="token comment" spellcheck="true">#abort æ–‡ä»¶å­˜å‚¨è·¯å¾„</span><span class="token attr-name">abortFile</span><span class="token punctuation">=</span><span class="token attr-value">/opt/store/abort</span></code></pre><h4 id="åˆ·ç›˜æœºåˆ¶"><a href="#åˆ·ç›˜æœºåˆ¶" class="headerlink" title="åˆ·ç›˜æœºåˆ¶"></a>åˆ·ç›˜æœºåˆ¶</h4></li></ol><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d42e460c861249ab818379cc1fb4cef8~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒrocketMQæ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå¯ä»¥åˆ†ä¸ºåŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜ï¼›</p><ul><li>åŒæ­¥åˆ·ç›˜ï¼šæ¯æ¬¡æ¶ˆæ¯å‘é€åˆ°brokerï¼Œåªæœ‰å†æ¶ˆæ¯çœŸæ­£å†™å…¥ç£ç›˜ï¼Œå¹¶è¿”å›æˆåŠŸACKå“åº”ï¼Œç”Ÿäº§è€…ç«¯æ‰è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ¶ˆæ¯å¯é æ€§å¼ºï¼Œååé‡ä½</li><li>å¼‚æ­¥åˆ·ç›˜ï¼šæ¯æ¬¡æ¶ˆæ¯å‘é€åˆ°brokerï¼Œåªè¦æ¶ˆæ¯è¢«å†™å…¥pageCacheå°±ä¼šè¿”å›ä¸€ä¸ªæˆåŠŸACKå“åº”ã€‚æ¶ˆæ¯å¯èƒ½å­˜åœ¨ä¸¢å¤±æƒ…å†µï¼Œä½†æ˜¯ååé‡é«˜ã€‚<h3 id="æ¶ˆæ¯ä¸»ä»åŒæ­¥"><a href="#æ¶ˆæ¯ä¸»ä»åŒæ­¥" class="headerlink" title="æ¶ˆæ¯ä¸»ä»åŒæ­¥"></a>æ¶ˆæ¯ä¸»ä»åŒæ­¥</h3>å¦‚æœbrokeræ˜¯ä»¥é›†ç¾¤çš„æ–¹å¼éƒ¨ç½²ï¼Œé‚£ä¹ˆå¿…ç„¶å­˜åœ¨ä¸€ä¸»å¤šä»ä¹‹å‰çš„æ•°æ®åŒæ­¥ã€masterå¤åˆ¶åˆ°slaveã€‘ï¼Œæ¶ˆæ¯å¤åˆ¶çš„æ–¹å¼åˆ†ä¸ºåŒæ­¥å¤åˆ¶ã€å¼‚æ­¥å¤åˆ¶</li><li>åŒæ­¥å¤åˆ¶ï¼šç­‰masterèŠ‚ç‚¹å’ŒslaveèŠ‚ç‚¹éƒ½å†™å…¥æˆåŠŸï¼Œæ‰ç»™ç”Ÿäº§è€…è¿”å›å†™å…¥æˆåŠŸçš„çŠ¶æ€ã€‚æ•°æ®å®‰å…¨æ€§é«˜ï¼Œååé‡ä½</li><li>å¼‚æ­¥å¤åˆ¶ï¼šåªè¦masterèŠ‚ç‚¹å†™å…¥æˆåŠŸï¼Œå°±ç»™ç”Ÿäº§è€…è¿”å›å†™å…¥æˆåŠŸçš„çŠ¶æ€ï¼Œç„¶åå¼‚æ­¥ä»master å¤åˆ¶åˆ° slaveã€‚ååé‡é«˜ï¼Œå­˜åœ¨æ•°æ®ä¸¢å¤±çš„æƒ…å†µã€‚</li><li>å¦‚ä½•é…ç½®ï¼šconfç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œé…ç½® brokerRole å‚æ•°ï¼Œå‚æ•°ç±»å‹ï¼šASYNC_MASTERã€å¼‚æ­¥ã€‘ã€ SYNC_MASTERã€åŒæ­¥ã€‘ã€SLAVEã€ä»èŠ‚ç‚¹æ¥å—å¤åˆ¶ã€‘<h3 id="è´Ÿè½½å‡è¡¡æœºåˆ¶"><a href="#è´Ÿè½½å‡è¡¡æœºåˆ¶" class="headerlink" title="è´Ÿè½½å‡è¡¡æœºåˆ¶"></a>è´Ÿè½½å‡è¡¡æœºåˆ¶</h3>rocketMQ è´Ÿè½½å‡è¡¡åˆ†ä¸ºï¼š<strong>Producerç«¯å‘é€æ¶ˆæ¯æ—¶å€™çš„è´Ÿè½½å‡è¡¡</strong>ã€<strong>Consumerç«¯è®¢é˜…æ¶ˆæ¯çš„è´Ÿè½½å‡è¡¡</strong></li><li><strong>Producerç«¯å‘é€æ¶ˆæ¯è´Ÿè½½å‡è¡¡</strong>ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œé‡‡ç”¨çš„<strong>éšæœºé€’å¢å–æ¨¡</strong>çš„æ–¹å¼ï¼Œå°±æ˜¯ç¬¬ä¸€æ¬¡ç»™æŸä¸ªtopicå‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šéšæœºè·å–ä¸€ä¸ªéšæœºæ•°ï¼Œå¯¹consumerQueueçš„æ€»æ•°å–æ¨¡ã€‚ç„¶åæ ¹æ®æ¨¡æ•°ä»consumerQueueçš„åˆ—è¡¨ä¸­è·å–ã€‚æ­¤åå†å¾€è¯¥topicå‘é€æ¶ˆæ¯ï¼Œå°±å†åŸæœ‰çš„éšæœºæ•°ä¸Šé€’å¢ç„¶åå†å–æ¨¡ã€‚<br>rocketMQè¿˜æä¾›ä¸€ä¸ª<code>sendLatencyFaultEnable</code>å‚æ•°ï¼Œåœ¨åŸæœ‰çš„é€’å¢å–æ¨¡çš„åŸºç¡€ä¸Šï¼Œè¿‡æ»¤æ‰ä¸Šæ¬¡å¤±è´¥çš„brokerã€åœ¨ä¸€å®šæ—¶é—´å†…ä¸‹ã€‘ï¼Œæºç ä½ç½®ï¼šMQFaultStrategy.selectOneMessageQueue()<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> MessageQueue <span class="token function">selectOneMessageQueue</span><span class="token punctuation">(</span><span class="token keyword">final</span> TopicPublishInfo tpInfo<span class="token punctuation">,</span> <span class="token keyword">final</span> String lastBrokerName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å¼€å¯ sendLatencyFaultEnable é…ç½®</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sendLatencyFaultEnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> index <span class="token operator">=</span> tpInfo<span class="token punctuation">.</span><span class="token function">getSendWhichQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tpInfo<span class="token punctuation">.</span><span class="token function">getMessageQueueList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">int</span> pos <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">%</span> tpInfo<span class="token punctuation">.</span><span class="token function">getMessageQueueList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                    pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                MessageQueue mq <span class="token operator">=</span> tpInfo<span class="token punctuation">.</span><span class="token function">getMessageQueueList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦æ˜¯ä¹‹å‰å­˜åœ¨å¤±è´¥çš„brokerï¼Œå¦‚æœæ˜¯ï¼Œç»§ç»­å¾ªç¯é€‰æ‹©ä¸‹ä¸€ä¸ªbroker</span>                <span class="token comment" spellcheck="true">// latencyFaultTolerance è¯¥å¯¹è±¡çš„æ›´æ–°æ“ä½œåœ¨å‘é€å®Œæˆæ—¶æ›´æ–°ï¼Œå‰ææ˜¯æ‰“å¼€äº†sendLatencyFaultEnableé…ç½®</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>latencyFaultTolerance<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token keyword">return</span> mq<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">final</span> String notBestBroker <span class="token operator">=</span> latencyFaultTolerance<span class="token punctuation">.</span><span class="token function">pickOneAtLeast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> writeQueueNums <span class="token operator">=</span> tpInfo<span class="token punctuation">.</span><span class="token function">getQueueIdByBroker</span><span class="token punctuation">(</span>notBestBroker<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>writeQueueNums <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">final</span> MessageQueue mq <span class="token operator">=</span> tpInfo<span class="token punctuation">.</span><span class="token function">selectOneMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>notBestBroker <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    mq<span class="token punctuation">.</span><span class="token function">setBrokerName</span><span class="token punctuation">(</span>notBestBroker<span class="token punctuation">)</span><span class="token punctuation">;</span>                    mq<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span>tpInfo<span class="token punctuation">.</span><span class="token function">getSendWhichQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> writeQueueNums<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">return</span> mq<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                latencyFaultTolerance<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>notBestBroker<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error occurred when selecting message queue"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æœªå¼€å¯sendLatencyFaultEnableçš„æƒ…å†µä¸‹ï¼Œéšå³é€’å¢å–æ¨¡</span>        <span class="token keyword">return</span> tpInfo<span class="token punctuation">.</span><span class="token function">selectOneMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre></li><li><strong>Consumerç«¯è®¢é˜…æ¶ˆæ¯è´Ÿè½½å‡è¡¡</strong>ï¼šæ ¹æ®æ¶ˆè´¹æ¨¡å¼åˆ†ä¸ºå¹¿æ’­æ¨¡å¼ å’Œ é›†ç¾¤æ¨¡å¼<ul><li>å¹¿æ’­æ¨¡å¼ä¸‹ï¼šé¦–å…ˆæ ¹æ®topicè·å–æ‰€æœ‰çš„messageQueueï¼Œç„¶åéå†æ‰€æœ‰messageQueueï¼Œå¹¶æ‹‰å–æ¶ˆæ¯</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">rebalanceByTopic</span><span class="token punctuation">(</span><span class="token keyword">final</span> String topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>messageModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> BROADCASTING<span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// è·å–topicå¯¹åº”çš„messageQueue</span>            Set<span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span> mqSet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicSubscribeInfoTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mqSet <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// éå†æ‰€æœ‰messageQueueï¼ŒæŒ¨ä¸ªæ‹‰å–æ¶ˆæ¯</span>                <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateProcessQueueTableInRebalance</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> mqSet<span class="token punctuation">,</span> isOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">messageQueueChanged</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> mqSet<span class="token punctuation">,</span> mqSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"messageQueueChanged {} {} {} {}"</span><span class="token punctuation">,</span>                        consumerGroup<span class="token punctuation">,</span>                        topic<span class="token punctuation">,</span>                        mqSet<span class="token punctuation">,</span>                        mqSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"doRebalance, {}, but the topic[{}] not exist."</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/**         * çœç•¥é›†ç¾¤æ¨¡å¼ éƒ¨åˆ†ä»£ç          */</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">updateProcessQueueTableInRebalance</span><span class="token punctuation">(</span><span class="token keyword">final</span> String topic<span class="token punctuation">,</span> <span class="token keyword">final</span> Set<span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span> mqSet<span class="token punctuation">,</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> isOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    Iterator<span class="token operator">&lt;</span>Entry<span class="token operator">&lt;</span>MessageQueue<span class="token punctuation">,</span> ProcessQueue<span class="token operator">>></span> it <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processQueueTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡è¿›å…¥è¿™é‡Œå¿…ä¸º ç©ºï¼Œæ‰€ä»¥çœç•¥</span>    <span class="token punctuation">}</span>    List<span class="token operator">&lt;</span>PullRequest<span class="token operator">></span> pullRequestList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>PullRequest<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>MessageQueue mq <span class="token operator">:</span> mqSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>processQueueTable<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isOrder <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"doRebalance, {}, add a new mq failed, {}, because lock failed"</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> mq<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// ç§»é™¤åç§»é‡</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeDirtyOffset</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">;</span>            ProcessQueue pq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æ ¹æ® é…ç½® æŸ¥çœ‹ ä»å“ªå„¿å¼€å§‹æ¶ˆè´¹ï¼Œä»ç¬¬ä¸€ä¸ªã€æœ€åä¸€ä¸ªã€æŸä¸€æ—¶é—´æ—¶é—´æˆ³ å¼€å§‹æ¶ˆè´¹</span>            <span class="token keyword">long</span> nextOffset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">computePullFromWhere</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextOffset <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                ProcessQueue pre <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processQueueTable<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span> pq<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pre <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"doRebalance, {}, mq already exists, {}"</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> mq<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"doRebalance, {}, add a new mq, {}"</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> mq<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// æ„å»ºæ‹‰å–è¯·æ±‚</span>                    PullRequest pullRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PullRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    pullRequest<span class="token punctuation">.</span><span class="token function">setConsumerGroup</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>                    pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>nextOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>                    pullRequest<span class="token punctuation">.</span><span class="token function">setMessageQueue</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">;</span>                    pullRequest<span class="token punctuation">.</span><span class="token function">setProcessQueue</span><span class="token punctuation">(</span>pq<span class="token punctuation">)</span><span class="token punctuation">;</span>                    pullRequestList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>                    changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"doRebalance, {}, add new mq failed, {}"</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> mq<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è¿›è¡Œæ‹‰å–æ¶ˆæ¯</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchPullRequest</span><span class="token punctuation">(</span>pullRequestList<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> changed<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li>é›†ç¾¤æ¨¡å¼ï¼šæ ¹æ®é…ç½®çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ä»¥åŠå½“å‰æ¶ˆè´¹è€…çš„ClientIdï¼Œè¿›è¡Œç»™æ¯ä¸ªæ¶ˆè´¹è€…åˆ†é…messageQueue<pre class=" language-java"><code class="language-java"><span class="token keyword">case</span> CLUSTERING<span class="token operator">:</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// è·å–topicçš„æ‰€æœ‰é˜Ÿåˆ—</span>     Set<span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span> mqSet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicSubscribeInfoTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// è·å–æ‰€æœ‰æ¶ˆè´¹è€…</span>     List<span class="token operator">&lt;</span>String<span class="token operator">></span> cidAll <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">findConsumerIdList</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> consumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>mqSet <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cidAll <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>         List<span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span> mqAll <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         mqAll<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>mqSet<span class="token punctuation">)</span><span class="token punctuation">;</span>         Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>mqAll<span class="token punctuation">)</span><span class="token punctuation">;</span>         Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>         AllocateMessageQueueStrategy strategy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMessageQueueStrategy<span class="token punctuation">;</span>         List<span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span> allocateResult <span class="token operator">=</span> null<span class="token punctuation">;</span>         <span class="token keyword">try</span> <span class="token punctuation">{</span>             <span class="token comment" spellcheck="true">// æ ¹æ®å½“å‰æ¶ˆè´¹è€…çš„ClientIdå’Œè§„åˆ™ï¼Œè¿›è¡Œåˆ†é…messageQueue</span>             allocateResult <span class="token operator">=</span> strategy<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>                 <span class="token keyword">this</span><span class="token punctuation">.</span>consumerGroup<span class="token punctuation">,</span>                 <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                 mqAll<span class="token punctuation">,</span>                 cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token punctuation">}</span>         Set<span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span> allocateResultSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>allocateResult <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>             allocateResultSet<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>allocateResult<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateProcessQueueTableInRebalance</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> allocateResultSet<span class="token punctuation">,</span> isOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token punctuation">}</span>     <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></li></ul>   <strong>é›†ç¾¤è´Ÿè½½å‡è¡¡ç­–ç•¥</strong>ï¼š<ul><li>AllocateMachineRoomNearbyï¼šå°†åŒæœºæˆ¿çš„Consumerå’ŒBrokerä¼˜å…ˆåˆ†é…åœ¨ä¸€èµ·ã€‚</li><li>AllocateMessageQueueAveragelyï¼šå¹³å‡åˆ†é…ã€‚å°†æ‰€æœ‰MessageQueueå¹³å‡åˆ†ç»™æ¯ä¸€ä¸ªæ¶ˆè´¹è€…</li><li>AllocateMessageQueueAveragelyByCircleï¼šè½®è¯¢åˆ†é…ã€‚è½®æµçš„ç»™ä¸€ä¸ªæ¶ˆè´¹è€…åˆ†é…ä¸€ä¸ªMessageQueue</li><li>AllocateMessageQueueByConfigï¼šä¸åˆ†é…ï¼Œç›´æ¥æŒ‡å®šä¸€ä¸ªmessageQueueåˆ—è¡¨</li><li>AllocateMessageQueueByMachineRoomï¼šæŒ‰é€»è¾‘æœºæˆ¿çš„æ¦‚å¿µè¿›è¡Œåˆ†é…</li><li>AllocateMessageQueueConsistentHashï¼šæ ¹ç»ä¸€è‡´æ€§hashç®—æ³•æ¥åˆ†é…MessageQueue<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c8e6623cfa54f4190247e39ffad5e49~tplv-k3u1fbpfcp-watermark.image" alt="image.png"><h3 id="æ¶ˆæ¯çš„é‡æŠ•-é‡è¯•æœºåˆ¶"><a href="#æ¶ˆæ¯çš„é‡æŠ•-é‡è¯•æœºåˆ¶" class="headerlink" title="æ¶ˆæ¯çš„é‡æŠ•/é‡è¯•æœºåˆ¶"></a>æ¶ˆæ¯çš„é‡æŠ•/é‡è¯•æœºåˆ¶</h3><h4 id="ç”Ÿäº§è€…-æ¶ˆæ¯é‡æŠ•"><a href="#ç”Ÿäº§è€…-æ¶ˆæ¯é‡æŠ•" class="headerlink" title="ç”Ÿäº§è€…-æ¶ˆæ¯é‡æŠ•"></a>ç”Ÿäº§è€…-æ¶ˆæ¯é‡æŠ•</h4>ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œå‡ºç°å¼‚å¸¸å¯¼è‡´æ¶ˆæ¯æ²¡æœ‰æ­£å¸¸å‘é€åˆ°brokerï¼ŒåŒæ­¥æ¶ˆæ¯å­˜åœ¨é‡æŠ•æœºåˆ¶ã€å¼‚æ­¥æ¶ˆæ¯å­˜åœ¨é‡è¯•æœºåˆ¶ã€å•å‘æ¶ˆæ¯æ²¡æœ‰æ¶ˆæ¯å®‰å…¨ä¿éšœã€‚</li></ul></li><li>retryTimesWhenSendFailedï¼šåŒæ­¥æ¶ˆæ¯å‘é€å¤±è´¥é‡æŠ•æ¬¡æ•°ï¼Œé»˜è®¤2æ¬¡ï¼Œç”Ÿäº§è€…ä¼šé‡æ–°æŠ•é€’æ¶ˆæ¯ retryTimesWhenSendFailed+1æ¬¡ï¼Œä¸”ä¸ä¼šé€‰æ‹©ä¸Šæ¬¡å¤±è´¥çš„brokerã€‚</li><li>retryTimesWhenSendAsyncFailedï¼šå¼‚æ­¥æ¶ˆæ¯å¤±è´¥é‡è¯•æ¬¡æ•°ï¼Œå¼‚æ­¥é‡è¯•ä¸ä¼šé€‰æ‹©åˆ«çš„brokerï¼Œä»…åœ¨åŒä¸€å°brokerå°è¯•é‡è¯•ã€‚</li><li>retryAnotherBrokerWhenNotStoreOKï¼šæ¶ˆæ¯æŒä¹…åŒ–è¶…æ—¶æˆ–è€…slaveåŒæ­¥å¤±è´¥ï¼Œæ˜¯å¦å°è¯•æŠ•é€’å…¶ä»–brokerã€‚é»˜è®¤false<h4 id="æ¶ˆè´¹è€…-æ¶ˆæ¯é‡è¯•"><a href="#æ¶ˆè´¹è€…-æ¶ˆæ¯é‡è¯•" class="headerlink" title="æ¶ˆè´¹è€…-æ¶ˆæ¯é‡è¯•"></a>æ¶ˆè´¹è€…-æ¶ˆæ¯é‡è¯•</h4>ç”Ÿäº§è€…å°†æ¶ˆæ¯æ­£å¸¸å‘é€å¸¦brokerä¹‹åï¼Œæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆè´¹è€…ä¼šé‡æ–°æ‹‰èµ·æ¶ˆæ¯é‡æ–°æ¶ˆè´¹ã€‚ </li></ul><p>RocketMQ ä¸ºæ¯ä¸ªtopicè®¾ç½®äº†â€%RETRY%+consumerGroupâ€œçš„é‡è¯•é˜Ÿåˆ—ï¼Œä¸”ä¸ºéœ€è¦é‡è¯•çš„æ¶ˆæ¯è®¾ç½®é‡è¯•çº§åˆ«ã€1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2hã€‘ï¼Œé‡è¯•æ¬¡æ•°è¶Šå¤šï¼Œé‡è¯•çº§åˆ«è¶Šé«˜ã€æŠ•é€’å»¶æ—¶å°±è¶Šå¤§ã€‘ã€‚</p><p>åŸç†ï¼šæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥æ—¶ï¼ŒrocketMQ ä¼šå°†å¤±è´¥çš„æ¶ˆæ¯å‘é€åˆ°topicä¸ºâ€SCHEDULE_TOPIC_XXXXâ€œçš„å»¶æ—¶é˜Ÿåˆ—ä¸­ï¼Œåå°å®šæ—¶ä»»åŠ¡æŒ‰ç…§å¯¹åº”çš„æ—¶é—´é‡æ–°å°†å»¶æ—¶é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ç§»å…¥å¯¹åº”çš„topicä¸­ã€‚</p><p>å¦‚æœé‡è¯•18æ¬¡ä¹‹åä»ç„¶å¤±è´¥ï¼ŒrocketMQ ä¼šå°†å¤±è´¥çš„æ¶ˆæ¯å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚</p><h3 id="æ¶ˆæ¯çš„å¹‚ç­‰æ€§"><a href="#æ¶ˆæ¯çš„å¹‚ç­‰æ€§" class="headerlink" title="æ¶ˆæ¯çš„å¹‚ç­‰æ€§"></a>æ¶ˆæ¯çš„å¹‚ç­‰æ€§</h3><p>åœ¨ç¡®ä¿æ¶ˆæ¯å¯é æ€§æ—¶ï¼Œæ¶ˆæ¯é‡å¤æ˜¯ä¸å¯é¿å…çš„ï¼Œå¦‚æœä¸šåŠ¡ä¸Šå¯¹äºæ¶ˆæ¯é‡å¤æ¯”è¾ƒæ•æ„Ÿï¼Œé‚£ä¹ˆéœ€è¦åœ¨ä¸šåŠ¡å±‚è¿‡æ»¤é‡å¤çš„æ¶ˆæ¯ã€‚</p><p>è¿™å°±åŠ¡å¿…ç¡®è®¤æ¶ˆæ¯å­˜åœ¨å”¯ä¸€é”®ï¼Œå¯ä»¥æ˜¯msgIdï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸šåŠ¡çš„å”¯ä¸€æ ‡è¯†å­—æ®µï¼Œæ¯”å¦‚è®¢å•idã€‚åœ¨å®é™…ä½¿ç”¨ä¸Šï¼Œ<strong>å°½é‡ä½¿ç”¨ä¸šåŠ¡ä¸Šçš„å”¯ä¸€æ ‡è¯†</strong>ï¼Œå› ä¸ºæœ‰å¯èƒ½å­˜åœ¨msgIdä¸ä¸€è‡´ï¼Œä½†æ˜¯æ¶ˆæ¯å†…å®¹ä¸€è‡´çš„æƒ…å†µï¼Œå¦‚æ¶ˆæ¯é‡è¯•ã€‚</p><h3 id="RocketMQæ˜¯å¦æ”¯æŒé«˜å¯ç”¨ï¼Ÿå¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ"><a href="#RocketMQæ˜¯å¦æ”¯æŒé«˜å¯ç”¨ï¼Ÿå¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ" class="headerlink" title="RocketMQæ˜¯å¦æ”¯æŒé«˜å¯ç”¨ï¼Ÿå¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ"></a>RocketMQæ˜¯å¦æ”¯æŒé«˜å¯ç”¨ï¼Ÿå¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ</h3><p>RocketMQ æœ¬èº«æ˜¯ä¸æ”¯æŒé«˜å¯ç”¨çš„ï¼Œä½†æ˜¯å¯ä»¥åŸºäº DLedger æ­å»ºå¯ä»¥è‡ªåŠ¨å®¹ç¾åˆ‡æ¢çš„ RocketMQ é›†ç¾¤ã€‚</p><ol><li>ä¸‹è½½rocketMQ 4.5 ç‰ˆæœ¬ä»¥ä¸Š</li><li>è‡³å°‘å‡†å¤‡ä¸‰ä¸ªèŠ‚ç‚¹</li><li>æ­£å¸¸å¯åŠ¨nameServer</li><li>æ ¹ç»é…ç½®æ–‡åŒ–[<code>../conf/dledger</code>]ä¸‹çš„é…ç½®æ–‡ä»¶å¯åŠ¨brokerå³å¯<h3 id="æ¶ˆæ¯ä¸¢å¤±é—®é¢˜"><a href="#æ¶ˆæ¯ä¸¢å¤±é—®é¢˜" class="headerlink" title="æ¶ˆæ¯ä¸¢å¤±é—®é¢˜"></a>æ¶ˆæ¯ä¸¢å¤±é—®é¢˜</h3><h4 id="å“ªäº›æƒ…å†µå¯èƒ½å­˜åœ¨æ¶ˆæ¯ä¸¢å¤±"><a href="#å“ªäº›æƒ…å†µå¯èƒ½å­˜åœ¨æ¶ˆæ¯ä¸¢å¤±" class="headerlink" title="å“ªäº›æƒ…å†µå¯èƒ½å­˜åœ¨æ¶ˆæ¯ä¸¢å¤±"></a>å“ªäº›æƒ…å†µå¯èƒ½å­˜åœ¨æ¶ˆæ¯ä¸¢å¤±</h4>ä»ä¸Šæ–‡æˆ‘ä»¬å¤§è‡´å¯ä»¥çŸ¥é“æ¶ˆæ¯ä»å‘é€åˆ°æ¶ˆè´¹ç»å†äº†4ä¸ªæ­¥éª¤ï¼š</li><li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°mq-masterèŠ‚ç‚¹çš„broker</li><li>brokerä¸»ä»åŒæ­¥</li><li>brokeræŒä¹…åŒ–åˆ°ç£ç›˜</li><li>æ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯æ¶ˆè´¹</li></ol><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62c60b7d1e2a43859c51886a056786bb~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p><h4 id="æ€ä¹ˆé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±"><a href="#æ€ä¹ˆé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±" class="headerlink" title="æ€ä¹ˆé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±"></a>æ€ä¹ˆé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±</h4><p>åœ¨ä»¥ä¸Š4ä¸ªæ­¥éª¤ä¸­å‡æœ‰å¯èƒ½å‡ºç°æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µï¼Œé‚£ä¹ˆå¦‚ä½•é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ä¹Ÿä»è¿™4ç‚¹å‡ºå‘</p><ol><li><blockquote><p>ç”Ÿäº§è€…ä½¿ç”¨äº‹åŠ¡æ¶ˆæ¯ä¿éšœæ¶ˆæ¯å¯é æ€§ï¼Œå¯ä»¥ä¿éšœç”Ÿäº§è€…æœ¬åœ°äº‹åŠ¡å’Œå‘é€åˆ°brokerçš„æ¶ˆæ¯äº‹åŠ¡ä¸€è‡´æ€§ã€‚ã€1å¯ä»¥é¿å…ã€‘</p></blockquote></li><li><blockquote><p>RocketMQé…ç½®åŒæ­¥åˆ·ç›˜+Dledgerä¸»ä»æ¶æ„ä¿è¯MQè‡ªèº«ä¸ä¼šä¸¢æ¶ˆæ¯ã€2ã€3å¯ä»¥é¿å…ã€‘</p></blockquote></li><li><blockquote><p>æ¶ˆè´¹è€…åŒæ­¥æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶åœ¨æœ¬åœ°ä¸šåŠ¡å¤„ç†å®Œæˆåï¼Œè¿”å›æ¶ˆè´¹æˆåŠŸæ ‡è¯†ã€4å¯ä»¥é¿å…ã€‘</p></blockquote></li></ol>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ä¸­é—´ä»¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¶ˆæ¯é˜Ÿåˆ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€æ–‡è§£è¯» redis ä¸»ä»/å“¨å…µ/é›†ç¾¤æ¶æ„</title>
      <link href="/2021/03/10/%E4%B8%80%E6%96%87%E8%A7%A3%E8%AF%BB%20redis%20%E4%B8%BB%E4%BB%8E%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/"/>
      <url>/2021/03/10/%E4%B8%80%E6%96%87%E8%A7%A3%E8%AF%BB%20redis%20%E4%B8%BB%E4%BB%8E%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸»ä»"><a href="#ä¸»ä»" class="headerlink" title="ä¸»ä»"></a>ä¸»ä»</h2><p>ä¸»ä»ç»“æ„ç¤ºæ„å›¾ï¼š<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6c8fc51278a04589bb4274db36302ecc~tplv-k3u1fbpfcp-watermark.image">  </p><h3 id="ä¸»ä»æ¶æ„æ­å»ºï¼Œé…ç½®ä»èŠ‚ç‚¹ï¼š"><a href="#ä¸»ä»æ¶æ„æ­å»ºï¼Œé…ç½®ä»èŠ‚ç‚¹ï¼š" class="headerlink" title="ä¸»ä»æ¶æ„æ­å»ºï¼Œé…ç½®ä»èŠ‚ç‚¹ï¼š"></a>ä¸»ä»æ¶æ„æ­å»ºï¼Œé…ç½®ä»èŠ‚ç‚¹ï¼š</h3><ol><li>å¤åˆ¶ redis.conf æ–‡ä»¶ï¼Œå¹¶ä¿®æ”¹å¦‚ä¸‹é…ç½®<ul><li>port 8001</li><li>pidfile /var/redis_8001.pid</li><li>logfile 8001.log</li><li>dir /usr/local/redis_8001/data</li></ul></li><li>é…ç½®ä¸»ä»é…ç½®<ul><li>replicaof 172.0.0.1 8002</li><li>replica-read-only yes</li></ul></li><li>æ ¹æ®é…ç½®æ–‡ä»¶å¯åŠ¨redis<ul><li>redis-server redis.conf  </li></ul></li></ol><span id="more"></span><h3 id="ä¸»ä»ç»“æ„å·¥ä½œåŸç†"><a href="#ä¸»ä»ç»“æ„å·¥ä½œåŸç†" class="headerlink" title="ä¸»ä»ç»“æ„å·¥ä½œåŸç†"></a>ä¸»ä»ç»“æ„å·¥ä½œåŸç†</h3><p>master-slaveæ•°æ®åŒæ­¥è¿‡ç¨‹ï¼š </p><p><strong>å…¨é‡åŒæ­¥</strong>ï¼šslaveä¼šå‘é€ä¸€ä¸ª<strong>PSYNC</strong>å‘½ä»¤ç»™masterï¼Œmasteræ¥æ”¶åˆ°è¯¥å‘½ä»¤åï¼Œä¼šç«‹å³è¿›è¡ŒæŒä¹…åŒ–æ“ä½œï¼Œé€šè¿‡å‘½ä»¤<strong>bgsava</strong>ç”Ÿæˆä¸€ä¸ªRDBå¿«ç…§æ–‡ä»¶ï¼ŒæŒä¹…åŒ–æœŸé—´ï¼Œå¦‚æœå®¢æˆ·ç«¯ä»åœ¨å†™å…¥æ•°æ®ï¼Œè¿™éƒ¨åˆ†æ•°æ®ä¼šè¢«ä¿å­˜åœ¨å†…å­˜ç¼“å†²åŒºï¼ˆrepl bufferï¼‰ä¸­ï¼ŒæŒä¹…åŒ–å®Œæˆä»¥åï¼Œmasterä¼šå°†RDBæ–‡ä»¶å‘é€ç»™slaveï¼Œslave å°†æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åmasterä¼šå°†ç¼“å†²åŒºçš„å‘½ä»¤å‘é€ç»™slaveèŠ‚ç‚¹ã€‚<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ccba6ea8a9ef45619a047fd74e0ee6f5~tplv-k3u1fbpfcp-watermark.image" alt="å…¨é‡åŒæ­¥">  </p><p><strong>æ–­ç‚¹ç»­ä¼ </strong>ï¼šå½“masterå’Œslaveç”±äºæŸäº›åŸå› æ–­å¼€æ—¶ï¼Œslaveé‡æ–°è¿æ¥æ—¶ï¼Œä¼šå‘é€ <strong>PSYNC(offset)</strong> åŒ…å«ä¸€ä¸ªä¸‹æ ‡çš„å‘½ä»¤ï¼Œè¡¨ç¤ºæ–­å¼€ä¹‹å‰åŒæ­¥åˆ°äº†å“ªå„¿ã€‚masterèŠ‚ç‚¹åœ¨å†™å…¥æ•°æ®æ—¶ï¼Œä¼šå°†æ•°æ®å†™å…¥ä¸€ä¸ªç¼“å†²åŒºï¼ˆrepl backlog bufferï¼‰ï¼Œå½“masteræ¥å—åˆ° <strong>PSYNC(offset)</strong> å‘½ä»¤æ—¶ï¼Œä¼šå…ˆå»æŸ¥çœ‹offsetæ˜¯å¦åœ¨ç¼“å†²åŒºï¼Œå¦‚æœåœ¨ç¼“å­˜åŒºï¼Œä¼šå°†offsetåé¢çš„å‘½ä»¤å‘é€ç»™slaveï¼Œå¦åˆ™ç›´æ¥è¿›è¡Œä¸€æ¬¡å…¨é‡åŒæ­¥</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9b535ecf7ddc4b26bca5dbe8aeeb7119~tplv-k3u1fbpfcp-watermark.image" alt="æ–­ç‚¹ç»­ä¼ ">  </p><h3 id="ä¸»ä»ç»“æ„å¯èƒ½å‘ç”Ÿçš„é—®é¢˜ï¼š"><a href="#ä¸»ä»ç»“æ„å¯èƒ½å‘ç”Ÿçš„é—®é¢˜ï¼š" class="headerlink" title="ä¸»ä»ç»“æ„å¯èƒ½å‘ç”Ÿçš„é—®é¢˜ï¼š"></a>ä¸»ä»ç»“æ„å¯èƒ½å‘ç”Ÿçš„é—®é¢˜ï¼š</h3><p><strong>ä¸»ä»å¤åˆ¶é£æš´</strong>ï¼šå¤šä¸ªä»èŠ‚ç‚¹åŒæ—¶å®•æœºé‡å¯åï¼Œå…¨éƒ¨éœ€è¦è¿›è¡Œå…¨é‡åŒæ­¥ï¼Œå¯¼è‡´masterèŠ‚ç‚¹å‹åŠ›è¿‡å¤§  </p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š å°†å°†ä»èŠ‚ç‚¹æŒ‚è½½åœ¨æŸä¸ªä»èŠ‚ç‚¹ä¸Šï¼Œæ•°æ®åŒæ­¥ä¹Ÿä»è¿™ä¸ªä»èŠ‚ç‚¹å¤åˆ¶ã€‚<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a1751533c3c4c36aea8e3eba291aa5b~tplv-k3u1fbpfcp-watermark.image">  </p><h2 id="å“¨å…µæ¨¡å¼"><a href="#å“¨å…µæ¨¡å¼" class="headerlink" title="å“¨å…µæ¨¡å¼"></a>å“¨å…µæ¨¡å¼</h2><p>å“¨å…µæ¨¡å¼ç»“æ„ç¤ºæ„å›¾ï¼š<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/389cf3d4bf42416ba7e1e32a51101da7~tplv-k3u1fbpfcp-watermark.image">  </p><h3 id="å“¨å…µæ¨¡å¼æ­å»ºï¼Œé…ç½®å“¨å…µ"><a href="#å“¨å…µæ¨¡å¼æ­å»ºï¼Œé…ç½®å“¨å…µ" class="headerlink" title="å“¨å…µæ¨¡å¼æ­å»ºï¼Œé…ç½®å“¨å…µ"></a>å“¨å…µæ¨¡å¼æ­å»ºï¼Œé…ç½®å“¨å…µ</h3><ol><li>å¤åˆ¶ sentinel.conf æ–‡ä»¶åˆ°confç›®å½•ï¼Œå¹¶ä¿®æ”¹å¦‚ä¸‹é…ç½®<ul><li>port 26379</li><li>daemonize yes</li><li>pidfile â€œ/var/run/redis-sentinel.pidâ€</li><li>logfile â€œredis_sentinel_26379.logâ€</li><li>dir â€œ/home/redis/redis-6.0.9/sentinel_26379â€</li><li>sentinel monitor mymaster 172.19.14.57 6379 2</li></ul></li><li>å¯åŠ¨å“¨å…µ<ul><li>src/redis-sentinel conf/sentinel.conf</li></ul></li></ol><h3 id="å“¨å…µçš„å·¥ä½œåŸç†"><a href="#å“¨å…µçš„å·¥ä½œåŸç†" class="headerlink" title="å“¨å…µçš„å·¥ä½œåŸç†"></a>å“¨å…µçš„å·¥ä½œåŸç†</h3><p>sentinel å“¨å…µæ˜¯ç‰¹æ®Šçš„redisæœåŠ¡ï¼Œä»–ä¸å¯¹å¤–æä¾›è¯»å†™æœåŠ¡ï¼Œåªç”¨äºç›‘æ§ä¸»ä»ç»“æ„çš„çŠ¶æ€ã€‚<br>å“¨å…µæ¨¡å¼ä¸‹ï¼Œclientç«¯ç¬¬ä¸€æ¬¡è¿æ¥å“¨å…µæ‰¾å‡ºredisä¸»èŠ‚ç‚¹å¹¶ç¼“å­˜åˆ°æœ¬åœ°ï¼Œä¹‹åç›´æ¥è®¿é—®redisä¸»èŠ‚ç‚¹ã€‚<br>å½“redisèŠ‚ç‚¹çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œsentinelå“¨å…µä¼šç¬¬ä¸€æ—¶é—´æ„ŸçŸ¥åˆ°ï¼Œå¹¶å°†æ–°çš„ä¸»èŠ‚ç‚¹æ¨é€ç»™å®¢æˆ·ç«¯ã€‚ï¼ˆclientç«¯è®¢é˜…sentinelï¼Œä¸€æœ‰å˜åŠ¨ç›´æ¥æ¨é€ï¼‰   </p><p><strong>å“¨å…µleaderé€‰ä¸¾æµç¨‹</strong><br>å½“ä¸€ä¸ª master æœåŠ¡å™¨è¢«æŸ sentinel<code>[å“¨å…µ]</code>è§†ä¸ºä¸‹çº¿çŠ¶æ€åï¼Œè¯¥sentinel<code>[å“¨å…µ]</code> ä¼šä¸å…¶ä»– sentinel<code>[å“¨å…µ]</code> åå•†é€‰å‡ºæ–°çš„masterï¼Œè¿›è¡Œæ•…éšœè½¬ç§»å·¥ä½œã€‚</p><p>æ¯ä¸ªå‘ç°masteræœåŠ¡å™¨è¿›å…¥ä¸‹çº¿çŠ¶æ€çš„sentinel<code>[å“¨å…µ]</code>éƒ½å¯ä»¥è¦æ±‚å…¶ä»–sentinel<code>[å“¨å…µ]</code>é€‰è‡ªå·±ä¸ºâ€œæœ¬æ¬¡å†³ç­–â€çš„leaderï¼Œé€‰ä¸¾æ˜¯å…ˆåˆ°å…ˆå¾—ã€‚</p><p>åŒæ—¶æ¯ä¸ªsentinelæ¯æ¬¡é€‰ä¸¾éƒ½ä¼šè‡ªå¢é…ç½®çºªå…ƒ(é€‰ä¸¾å‘¨æœŸ)ï¼Œæ¯ä¸ªçºªå…ƒä¸­åªä¼šé€‰æ‹©ä¸€ä¸ªsentinelçš„leaderã€‚å¦‚æœæ‰€æœ‰è¶…è¿‡ä¸€åŠçš„sentinelé€‰ä¸¾æŸsentinelä½œä¸ºleaderã€‚</p><p>ä¹‹åç”±è¯¥sentinel<code>[å“¨å…µleader]</code>è¿›è¡Œæ•…éšœè½¬ç§»æ“ä½œï¼Œä»å­˜æ´»çš„slaveä¸­é€‰ä¸¾å‡ºæ–°çš„masterï¼Œè¿™ä¸ªé€‰ä¸¾è¿‡ç¨‹è·Ÿé›†ç¾¤çš„masteré€‰ä¸¾å¾ˆç±»ä¼¼<sub>ã€è¯·æŸ¥çœ‹ä¸‹é¢redisé›†ç¾¤æ¨¡å¼çš„é€‰ä¸¾ã€‘</sub>ã€‚å“¨å…µé›†ç¾¤åªæœ‰ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œredisçš„ä¸»ä»ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œä»¥åŠé€‰ä¸¾masterï¼Œå¦‚æœmasteræŒ‚äº†ï¼Œé‚£å”¯ä¸€çš„é‚£ä¸ªå“¨å…µèŠ‚ç‚¹å°±æ˜¯å“¨å…µleaderäº†ï¼Œå¯ä»¥æ­£å¸¸é€‰ä¸¾æ–°masterã€‚ä¸è¿‡ä¸ºäº†é«˜å¯ç”¨ä¸€èˆ¬éƒ½æ¨èè‡³å°‘éƒ¨ç½²ä¸‰ä¸ªå“¨å…µèŠ‚ç‚¹ã€‚ä¸ºä»€ä¹ˆæ¨èå¥‡æ•°ä¸ªå“¨å…µèŠ‚ç‚¹åŸç†è·Ÿé›†ç¾¤å¥‡æ•°ä¸ªmasterèŠ‚ç‚¹ç±»ä¼¼ã€‚</p><p><strong>å“¨å…µæ¨¡å¼å…¶å®å°±æ˜¯ä¸»ä»ç»“æ„ä¸ŠåŠ äº†ä¸€ä¸ªå“¨å…µï¼Œæ‰€ä»¥æ•°æ®åŒæ­¥åŸç†å’Œä¸»ä»ç»“æ„ä¸€è‡´</strong></p><h3 id="å“¨å…µæ¨¡å¼å¯èƒ½å‘ç”Ÿçš„é—®é¢˜ï¼š"><a href="#å“¨å…µæ¨¡å¼å¯èƒ½å‘ç”Ÿçš„é—®é¢˜ï¼š" class="headerlink" title="å“¨å…µæ¨¡å¼å¯èƒ½å‘ç”Ÿçš„é—®é¢˜ï¼š"></a>å“¨å…µæ¨¡å¼å¯èƒ½å‘ç”Ÿçš„é—®é¢˜ï¼š</h3><p><strong>è®¿é—®ç¬æ–­</strong>ï¼šåœ¨ä¸»èŠ‚ç‚¹å®•æœºæ—¶ï¼Œå“¨å…µä¼šå‘èµ·é€‰ä¸¾ã€‚åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œä¼šå‘ç”Ÿå¼‚å¸¸ã€‚å½“ä¸»èŠ‚ç‚¹é‡æ–°é€‰ä¸¾å‡ºæ¥ï¼Œåˆä¼šæ¢å¤ã€‚è¯¥é—®é¢˜åœ¨å“¨å…µæ¨¡å¼ä¸‹æ— æ³•é¿å…ã€‚</p><h2 id="redisé›†ç¾¤æ¶æ„"><a href="#redisé›†ç¾¤æ¶æ„" class="headerlink" title="redisé›†ç¾¤æ¶æ„"></a>redisé›†ç¾¤æ¶æ„</h2><p>é›†ç¾¤å›¾ç¤ºï¼š<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/847252bac04744f6893d264c35175b82~tplv-k3u1fbpfcp-watermark.image"></p><h3 id="é›†ç¾¤æ­å»º"><a href="#é›†ç¾¤æ­å»º" class="headerlink" title="é›†ç¾¤æ­å»º"></a>é›†ç¾¤æ­å»º</h3><ol><li>å¤åˆ¶ sentinel.conf æ–‡ä»¶åˆ° redis_cluster/8001/redis.conf ç›®å½•ï¼Œå¹¶ä¿®æ”¹å¦‚ä¸‹é…ç½®<ul><li>port 8001</li><li>daemonize yes    ######## å®ˆæŠ¤è¿›ç¨‹</li><li>pidfile /var/run/redis_8001.pid</li><li>dir /usr/local/redis-cluster/8001/</li><li>replica-read-only yes                 ######## ä»èŠ‚ç‚¹åªè¯»</li><li>appendonly yes    #######å¼€å¯AOF</li><li>cluster-enabled yes ########å¼€å¯é›†ç¾¤æ¨¡å¼</li><li>cluster-config-file nodes-8001.conf ########### é›†ç¾¤ä¿¡æ¯</li><li>cluster-node-timeout 15000 ############ é›†ç¾¤master èŠ‚ç‚¹å¤±è”å¤šä¹…å¼€å§‹é€‰ä¸¾</li><li>requirepass zhouxh_z  ########å½“å‰ä¸»æœºå¯†ç </li><li>masterauth zhouxh_z   ########è®¿é—®å…¶ä»–ä¸»æœºå¯†ç </li></ul></li><li>å¯åŠ¨é›†ç¾¤èŠ‚ç‚¹<ul><li>src/redis-server redis_cluster/8001/redis.conf</li></ul></li><li>é›†ç¾¤é…ç½®<ul><li>src/redis-cli -a zhouxh â€“cluster create â€“cluster-replicas 1 172.19.14.57:8001 172.19.14.57:8002 172.19.14.57:8003 172.19.14.57:8004 172.19.14.57:8005 172.19.14.57:8006 </li></ul></li><li>è¿æ¥å®¢æˆ·ç«¯<ul><li>src/redis-cli -a zhouxh -c -h 172.19.14.57 -p 8001</li></ul></li><li>æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯<ul><li>cluster info</li></ul></li><li>æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨<ul><li>cluster nodes<h3 id="é›†ç¾¤åŸç†"><a href="#é›†ç¾¤åŸç†" class="headerlink" title="é›†ç¾¤åŸç†"></a>é›†ç¾¤åŸç†</h3>é›†ç¾¤ä¸‹çš„æ¯ä¸ªå°èŠ‚ç‚¹çš„åŒæ­¥å¤åˆ¶ï¼Œå’Œä¸»ä»ä¸€è‡´ã€‚</li></ul></li></ol><h4 id="æ§½ä½"><a href="#æ§½ä½" class="headerlink" title="æ§½ä½"></a>æ§½ä½</h4><p>å¹¶ä¸æ˜¯çœŸå®çš„ç‰©ç†ç©ºé—´ï¼Œæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æ¦‚å¿µã€‚<br>redisCluster å°†å†…å­˜è™šæ‹Ÿåˆ’åˆ†ä¸º16384ä¸ªæ§½ä½ï¼Œåˆ†åˆ«åˆ†é…åˆ°å„ä¸ªmasterèŠ‚ç‚¹ä¸­ã€‚redisåœ¨å­˜å‚¨æ•°æ®æ—¶ï¼Œä¼šå¯¹keyè¿›è¡ŒHashç®—æ³•åœ¨å¯¹16383å–ä½™ç¡®ä¿ï¼Œkeyå€¼å¿…å®šå­˜åœ¨é›†ç¾¤æ§½ä½ä¸Šã€‚ </p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1f1bd2d4ab6f452f800e4dcc4a0d59bd~tplv-k3u1fbpfcp-watermark.image"></p><h4 id="å–ä½™ç®—æ³•"><a href="#å–ä½™ç®—æ³•" class="headerlink" title="å–ä½™ç®—æ³•"></a>å–ä½™ç®—æ³•</h4><p>hash(key) = CRC16(key) % 16383</p><h4 id="è·³è½¬é‡å®šä½"><a href="#è·³è½¬é‡å®šä½" class="headerlink" title="è·³è½¬é‡å®šä½"></a>è·³è½¬é‡å®šä½</h4><p>åœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œåœ¨å®¢æˆ·å‘ä¸€ä¸ªredisèŠ‚ç‚¹å‘èµ·æ“ä½œå‘½ä»¤ï¼ˆå¦‚ set key valueï¼‰ï¼Œä¼šé€šè¿‡<strong>å–ä½™ç®—æ³•</strong>è®¡ç®—å¯¹åº”çš„æ§½ä½ï¼Œå¦‚æœå‘ç°å¯¹åº”çš„æ§½ä½ä¸åœ¨ç›®å‰èŠ‚ç‚¹ä¸Šæ—¶ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œè·³è½¬é‡å®šå‘ã€‚ </p><p>å¦‚ä¸‹ï¼šåŸæœ¬åœ¨ 8001 ç«¯å£çš„redisï¼Œå‘èµ·setæ“ä½œï¼Œé€šè¿‡<strong>å–ä½™ç®—æ³•</strong>è®¡ç®—keyï¼Œå‘ç°zhouxh_1åº”è¯¥å‘½ä¸­ 8002 ç«¯å£çš„redisæ‰€åœ¨çš„æ§½ä½ï¼Œreidsè¿›è¡Œè·³è½¬é‡å®šå‘ï¼Œè‡ªåŠ¨å°†å€¼setåˆ°äº†å¯¹åº”çš„æ§½ä½ï¼Œå¹¶è·³è½¬åˆ°äº†8002 ç«¯å£</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d627b69392de4a9fb3b1d16c9a096b24~tplv-k3u1fbpfcp-watermark.image">  </p><h4 id="ç½‘ç»œæŠ–åŠ¨"><a href="#ç½‘ç»œæŠ–åŠ¨" class="headerlink" title="ç½‘ç»œæŠ–åŠ¨"></a>ç½‘ç»œæŠ–åŠ¨</h4><p>ç½‘ç»œæ³¢åŠ¨å¯èƒ½å¯¼è‡´éƒ¨åˆ†masterèŠ‚ç‚¹åœ¨çŸ­æ—¶é—´å†…è¿æ¥ä¸ä¸Šï¼Œå¦‚æœä¸è¿›è¡Œé™åˆ¶ï¼Œå¯èƒ½ä¼šå‘ç”Ÿé¢‘ç¹é€‰ä¸¾ï¼Œè¿›è€Œå¯¼è‡´è„‘è£‚é—®é¢˜ã€‚  </p><p><code>cluster-node-timeout 15000</code><br>è¯¥é…ç½®å¯ä»¥ä½¿masterèŠ‚ç‚¹åœ¨å¤±è”15000åï¼Œå†è¿›è¡Œé€‰ä¸¾ã€‚æœ‰æ•ˆé¿å…é¢‘ç¹é€‰ä¸¾é—®é¢˜</p><h4 id="è„‘è£‚é—®é¢˜-é¢è¯•å¸¸é—®"><a href="#è„‘è£‚é—®é¢˜-é¢è¯•å¸¸é—®" class="headerlink" title="è„‘è£‚é—®é¢˜* é¢è¯•å¸¸é—®"></a>è„‘è£‚é—®é¢˜* <sub>é¢è¯•å¸¸é—®</sub></h4><p>ç”±äºç½‘ç»œé—®é¢˜å¯¼è‡´masterèŠ‚ç‚¹å’Œå…¶ä»–èŠ‚ç‚¹æ–­å¼€è¿æ¥ï¼Œæ­¤æ—¶masterï¼ˆæ—§ï¼‰èŠ‚ç‚¹å¹¶æ²¡æœ‰å®•æœºï¼Œä½†æ˜¯å…¶ä»–èŠ‚ç‚¹è®¤ä¸ºå®ƒå·²ç»å®•æœºäº†ï¼Œæ­¤æ—¶slaveèŠ‚ç‚¹å°†å‘èµ·é€‰ä¸¾ï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„masterï¼ˆæ–°ï¼‰èŠ‚ç‚¹ã€‚æ­¤æ—¶å­˜åœ¨ä¸¤ä¸ªmasterèŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯è®¤ä¸ºä¸¤ä¸ªmasterèŠ‚ç‚¹éƒ½æ­£å¸¸å·¥ä½œï¼Œæ­¤æ—¶ä¼šå‘è¿™ä¸¤ä¸ªmasterèŠ‚ç‚¹å†™å…¥æ•°æ®ã€‚å½“ç½‘ç»œé‡æ–°è¿æ¥æ—¶ï¼Œç”±äºå­˜åœ¨ä¸¤ä¸ªmasterèŠ‚ç‚¹ï¼Œæ­¤æ—¶é›†ç¾¤ä¼šå°†masterï¼ˆæ—§ï¼‰è®¾ç½®ä¸ºä»èŠ‚ç‚¹ï¼ˆslaveï¼‰ï¼ŒæŒ‚è½½åˆ°masterï¼ˆæ–°ï¼‰ä¸Šï¼Œæ­¤æ—¶ä»èŠ‚ç‚¹ç›¸å½“äºé‡å¯ï¼Œéœ€è¦ä»masterèŠ‚ç‚¹åŒæ­¥æ•°æ®ï¼Œè¿™å°±å¯¼è‡´äº†ä¹‹å‰å®¢æˆ·ç«¯è®¤ä¸ºæ­£å¸¸å†™å…¥ï¼ˆmasterã€ä¹…ã€‘ï¼‰çš„æ•°æ®ä¸¢å¤±äº†ã€‚<br>è§£å†³æ–¹æ³•ï¼šè®¾ç½®åŠæ•°å†™å…¥é…ç½®<br><code>minâ€slavesâ€toâ€write 1</code><br>åŠæ•°å†™å…¥ï¼šå³ä¸€åŠçš„èŠ‚ç‚¹è®¤ä¸ºå†™å…¥æˆåŠŸæ‰ç®—æˆåŠŸ<br>è¿™é‡Œçš„ â€1â€œ å¯å˜ï¼Œè®¡ç®—æ–¹å¼ï¼šï¼ˆå°çš„ä¸»ä»èŠ‚ç‚¹æ•°-1ï¼‰/2</p><h4 id="redisé€‰ä¸¾åŸç†-é¢è¯•å¸¸é—®"><a href="#redisé€‰ä¸¾åŸç†-é¢è¯•å¸¸é—®" class="headerlink" title="redisé€‰ä¸¾åŸç†* é¢è¯•å¸¸é—®"></a>redisé€‰ä¸¾åŸç†* <sub>é¢è¯•å¸¸é—®</sub></h4><ol><li>å½“slaveå‘ç°è‡ªå·±çš„masterèŠ‚ç‚¹ æŒ‚äº†ï¼ˆfailï¼‰</li><li>å°†è‡ªå·±è®°å½•çš„é›†ç¾¤ currentEpoch åŠ 1ï¼Œå¹¶å¹¿æ’­ FAILOVER_AUTH_REQUEST ä¿¡æ¯</li><li>å…¶ä»–èŠ‚ç‚¹æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œç”±ä¸»èŠ‚ç‚¹å›å¤ FAILOVER_AUTH_ACK ä¿¡æ¯ï¼Œæ¯ä¸ªmasterèŠ‚ç‚¹åªèƒ½å‘é€ä¸€æ¬¡</li><li>å¯¹åº”çš„slaveèŠ‚ç‚¹ï¼Œæ”¶é›†å¹¶ç»Ÿè®¡ FAILOVER_AUTH_ACK ä¿¡æ¯ã€‚</li><li>å½“æ”¶é›†åˆ°è¶…è¿‡åŠæ•°çš„ACKä¿¡æ¯åï¼Œè¯¥èŠ‚ç‚¹è‡ªåŠ¨å‡çº§ä¸ºmasterèŠ‚ç‚¹ã€‚</li><li>masterï¼ˆæ–°ï¼‰ä¼šæ’­Pongæ¶ˆæ¯é€šçŸ¥å…¶ä»–é›†ç¾¤èŠ‚ç‚¹ï¼Œâ€æˆ‘å·²ç»æˆåŠŸä¸Šä½ï¼Œä½ ä»¬å¯ä»¥æ­‡æ­‡äº†ï¼Œèµ¶ç´§æ›´æ–°ä½ ä»¬çš„é…ç½®â€œã€‚</li></ol><p>ç¬¬1æ­¥ç»“æŸåï¼Œç¬¬2ä¸¤æ­¥å¹¶ä¸æ˜¯é©¬ä¸Šæ‰§è¡Œï¼Œä¸­é—´ä¼šæœ‰ä¸€ä¸ªå»¶è¿Ÿæ—¶é—´ï¼Œæ¯ä¸ªslaveèŠ‚ç‚¹çš„å»¶è¿Ÿæ—¶é—´ä¸åŒã€‚<br>è®¡ç®—è§„åˆ™ï¼š<code>500ms + random(0 ~ 500ms) + SLAVE_RANK * 1000ms</code><br>SLAVE_RANKï¼šè¡¨ç¤ºæ­¤slaveå·²ç»ä»masterå¤åˆ¶æ•°æ®çš„æ€»é‡çš„rankã€‚Rankè¶Šå°ä»£è¡¨å·²å¤åˆ¶çš„æ•°æ®è¶Šæ–°ã€‚è¿™ç§æ–¹<br>å¼ä¸‹ï¼ŒæŒæœ‰æœ€æ–°æ•°æ®çš„slaveå°†ä¼šé¦–å…ˆå‘èµ·é€‰ä¸¾ï¼ˆç†è®ºä¸Šï¼‰ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼ä¸­é—´ä»¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¶ˆæ¯é˜Ÿåˆ—[1]--RabbitMQ</title>
      <link href="/2021/03/10/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-1-RabbitMQ/"/>
      <url>/2021/03/10/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-1-RabbitMQ/</url>
      
        <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—"><a href="#ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—"></a>ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—</h2><ul><li>æ¶ˆæ¯ï¼šè¯·æ±‚æˆ–åº”ç”¨é—´ä¼ è¾“çš„æ•°æ®</li><li>é˜Ÿåˆ—ï¼šä¸€ç§å…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„</li><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­—é¢æ„æ€å°±æ˜¯ä¸€ç§å­˜æ”¾æ•°æ®çš„å…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„æˆ–è€…è¯´å®¹å™¨</li></ul><p>æ€»çš„æ¥è¯´ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ç§æœåŠ¡é—´ <strong>å¼‚æ­¥é€šä¿¡ç»„ä»¶</strong> ï¼Œä¸»è¦è§£å†³åº”ç”¨è§£è€¦ï¼Œå¼‚æ­¥å¤„ç†ï¼Œæµé‡å‰Šé”‹ç­‰é—®é¢˜ï¼Œå®ç°é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨ï¼Œå¯ä¼¸ç¼©å’Œæœ€ç»ˆä¸€è‡´æ€§ã€‚</p><h2 id="æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨åœºæ™¯"><a href="#æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨åœºæ™¯"></a>æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨åœºæ™¯</h2><h3 id="1ã€å¼‚æ­¥å¤„ç†"><a href="#1ã€å¼‚æ­¥å¤„ç†" class="headerlink" title="1ã€å¼‚æ­¥å¤„ç†"></a>1ã€å¼‚æ­¥å¤„ç†</h3><span id="more"></span><p>åœºæ™¯ï¼šé¡¹ç›®ä¹‹åˆç”¨æˆ·ä½“é‡å°ï¼Œç”¨æˆ·ä»é€‰å•†å“åˆ°æ”¯ä»˜ä¸€æ¡é¾™ï¼Œå•æœºå®Œæˆã€‚åæ¥ç”¨æˆ·ä½“é‡æ‰©å¤§ï¼Œæ–°å¢å¾ˆå¤šå…¶ä»–æœåŠ¡ï¼Œå¦‚æ¶ˆè´¹å·ï¼Œç§¯åˆ†ç­‰ã€‚<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6862484dcfda4afc8dd1c743b0c43192~tplv-k3u1fbpfcp-watermark.image"><br>ç”±äºè°ƒç”¨é“¾è·¯çš„å¢é•¿ï¼Œæ”¯ä»˜è€—æ—¶ä¹Ÿéšä¹‹å¢åŠ ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚ç”±æ­¤å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰ï¼Œé€šè¿‡å¼‚æ­¥å¤„ç†ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/17b63a1b22ad4bed9ef0aa217ee3d0b8~tplv-k3u1fbpfcp-watermark.image"><br>æ”¯ä»˜ç³»ç»Ÿæ”¯ä»˜æˆåŠŸåï¼Œåªéœ€è¦å¾€ MQ ä¸­ï¼Œå†™å…¥ä¸€æ¡æ”¯ä»˜æˆåŠŸçš„æ¶ˆæ¯ã€‚å…¶ä»–ç³»ç»Ÿè®¢é˜…åï¼Œå¼‚æ­¥å¤„ç†å„è‡ªä¸šåŠ¡ã€‚ç”¨æˆ·æ„Ÿè§‰åˆ°çš„æ—¶é•¿å°±æ˜¯ï¼šæ”¯ä»˜ç³»ç»Ÿçš„æ¶ˆè€—æ—¶é—´ + å†™å…¥MQçš„æ¶ˆè€—æ—¶é—´ã€‚</p><h3 id="2ã€åº”ç”¨è§£è€¦"><a href="#2ã€åº”ç”¨è§£è€¦" class="headerlink" title="2ã€åº”ç”¨è§£è€¦"></a>2ã€åº”ç”¨è§£è€¦</h3><ul><li><p>ä¸å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰ï¼Œé‚£æ”¯ä»˜è¿‡ç¨‹ä¸­çš„æ¶ˆè´¹å·æŠµæ‰£ã€ç§¯åˆ†æŠµæ‰£ç­‰æœåŠ¡ï¼Œå°±éœ€è¦å¯¹åº”ç³»ç»Ÿæš´éœ²æ¥å£ï¼Œä»¥ä¾¿åœ¨æ”¯ä»˜ç³»ç»Ÿä¸­è°ƒç”¨ã€‚<br>  å¦‚æœæ­¤æ—¶éœ€è¦æ–°å¢ä¸€ä¸ªé‚®ä»¶/çŸ­ä¿¡ç³»ç»Ÿçš„åŠŸèƒ½ï¼Œå°±éœ€è¦ä¿®æ”¹æ”¯ä»˜ç³»ç»Ÿåé‡æ–°å‘å¸ƒåº”ç”¨ã€‚è¿™ä¹Ÿå¸¦æ¥çš„ä¸å¿…è¦çš„ç»´æŠ¤æˆæœ¬ã€‚</p></li><li><p>å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰åï¼Œæ”¯ä»˜ç³»ç»Ÿä¸å…³å¿ƒæœ‰å“ªäº›ç³»ç»Ÿéœ€è¦çŸ¥é“æ”¯ä»˜æˆåŠŸã€‚æ”¯ä»˜ç³»ç»Ÿåªéœ€å‘ MQ ä¸­å†™å…¥ä¸€æ¡æ”¯ä»˜æˆåŠŸçš„æ¶ˆæ¯ï¼Œå…¶ä»–ç³»ç»Ÿè®¢é˜…è¯¥æ¶ˆæ¯ï¼Œåœ¨æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œè‡ªå‘çš„è¿›è¡Œè‡ªèº«çš„ä¸šåŠ¡å³å¯ã€‚</p><h3 id="3ã€æµé‡å‰Šå³°"><a href="#3ã€æµé‡å‰Šå³°" class="headerlink" title="3ã€æµé‡å‰Šå³°"></a>3ã€æµé‡å‰Šå³°</h3><p>å¹³æ—¶æµé‡æ¯”è¾ƒä½ï¼Œä½†æ˜¯ä¸€åˆ°å¤§ä¿ƒï¼ˆæ¯”å¦‚ç§’æ€åœºæ™¯ï¼‰ï¼Œæµé‡åœ¨æŸä¸€æ—¶æ®µçªç„¶æš´å¢ï¼Œå¯èƒ½å‡ºç°è¿œè¶…æœåŠ¡æ‰€èƒ½æ‰¿è½½çš„è¯·æ±‚æ‰“å…¥ï¼Œå¯¼è‡´æœåŠ¡å®•æœºæ— æ³•å¯¹å¤–æä¾›æœåŠ¡ã€‚</p></li></ul><p>è¿™ç§æƒ…å†µä¸‹å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåœ¨å¤§é‡è¯·æ±‚æ‰“å…¥æœåŠ¡æ—¶ï¼Œå…ˆå°†è¯·æ±‚å†™å…¥é˜Ÿåˆ—ï¼Œç„¶åæœåŠ¡å†æŒ‰è‡ªèº«å¤„ç†èƒ½åŠ›ä»MQä¸­æ‹‰å–æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ï¼Œè¿™å°±è¾¾åˆ°äº†æµé‡å‰Šå³°çš„ä½œç”¨ã€‚</p><h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><p>RabbitMQ è™½ç„¶å†ååé‡ä¸Šä¸åŠ kafkaã€rocketMQï¼Œä½†æ˜¯å…¶é«˜æ•ˆçš„å“åº”æ€§ï¼Œæ¶ˆæ¯å¯é æ€§ä¸Šæ˜¯æ— ä¸ä¼¦æ¯”çš„ã€‚å®Œå…¨å¯ä»¥æ”¯æŒç”¨æˆ·ä½“é‡ä¸æ˜¯é‚£ä¹ˆé«˜çš„åº”ç”¨ã€‚</p><h3 id="1ã€RabblitMQçš„å·¥ä½œæ¨¡å‹"><a href="#1ã€RabblitMQçš„å·¥ä½œæ¨¡å‹" class="headerlink" title="1ã€RabblitMQçš„å·¥ä½œæ¨¡å‹"></a>1ã€RabblitMQçš„å·¥ä½œæ¨¡å‹</h3><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c5f657ca2ad545db9d23e3da4c1ffeaa~tplv-k3u1fbpfcp-watermark.image"></p><ul><li>producerï¼šç”Ÿäº§è€…</li><li>connectionï¼šç”Ÿäº§è€…/æ¶ˆè´¹è€… å’Œ MQ ä¹‹é—´çš„TCPè¿æ¥</li><li>channelï¼šconnectionå†…éƒ¨å»ºç«‹çš„è™šæ‹Ÿè¿æ¥</li><li>brokerï¼šMQ ä¸­æ¥å—å’Œåˆ†å‘æ¶ˆæ¯çš„åº”ç”¨</li><li>Virtual Hostï¼šä¸ºå¤šç§Ÿæˆ·è€ƒè™‘å’Œå®‰å…¨å› ç´ è€ƒè™‘çš„è™šæ‹Ÿåˆ†ç»„ï¼Œä¸åŒç»„çš„ç”¨æˆ·ä¸èƒ½ç›¸äº’è®¿é—®</li><li>Exchangeï¼šäº¤æ¢æœºï¼Œç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°äº¤æ¢æœºï¼Œå†æœ‰äº¤æ¢æœºå‘é€åˆ°é˜Ÿåˆ—ä¸­</li><li>Queueï¼šé˜Ÿåˆ—ï¼Œæ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«æ¶ˆè´¹è€…æ¶ˆè´¹</li><li>Bindingï¼šäº¤æ¢æœºå’Œé˜Ÿåˆ—çš„ç»‘å®šå…³ç³»</li><li>consumerï¼šæ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯çš„æœ€ç»ˆä½¿ç”¨è€…</li></ul><p>æ¶ˆæ¯ç”Ÿäº§è€…é€šè¿‡connectionè¿æ¥åˆ°RabbitMQï¼Œç„¶åå»ºç«‹è™šæ‹Ÿè¿æ¥[channel]ï¼Œé€šè¿‡channelå°†æ¶ˆæ¯å‘é€åˆ°exchangeï¼Œå› ä¸ºexchangeå’Œqueueç»‘å®šï¼Œæ‰€ä»¥ä¼šé€šè¿‡exchangeç›´æ¥å‘é€å¹¶ä¿å­˜åœ¨queueé˜Ÿåˆ—ä¸­ï¼Œæœ€åæ¶ˆè´¹è€…é€šè¿‡connectionè¿æ¥åˆ°RabbitMQï¼Œç„¶åå»ºç«‹è™šæ‹Ÿè¿æ¥[channel]ï¼Œé€šè¿‡channelä»queueä¸­è·å–å¹¶æ¶ˆè´¹æ¶ˆæ¯ã€‚</p><h3 id="2ã€RabbitMQ-å¸¸ç”¨çš„5ç§å·¥ä½œæ¨¡å¼ã€å…±7ç§ã€‘"><a href="#2ã€RabbitMQ-å¸¸ç”¨çš„5ç§å·¥ä½œæ¨¡å¼ã€å…±7ç§ã€‘" class="headerlink" title="2ã€RabbitMQ å¸¸ç”¨çš„5ç§å·¥ä½œæ¨¡å¼ã€å…±7ç§ã€‘"></a>2ã€RabbitMQ å¸¸ç”¨çš„5ç§å·¥ä½œæ¨¡å¼ã€å…±7ç§ã€‘</h3><ol><li><p>ç®€å•æ¨¡å¼ï¼ˆhello worldï¼‰<br>åœ¨ä¸‹å›¾ä¸­ï¼Œâ€œPâ€è¡¨ç¤ºæ¶ˆæ¯çš„ç”Ÿäº§è€…ã€producerã€‘ï¼Œâ€œCâ€è¡¨ç¤ºæ¶ˆè´¹è€…ã€consumerã€‘ï¼Œä¸­é—´çš„æ¡†æ˜¯ä¸€ä¸ªé˜Ÿåˆ—-RabbitMQä¿ç•™æ¶ˆæ¯çš„ç¼“å†²åŒºã€‚<br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fdb9c94c706947f7a7c1d4b343b29e5a~tplv-k3u1fbpfcp-watermark.image">  </p><blockquote><p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªç”Ÿäº§è€…ã€ä¸€ä¸ªé˜Ÿåˆ—ã€ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆ<code>å…¶å®è¿˜æœ‰ä¸€ä¸ªé»˜è®¤çš„ï¼Œä¸éœ€è¦æˆ‘ä»¬å£°æ˜çš„exchange</code>ï¼‰</p></blockquote></li><li><p>å·¥ä½œé˜Ÿåˆ—æ¨¡å¼<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a1156e55da414d21b5b2aa307616f7d1~tplv-k3u1fbpfcp-watermark.image">  </p><blockquote><p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªç”Ÿäº§è€…ã€ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä½†æ˜¯å­˜åœ¨<strong>å¤šä¸ªæ¶ˆè´¹è€…</strong>ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å…±åŒæ¶ˆè´¹é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹<strong>ä¸€æ¡æ¶ˆæ¯ åªä¼š è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</strong>ï¼ˆ<code>å…¶å®è¿˜æœ‰ä¸€ä¸ªé»˜è®¤çš„ï¼Œä¸éœ€è¦æˆ‘ä»¬å£°æ˜çš„exchange</code>ï¼‰</p></blockquote></li><li><p>å‘å¸ƒè®¢é˜…æ¨¡å¼<br>åœ¨ä¸‹å›¾ä¸­ï¼Œâ€œXâ€è¡¨ç¤ºäº¤æ¢æœºã€exchangeã€‘ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å£°æ˜ã€‚<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4393b1faa0304f0fb224666847ebc8a5~tplv-k3u1fbpfcp-watermark.image"></p><blockquote><p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªäº¤æ¢æœºï¼Œäº¤æ¢æœºç»‘å®šå¤šä¸ªé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—å­˜åœ¨ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šæ¶ˆè´¹ï¼ˆæ¯ä¸ªæ¶ˆè´¹è€…æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ä¸€è‡´çš„ï¼‰ã€‚</p></blockquote></li><li><p>Routing åŒ¹é…æ¨¡å¼<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6f1812d15194804889ff6ee1c1a798f~tplv-k3u1fbpfcp-watermark.image"></p><blockquote><p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªäº¤æ¢æœºï¼Œäº¤æ¢æœºç»‘å®šå¤šä¸ªé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—å­˜åœ¨ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚åœ¨ç»“æ„ä¸Šå’Œå‘å¸ƒè®¢é˜…æ¨¡å¼å®Œå…¨ä¸€è‡´ï¼Œ<strong>åŒºåˆ«åœ¨äºäº¤æ¢æœºç»‘å®šé˜Ÿåˆ—æ—¶ï¼Œç»™æ¯ä¸ªé˜Ÿåˆ—è®¾ç½®Routing keyå±æ€§ï¼Œç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šæºå¸¦Routing keyï¼Œæ ¹æ®Routing keyäº¤æ¢æœºä¼šå°†æ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„é˜Ÿåˆ—ä¸­</strong></p></blockquote></li><li><p>Topic åŒ¹é…æ¨¡å¼<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5ace17680d024f9a9e53841b004229c3~tplv-k3u1fbpfcp-watermark.image"></p><blockquote><p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªäº¤æ¢æœºï¼Œäº¤æ¢æœºç»‘å®šå¤šä¸ªé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—å­˜åœ¨ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚åœ¨ç»“æ„å’ŒåŸç†ä¸Šå’ŒRouting åŒ¹é…æ¨¡å¼éå¸¸ç›¸ä¼¼ï¼Œ<strong>åŒºåˆ«åœ¨äºRoutingåŒ¹é…æ¨¡å¼ä¸‹ï¼Œrouting key æ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œéœ€è¦å®ŒæˆåŒ¹é…ï¼Œè€ŒTopic åŒ¹é…æ¨¡å¼æ”¯æŒæ¨¡ç³ŠåŒ¹é…</strong>ã€‚<code>topic æ¨¡å¼é€šé…ç¬¦ï¼šâ€œ * â€ï¼šåŒ¹é…ä¸€ä¸ªè¯ï¼›â€œ # â€ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯ï¼Œams.* èƒ½åŒ¹é… ams.insertï¼› ams.# å¯ä»¥åŒ¹é… ams.insert.abc å’Œ ams.insert</code></p></blockquote><h3 id="3ã€RabbitMQ-å’ŒSpringBoot-çš„æ•´åˆ"><a href="#3ã€RabbitMQ-å’ŒSpringBoot-çš„æ•´åˆ" class="headerlink" title="3ã€RabbitMQ å’ŒSpringBoot çš„æ•´åˆ"></a>3ã€RabbitMQ å’ŒSpringBoot çš„æ•´åˆ</h3><p>æ•´åˆç›¸å…³ä»£ç å·²ä¸Šä¼ è‡³github <a href="https://github.com/zhouxh-z/spring-boot-rabbitmq">zhouxh-z</a></p><h4 id="3-1ã€ç”Ÿäº§è€…"><a href="#3-1ã€ç”Ÿäº§è€…" class="headerlink" title="3.1ã€ç”Ÿäº§è€…"></a>3.1ã€ç”Ÿäº§è€…</h4></li></ol><ul><li>jaråŒ…å¼•å…¥<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre></li><li>ymlé…ç½®æ–‡ä»¶<pre class=" language-proprities"><code class="language-proprities">spring:  rabbitmq:    port: 5672    username: guest    password: guest    host: 101.37.10.135    virtual-host: /    template:      exchange: xxxxExchange      default-receive-queue: xxxxQueue      routing-key: xxxx.#</code></pre></li><li>é…ç½®ç±»<br>é…ç½®ç±»çš„ä½œç”¨ï¼šé¡¹ç›®å¯åŠ¨ååœ¨ RabbitMQ ä¸­åˆ›å»ºé˜Ÿåˆ—ï¼Œåˆ›å»ºäº¤æ¢æœºï¼Œå¹¶å’Œé˜Ÿåˆ—ç»‘å®šã€‚<br>åˆ›å»ºæ—¶é—´ï¼šé¡¹ç›®å¯åŠ¨åç¬¬ä¸€æ¬¡è¿æ¥mqæ—¶ã€‚<code>å¦‚æœæ‰‹åŠ¨åˆ›å»ºé˜Ÿåˆ—/äº¤æ¢æœºï¼Œå¹¶ç»‘å®šï¼Œåˆ™ä¸éœ€è¦è¿™ä¸ªé…ç½®ç±»</code><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">public</span> BeanFactory beanFactory<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.rabbitmq.template.exchange}"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> String exchangeName<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.rabbitmq.template.default-receive-queue}"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> String queueName<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.rabbitmq.template.routing-key}"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> String routeName<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"exchange"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> Exchange <span class="token function">buildExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       <span class="token keyword">return</span> ExchangeBuilder<span class="token punctuation">.</span><span class="token function">topicExchange</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"queue"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> Queue <span class="token function">buildQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> QueueBuilder<span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span>queueName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"binder"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> Binding <span class="token function">buildBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        Queue queue <span class="token operator">=</span> <span class="token punctuation">(</span>Queue<span class="token punctuation">)</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"queue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Exchange exchange <span class="token operator">=</span> <span class="token punctuation">(</span>Exchange<span class="token punctuation">)</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"exchange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> BindingBuilder<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>routeName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li><li>æ¶ˆæ¯å‘é€ç±»<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerSender</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    RabbitTemplate rabbitTemplate<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.rabbitmq.template.exchange}"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> String exchangeName<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.rabbitmq.template.routing-key}"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> String routeName<span class="token punctuation">;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/sendMSG"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMSG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span>routeName<span class="token punctuation">,</span><span class="token string">"testMSG"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="3-2ã€æ¶ˆè´¹è€…"><a href="#3-2ã€æ¶ˆè´¹è€…" class="headerlink" title="3.2ã€æ¶ˆè´¹è€…"></a>3.2ã€æ¶ˆè´¹è€…</h4></li><li>ä¾èµ–å’Œé…ç½®æ–‡ä»¶<br>ä¸ç”Ÿäº§è€…ä¸€è‡´</li><li>æ¶ˆæ¯æ¥æ”¶ç±»<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ackMode = "MANUAL" å¦‚æœéœ€è¦æ‰‹åŠ¨ç­¾æ”¶æ¶ˆæ¯ï¼Œåˆ™è®¾ç½®ï¼Œå¦åˆ™ä¸éœ€è¦</span>    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"zhouxhQueue"</span><span class="token punctuation">,</span>ackMode <span class="token operator">=</span> <span class="token string">"MANUAL"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span>Message ms<span class="token punctuation">,</span> Channel channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ‰§è¡Œä¸šåŠ¡ï¼Œä¼ªä»£ç </span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ‰‹åŠ¨ç­¾æ”¶</span>        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ‹’æ”¶,ç¬¬äºŒä¸ª Boolean å…¥å‚è¡¨ç¤ºæ¶ˆæ¯æ˜¯å¦ è¿”å› å¯¹åˆ—ï¼Œfalseè¡¨ç¤ºæ¶ˆæ¯ç›´æ¥ä¸¢å¼ƒ</span>        <span class="token comment" spellcheck="true">// å¦‚æœè¿”å›é˜Ÿåˆ—ï¼Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ ï¼Œè¯¥æ¶ˆæ¯å°†ä¸€ç›´é‡æ–°è¢«æ¶ˆè´¹,éœ€è¦æ‰‹åŠ¨å®ç°é‡è¯•æ¬¡æ•°ï¼Œæ¯”å¦‚é‡è¯•æ¬¡æ•°ä¿å­˜åˆ°ç¼“å­˜ä¸­ï¼Œè¿›è¡Œæ‰‹åŠ¨åˆ¤æ–­</span>        <span class="token comment" spellcheck="true">//channel.basicNack(ms.getMessageProperties().getDeliveryTag(),true,true);</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="4ã€RebbitMQ-é«˜å¯ç”¨é›†ç¾¤æ­å»º"><a href="#4ã€RebbitMQ-é«˜å¯ç”¨é›†ç¾¤æ­å»º" class="headerlink" title="4ã€RebbitMQ é«˜å¯ç”¨é›†ç¾¤æ­å»º"></a>4ã€RebbitMQ é«˜å¯ç”¨é›†ç¾¤æ­å»º</h3></li></ul><ol><li>é¦–å…ˆæ­å»ºå¥½ä¸¤å°å•æœº RabbitMQï¼Œå¹¶åˆ†åˆ«å¯åŠ¨</li><li><code>rabbitmqctl stop_app</code> ä¸¤å°å•æœº RabbitMQ éƒ½åœæ­¢å¯¹å¤–æœåŠ¡</li><li><code>rabbitmqctl join_cluster rabbit@101.37.10.135</code> åˆ†åˆ«å°†ä¸¤å° RabbitMQ åŠ å…¥æœåŠ¡</li><li><code>rabbitmqctl start_app</code> åˆ†åˆ«å°†ä¸¤å° RabbitMQ é‡æ–°å¼€å¯å¯¹å¤–æœåŠ¡</li><li>é€šè¿‡<code>rabbitmqctl cluster_status</code> å°±å¯ä»¥æŸ¥çœ‹ RabbitMQ çš„é›†ç¾¤çŠ¶æ€äº†<h3 id="5ã€RabbitMQ-é«˜çº§ç‰¹æ€§"><a href="#5ã€RabbitMQ-é«˜çº§ç‰¹æ€§" class="headerlink" title="5ã€RabbitMQ é«˜çº§ç‰¹æ€§"></a>5ã€RabbitMQ é«˜çº§ç‰¹æ€§</h3></li></ol><h4 id="5-1ã€RabbitMQ-æ¶ˆæ¯çš„å¯é æ€§ä¼ é€’æ˜¯å¦‚ä½•ä¿éšœçš„ï¼Ÿ"><a href="#5-1ã€RabbitMQ-æ¶ˆæ¯çš„å¯é æ€§ä¼ é€’æ˜¯å¦‚ä½•ä¿éšœçš„ï¼Ÿ" class="headerlink" title="5.1ã€RabbitMQ æ¶ˆæ¯çš„å¯é æ€§ä¼ é€’æ˜¯å¦‚ä½•ä¿éšœçš„ï¼Ÿ"></a>5.1ã€RabbitMQ æ¶ˆæ¯çš„å¯é æ€§ä¼ é€’æ˜¯å¦‚ä½•ä¿éšœçš„ï¼Ÿ</h4><ol><li><p>ä»ç”Ÿäº§è€…åˆ°äº¤æ¢æœºï¼ŒConfirm ç¡®è®¤æ¨¡å¼(springboot-rabbitmq é»˜è®¤å¼€å¯)</p><ul><li><p>ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°exchangeæ—¶ï¼Œä¼šé€šè¿‡confirmå›è°ƒï¼Œå‘ŠçŸ¥ç”Ÿäº§è€…å‘é€çŠ¶æ€ã€‚</p><pre class=" language-java"><code class="language-java">  <span class="token comment" spellcheck="true">//å®šä¹‰å›è°ƒ</span>  rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">/**       *       * @param correlationData ç›¸å…³é…ç½®ä¿¡æ¯       * @param ack   exchangeäº¤æ¢æœº æ˜¯å¦æˆåŠŸæ”¶åˆ°äº†æ¶ˆæ¯ã€‚true æˆåŠŸï¼Œfalseä»£è¡¨å¤±è´¥       * @param cause å¤±è´¥åŸå›        */</span>      <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span>CorrelationData correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> String cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"confirmæ–¹æ³•è¢«æ‰§è¡Œäº†...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">//ack ä¸º  trueè¡¨ç¤º æ¶ˆæ¯å·²ç»åˆ°è¾¾äº¤æ¢æœº</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">//æ¥æ”¶æˆåŠŸ</span>              System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶æˆåŠŸæ¶ˆæ¯"</span> <span class="token operator">+</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">//æ¥æ”¶å¤±è´¥</span>              System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶å¤±è´¥æ¶ˆæ¯"</span> <span class="token operator">+</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">//åšä¸€äº›å¤„ç†ï¼Œè®©æ¶ˆæ¯å†æ¬¡å‘é€ã€‚</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ul></li><li><p>ä»äº¤æ¢æœºåˆ°é˜Ÿåˆ—ï¼Œreturn å›é€€æ¨¡å¼ ï¼ˆå¼€å¯ rabbitmq.publisher-returns: trueï¼‰</p><ul><li><p>exchange æ”¶åˆ°æ¶ˆæ¯åï¼Œé€šè¿‡routing keyåŒ¹é…å¯¹åº”çš„ queueæ—¶ï¼Œä¼šé€šè¿‡return å›è°ƒï¼Œå‘ŠçŸ¥ç”Ÿäº§è€…å‘é€çŠ¶æ€</p><pre class=" language-java"><code class="language-java">  <span class="token comment" spellcheck="true">//è®¾ç½®äº¤æ¢æœºå¤„ç†å¤±è´¥æ¶ˆæ¯çš„æ¨¡å¼   ä¸ºtrueçš„æ—¶å€™ï¼Œæ¶ˆæ¯è¾¾åˆ°ä¸äº† é˜Ÿåˆ—æ—¶ï¼Œä¼šå°†æ¶ˆæ¯é‡æ–°è¿”å›ç»™ç”Ÿäº§è€…</span>  rabbitTemplate<span class="token punctuation">.</span><span class="token function">setMandatory</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//å®šä¹‰å›è°ƒ</span>  rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ReturnCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">/**       *       * @param message   æ¶ˆæ¯å¯¹è±¡       * @param replyCode é”™è¯¯ç        * @param replyText é”™è¯¯ä¿¡æ¯       * @param exchange  äº¤æ¢æœº       * @param routingKey è·¯ç”±é”®       */</span>      <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">returnedMessage</span><span class="token punctuation">(</span>Message message<span class="token punctuation">,</span> <span class="token keyword">int</span> replyCode<span class="token punctuation">,</span> String replyText<span class="token punctuation">,</span> String exchange<span class="token punctuation">,</span> String routingKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"return æ‰§è¡Œäº†...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"message:"</span><span class="token operator">+</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"replyCode:"</span><span class="token operator">+</span>replyCode<span class="token punctuation">)</span><span class="token punctuation">;</span>          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"replyText:"</span><span class="token operator">+</span>replyText<span class="token punctuation">)</span><span class="token punctuation">;</span>          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"exchange:"</span><span class="token operator">+</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"routingKey:"</span><span class="token operator">+</span>routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">//å¤„ç†</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ul></li><li><p>ä»é˜Ÿåˆ—åˆ°æ¶ˆè´¹è€…ï¼Œç­¾æ”¶æœºåˆ¶ï¼ˆå¼€å¯ï¼šacknowledge-mode: manualï¼‰</p><ul><li>æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­æ‹‰å–æ¶ˆæ¯ï¼Œå¦‚æœåœ¨æ¶ˆæ¯æ¶ˆè´¹è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ‹’æ”¶æ¶ˆæ¯ï¼Œç„¶åé‡æ–°æ‹‰å–æ¶ˆæ¯ã€‚å¦åˆ™æ­£å¸¸ç­¾æ”¶ã€‚<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æ‰‹åŠ¨ç­¾æ”¶</span>channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// æ‹’æ”¶,ç¬¬äºŒä¸ª Boolean å…¥å‚è¡¨ç¤ºæ¶ˆæ¯æ˜¯å¦ è¿”å› å¯¹åˆ—</span><span class="token comment" spellcheck="true">// å¦‚æœè¿”å›é˜Ÿåˆ—ï¼Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ ï¼Œè¯¥æ¶ˆæ¯å°†ä¸€ç›´é‡æ–°è¢«æ¶ˆè´¹,éœ€è¦æ‰‹åŠ¨å®ç°é‡è¯•æ¬¡æ•°ï¼Œæ¯”å¦‚ä¿å­˜åˆ°ç¼“å­˜ä¸­</span>channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ul></li><li><p>exchangeã€queueã€message ç­‰æŒä¹…åŒ–</p><h4 id="5-2ã€é™æµ"><a href="#5-2ã€é™æµ" class="headerlink" title="5.2ã€é™æµ"></a>5.2ã€é™æµ</h4><p>åœ¨å¤§ä¿ƒæˆ–è€…ç§’æ€åœºæ™¯ä¸‹ï¼Œç”Ÿäº§è€…ç¬é—´æ‰“å…¥å¤§é‡æ¶ˆæ¯ï¼Œå¯èƒ½å› ä¸ºæ¶ˆè´¹è€…æ¶ˆè´¹èƒ½åŠ›ä¸å¤Ÿçš„é—®é¢˜ï¼Œå¯¼è‡´æœåŠ¡å®•æœºã€‚<br>åº”å¯¹è¿™ç§ç¬é—´çš„å¤§æµé‡ï¼Œæ¶ˆè´¹è€…çš„é™æµæ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p></li></ol><p>é€šè¿‡æŒ‡å®šç›‘å¬å™¨å·¥å‚ï¼Œå¯ä»¥è¾¾åˆ°é™æµçš„æ•ˆæœ</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMqConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> CachingConnectionFactory connectionFactory<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"listenerContainer"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> SimpleRabbitListenerContainerFactory <span class="token function">listenerContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        SimpleRabbitListenerContainerFactory factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleRabbitListenerContainerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factory<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è®¾ç½®é™æµæ•°é‡</span>        factory<span class="token punctuation">.</span><span class="token function">setPrefetchCount</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>åœ¨ <code>@RabbitListener</code> æ³¨è§£ä¸­æŒ‡å®š containerFactory</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"zhouxhQueue"</span><span class="token punctuation">,</span>ackMode <span class="token operator">=</span> <span class="token string">"MANUAL"</span><span class="token punctuation">,</span>containerFactory <span class="token operator">=</span> <span class="token string">"listenerContainer"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span>Message ms<span class="token punctuation">,</span> Channel channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ‰‹åŠ¨ç­¾æ”¶</span>    channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span></code></pre><h4 id="5-3ã€å»¶è¿Ÿé˜Ÿåˆ—"><a href="#5-3ã€å»¶è¿Ÿé˜Ÿåˆ—" class="headerlink" title="5.3ã€å»¶è¿Ÿé˜Ÿåˆ—"></a>5.3ã€å»¶è¿Ÿé˜Ÿåˆ—</h4><p>RabbitMQ æ²¡æœ‰è‡ªå¸¦çš„å»¶è¿Ÿé˜Ÿåˆ—ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ <strong>TTLé˜Ÿåˆ— å’Œ æ­»ä¿¡é˜Ÿåˆ—</strong> å®Œæˆå»¶è¿Ÿé˜Ÿåˆ—çš„æ•ˆæœã€‚</p><ol><li>TTLï¼šé…ç½®äº†è¶…æ—¶æ—¶é—´çš„é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¾¾åˆ°è¶…æ—¶æ—¶é—´è¿˜æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œä¼šå¾—åˆ é™¤</li><li>æ­»ä¿¡é˜Ÿåˆ—ï¼šå¯¹äºRabbitMQæ¥è¯´ï¼Œå…¶å®æ˜¯æ­»ä¿¡äº¤æ¢æœºï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ç»‘å®šä¸€ä¸ªæ­»ä¿¡äº¤æ¢æœºï¼Œç„¶åå½“æ¶ˆæ¯æ­»ä¿¡åå°±ä¼šé€šè¿‡è¿™ä¸ªæ­»ä¿¡äº¤æ¢æœºï¼Œè¿›å…¥ä¸€ä¸ªæ™®é€šé˜Ÿåˆ—ã€‚<br>ä¸‹å›¾ä¸­çš„â€œDLXâ€å…¶å®å°±æ˜¯DEAD LETTER EXCHANGEï¼ˆæ­»ä¿¡äº¤æ¢æœºï¼‰ã€‚<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/be55018fc8ec4983ae3c9b7bb64d38fd~tplv-k3u1fbpfcp-watermark.image"></li></ol><p><strong>è¿›å…¥æ­»å¿ƒé˜Ÿåˆ—çš„ä¸‰ç§æ–¹å¼</strong></p><ul><li>é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å·²ç»æ»¡äº†ï¼Œæ­¤æ—¶æ–°è¿›å…¥çš„æ¶ˆæ¯ä¼šç›´æ¥è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—</li><li>æ¶ˆè´¹è€…æ‹’ç»ç­¾æ”¶ï¼Œä¸”ä¸é‡å…¥é˜Ÿåˆ—</li><li>åŸé˜Ÿåˆ—è®¾ç½®äº†è¶…æ—¶æ—¶é—´ï¼Œæ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­è¾¾åˆ°è¶…æ—¶æ—¶é—´æ²¡æœ‰è¢«æ¶ˆè´¹</li></ul><p><strong>é‚£ä¹ˆå»¶è¿Ÿé˜Ÿåˆ—æ˜¯æ€ä¹ˆæ ¹æ®è¿™ä¸¤ç§é˜Ÿåˆ—å®Œæˆçš„å‘¢ï¼Ÿ</strong><br>ä»¥æˆ‘ä»¬åœ¨ç½‘ä¸Šè´­ç‰©ï¼Œä¸‹å•äº†ä½†æ˜¯è¿˜æ²¡ä»˜æ¬¾è¿™æ ·ä¸€ä¸ªåœºæ™¯æ¥è¯´æ˜ï¼š  </p><ol><li>é¦–å…ˆæˆ‘ä»¬åœ¨è®¢å•ç³»ç»Ÿä¸‹å•ï¼Œå°†è®¢å•ä¿¡æ¯å‘é€åˆ°TTLé˜Ÿåˆ—<sub>[å‡è®¾è®¢å•ä¿å­˜æ—¶é—´ä¸º30åˆ†é’Ÿï¼Œå³30åˆ†é’Ÿå†…ä»˜æ¬¾ï¼Œè®¢å•æœ‰æ•ˆï¼Œå¦åˆ™è®¢å•è¿‡æœŸ]</sub></li><li>æœŸé—´æˆ‘ä»¬éƒ½æ²¡æœ‰ä»˜æ¬¾ï¼Œé‚£ä¹ˆè¿‡äº†30åˆ†é’Ÿè¯¥è®¢å•ä¿¡æ¯ä¼šä»TTLé˜Ÿåˆ—ä¸­åˆ é™¤ã€‚</li><li>ä»TTLé˜Ÿåˆ—ä¸­åˆ é™¤çš„è®¢å•ä¼šè¢«å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼Œç„¶åè¿™ä¸ªæ¶ˆæ¯ä¼šè¢«åº“å­˜ç³»ç»Ÿæ¶ˆè´¹ã€‚åˆ¤æ–­æ˜¯å–æ¶ˆè®¢å•ï¼Œè¿˜æ˜¯æ­£å¸¸å‘è´§ã€‚<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/573a170d9bc6400b868596b28b701f96~tplv-k3u1fbpfcp-watermark.image"><h4 id="5-4ã€æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœï¼ˆæ¶ˆæ¯é‡å¤è¯»å–ï¼‰"><a href="#5-4ã€æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœï¼ˆæ¶ˆæ¯é‡å¤è¯»å–ï¼‰" class="headerlink" title="5.4ã€æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœï¼ˆæ¶ˆæ¯é‡å¤è¯»å–ï¼‰"></a>5.4ã€æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœï¼ˆæ¶ˆæ¯é‡å¤è¯»å–ï¼‰</h4>åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œæºå¸¦versionï¼Œåœ¨æ¶ˆè´¹è€…æ¶ˆè´¹å¹¶å°†æ¶ˆæ¯ä¿å­˜åœ¨æ•°æ®åº“æ—¶ï¼Œé€šè¿‡ä¹è§‚é”æœºåˆ¶ï¼Œä¿éšœå¹‚ç­‰æ€§ã€‚</li></ol><h4 id="5-5ã€æ¶ˆæ¯ç§¯å‹é—®é¢˜"><a href="#5-5ã€æ¶ˆæ¯ç§¯å‹é—®é¢˜" class="headerlink" title="5.5ã€æ¶ˆæ¯ç§¯å‹é—®é¢˜"></a>5.5ã€æ¶ˆæ¯ç§¯å‹é—®é¢˜</h4><p>ç”±äºå¤§ä¿ƒæˆ–è€…ç§’æ€ç­‰åœºæ™¯ï¼Œå¯¼è‡´çš„æ¶ˆæ¯ç§¯å‹é—®é¢˜ã€‚  </p><ol><li>é€šè¿‡å·¥ä½œé˜Ÿåˆ—æ¨¡å¼å¢åŠ æ¶ˆè´¹è€…ï¼Œæé«˜æ¶ˆæ¯æ¶ˆè´¹é€Ÿåº¦ã€‚</li><li>æ¶ˆè´¹è€…å…ˆå°†æ¶ˆæ¯å†™å…¥æ•°æ®åº“ï¼Œç„¶åä¸šåŠ¡ä»£ç ä»æ•°æ®åº“è¯»å–æ¶ˆæ¯è¿›è¡Œå¤„ç†</li></ol>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ä¸­é—´ä»¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¶ˆæ¯é˜Ÿåˆ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springæºç ç ”è¯»-AOP-ä¸‰æ­¥èµ°ï¼Ÿ</title>
      <link href="/2021/03/10/AOP-%E4%B8%89%E6%AD%A5%E8%B5%B0%EF%BC%9F/"/>
      <url>/2021/03/10/AOP-%E4%B8%89%E6%AD%A5%E8%B5%B0%EF%BC%9F/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡å°†åŸºäºjava-configï¼ˆæ³¨è§£ï¼‰ç ”è¯» spring-AOP æºç </p><h2 id="AOPçš„ä½¿ç”¨"><a href="#AOPçš„ä½¿ç”¨" class="headerlink" title="AOPçš„ä½¿ç”¨"></a>AOPçš„ä½¿ç”¨</h2><ol><li><p>é…ç½®ç±»ä¸Šæ·»åŠ <code>@EnableAspectJAutoProxy</code>æ³¨è§£ <sub>[å¼€å¯AOPåŠŸèƒ½]</sub></p></li><li><p>AOP beanå¯¹è±¡æ·»åŠ <code>@Aspect</code>æ³¨è§£</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Aspect</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AOPTest</span> <span class="token punctuation">{</span>     <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(* com.zhouxh.service.componentTest.*(..))"</span><span class="token punctuation">)</span>     <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pointCut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     <span class="token punctuation">}</span>     <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pointCut()"</span><span class="token punctuation">)</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"aop Before start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token annotation punctuation">@After</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pointCut()"</span><span class="token punctuation">)</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"aop After start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pointCut()"</span><span class="token punctuation">)</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">around</span><span class="token punctuation">(</span>ProceedingJoinPoint joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"aop Around start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"aop Around end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pointCut()"</span><span class="token punctuation">)</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterReturning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"aop AfterReturning start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pointCut()"</span><span class="token punctuation">)</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterThrowing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"aop AfterThrowing start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ol><span id="more"></span><h2 id="1-åŠ è½½åˆ‡é¢"><a href="#1-åŠ è½½åˆ‡é¢" class="headerlink" title="1. åŠ è½½åˆ‡é¢"></a>1. åŠ è½½åˆ‡é¢</h2><ol><li><p>æˆ‘ä»¬å†å¼€å¯AOPåŠŸèƒ½æ—¶ï¼Œåœ¨é…ç½®ç±»ä¸Šæ·»åŠ äº†<code>@EnableAspectJAutoProxy</code>æ³¨è§£ã€‚è¯¥æ³¨è§£åœ¨é…ç½®ç±»è¢«è§£ææ—¶ï¼Œä¼šåœ¨springå®¹å™¨ä¸­æ·»åŠ ä¸€ä¸ª<code>AnnotationAwareAspectJAutoProxyCreator</code>åç½®å¤„ç†å™¨ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@EnableAspectJAutoProxy</span></code></pre><p> è¿›å…¥è¯¥æ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥æ³¨è§£å‘spring å®¹å™¨ä¸­æ³¨å…¥äº†<code>AspectJAutoProxyRegistrar</code>ç±»</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>AspectJAutoProxyRegistrar<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">EnableAspectJAutoProxy</span> <span class="token punctuation">{</span></code></pre><p> è¿›å…¥<code>AspectJAutoProxyRegistrar</code>ç±»ï¼Œåªæœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ã€‚<br> è¿™ä¸ªå‡½æ•°åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š</p><ul><li>åœ¨springä¸­æ³¨å…¥äº†AnnotationAwareAspectJAutoProxyCreatoråç½®å¤„ç†å™¨</li><li>åˆ¤æ–­æ˜¯å¦è®¾ç½®proxyTargetClass å’Œ exposeProxyå±æ€§<ul><li>proxyTargetClass å±æ€§ï¼Œé»˜è®¤ä¸ºfalseï¼Œå¦‚æœä¸ºtrueæ—¶ï¼Œè¡¨ç¤ºç›¸å…³beanå¯¹è±¡åŠ¨æ€ä»£ç†å¼ºåˆ¶ä½¿ç”¨CGLIB</li><li>exposeProxyå±æ€§ï¼Œé»˜è®¤ä¸ºfalseï¼Œå¦‚æœä¸ºtrueï¼Œæœ‰jdkåŠ¨æ€ä»£ç†ç”Ÿæˆbeanå¯¹è±¡å‡ºç°æ–¹æ³•å†…éƒ¨è°ƒç”¨æ—¶ï¼Œä¹Ÿä¼šè§¦å‘AOPåŠŸèƒ½ã€‚<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>AnnotationMetadata importingClassMetadata<span class="token punctuation">,</span> BeanDefinitionRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">// åœ¨springä¸­æ³¨å…¥äº†AnnotationAwareAspectJAutoProxyCreatoråç½®å¤„ç†å™¨</span>AopConfigUtils<span class="token punctuation">.</span><span class="token function">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// è·å–æ³¨è§£@EnableAspectJAutoProxy</span>AnnotationAttributes enableAspectJAutoProxy <span class="token operator">=</span>       AnnotationConfigUtils<span class="token punctuation">.</span><span class="token function">attributesFor</span><span class="token punctuation">(</span>importingClassMetadata<span class="token punctuation">,</span> EnableAspectJAutoProxy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>enableAspectJAutoProxy <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦è®¾ç½®proxyTargetClass å’Œ exposeProxyå±æ€§</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableAspectJAutoProxy<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"proxyTargetClass"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      AopConfigUtils<span class="token punctuation">.</span><span class="token function">forceAutoProxyCreatorToUseClassProxying</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableAspectJAutoProxy<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"exposeProxy"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      AopConfigUtils<span class="token punctuation">.</span><span class="token function">forceAutoProxyCreatorToExposeProxy</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ul></li></ul></li><li><p>åœ¨<a href="https://juejin.cn/post/6912354445082755079">ã€Šspring IOCæºç è§£æã€‹</a>è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“spring_beanç¬¬ä¸€æ¬¡åˆå§‹åŒ–ä¼šè°ƒç”¨createBean()æ–¹æ³•åˆ›å»ºä¸€ä¸ªbeanå®ä¾‹ã€‚åœ¨beanè¢«åˆ›å»º<sub>ã€doCreateBeanæ–¹æ³•ã€‘</sub>å‰ï¼Œé€šè¿‡springæä¾›çš„æ‹“å±•ç‚¹<sub>ã€resolveBeforeInstantiationæ–¹æ³•ã€‘</sub>ï¼Œå°†åˆ‡ç‚¹å’Œé€šçŸ¥åŒ…è£…æˆ<code>Advisors</code>ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> Object <span class="token function">createBean</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">,</span> RootBeanDefinition mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>    <span class="token keyword">throws</span> BeanCreationException <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/** * çœç•¥éƒ¨åˆ†ä¸ç›¸å¹²ä»£ç  */</span><span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// spring å®¹å™¨æä¾›çš„æ‹“å±•ç‚¹ï¼Œä¼šåœ¨æ­¤å¤„è¿è¡Œspringå‰ç½®å¤„ç†å™¨</span>    Object bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªbeanå®ä¾‹</span>    Object beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Finished creating instance of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> <span class="token operator">|</span> ImplicitlyAppearedSingletonException ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// çœç•¥</span><span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// çœç•¥</span><span class="token punctuation">}</span></code></pre><p> è¿›å…¥ resolveBeforeInstantiationæ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨ <code>applyBeanPostProcessorsBeforeInstantiation</code> æ–¹æ³•å¾ªç¯è°ƒç”¨æ‰€æœ‰çš„å‰ç½®å¤„ç†å™¨ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> Object <span class="token function">applyBeanPostProcessorsBeforeInstantiation</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> beanClass<span class="token punctuation">,</span> String beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>BeanPostProcessor bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            InstantiationAwareBeanPostProcessor ibp <span class="token operator">=</span> <span class="token punctuation">(</span>InstantiationAwareBeanPostProcessor<span class="token punctuation">)</span> bp<span class="token punctuation">;</span>            Object result <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> result<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p> ä¹Ÿå°±æ˜¯åœ¨è¿™é‡Œè°ƒç”¨äº†æˆ‘ä»¬åœ¨<code>@EnableAspectJAutoProxy</code>æ³¨è§£ï¼Œç»™springå®¹å™¨ä¸­æ·»åŠ çš„<code>AnnotationAwareAspectJAutoProxyCreator</code>åç½®å¤„ç†å™¨ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> beanClass<span class="token punctuation">,</span> String beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>StringUtils<span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// isInfrastructureClass åˆ¤æ–­å½“å‰beanClassæ˜¯å¦è¢«@Aspectjæ³¨é‡Šï¼Œæ˜¯ è¿”å›trueï¼Œå¦åˆ™è¿”å›false</span>        <span class="token comment" spellcheck="true">// AOP ç±»ä¼šè¢«æ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼Œç„¶å ä¿å­˜åœ¨advisedBeansç¼“å­˜ä¸­</span>        <span class="token comment" spellcheck="true">// shouldSkip()æ–¹æ³•è§£æå„é€šçŸ¥ï¼Œå¹¶ä¸åˆ‡ç‚¹ä¸€èµ·åŒ…è£…æˆAdvisors</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><pre><code>    çœç•¥äº†éƒ¨åˆ†ä»£ç ``` return null;</code></pre><p> }</p><pre><code>`shouldSkip()`æ–¹æ³•è§£æå„é€šçŸ¥ï¼Œå¹¶ä¸åˆ‡ç‚¹ä¸€èµ·åŒ…è£…æˆ`Advisors`ã€‚``` javaprotected boolean shouldSkip(Class&lt;?&gt; beanClass, String beanName) &#123;    // TODO: æŸ¥è¯¢æ‰€æœ‰çš„é€šçŸ¥å¹¶æ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼Œæ–¹ä¾¿è°ƒç”¨æ—¶è·å–ã€‚    List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();    for (Advisor advisor : candidateAdvisors) &#123;        // åˆ¤æ–­AOPæ˜¯å¦æ˜¯é€šè¿‡xmlé…ç½®çš„ï¼Œå¦‚æœæ˜¯è¿”å›true ã€ä¸ºäº†å…¼å®¹xmlã€‘        if (advisor instanceof AspectJPointcutAdvisor &amp;&amp;                ((AspectJPointcutAdvisor) advisor).getAspectName().equals(beanName)) &#123;            return true;        &#125;    &#125;    return super.shouldSkip(beanClass, beanName);&#125;</code></pre><p> <code>findCandidateAdvisors()</code>æ–¹æ³•æŸ¥è¯¢æ‰€æœ‰çš„é€šçŸ¥å¹¶æ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼Œæ–¹ä¾¿è°ƒç”¨æ—¶è·å–ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> <span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æŸ¥æ‰¾æ‰€æœ‰ç»§æ‰¿äº† Advisor.classçš„ç±»ã€æˆ‘ä»¬é€šè¿‡æ³¨è§£çš„å½¢å¼ï¼Œæ‰€ä»¥æ­¤å¤„æŸ¥è¯¢ä¸ºç©ºã€‘</span>    List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> advisors <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Build Advisors for all AspectJ aspects in the bean factory.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorsBuilder <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// çœŸæ­£ç”Ÿæ•ˆçš„æ˜¯ buildAspectJAdvisors() è§£æå˜åˆ›å»º advisors</span>        advisors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorsBuilder<span class="token punctuation">.</span><span class="token function">buildAspectJAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> advisors<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p> é€šè¿‡<code>aspectJAdvisorsBuilder.buildAspectJAdvisors()</code>åˆ›å»ºadvisorså¹¶æ·»åŠ åˆ°ç¼“å­˜ä¸­ã€‚</p><ul><li>this.advisorFactory.getAdvisors(factory)é€šè¿‡ è§£æåˆ‡é¢ç±»ä¸­æ–¹æ³•ä¸Šçš„æ³¨è§£ <strong>è·å–é€šçŸ¥</strong> å’Œ <strong>åˆ‡ç‚¹</strong>ä¸€èµ·å°è£…åˆ°advisorä¸­ï¼Œå°†æ‰€æœ‰<code>advisors</code>æ ¹æ® Around.class, Before.class, After.class, AfterReturning.class, AfterThrowing.class çš„é¡ºåºè¿›è¡Œæ’åºã€‚</li><li>å¹¶å°†adviorsä¿å­˜åœ¨<code>advisorsCache</code>ç¼“å­˜ä¸­<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> <span class="token function">buildAspectJAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>Â·Â·Â·æ­¤å¤„çœç•¥éƒ¨åˆ†åˆ¤æ–­ä»£ç    Â·Â·Â·<span class="token comment" spellcheck="true">// é€šè¿‡è§£æclassç±»ä¸­çš„æ–¹æ³•ä¸Šçš„æ³¨è§£ æ ¹æ® Around.class, Before.class, After.class, AfterReturning.class, AfterThrowing.class æ’åº</span>List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> classAdvisors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advisorFactory<span class="token punctuation">.</span><span class="token function">getAdvisors</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å°†é€šçŸ¥å’Œåˆ‡ç‚¹ ä¸ å½“å‰bean ä¸€èµ·ä¿å­˜åœ¨advisorsCache ç¼“å­˜ä¸­</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>advisorsCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> classAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Â·Â·Â·   æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç    Â·Â·Â·<span class="token punctuation">}</span></code></pre></li></ul></li></ol><h2 id="2-åˆ›å»ºä»£ç†"><a href="#2-åˆ›å»ºä»£ç†" class="headerlink" title="2. åˆ›å»ºä»£ç†"></a>2. åˆ›å»ºä»£ç†</h2><p>spring_beanè¢«åˆ›å»ºå¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š1. beançš„å®ä¾‹åŒ–ï¼›2. beanå±æ€§çš„æ³¨å…¥ï¼›3. beançš„åˆå§‹åŒ–</p><p>AOP åˆ›å»ºåŠ¨æ€ä»£ç†åœ¨ç¬¬ä¸‰æ­¥ï¼šbeançš„åˆå§‹åŒ–ã€<code>exposedObject = initializeBean(beanName, exposedObject, mbd);</code>ã€‘  </p><p>åœ¨beançš„åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œspringæä¾›äº†ä¸€ä¸ªè°ƒç”¨åç½®å¤„ç†å™¨çš„æ‹“å±•ç‚¹ï¼Œå°±åœ¨æ­¤å¤„springä¼šè°ƒç”¨<code>AnnotationAwareAspectJAutoProxyCreator</code>åç½®å¤„ç†å™¨çš„åç½®å¤„ç†æ–¹æ³•ã€‚</p><p>è®©æˆ‘ä»¬æ¥è¿½æº¯æºç ï¼</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> Object <span class="token function">initializeBean</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">,</span> Object bean<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> RootBeanDefinition mbd<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Â·Â·Â·    çœç•¥éƒ¨åˆ†ä»£ç ï¼šå®Œæˆspring_beançš„åˆå§‹åŒ–å·¥ä½œ    Â·Â·Â·    <span class="token comment" spellcheck="true">// åœ¨è¿™ä¹‹å‰ï¼Œbeançš„åˆå§‹åŒ–å·²ç»å®Œæˆã€‚</span>    <span class="token comment" spellcheck="true">// springæä¾›çš„æ‹“å±•ç‚¹ï¼Œè°ƒç”¨åç½®å¤„ç†å™¨çš„åç½®å¤„ç†æ–¹æ³•</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> wrappedBean<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>åœ¨<code>applyBeanPostProcessorsAfterInitialization</code>æ–¹æ³•ä¸­å¾ªç¯æ‰€æœ‰åç½®å¤„ç†å™¨å¹¶è°ƒç”¨å¯¹åº”çš„åç½®å¤„ç†æ–¹æ³•ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>Object existingBean<span class="token punctuation">,</span> String beanName<span class="token punctuation">)</span>        <span class="token keyword">throws</span> BeansException <span class="token punctuation">{</span>    Object result <span class="token operator">=</span> existingBean<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>BeanPostProcessor processor <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Object current <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> result<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        result <span class="token operator">=</span> current<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><code>getBeanPostProcessors()</code>è·å–æ‰€æœ‰çš„åç½®å¤„ç†å™¨ï¼Œå…¶ä¸­å°±æœ‰ <code>AnnotationAwareAspectJAutoProxyCreator</code><br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5b5cc16652154aa7a36c74411d9569e1~tplv-k3u1fbpfcp-watermark.image"></p><p>é€šè¿‡è°ƒç”¨çˆ¶ç±»<code>AbstractAutoProxyCreator.postProcessAfterInitialization()</code>æ–¹æ³• â€”&gt; æœ€ç»ˆè°ƒç”¨<code>wrapIfNecessary()</code>æ–¹æ³•ç”ŸæˆåŠ¨æ€ä»£ç†ã€‚</p><pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> Object <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Object bean<span class="token punctuation">,</span> String beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Object cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token operator">!=</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> Object <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>Object bean<span class="token punctuation">,</span> String beanName<span class="token punctuation">,</span> Object cacheKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ä¸éœ€è¦AOPå¢å¼ºçš„ç±»ï¼Œç›´æ¥è¿”å›åŸå§‹å¯¹è±¡ï¼Œä¸éœ€è¦åŠ¨æ€ä»£ç†</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å†æ¬¡åˆ¤æ–­æ˜¯å¦éœ€è¦å¢å¼ºï¼Œä¸éœ€è¦çš„ç›´æ¥è¿”å›</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å¦‚æœéœ€è¦AOP å¢å¼ºï¼Œåˆ›å»ºåŠ¨æ€ä»£ç†</span>       <span class="token comment" spellcheck="true">// é€šè¿‡ AspectJ çš„ api åˆ¤æ–­å½“å‰ç±»ä¸­å“ªäº›æ–¹æ³•ç¬¦åˆå“ªäº›é€šçŸ¥ã€é€šè¿‡åˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œé€‰æ‹©éœ€è¦å¢å¼ºçš„å†…å®¹ã€‘</span>    Object<span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>specificInterceptors <span class="token operator">!=</span> DO_NOT_PROXY<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// åˆ›å»ºåŠ¨æ€ä»£ç† </span>        Object proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>                bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SingletonTargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> bean<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªç–‘é—®ï¼šAOPåŠ¨æ€ä»£ç†æ˜¯æ€ä¹ˆé€‰æ‹©JDKåŠ¨æ€ä»£ç† è¿˜æ˜¯ CGLIBåŠ¨æ€ä»£ç†çš„ï¼Ÿ</strong></p><p>ç»§ç»­è·Ÿè¿›<code>createProxy()</code>æ–¹æ³•ï¼Œæœ€ç»ˆè¿›å…¥<code>DefaultAopProxyFactory.createAopProxy()</code>æ–¹æ³•</p><ul><li>isProxyTargetClass() â€”-&gt; æˆ‘ä»¬åœ¨@EnableAspectJAutoProxy()æ³¨è§£ä¸­è®¾ç½® proxyTargetClass = trueï¼› <pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>proxyTargetClass <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></code></pre></li><li>hasNoUserSuppliedProxyInterfaces() â€”-&gt; true è¡¨ç¤º å½“å‰å¢å¼ºç±»æ²¡æœ‰å®ç°ä»»ä½•æ¥å£<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> AopProxy <span class="token function">createAopProxy</span><span class="token punctuation">(</span>AdvisedSupport config<span class="token punctuation">)</span> <span class="token keyword">throws</span> AopConfigException <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isOptimize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasNoUserSuppliedProxyInterfaces</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>targetClass <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AopConfigException</span><span class="token punctuation">(</span><span class="token string">"TargetSource cannot determine target class: "</span> <span class="token operator">+</span>                  <span class="token string">"Either an interface or a target is required for proxy creation."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// å¦‚æœç›®æ ‡å¢å¼ºç±»ï¼Œæ˜¯ä¸€ä¸ªæ¥å£ æˆ–è€… æ˜¯ä¸€ä¸ªä»£ç†ç±» ä¹Ÿä¼šä½¿ç”¨JDKåŠ¨æ€ä»£ç†</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>targetClass<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> Proxy<span class="token punctuation">.</span><span class="token function">isProxyClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ObjenesisCglibAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ul><p><strong>çœ‹å®Œè¿™éƒ¨åˆ†ä»£ç æˆ‘ä»¬ä¹Ÿèƒ½å¾—å‡ºä¸Šé¢é—®é¢˜çš„ç­”æ¡ˆäº†</strong></p><ol><li>å¦‚æœåœ¨å¼€å¯AOPçš„æ³¨è§£<code>@EnableAspectJAutoProxy(proxyTargetClass = true)</code>ä¸­æ·»åŠ äº†<code>proxyTargetClass = true</code>ï¼Œé‚£ä¹ˆspringä¼šä½¿ç”¨CGLIBåŠ¨æ€ä»£ç†ã€‚</li><li>å¦‚æœç›®æ ‡å¢å¼ºç±»æ²¡æœ‰ç»§æ‰¿ä»»ä½•æ¥å£ï¼Œé‚£ä¹ˆspringä¼šä½¿ç”¨CGLIBåŠ¨æ€ä»£ç†ã€‚</li><li>å¦‚æœç›®æ ‡å¢å¼ºç±»ï¼Œæ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…æ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼Œä¹Ÿä¼šä½¿ç”¨JDKåŠ¨æ€ä»£ç†</li><li>å¦åˆ™ï¼Œä¼šä½¿ç”¨JDKåŠ¨æ€ä»£ç†<h2 id="3-è°ƒç”¨ä»£ç†"><a href="#3-è°ƒç”¨ä»£ç†" class="headerlink" title="3. è°ƒç”¨ä»£ç†"></a>3. è°ƒç”¨ä»£ç†</h2>æˆ‘ä»¬çŸ¥é“è¢«ä»£ç†ç±»çš„æ–¹æ³•è¢«æ‰§è¡Œæ—¶ï¼Œä¼šå…ˆè°ƒç”¨ä»£ç†ç±»çš„ä»£ç†æ–¹æ³•ã€jdkåŠ¨æ€ä»£ç†çš„invoke()/CGLIBåŠ¨æ€ä»£ç†çš„intercept()ã€‘ã€‚</li></ol><p>æˆ‘ä»¬å°†ä»¥CGLIBåŠ¨æ€ä»£ç†ä¸ºä¾‹ï¼Œç ”è¯»Spring AOPæ˜¯å¦‚æœè°ƒç”¨ä»£ç†çš„ã€‚</p><p>å½“è¢«å¢å¼ºç±»çš„æ–¹æ³•è¢«æ‰§è¡Œæ—¶ï¼Œspringä¼šå…ˆè°ƒç”¨CglibAopProxyçš„å†…éƒ¨ç±»DynamicAdvisedInterceptor.intercept()æ–¹æ³•</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">intercept</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> MethodProxy methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>    Object oldProxy <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">boolean</span> setProxyContext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    Object target <span class="token operator">=</span> null<span class="token punctuation">;</span>    TargetSource targetSource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>exposeProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>            oldProxy <span class="token operator">=</span> AopContext<span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>            setProxyContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        target <span class="token operator">=</span> targetSource<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> null <span class="token operator">?</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åŠ è½½åˆ‡é¢æ—¶ï¼Œå°è£…å¥½çš„adviorsé›†åˆ</span>        List<span class="token operator">&lt;</span>Object<span class="token operator">></span> chain <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>        Object retVal<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰å°è£…å¥½çš„adviorsï¼Œç›´æ¥è°ƒç”¨å¯¹åº”æ–¹æ³•</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> Modifier<span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Object<span class="token punctuation">[</span><span class="token punctuation">]</span> argsToUse <span class="token operator">=</span> AopProxyUtils<span class="token punctuation">.</span><span class="token function">adaptArgumentsIfNecessary</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>            retVal <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> argsToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// AOP æ‰§è¡Œé€šçŸ¥çš„å…¥å£</span>            retVal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CglibMethodInvocation</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> methodProxy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        retVal <span class="token operator">=</span> <span class="token function">processReturnType</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> retVal<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>targetSource<span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            targetSource<span class="token punctuation">.</span><span class="token function">releaseTarget</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>setProxyContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Restore old proxy.</span>            AopContext<span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>oldProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä»¥ä¸Šä»£ç æ ¸å¿ƒåœ¨äºï¼šretVal = new CglibMethodInvocation(proxy, target, method, args, targetClass, chain, methodProxy).proceed(); è¯¥æ–¹æ³•æ˜¯ AOP æ‰§è¡Œé€šçŸ¥çš„å…¥å£ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// currentInterceptorIndex åˆå§‹åŒ–æ—¶ä¸º -1</span>    <span class="token comment" spellcheck="true">// å¦‚æœæ‰§è¡Œåˆ°AOPä¸­å£°æ˜çš„æœ€åä¸€ä¸ªé€šçŸ¥ï¼Œè°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentInterceptorIndex <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorsAndDynamicMethodMatchers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ç›®æ ‡å¢å¼ºæ–¹æ³•</span>        <span class="token keyword">return</span> <span class="token function">invokeJoinpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// interceptorsAndDynamicMethodMatchers åŒ…å«æ‰€æœ‰çš„é€šçŸ¥çš„é›†åˆï¼Œæ¯æ¬¡è·å–ä¸‹ä¸€ä¸ªé€šçŸ¥</span>    Object interceptorOrInterceptionAdvice <span class="token operator">=</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorsAndDynamicMethodMatchers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentInterceptorIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptorOrInterceptionAdvice <span class="token keyword">instanceof</span> <span class="token class-name">InterceptorAndDynamicMethodMatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†ä»£ç </span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åœ¨æ­¤å¤„è°ƒç”¨å¯¹åº”é€šçŸ¥çš„å¯¹åº”ç±»</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>MethodInterceptor<span class="token punctuation">)</span> interceptorOrInterceptionAdvice<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>invoke()æ–¹æ³•ä¼šæ›´æ ¹æ®ä¸‹å›¾é¡ºåºä¾æ¬¡è°ƒç”¨ã€‚<br><code>interceptorsAndDynamicMethodMatchers</code>ä¸­çš„å¯¹è±¡</p><h3 id="è°ƒç”¨æ—¶åºå›¾"><a href="#è°ƒç”¨æ—¶åºå›¾" class="headerlink" title="è°ƒç”¨æ—¶åºå›¾"></a>è°ƒç”¨æ—¶åºå›¾</h3><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/182dd05090e04b1babd8bf5a8d4f6b15~tplv-k3u1fbpfcp-watermark.image"></p><h4 id="ç¯ç»•é€šçŸ¥ç±»-AspectJAroundAdvice"><a href="#ç¯ç»•é€šçŸ¥ç±»-AspectJAroundAdvice" class="headerlink" title="ç¯ç»•é€šçŸ¥ç±» - AspectJAroundAdvice"></a>ç¯ç»•é€šçŸ¥ç±» - AspectJAroundAdvice</h4><p>è¯¥ç±»æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„æ–¹æ³•ï¼Œå°±æ˜¯è°ƒç”¨AOPä¸­è¢«@Aroundæ³¨é‡Šçš„æ–¹æ³•</p><pre class=" language-JAVA"><code class="language-JAVA">public Object invoke(MethodInvocation mi) throws Throwable {    if (!(mi instanceof ProxyMethodInvocation)) {        throw new IllegalStateException("MethodInvocation is not a Spring ProxyMethodInvocation: " + mi);    }    ProxyMethodInvocation pmi = (ProxyMethodInvocation) mi;    ProceedingJoinPoint pjp = lazyGetProceedingJoinPoint(pmi);    JoinPointMatch jpm = getJoinPointMatch(pmi);       // è°ƒç”¨ç¯ç»•é€šçŸ¥æ–¹æ³•    return invokeAdviceMethod(pjp, jpm, null, null);}</code></pre><p>åœ¨ç¯ç»•é€šçŸ¥æ–¹æ³•ä¸­ï¼Œå…ˆè¿›è¡Œå‰ç½®é€šçŸ¥ï¼Œç„¶åå”¤é†’ä¸€ä¸ªé€šçŸ¥ï¼Œæœ€åè¿›è¡Œåç½®é€šçŸ¥ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pointCut()"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">around</span><span class="token punctuation">(</span>ProceedingJoinPoint joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"aop Around start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"aop Around end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="å‰ç½®é€šçŸ¥-MethodBeforeAdviceInterceptor"><a href="#å‰ç½®é€šçŸ¥-MethodBeforeAdviceInterceptor" class="headerlink" title="å‰ç½®é€šçŸ¥ - MethodBeforeAdviceInterceptor"></a>å‰ç½®é€šçŸ¥ - MethodBeforeAdviceInterceptor</h4><p>å…ˆè°ƒç”¨AOPä¸­è¢«@Beforeæ³¨é‡Šçš„æ–¹æ³•ï¼Œç„¶åå”¤é†’ä¸‹ä¸€é€šçŸ¥</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>MethodInvocation mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>advice<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>mi<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="åç½®é€šçŸ¥-AspectJAfterAdvice"><a href="#åç½®é€šçŸ¥-AspectJAfterAdvice" class="headerlink" title="åç½®é€šçŸ¥ - AspectJAfterAdvice"></a>åç½®é€šçŸ¥ - AspectJAfterAdvice</h4><p>å…ˆå”¤é†’ä¸‹ä¸€é€šçŸ¥ï¼Œå†è°ƒç”¨AOPä¸­è¢«@Afteræ³¨é‡Šçš„æ–¹æ³•ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>MethodInvocation mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token function">invokeAdviceMethod</span><span class="token punctuation">(</span><span class="token function">getJoinPointMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="åç½®è¿”å›é€šçŸ¥-AfterReturningAdviceInterceptor"><a href="#åç½®è¿”å›é€šçŸ¥-AfterReturningAdviceInterceptor" class="headerlink" title="åç½®è¿”å›é€šçŸ¥ - AfterReturningAdviceInterceptor"></a>åç½®è¿”å›é€šçŸ¥ - AfterReturningAdviceInterceptor</h4><p>å”¤é†’ä¸‹ä¸€é€šçŸ¥ï¼Œå†è°ƒç”¨AOPä¸­è¢«@AfterReturningæ³¨é‡Šçš„æ–¹æ³•ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>MethodInvocation mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>    Object retVal <span class="token operator">=</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>advice<span class="token punctuation">.</span><span class="token function">afterReturning</span><span class="token punctuation">(</span>retVal<span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> retVal<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="åç½®å¼‚å¸¸é€šçŸ¥-AspectJAfterThrowingAdvice"><a href="#åç½®å¼‚å¸¸é€šçŸ¥-AspectJAfterThrowingAdvice" class="headerlink" title="åç½®å¼‚å¸¸é€šçŸ¥ - AspectJAfterThrowingAdvice"></a>åç½®å¼‚å¸¸é€šçŸ¥ - AspectJAfterThrowingAdvice</h4><p>å…ˆæ‰§è¡Œä¸‹ä¸€é€šçŸ¥ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ï¼Œå†æ‰§è¡Œ@AfterThrowingæ³¨é‡Šçš„æ–¹æ³•ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>MethodInvocation mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldInvokeOnThrowing</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">invokeAdviceMethod</span><span class="token punctuation">(</span><span class="token function">getJoinPointMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>åœ¨å”¤é†’ä¸‹ä¸€é€šçŸ¥å‰ï¼Œä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¸‹ä¸€é€šçŸ¥ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œç›´æ¥è°ƒç”¨ç›®æ ‡å¢å¼ºæ–¹æ³•ã€‚</strong></p><p>è¯¥åˆ¤æ–­åœ¨<code>ReflectiveMethodInvocation.proceed()</code>æ–¹æ³•ä¸­</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// currentInterceptorIndex åˆå§‹åŒ–æ—¶ä¸º -1</span>    <span class="token comment" spellcheck="true">// å¦‚æœæ‰§è¡Œåˆ°AOPä¸­å£°æ˜çš„æœ€åä¸€ä¸ªé€šçŸ¥ï¼Œè°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentInterceptorIndex <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorsAndDynamicMethodMatchers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ç›®æ ‡å¢å¼ºæ–¹æ³•</span>        <span class="token keyword">return</span> <span class="token function">invokeJoinpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    Â·Â·Â·Â·    Â·Â·Â·Â·<span class="token punctuation">}</span></code></pre><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li><p>springä¼šåœ¨doCreateBeanä¹‹å‰ï¼Œä¼šè°ƒç”¨ spring æä¾›çš„æ‹“å±•ç‚¹ã€resolveBeforeInstantiationã€‘ï¼Œä»æ‰€æœ‰ beanDefinitionMap ä¸­è·å–æ‰€æœ‰çš„ Object ç±»å‹çš„ç±»ï¼Œå¾ªç¯åˆ¤æ–­å¹¶è·å–å“ªä¸ªç±»è¢« @Aspectj æ³¨è§£æ³¨é‡Šã€‚ç„¶åè§£æè¯¥ç±»ä¸­è¢« @Beforeã€@Afterã€@Aroundã€@AfterReturningã€@AfterThrowing æ³¨è§£æ³¨é‡Šçš„æ–¹æ³•ï¼Œå¹¶ä¸ @Pointcut æ³¨é‡Šçš„åˆ‡ç‚¹ä¸€èµ·å°è£…åœ¨ adviors ä¸­ã€‚</p></li><li><p>åœ¨ spring åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼Œè°ƒç”¨æ‰€æœ‰åç½®å¤„ç†å™¨çš„åç½®å¤„ç†æ–¹æ³•ï¼Œè·å–æ‰€æœ‰çš„ adviors å’Œå½“å‰ç±»è¿›è¡ŒåŒ¹é…ã€åŒ¹é…æ–¹æ³•æ˜¯è°ƒç”¨AspectJçš„å†…éƒ¨APIã€‘ã€‚åŒ¹é…æˆåŠŸçš„ç±»å†ç”± AOPProxyFactory æ ¹æ®ã€æ˜¯å¦æœ‰æ¥å£ã€æ˜¯å¦æœ‰proxyTargetClass = trueã€‘é€‰æ‹©ä½¿ç”¨CGLIBåŠ¨æ€ä»£ç†è¿˜æ˜¯JDKåŠ¨æ€ä»£ç†ã€‚</p></li><li><p>åœ¨ç›®æ ‡å¢å¼ºæ–¹æ³•è¢«æ‰§è¡Œæ—¶ï¼Œspring ä¼šå°†adviorsè½¬æ¢æˆInterceptorï¼Œç„¶åé€šè¿‡è´£ä»»é“¾çš„æ¨¡å¼ä¸€æ¬¡è¿›è¡Œè°ƒç”¨ã€‚</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€æ–‡è§£è¯» zookeeper</title>
      <link href="/2021/03/09/%E4%B8%80%E6%96%87%E8%A7%A3%E8%AF%BB-zookeeper/"/>
      <url>/2021/03/09/%E4%B8%80%E6%96%87%E8%A7%A3%E8%AF%BB-zookeeper/</url>
      
        <content type="html"><![CDATA[<h2 id="zookeeper-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#zookeeper-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="zookeeper æ˜¯ä»€ä¹ˆï¼Ÿ"></a>zookeeper æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>å®˜æ–¹æ–‡æ¡£æ˜¯è¿™æ ·è§£è¯»zookeeperçš„ï¼šå®ƒæ˜¯ä¸€ä¸ª<strong>åˆ†å¸ƒå¼åè°ƒæ¡†æ¶</strong>ï¼Œæ˜¯Apache Hadoop çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥ <strong>è§£å†³åˆ†å¸ƒå¼åº”ç”¨ä¸­</strong> ç»å¸¸é‡åˆ°çš„ä¸€äº› <strong>æ•°æ®ç®¡ç†é—®é¢˜</strong>ï¼Œå¦‚ï¼šç»Ÿä¸€å‘½åæœåŠ¡ã€çŠ¶æ€åŒæ­¥æœåŠ¡ã€é›†ç¾¤ç®¡ç†ã€åˆ†å¸ƒå¼åº”ç”¨é…ç½®é¡¹çš„ç®¡ç†ç­‰ã€‚</p><h2 id="zookeeperçš„ä¸¤å¤§åŸºæœ¬ç‰¹æ€§"><a href="#zookeeperçš„ä¸¤å¤§åŸºæœ¬ç‰¹æ€§" class="headerlink" title="zookeeperçš„ä¸¤å¤§åŸºæœ¬ç‰¹æ€§"></a>zookeeperçš„ä¸¤å¤§åŸºæœ¬ç‰¹æ€§</h2><h3 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><p>Zookeeper ç»´æŠ¤ä¸€ä¸ªç±»ä¼¼Linuxæ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®ç»“æ„ã€‚<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5beb4fd3fcba47f4b520c280ade966a4~tplv-k3u1fbpfcp-watermark.image">  </p><span id="more"></span><p>â€œ/â€å¯ä»¥ç†è§£ä¸ºæ ¹ç›®å½•ï¼ŒåŠå…¶å­ç›®å½•é¡¹éƒ½è¢«ç§°ä½œä¸º znode(ç›®å½•èŠ‚ç‚¹)ï¼Œå’Œæ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè‡ªç”±çš„å¢åŠ ã€åˆ é™¤znodeï¼Œåœ¨ä¸€ä¸ªznodeä¸‹å¢åŠ ã€åˆ é™¤å­znodeã€‚</p><p>zookeeper æœ‰6ç§èŠ‚ç‚¹ç±»å‹ï¼š</p><ol><li>PERSISTENT - æŒä¹…åŒ–ç›®å½•èŠ‚ç‚¹<ul><li>ç›®å½•èŠ‚ç‚¹ä¸€ç»åˆ›å»ºï¼Œåªè¦ä¸æ‰‹åŠ¨åˆ é™¤è¯¥èŠ‚ç‚¹ï¼Œä»–å°†æ°¸è¿œå­˜åœ¨ã€‚å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥ï¼ŒèŠ‚ç‚¹ä¸ä¼šåˆ é™¤ã€‚</li></ul></li><li>PERSISTENT_SEQUENTIAL - æŒä¹…åŒ–é¡ºåºç¼–å·ç›®å½•èŠ‚ç‚¹<ul><li>é¡ºåºèŠ‚ç‚¹åœ¨æŒèŠ‚åŒ–èŠ‚ç‚¹çš„åŸºç¡€ä¸Šï¼Œå¯¹ç›®å½•èŠ‚ç‚¹è¿›è¡Œé¡ºåºæ ‡å·</li></ul></li><li>EPHEMERAL - ä¸´æ—¶ç›®å½•èŠ‚ç‚¹<ul><li>ä¸€æ¬¡sessionä¸­æœ‰æ•ˆï¼Œsession è¿‡æœŸå°±ä¼šè¢«åˆ é™¤ã€‚å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥åï¼Œå“ªæ€•çŸ­æ—¶é—´å†…é‡è¿ï¼Œåªè¦ä¸æ˜¯åŒä¸€sessionç™»å½•ï¼Œè¯¥èŠ‚ç‚¹ä¹Ÿä¼šåˆ é™¤ã€‚</li></ul></li><li>EPHEMERAL_SEQUENTIAL - ä¸´æ—¶é¡ºåºç¼–å·ç›®å½•èŠ‚ç‚¹<ul><li>ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œåœ¨ä¸´æ—¶èŠ‚ç‚¹çš„åŸºç¡€ä¸Šï¼Œå¯¹ç›®å½•èŠ‚ç‚¹è¿›è¡Œé¡ºåºæ ‡å·</li></ul></li><li>TTLèŠ‚ç‚¹<ul><li>å¯è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä¸€æ—¦è¶…è¿‡é™å®šæ—¶é—´å°±ä¼šè¢«åˆ é™¤ï¼Œzkåå°ç»´æŠ¤äº†ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯60ç§’æ‰«æä¸€æ¬¡ï¼Œè¿‡æœŸçš„åˆ é™¤ã€‚ã€é»˜è®¤ç¦ç”¨ï¼Œåªèƒ½é€šè¿‡ç³»ç»Ÿé…ç½®zookeeper.extendedTypesEnabled=true å¼€å¯ï¼Œä¸ç¨³å®šã€‘</li></ul></li><li>Container - å®¹å™¨èŠ‚ç‚¹<ul><li>3.5.3 ç‰ˆæœ¬æ–°å¢ï¼Œæ–°å»ºçš„å®¹å™¨èŠ‚ç‚¹å’Œæ™®é€šèŠ‚ç‚¹æ— å¼‚ï¼Œä¸€æ—¦å®¹å™¨èŠ‚ç‚¹ä¸‹æ–°å»ºè¿‡å­èŠ‚ç‚¹ï¼Œæœ€åæ¸…ç©ºå­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¯¥å®¹å™¨èŠ‚ç‚¹ä¹Ÿä¼šåœ¨æœªæ¥è¢«åˆ é™¤ã€‚ã€zkåå°ç»´æŠ¤äº†ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯60ç§’æ‰«æä¸€æ¬¡ã€‘<h3 id="èŠ‚ç‚¹ç›‘å¬æœºåˆ¶"><a href="#èŠ‚ç‚¹ç›‘å¬æœºåˆ¶" class="headerlink" title="èŠ‚ç‚¹ç›‘å¬æœºåˆ¶"></a>èŠ‚ç‚¹ç›‘å¬æœºåˆ¶</h3>zookeeper æœåŠ¡ç«¯æä¾›èŠ‚ç‚¹ç›‘å¬åŠŸèƒ½ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯æ„ŸçŸ¥åˆ°æœåŠ¡ç«¯èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–ã€‚<br>zookeeper æä¾›äº†ä¸‰ç§ç›‘å¬æ–¹å¼ï¼š</li></ul></li><li>ç›‘å¬æŸä¸€èŠ‚ç‚¹ï¼ˆget -w /pathï¼‰<ul><li>å½“è¯¥èŠ‚ç‚¹çš„è¢«åˆ é™¤ï¼Œæˆ–è€…æ•°æ®å‘ç”Ÿä¿®æ”¹æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šé€šçŸ¥å®¢æˆ·ç«¯èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–ã€åªä¼šå‘ŠçŸ¥æ˜¯èŠ‚ç‚¹è¢«åˆ é™¤ï¼Œè¿˜æ˜¯èŠ‚ç‚¹ä¸­çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œè€Œä¸ä¼šå‘ŠçŸ¥æ•°æ®å˜åŒ–çš„ç»“æœï¼Œéœ€è¦å®¢æˆ·ç«¯æ‰‹åŠ¨è·å–æ–°æ•°æ®ã€‘</li></ul></li><li>ç›‘å¬æŸä¸€ç›®å½•ï¼ˆls -w /pathï¼‰<ul><li>å½“è¯¥ç›®å½•ä¸‹æœ‰å­èŠ‚ç‚¹æ–°å¢æˆ–è€…åˆ é™¤ï¼ŒæœåŠ¡ç«¯ä¼šé€šçŸ¥å®¢æˆ·ç«¯</li></ul></li><li>ç›‘å¬æŸä¸ªç›®å½•çš„é€’å½’å­èŠ‚ç‚¹ï¼ˆls -R -w /pathï¼‰<ul><li>å½“è¯¥æ ¹ç›®å½•çš„è¢«åˆ é™¤ã€æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œæˆ–è€…å­ç›®å½•æœ‰æ–°å¢åˆ é™¤æ—¶ï¼Œä¼šé€šçŸ¥å®¢æˆ·ç«¯</li></ul></li></ol><p><strong>æ³¨ï¼šzookeeper æ‰€æœ‰çš„ç›‘å¬æœºåˆ¶éƒ½æ˜¯å•æ¬¡ç”Ÿæ•ˆï¼Œä¸€æ—¦è§¦å‘ï¼Œç›‘å¬äº‹ä»¶å°±ä¼šè¢«ç§»é™¤ã€‚å¦‚æœç›‘å¬çš„æ˜¯ç›®å½•çš„é€’å½’å­èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè§¦å‘ä¸€æ¬¡ã€‚</strong></p><h3 id="zookeeper-çš„ä½¿ç”¨åœºæ™¯"><a href="#zookeeper-çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="zookeeper çš„ä½¿ç”¨åœºæ™¯"></a>zookeeper çš„ä½¿ç”¨åœºæ™¯</h3><p>åŸºäºzookeeperçš„ä¸¤å¤§ç‰¹æ€§ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®Œæˆ</p><ol><li><p><strong>åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ</strong>/<code>åˆ†å¸ƒå¼æ³¨å†Œä¸­å¿ƒ</code>ï¼šåˆ©ç”¨zkçš„æŒä¹…åŒ–èŠ‚ç‚¹ä»¥åŠç›‘å¬æœºåˆ¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å°† <strong>é…ç½®</strong>/ <code>åº”ç”¨ä¿¡æ¯</code> ä¿å­˜åœ¨zkçš„æŒä¹…åŒ–èŠ‚ç‚¹ä¸Šé¢ï¼Œæœ€ç»ˆé€šè¿‡ç›‘å¬æœºåˆ¶ï¼Œåœ¨é…ç½®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œé€šçŸ¥å„åº”ç”¨ã€‚ã€é€‚åˆä½“é‡ä¸å¤§çš„åº”ç”¨ã€‘</p></li><li><p>åˆ†å¸ƒå¼é”ï¼šåˆ©ç”¨zkèŠ‚ç‚¹çš„åç§°çš„å”¯ä¸€æ€§ï¼Œå¯ä»¥æ¯”è¾ƒç®€å•çš„å®ç°åˆ†å¸ƒå¼é”</p><ul><li><p>å…¬å¹³é”ï¼šé€šè¿‡ä¸´æ—¶æŒä¹…åŒ–é¡ºåºèŠ‚ç‚¹ï¼Œè®©æƒ³è¦è·å–é”çš„å¯¹è±¡åœ¨æŸä¸€çˆ¶èŠ‚ç‚¹ä¸‹ä¾æ¬¡æ–°å¢é¡ºåºèŠ‚ç‚¹ï¼Œç„¶åç›‘å¬ä¸Šä¸€ä¸ªæ–°å¢çš„èŠ‚ç‚¹ã€‚<strong>æŠ¢é”æ¡ä»¶ï¼šåºå·æœ€å°çš„èŠ‚ç‚¹è·å–é”</strong>ã€‚å†ä¸Šä¸€èŠ‚ç‚¹é‡Šæ”¾é”è¢«åˆ é™¤æ—¶ï¼Œä¸‹ä¸€èŠ‚ç‚¹ä¼šç›‘å¬åˆ°è¿™ä¸€æ¶ˆæ¯ï¼Œç„¶åè¿›è¡ŒæŠ¢é”å·¥ä½œã€‚  </p><p>  <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6682d5e9cc714564b1114318338a9fd2~tplv-k3u1fbpfcp-watermark.image"></p></li><li><p>éå…¬å¹³é”ï¼šé€šè¿‡ç›‘å¬æŸä¸€å›ºå®šåç§°çš„ä¸´æ—¶èŠ‚ç‚¹ï¼Œå®ç°éå…¬å¹³é”ã€‚åœ¨è¯·æ±‚è¿›æ¥æ—¶ï¼Œå…ˆå»å°è¯•è·å–é”ï¼ˆget -w /pathï¼‰ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œå¾ªç¯ç­‰å¾…ã€‚ç„¶åç­‰ä¸Šä¸€ä¸ªå ç”¨é”çš„çº¿ç¨‹ç»“æŸæ—¶ï¼ŒæœåŠ¡å™¨é€šçŸ¥æ‰€æœ‰ç­‰å¾…è·å–é”çš„çº¿ç¨‹ï¼Œæ‰€æœ‰ç­‰å¾…çº¿ç¨‹å†ç«äº‰é”ã€‚ã€åœ¨é«˜å¹¶å‘ä¸‹ï¼Œè¿™ç§æ–¹å¼æ•ˆç‡æ¯”è¾ƒä½ã€‚åŸå› ï¼šæƒŠç¾¤æ•ˆåº”ï¼Œæ¯æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹è·å–é”ï¼Œä½†æ˜¯å”¤é†’äº†æ‰€æœ‰çº¿ç¨‹ã€‘   </p><pre><code> ![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cfb6ad11f53b46e99739904587b2e3e2~tplv-k3u1fbpfcp-watermark.image)</code></pre></li><li><p>è¯»å†™é”ï¼šåœ¨åº”ç”¨ä¸­åŒæ—¶å­˜åœ¨ç¼“å­˜å±‚å’Œæ•°æ®åº“å±‚æ—¶ï¼Œåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ä¸‹ï¼Œå¯èƒ½å‡ºç°ç¼“å­˜å’Œæ•°æ®è¯»å†™ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p><pre><code> ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fcd59e37ff214f76bfc0a3a6cbdec70b~tplv-k3u1fbpfcp-watermark.image)</code></pre><p> è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€æŠŠè¯»å†™é”ï¼Œæ¥ç¡®ä¿å†™æ“ä½œå‘ç”Ÿæ—¶ï¼Œè¯»æ“ä½œä¸èƒ½å†è¿›è¡Œè¯»å–ï¼Œéœ€ç­‰å¾…å†™æ“ä½œå®Œæˆåï¼Œæ‰èƒ½è¿›è¡Œè¯»å–ï¼›è¯»æ“ä½œæ­£åœ¨å‘ç”Ÿæ—¶ï¼Œå†™æ“ä½œä¸èƒ½è¿›è¡Œå†™ï¼Œéœ€ç­‰å¾…è¯»æ“ä½œå®Œæˆåï¼Œæ‰èƒ½å†™å…¥ã€‚<br>  <strong>ç›‘å¬è§„åˆ™ï¼šè¿ç»­è¯»çš„æƒ…å†µï¼Œç›‘å¬ä¸Šä¸€ä¸ªå†™ï¼Œå¦‚æœä¹‹å‰æ²¡æœ‰å†™ï¼Œæ— éœ€åŠ é”ï¼›å†™çš„æƒ…å†µï¼Œç›‘å¬è‡ªå·±ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼›</strong><br> <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ea3cc8d44cf84fc491455a0df3500011~tplv-k3u1fbpfcp-watermark.image"></p><h2 id="zookeeper-é›†ç¾¤"><a href="#zookeeper-é›†ç¾¤" class="headerlink" title="zookeeper é›†ç¾¤"></a>zookeeper é›†ç¾¤</h2></li></ul></li><li><p>å¤åˆ¶zoo.cfgï¼Œå¹¶ä¿®æ”¹å¦‚ä¸‹é…ç½®ï¼ˆç¤ºèŒƒä¸ºå•æœºï¼Œä¼ªé›†ç¾¤é…ç½®ï¼‰ </p><ul><li>dataDir=/zookeeper/zk1  </li><li>clientPort=2181  ### å®¢æˆ·ç«¯è¿æ¥ç«¯å£</li><li>server.1=localhost:2888:3888      ### 2888 é›†ç¾¤æ•°æ®åŒæ­¥é€šä¿¡ç«¯å£  3888 é€‰ä¸¾é€šä¿¡ç«¯å£ </li><li>server.2=localhost:2889:3889  </li><li>server.3=localhost:2890:3890  </li></ul></li><li><p>å†å¯¹åº”çš„dataDirç›®å½•ä¸‹æ–°å»ºmyidæ–‡ä»¶ã€ä¸å¸¦æ–‡ä»¶æ ¼å¼,server.1æœåŠ¡ï¼Œmyidæ–‡ä»¶å†…å®¹å°±æ˜¯â€1â€œã€‘ </p></li><li><p>å°†æœåŠ¡åˆ†åˆ«å¯åŠ¨</p><h3 id="zookeeper-é›†ç¾¤é€‰ä¸¾æµç¨‹-é¢è¯•å¸¸é—®"><a href="#zookeeper-é›†ç¾¤é€‰ä¸¾æµç¨‹-é¢è¯•å¸¸é—®" class="headerlink" title="zookeeper é›†ç¾¤é€‰ä¸¾æµç¨‹* é¢è¯•å¸¸é—® "></a>zookeeper é›†ç¾¤é€‰ä¸¾æµç¨‹*<sub> é¢è¯•å¸¸é—® </sub></h3><p>ä»¥ä¸‰ä¸ªèŠ‚ç‚¹çš„zookeeperèŠ‚ç‚¹ä¸ºä¾‹ï¼Œå½“ä¸¤ä¸ªåŠä»¥ä¸ŠæœåŠ¡å¯åŠ¨åï¼Œæ­£å¼é€‰ä¸¾å¼€å§‹ï¼š</p></li><li><p>ç¬¬ä¸€è½®é€‰ä¸¾ï¼šåœ¨ ZK æœåŠ¡å¯åŠ¨æ—¶ï¼Œä¼šå‘é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å‘é€ä¸€å¼ é€‰ç¥¨ï¼Œé€‰ç¥¨å†…å®¹åŒ…æ‹¬ <strong>è‡ªèº«serverId</strong>ã€<strong>æœ€æ–°æ•°æ®çš„ZXID</strong> ç­‰ã€‚åŒæ—¶ä¼šæ”¶åˆ°å…¶ä»–åº”ç”¨çš„é€‰ç¥¨ï¼Œå°†æ”¶åˆ°çš„é€‰ç¥¨å’Œè‡ªèº«é€‰ç¥¨å¯¹æ¯”ã€å¯¹æ¯”è§„åˆ™ï¼šZXIDå¤§çš„ä¼˜å…ˆï¼Œå¦‚æœZXIDä¸€è‡´ï¼ŒserverIdå¤§çš„ä¼˜å…ˆã€‘</p></li><li><p>ç¬¬äºŒæ¬¡é€‰ä¸¾ï¼šå„ä¸ª ZK æœåŠ¡ï¼Œä¼šå‘å…¶ä»–èŠ‚ç‚¹å‘é€ï¼Œè‡ªå·±æ‰€å¾—çš„æ‰€æœ‰é€‰ç¥¨ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰ä¸­ä¼˜å…ˆçº§æœ€é«˜çš„é€‰ç¥¨ã€‚å¦‚æœæŠ•æŸä¸€æœåŠ¡çš„ç¥¨æ•°è¶…è¿‡åŠæ•°ï¼Œåˆ™é€‰ä¸¾ç»“æŸã€‚é€‰ä¸¾å‡ºæ¥çš„æœºå™¨ï¼Œå°±æ˜¯leaderã€‚</p></li><li><p>ä¹‹åå…¶ä»–æœåŠ¡è¿æ¥åˆ°é›†ç¾¤ï¼Œå°±ä¼šå‘ç°å·²ç»å­˜åœ¨leaderï¼Œè‡ªåŠ¨å°†è‡ªèº«è®¾ç½®ä¸ºfollowerã€‚<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43ab49311c834de2a2e07187b4322702~tplv-k3u1fbpfcp-watermark.image"></p><h3 id="zookeeper-é›†ç¾¤æ•°æ®åŒæ­¥"><a href="#zookeeper-é›†ç¾¤æ•°æ®åŒæ­¥" class="headerlink" title="zookeeper é›†ç¾¤æ•°æ®åŒæ­¥"></a>zookeeper é›†ç¾¤æ•°æ®åŒæ­¥</h3><p>åœ¨é€‰ä¸¾å®Œæˆåï¼Œå®¢æˆ·ç«¯è¿æ¥zookeeper - leaderèŠ‚ç‚¹å†™å…¥æ•°æ®ï¼Œæ­¤æ—¶leaderèŠ‚ç‚¹ä¼šæ‰“å¼€ä¸€ä¸ªsocketç­‰å¾…followerèŠ‚ç‚¹æ¥è¿æ¥ï¼ŒfollowerèŠ‚ç‚¹è¿æ¥ä¸ŠleaderèŠ‚ç‚¹åï¼ŒleaderèŠ‚ç‚¹ä¼šæŒç»­å‘é€æ–°çš„æ•°æ®åˆ°followerèŠ‚ç‚¹ã€‚å¦‚æœå½“æ—¶æ²¡æœ‰æ–°çš„æ•°æ®å†™å…¥ï¼Œä¸”æ—§æ•°æ®å·²ç»åŒæ­¥å®Œæˆï¼ŒleaderèŠ‚ç‚¹ä¼šå‘¨æœŸæ€§çš„å‘é€ä¸€äº›ç©ºç™½çš„socketä¿¡æ¯ï¼Œç”¨äºä¿æŒèŠ‚ç‚¹é—´çš„è¿æ¥ã€‚</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> åˆ†å¸ƒå¼ä¸­é—´ä»¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼ä¸­é—´ä»¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springæ€ä¹ˆè§£å†³å¾ªç¯ä¾èµ–ï¼Ÿ</title>
      <link href="/2021/02/20/Spring%20%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%EF%BC%9F/"/>
      <url>/2021/02/20/Spring%20%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%EF%BC%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="1ã€ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–"><a href="#1ã€ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–" class="headerlink" title="1ã€ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–"></a>1ã€ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–</h1><p>æ‰€è°“å¾ªç¯ä¾èµ–æ˜¯æŒ‡ï¼Œåœ¨Aæ³¨å…¥äº†Bï¼Œåœ¨Bä¸­æ³¨å…¥äº†Aã€‚åˆå§‹åŒ–Aæ—¶éœ€è¦å…ˆåˆå§‹åŒ–Bï¼Œåˆå§‹åŒ–Båˆéœ€è¦åˆå§‹åŒ–Aï¼Œä»è€Œå‡ºç°çš„ç±»ä¼¼æ­»é”çš„ç°è±¡ã€‚</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f330358abe1a4ed9b18b2e40b11b98e5~tplv-k3u1fbpfcp-watermark.image"></p><span id="more"></span><h1 id="2ã€spring-å¦‚ä½•è§£å†³"><a href="#2ã€spring-å¦‚ä½•è§£å†³" class="headerlink" title="2ã€spring å¦‚ä½•è§£å†³"></a>2ã€spring å¦‚ä½•è§£å†³</h1><h2 id="2-1ã€å¾ªç¯ä¾èµ–ç¤ºä¾‹"><a href="#2-1ã€å¾ªç¯ä¾èµ–ç¤ºä¾‹" class="headerlink" title="2.1ã€å¾ªç¯ä¾èµ–ç¤ºä¾‹"></a>2.1ã€å¾ªç¯ä¾èµ–ç¤ºä¾‹</h2><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">public</span> B b<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">public</span> A a<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>åœ¨<a href="https://juejin.cn/post/6912354445082755079">springIOCåˆå§‹åŒ–è¿‡ç¨‹</a>ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°éæ‡’åŠ è½½çš„å•ä¾‹Beanéƒ½æ˜¯åœ¨<code>AbstractApplicationContext.refresh()</code>æ–¹æ³•ä¸­è°ƒç”¨<code>finishBeanFactoryInitialization()</code>æ–¹æ³•ï¼Œæœ€ç»ˆé€šè¿‡<code>AbstractBeanFactory.doGetBean()</code>æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–çš„ã€‚<strong>é‚£ä¹ˆspringå¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–ä¹Ÿå¿…å°†åœ¨è¿™ä¸ªæ–¹æ³•ä¸‹é¢</strong>[spring 5.2ç‰ˆæœ¬æºç ]ã€‚</p><h2 id="2-2ã€spring-beanç”Ÿæˆæ—¶åºå›¾"><a href="#2-2ã€spring-beanç”Ÿæˆæ—¶åºå›¾" class="headerlink" title="2.2ã€spring_beanç”Ÿæˆæ—¶åºå›¾"></a>2.2ã€spring_beanç”Ÿæˆæ—¶åºå›¾</h2><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/00f0eb010f2b4d94a172070985b14a0e~tplv-k3u1fbpfcp-watermark.image"></p><p>åœ¨é˜…è¯»æºç å‰ï¼Œå…ˆçœ‹çœ‹beanç”Ÿæˆçš„æ—¶åºå›¾æœ‰åŠ©äºç†è§£æºç ã€‚  </p><ol><li>springå°è¯•é€šè¿‡<code>ApplicationContext.getBean()</code>æ–¹æ³•è·å–Aå¯¹è±¡çš„å®ä¾‹ï¼Œç”±äºspringå®¹å™¨ä¸­è¿˜æ²¡æœ‰Aå¯¹è±¡[<code>getSingleton(A) = null</code>]ï¼Œå› æ­¤springä¼šåˆ›å»ºAå¯¹è±¡ã€springåˆ›å»ºä¸€ä¸ªbeanåˆ†ä¸ºä¸‰æ­¥ï¼š1. å®ä¾‹åŒ–beanã€ 2. ç»™beanæ³¨å…¥å±æ€§ã€3. åˆå§‹åŒ–beanã€‘ã€‚å¹¶å°†Aå¯¹è±¡çš„åŠæˆå“ã€æœªæ³¨å…¥å±æ€§ï¼Œæœªåˆå§‹åŒ–ã€‘ä¿å­˜åœ¨ä¸‰çº§ç¼“å­˜ä¸­[<code>addSingletonFactory(A)</code>]ã€‚</li><li>ç„¶åä¸ºAå¯¹è±¡æ³¨å…¥å±æ€§Bï¼Œé€šè¿‡<code>getBean(B)</code>ä»springå®¹å™¨ä¸­å°è¯•è·å–Bå¯¹è±¡ï¼Œç”±äºspringå®¹å™¨è¿˜æ²¡æœ‰Bå¯¹è±¡ï¼Œä¼šåˆ›å»ºBå¯¹è±¡ã€‚<blockquote><ul><li>åˆ›å»º B çš„åŠæˆå“å¯¹è±¡ï¼Œå¹¶ä¿å­˜åœ¨ä¸‰çº§ç¼“å­˜ä¸­[<code>addSingletonFactory(B)</code>]ã€‚</li></ul></blockquote></li></ol><pre><code>&gt; - ç„¶åä¸ºBå¯¹è±¡æ³¨å…¥å±æ€§Aï¼Œé€šè¿‡getBean(A)ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–Açš„åŠæˆå“å¯¹è±¡çš„å¼•ç”¨ï¼Œå°†Aä»ä¸‰çº§ç¼“å­˜ç§»å…¥äºŒçº§ç¼“å­˜ã€‚å¹¶å°†å®ƒåšä¸ºå±æ€§æ³¨å…¥Bå¯¹è±¡&gt; - åˆå§‹åŒ–Bå¯¹è±¡åï¼Œè¿”å›Bå¯¹è±¡ã€‚å°†Bå¯¹è±¡ä¿å­˜åˆ°ä¸€çº§ç¼“å­˜ä¸­</code></pre><ol start="3"><li>æœ€åå°†è¿”å›çš„Bå¯¹è±¡åšä¸ºå±æ€§æ³¨å…¥Aå¯¹è±¡ï¼Œåˆå§‹åŒ–Aï¼Œå¹¶å°†Aå¯¹è±¡ä¿å­˜åœ¨ä¸€çº§ç¼“å­˜ä¸­ã€‚</li></ol><h2 id="2-3ã€æºç è§£è¯»"><a href="#2-3ã€æºç è§£è¯»" class="headerlink" title="2.3ã€æºç è§£è¯»"></a>2.3ã€æºç è§£è¯»</h2><p>éæ‡’åŠ è½½çš„å•ä¾‹Spring_Beanæœ€ç»ˆéƒ½é€šè¿‡<code>AbstractBeanFactory.doGetBean()</code>è¿›è¡Œåˆå§‹åŒ–çš„ã€‚æˆ‘ä»¬çš„æºç åˆ†æä¹Ÿä»è¿™ä¸€ä¸ªæ–¹æ³•å¼€å§‹.</p><p>å¿½ç•¥å…¶ä¸­ä¸æœ¬æ¬¡å…³è”ä¸å¤§çš„ä»£ç </p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">doGetBean</span><span class="token punctuation">(</span>        String name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Class<span class="token operator">&lt;</span>T<span class="token operator">></span> requiredType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span>        <span class="token keyword">throws</span> BeansException <span class="token punctuation">{</span>    String beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    Object bean<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ£€æŸ¥æ˜¯å¦ç›®æ ‡beanæ˜¯å¦å·²ç»æ³¨å†Œè¿‡.</span>    Object sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å•ä¾‹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å°†è·å–åˆ°çš„bean åŠ å…¥ä¸€çº§ç¼“å­˜</span>            sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// åˆ›å»º beanå¯¹è±¡ </span>                    <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> bean<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>å…¶ä¸­å€¼å¾—å…³æ³¨çš„æ–¹æ³•æœ‰ä¸‰ä¸ªï¼š</p><ol><li>getSingleton(beanName);</li><li>getSingleton(beanName,ObjectFactory);</li><li>createBean(beanName, mbd, args);<br>æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†çœ‹ä¸€ä¸‹è¿™ä¸‰ä¸ªæ–¹æ³•æºç ã€‚<h3 id="2-3-1ã€getSingleton-bean"><a href="#2-3-1ã€getSingleton-bean" class="headerlink" title="2.3.1ã€getSingleton(bean)"></a>2.3.1ã€getSingleton(bean)</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> Object <span class="token function">getSingleton</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// æŸ¥è¯¢ä¸€çº§ç¼“å­˜</span> Object singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// æŸ¥è¯¢äºŒçº§ç¼“å­˜</span>     singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token comment" spellcheck="true">// Consistent creation of early reference within full singleton lock</span>             singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                     <span class="token comment" spellcheck="true">// æŸ¥è¯¢ä¸‰çº§ç¼“å­˜</span>                     ObjectFactory<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> singletonFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true">// å¦‚æœæŸ¥è¯¢åˆ°å°†æŸ¥è¯¢åˆ°çš„æ•°æ®å†™å…¥äºŒçº§ç¼“å­˜ï¼Œç„¶åä»ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤</span>                     <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                         singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token punctuation">}</span>                 <span class="token punctuation">}</span>             <span class="token punctuation">}</span>         <span class="token punctuation">}</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre></li><li>è¯¥æ–¹æ³•åˆ†åˆ«ä»ä¸€çº§ã€äºŒçº§ã€ä¸‰çº§ç¼“å­˜ä¸­å°è¯•è·å–beanï¼Œå¦‚æœèƒ½è·å–åˆ°ç›´æ¥è¿”å›è¯¥å¯¹è±¡ï¼Œå¦åˆ™è¿”å›nullã€‚</li><li><code>isSingletonCurrentlyInCreation</code>æ–¹æ³•ç”¨äºåˆ¤æ–­ç›®æ ‡beanæ˜¯å¦å¤„äºæ­£åœ¨åˆ›å»ºé˜¶æ®µï¼Œå¦‚æœæ˜¯è¿”å›trueã€‚</li><li>å¦‚æœå…¥å‚<code>allowEarlyReference</code>ä¸ºtrueï¼Œæ‰ä¼šå°è¯•æŸ¥è¯¢ä¸‰çº§ç¼“å­˜ã€‚ä¸”åœ¨ä¸‰çº§ç¼“å­˜ä¸­æŸ¥è¯¢åˆ°ä¹‹åä¼šå°†beanå¯¹è±¡ä¿å­˜åœ¨äºŒçº§ç¼“å­˜ã€‚<h3 id="2-3-2ã€createBean-beanName-mbd-args"><a href="#2-3-2ã€createBean-beanName-mbd-args" class="headerlink" title="2.3.2ã€createBean(beanName, mbd, args)"></a>2.3.2ã€createBean(beanName, mbd, args)</h3>åœ¨<code>getSingleton(beanName,ObjectFactory)</code>æ–¹æ³•ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°ç”±<code>createBean(beanName, mbd, args)</code>æä¾›ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆåˆ†æcreateBeanæ–¹æ³•ã€‚</li></ol><p>createBean(beanName, mbd, args)å§”æ‰˜ç»™åŒç±»çš„<code>doCreateBean(beanName, mbdToUse, args)</code>æ–¹æ³•å®ç°ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> Object <span class="token function">doCreateBean</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">,</span> RootBeanDefinition mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>        <span class="token keyword">throws</span> BeanCreationException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// BeanWrapper æ˜¯beançš„åŒ…è£…ç±» å®ƒæä¾›äº† getPropertyDescriptors æ–¹æ³• è·å–beançš„å±æ€§</span>    BeanWrapper instanceWrapper <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// åˆ›å»ºbeanå®ä¾‹çš„åŒ…è£…ç±»</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// earlySingletonExposure 1. æ˜¯å•ä¾‹ã€‚2. beanå…è®¸å¾ªç¯ä¾èµ–ã€‚3. è¯¥å•ä¾‹beanæ­£åœ¨è¢«åˆ›å»º</span>    <span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span>            <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Eagerly caching bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>                    <span class="token string">"' to allow for resolving potential circular references"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åŠ å…¥ä¸‰çº§ç¼“å­˜   -  getEarlyBeanReference æ–¹æ³• é»˜è®¤è¿”å›å…¥å‚ä¸­çš„beanå¯¹è±¡</span>        <span class="token comment" spellcheck="true">// æ­¤æ—¶çš„beanæœªæ³¨å…¥å±æ€§ï¼Œä¹Ÿå°±æ˜¯@Autowriedç­‰æ³¨è§£è¿˜æ²¡æœ‰è¢«è§£æ</span>        <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    Object exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ³¨å…¥å±æ€§ï¼Œ@Autowired ç­‰åœ¨æ­¤å¤„è§£æ</span>        <span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// beanåˆå§‹åŒ–</span>        exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å»æ‰éƒ¨åˆ†ç›¸å¯¹ä¸é‡è¦ä»£ç </span>    <span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>spring_beanç”Ÿæˆçš„ä¸‰å¤§æ­¥éª¤ï¼š</p><ol><li>å®ä¾‹åŒ–ï¼šcreateBeanInstance(beanName, mbd, args)</li><li>å±æ€§æ³¨å…¥ï¼špopulateBean(beanName, mbd, instanceWrapper);</li><li>åˆå§‹åŒ–ï¼šinitializeBean(beanName, exposedObject, mbd);</li></ol><p>åœ¨å®ä¾‹åŒ–å’Œå±æ€§æ³¨å…¥ä¹‹é—´æœ‰ä¸€è¡Œå…³é”®æ€§ä»£ç ï¼š<code>addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</code></p><p><code>getEarlyBeanReference(beanName, mbd, bean)</code>æ–¹æ³•æœ€ç»ˆä¼šå§”æ‰˜<code>AbstractAutoProxyCreator.wrapIfNecessary()</code>å®ç°åŠ¨æ€ä»£ç†è¿”å›ä¸€ä¸ªbeanå¯¹è±¡çš„ä»£ç†ç±»ã€‚</p><pre class=" language-java"><code class="language-java">Object<span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>specificInterceptors <span class="token operator">!=</span> DO_NOT_PROXY<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>    Object proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>    bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SingletonTargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> proxy<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ç„¶åé€šè¿‡addSingletonFactory()å°†è¯¥ä»£ç†ç±»åŠ å…¥åˆ°ä¸‰çº§ç¼“å­˜ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">,</span> ObjectFactory<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> singletonFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>singletonFactory<span class="token punctuation">,</span> <span class="token string">"Singleton factory must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>registeredSingletons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="populateBean-beanName-mbd-instanceWrapper"><a href="#populateBean-beanName-mbd-instanceWrapper" class="headerlink" title="populateBean(beanName, mbd, instanceWrapper)"></a>populateBean(beanName, mbd, instanceWrapper)</h4><p>è¯¥æ–¹æ³•ä¼šè§£æbeanç±»ä¸­éœ€è¦æ³¨å…¥çš„å±æ€§ï¼Œå¦‚æœéœ€è¦æ³¨å…¥çš„æ˜¯ä¸€ä¸ªbeanå¯¹è±¡ï¼Œspringé€šè¿‡åå°„è·å–å¯¹åº”çš„beanï¼Œæœ€ç»ˆè¿˜æ˜¯è°ƒç”¨<code>getBean()</code>æ–¹æ³•ã€‚</p><p>ç”±äºæœ¬æ¬¡ä¾‹å­ä¸­æ˜¯é€šè¿‡<code>@Autowired</code>æ³¨è§£è¿›è¡Œå±æ€§æ³¨å…¥ï¼Œ@Autowiredå…¶å®æ˜¯é€šè¿‡<code>AutowiredAnnotationBeanPostProcessor</code>åç½®å¤„ç†å™¨è¿›è¡Œå±æ€§æ³¨å…¥çš„ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹å±æ€§æ˜¯å¦‚ä½•æ³¨å…¥</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// è·å–éœ€è¦æ³¨å…¥çš„ è¢«@Autowiredä¿®é¥°çš„å±æ€§</span>InjectionMetadata metadata <span class="token operator">=</span> <span class="token function">findAutowiringMetadata</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ä»metadataä¸­è·å–éœ€è¦æ³¨å…¥çš„bean_name,ç„¶åæœ€ç»ˆé€šè¿‡getBean()æ–¹æ³•è¿›è¡Œè·å–</span>    metadata<span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>æœ€ç»ˆè°ƒç”¨descriptor.resolveCandidate(autowiredBeanName, type, this)ï¼›è·å–éœ€è¦æ³¨å…¥çš„bean</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">resolveCandidate</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> requiredType<span class="token punctuation">,</span> BeanFactory beanFactory<span class="token punctuation">)</span>        <span class="token keyword">throws</span> BeansException <span class="token punctuation">{</span>    <span class="token keyword">return</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>è¿™è¾¹è°ƒç”¨é“¾è·¯æœ‰ç‚¹é•¿ï¼Œæ­¤å¤„å°±ä¸åšèµ˜è¿°ã€‚æœ‰å…´è¶£çš„å¯ä»¥æ ¹æ®ä»¥ä¸‹é“¾è·¯è‡ªè¡ŒæŸ¥çœ‹</p><ul><li>AbstractAutowireCapableBeanFactory.populateBean() </li><li>AutowiredAnnotationBeanPostProcessor.postProcessProperties()</li><li>AutowiredAnnotationBeanPostProcessor.inject()</li><li>DefaultListableBeanFactory.resolveDependency()</li><li>DefaultListableBeanFactory.doResolveDependency()</li><li>DependencyDescriptor.resolveCandidate()</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æŸ¥çœ‹å®Œä»¥ä¸Šæºç ï¼Œæˆ‘ä»¬å†æ¬¡å›é¡¾ä¸€ä¸‹æœ¬æ¬¡çš„é¢è¯•é¢˜ã€Šspring æ€ä¹ˆè§£å†³å¾ªç¯ä¾èµ–ï¼Ÿã€‹</p><p>springå®¹å™¨ä¸­å­˜åœ¨ä¸‰çº§ç¼“å­˜ã€åˆ†åˆ«æ˜¯singletonObjectsã€earlySingletonObjectsã€singletonFactoriesã€‘ï¼Œspringåœ¨å®ä¾‹åŒ–beanä¹‹åï¼Œä¼šå°†beanå¯¹è±¡çš„å¼•ç”¨æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜ä¸­ï¼Œåœ¨å¾ªç¯ä¾èµ–å‘ç”Ÿæ—¶ï¼Œspringä¼šå°†æ­£åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­çš„ä¸å®Œå…¨beançš„å¼•ç”¨å…ˆä½œä¸ºå±æ€§æ³¨å…¥ã€‚æœ€ç»ˆå°†beanå¯¹è±¡åˆå§‹åŒ–åæ·»åŠ åˆ°ä¸€çº§ç¼“å­˜ã€singletonObjectsã€‘ä¸­ã€‚</p><p>å‡è®¾å­˜åœ¨A å’Œ B å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œæ­¤æ—¶å…ˆå°†Aæ³¨å†Œåˆ°springå®¹å™¨ä¸­ã€‚  </p><ol><li>å…ˆå°è¯•åœ¨springçš„ä¸‰çº§ç¼“å­˜ä¸­è·å–beanå¯¹è±¡ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„bean A</li><li>å…ˆå®ä¾‹åŒ–Aï¼Œç„¶åå°†ä¸å®Œå…¨çš„Aå¯¹è±¡çš„å¼•ç”¨ï¼Œä¿å­˜åˆ°ä¸‰çº§ç¼“å­˜ä¸­ã€‚</li><li>å†å¯¹Aè¿›è¡Œå±æ€§Bçš„æ³¨å…¥ï¼Œå‘ç°Bå¯¹è±¡è¿˜æ²¡æœ‰å†springå®¹å™¨ä¸­ï¼Œåˆ›å»ºB<ul><li>å®ä¾‹åŒ–Bï¼Œç„¶åå°†ä¸å®Œå…¨çš„Bå¯¹è±¡çš„å¼•ç”¨ï¼Œä¿å­˜åœ¨ä¸‰çº§ç¼“å­˜ä¸­ã€‚</li><li>ç„¶åå¯¹Bè¿›è¡Œå±æ€§Açš„æ³¨å…¥ï¼Œé€šè¿‡æŸ¥è¯¢å‘ç°Aå¯¹è±¡å­˜åœ¨äºä¸‰çº§ç¼“å­˜ä¸­ï¼Œå°†Aå¯¹è±¡ä¿å­˜åˆ°äºŒçº§ç¼“å­˜ä¸­ã€‚ç„¶åæ³¨å…¥Bä¸­ã€‚ã€Bå¯¹è±¡ä¸­æ³¨å…¥çš„æ˜¯Aå¯¹è±¡çš„å¼•ç”¨ã€‘</li><li>åˆå§‹åŒ–Bä¹‹åï¼Œæ­¤æ—¶å¯¹è±¡Bæ˜¯ä¸€ä¸ªå®Œæ•´çš„beanï¼Œå°†å®ƒä¿å­˜åœ¨ä¸€çº§ç¼“å­˜ä¸­ã€‚</li></ul></li><li>Båˆ›å»ºæˆåŠŸåï¼Œè¿”å›ä¸€ä¸ªBå¯¹è±¡çš„å¼•ç”¨ã€‚å¹¶å°†å…¶æ³¨å…¥Aã€‚</li><li>Aè¿›è¡Œåˆå§‹åŒ–ã€Aåˆå§‹åŒ–å®Œæˆåï¼ŒAä¹Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„beanï¼Œé‚£ä¹ˆBä¸­Aå±æ€§å¼•ç”¨å¯¹è±¡ä¹Ÿå®Œæ•´äº†ã€‘ï¼Œç„¶åä¿å­˜åˆ°ä¸€çº§ç¼“å­˜ä¸­ã€‚</li></ol><h3 id="è™½ç„¶å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œä½†æ˜¯åœ¨æ„é€ å™¨æ³¨å…¥çš„æƒ…å†µä¸‹ï¼Œå¾ªç¯ä¾èµ–ä»ç„¶ä¼šæŠ¥é”™ã€‚"><a href="#è™½ç„¶å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œä½†æ˜¯åœ¨æ„é€ å™¨æ³¨å…¥çš„æƒ…å†µä¸‹ï¼Œå¾ªç¯ä¾èµ–ä»ç„¶ä¼šæŠ¥é”™ã€‚" class="headerlink" title="è™½ç„¶å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œä½†æ˜¯åœ¨æ„é€ å™¨æ³¨å…¥çš„æƒ…å†µä¸‹ï¼Œå¾ªç¯ä¾èµ–ä»ç„¶ä¼šæŠ¥é”™ã€‚"></a>è™½ç„¶å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œä½†æ˜¯åœ¨æ„é€ å™¨æ³¨å…¥çš„æƒ…å†µä¸‹ï¼Œå¾ªç¯ä¾èµ–ä»ç„¶ä¼šæŠ¥é”™ã€‚</h3><p>æ ¹æ®æºç æˆ‘ä»¬å¾—çŸ¥setteræ³¨å…¥å’Œæ³¨è§£æ³¨å…¥ï¼Œæ˜¯åœ¨populateBeanæ–¹æ³•ä¸Šè¿›è¡Œçš„é€’å½’ï¼ˆgetBeanï¼‰ï¼Œæ­¤æ—¶ä¸‰çº§ç¼“å­˜å·²ç»ä¿å­˜ï¼Œæ‰€ä»¥å¾ªç¯ä¾èµ–ä¸ä¼šå‡ºé”™ã€‚</p><p>ä½†æ˜¯æ„é€ å™¨æ³¨å…¥çš„é€’å½’æ“ä½œå‘ç”Ÿåœ¨createBeanInstance(beanName, mbd, args)è¿™ä¸ªæ–¹æ³•ä¸­ã€‚æ­¤æ—¶ä¸‰çº§ç¼“å­˜è¿˜æ²¡æœ‰ä¿å­˜ï¼Œåœ¨ç¼“å­˜ä¸­è·å–å¤±è´¥æ—¶ï¼Œåˆä¼šé‡æ–°createæ–°çš„beanã€‚è¿™ä¹Ÿå°±å‡ºç°äº†å¾ªç¯ä¾èµ–ã€‚</p><p>æœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è·Ÿä¸€ä¸‹æºç ã€‚</p><p>ä»£ç é“¾è·¯ï¼š</p><ul><li>createBeanInstance(beanName, mbd, args)</li><li>AbstractAutowireCapableBeanFactory.autowireConstructor()</li><li>ConstructorResolver.autowireConstructor()</li><li>ConstructorResolver.resolveConstructorArguments()</li><li>BeanDefinitionValueResolver.resolveValueIfNecessary();</li><li>BeanDefinitionValueResolver.resolveReference()<ul><li>æœ€ç»ˆåœ¨è¿™ä¸ªæ–¹æ³•ä¸­è°ƒç”¨äº†getBean()æ–¹æ³•</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring IOCæºç è§£æ</title>
      <link href="/2020/12/31/spring-IOC%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
      <url>/2020/12/31/spring-IOC%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>spring æ˜¯å½“å‰æœ€å¹¿æ³›ä½¿ç”¨çš„å¼€æºæ¡†æ¶ï¼Œè€Œspring framework åˆ™æ˜¯springå…¨å®¶æ¡¶çš„åŸºç¡€ã€‚spring frameworkæœ€é‡è¦çš„æ˜¯ IOC å’Œ AOPã€‚å…¶ä¸­ IOC åˆæ˜¯Spring framework çš„åŸºç¡€ã€‚<br>ä»Šå¤©æˆ‘ä»¬è¦åšçš„å°±æ˜¯è§£æIOCï¼Œæ€»çš„æ¥è¯´IOCæœ‰ä¸¤ç‚¹è‡³å…³é‡è¦ï¼š1ã€åˆ›å»ºbeanå®¹å™¨ï¼›2ã€åˆå§‹åŒ–beanã€‚</p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>æœ¬æ–‡ä»¥JAVA_CONFIGï¼ˆæ³¨è§£ï¼‰æ¥è§£è¯»spring IOC æºç ã€‚  </p><p>ä¸‹é¢æˆ‘ä»¬ä»ä¸€æ®µç®€å•çš„ä»£ç å‡ºå‘åˆ†æ</p><span id="more"></span> <p><strong>é…ç½®ç±»</strong></p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span><span class="token string">"com.zhouxh"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        AnnotationConfigApplicationContext applicationContext <span class="token operator">=</span>                 <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span>Main<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TestService testService <span class="token operator">=</span> <span class="token punctuation">(</span>TestService<span class="token punctuation">)</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"testService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        testService<span class="token punctuation">.</span><span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç»“æŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>serviceç±»</strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>zhouxh<span class="token punctuation">.</span>service<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Service<span class="token punctuation">;</span><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"testService"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello spring"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>é€šè¿‡æ³¨è§£<code>@Configuration</code>å°†Mainç±»æ ‡è®°ä¸ºé…ç½®ç±»ï¼Œå¹¶é€šè¿‡<code>@ComponentScan(&quot;com.zhouxh&quot;)</code>æŒ‡å®šbeanæ‰«æè·¯å¾„ã€‚</p><h3 id="Spring-IoCå®¹å™¨çš„åŠ è½½è¿‡ç¨‹"><a href="#Spring-IoCå®¹å™¨çš„åŠ è½½è¿‡ç¨‹" class="headerlink" title="Spring IoCå®¹å™¨çš„åŠ è½½è¿‡ç¨‹"></a>Spring IoCå®¹å™¨çš„åŠ è½½è¿‡ç¨‹</h3><h4 id="è„‘å›¾"><a href="#è„‘å›¾" class="headerlink" title="è„‘å›¾"></a>è„‘å›¾</h4><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d9935c26c2b74b2ea571ed5b4ac2e7ee~tplv-k3u1fbpfcp-watermark.image"><br>1.å®ä¾‹åŒ–å®¹å™¨ AnnotationConfigApplicationContext</p><pre class=" language-java"><code class="language-java">AnnotationConfigApplicationContext applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span>Main<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>è¯¥æœ‰å‚æ„é€ çš„ç®€å•è¯´æ˜:</p><ul><li>å¯ä»¥æ¥æ”¶å¤šä¸ªé…ç½®ç±»ï¼Œä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªä¼šä¼ å…¥ä¸€ä¸ªé…ç½®ç±»</li><li>è¿™ä¸ªé…ç½®ç±»æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„å¸¦ä¸Š<code>@Configuration</code>æ³¨è§£çš„é…ç½®ç±»ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯æ²¡æœ‰å¸¦ä¸Š@Configurationï¼Œä½†æ˜¯å¸¦æœ‰<code>@Component</code>ï¼Œ<code>@Import</code>ï¼Œ<code>@ImportResouce</code>ï¼Œ<code>@Service</code>ï¼Œ<code>@ComponentScan</code>ç­‰æ³¨è§£çš„é…ç½®ç±»ï¼Œåœ¨Springå†…éƒ¨æŠŠå‰è€…ç§°ä¸ºFullé…ç½®ç±»ï¼ŒæŠŠåè€…ç§°ä¹‹ä¸ºLiteé…ç½®ç±»ã€‚åœ¨æœ¬æºç åˆ†æä¸­ï¼Œæœ‰äº›åœ°æ–¹ä¹ŸæŠŠLiteé…ç½®ç±»ç§°ä¸ºæ™®é€šBeanã€‚<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> componentClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// è°ƒç”¨æ— å‚æ„é€ å‡½æ•°</span>  <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ³¨å†Œé…ç½®ç±»</span>  <span class="token function">register</span><span class="token punctuation">(</span>componentClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// IOC å®¹å™¨åˆ·æ–°æ¥å£</span>  <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="this"><a href="#this" class="headerlink" title="this()"></a>this()</h4></li></ul><p>åœ¨é€šè¿‡this()æ–¹æ³•è°ƒç”¨æ— å‚æ„é€ å‡½æ•°æ—¶ï¼Œä¼šéšå¼çš„è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ‰§è¡Œçˆ¶ç±»æ— å‚æ„é€ ï¼Œè®¾ç½®beanå·¥å‚ç±»</span>    <span class="token comment" spellcheck="true">/**     *  public GenericApplicationContext() {     *      this.beanFactory = new DefaultListableBeanFactory();     *  }     */</span>    <span class="token comment" spellcheck="true">// è®¾ç½®è¯»å–é…ç½®ç±»</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è®¾ç½®æ‰«æç±»ï¼Œé»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰ä½¿ç”¨ï¼Œé™¤éå¤–éƒ¨æ˜¾ç¤ºçš„è°ƒç”¨scan()æ–¹æ³•æŒ‡å®šæ‰«æè·¯å¾„</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>AnnotatedBeanDefinitionReaderã€beanDefinitionè¯»å–å™¨ã€‘</strong><br>ä¸»è¦åšäº†2ä»¶äº‹æƒ…</p><ol><li>æ³¨å†Œå†…ç½®BeanPostProcessor</li><li>æ³¨å†Œç›¸å…³çš„BeanDefinition<br>é€šè¿‡å¯¹<code>new AnnotatedBeanDefinitionReader(this)</code>ä»£ç çš„è¿½è¸ªå‘ç°çœŸæ­£åšäº‹æƒ…çš„<code>AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry);</code>ç”±äºè¯¥æ–¹æ³•ä»£ç è¾ƒå¤šï¼Œè¿™é‡ŒåªæŠŠæœ€æ ¸å¿ƒçš„ä»£ç è´´å‡ºæ¥ã€‚<pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> RootBeanDefinition def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>ConfigurationClassPostProcessor<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>åœ¨è¯¥æ–¹æ³•ä¸­å­˜åœ¨è¾ƒå¤šçš„ç±»ä¼¼çš„ä»£ç ã€‚å…¶ä¸»è¦ç›®çš„å°±æ˜¯ä¸ºäº†ç»™å®¹å™¨æ·»åŠ å†…ç½®ç»„ä»¶</li><li>åˆ¤æ–­å®¹å™¨ä¸­æ˜¯å¦å·²ç»å­˜åœ¨äº†ConfigurationClassPostProcessor Bean</li><li>å¦‚æœä¸å­˜åœ¨ï¼ˆç¬¬ä¸€æ¬¡è¿è¡Œå¿…ç„¶ä¸å­˜åœ¨ï¼‰ï¼Œå°±é€šè¿‡RootBeanDefinitionçš„æ„é€ æ–¹æ³•è·å¾—ConfigurationClassPostProcessorçš„BeanDefinitionï¼ŒRootBeanDefinitionæ˜¯BeanDefinitionçš„å­ç±»</li><li>æ‰§è¡ŒregisterPostProcessoræ–¹æ³•ï¼ŒregisterPostProcessoræ–¹æ³•å†…éƒ¨å°±æ˜¯æ³¨å†ŒBeanï¼Œå½“ç„¶è¿™é‡Œæ³¨å†Œå…¶ä»–Beanä¹Ÿæ˜¯ä¸€æ ·çš„æµç¨‹ã€‚</li></ol><p>è¯¥æ–¹æ³•æœ€ç»ˆä¼šå°†ContextAnnotationAutowireCandidateResolver,<code>ConfigurationClassPostProcessorã€beançš„æ‰«æå’Œæ³¨å†Œã€‘</code>,CommonAnnotationBeanPostProcessor,<code>AutowiredAnnotationBeanPostProcessorã€@Autowiredå±æ€§çš„è‡ªåŠ¨æ³¨å…¥ã€‘</code>,PersistenceAnnotationBeanPostProcessor è¿™5ä¸ªç»„ä»¶æ·»åŠ åˆ°springå®¹å™¨ä¸­ã€‚</p><h4 id="register-componentClasses"><a href="#register-componentClasses" class="headerlink" title="register(componentClasses);"></a>register(componentClasses);</h4><p>register æ˜¯å°†ä¼ å…¥çš„é…ç½®ç±»è§£ææˆbeanDefinitionï¼Œå¹¶æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚</p><ol><li><p>åŒ…è£…æˆ BeanDefinition</p></li><li><p>åˆ¤æ–­æ¡ä»¶æ˜¯å¦æ»¡è¶³ @condition</p></li><li><p>è®¾ç½®beanä½œç”¨åŸŸ</p></li><li><p>è§£æé€šç”¨æ³¨è§£ï¼ˆ@Lazyã€@Primaryã€@DependsOnã€@Roleã€@Descriptionï¼‰ï¼Œå¹¶å°†å±æ€§è®¾ç½®åˆ°beanDefinitionä¸­</p></li><li><p>å°†beanDefinitionæ³¨å†Œåˆ°å®¹å™¨ä¸­</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">void</span> <span class="token function">doRegisterBean</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> beanClass<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String name<span class="token punctuation">,</span>     <span class="token annotation punctuation">@Nullable</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> qualifiers<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Supplier<span class="token operator">&lt;</span>T<span class="token operator">></span> supplier<span class="token punctuation">,</span>     <span class="token annotation punctuation">@Nullable</span> BeanDefinitionCustomizer<span class="token punctuation">[</span><span class="token punctuation">]</span> customizers<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å°†beanClass åŒ…è£…æˆ BeanDefinition</span> AnnotatedGenericBeanDefinition abd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotatedGenericBeanDefinition</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡æ³¨è§£ï¼Œspringä¸­æœ‰ä¸€ä¸ª@Conditionæ³¨è§£ï¼Œå½“ä¸æ»¡è¶³æ¡ä»¶ï¼Œè¿™ä¸ªbeanå°±ä¸ä¼šè¢«è§£æ</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>abd<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> abd<span class="token punctuation">.</span><span class="token function">setInstanceSupplier</span><span class="token punctuation">(</span>supplier<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// è®¾ç½®beanä½œç”¨åŸŸ spring é»˜è®¤ singleton</span> ScopeMetadata scopeMetadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopeMetadataResolver<span class="token punctuation">.</span><span class="token function">resolveScopeMetadata</span><span class="token punctuation">(</span>abd<span class="token punctuation">)</span><span class="token punctuation">;</span> abd<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">.</span><span class="token function">getScopeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> String beanName <span class="token operator">=</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> null <span class="token operator">?</span> name <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>abd<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// è§£æé€šç”¨æ³¨è§£ï¼ˆ@Lazyã€@Primaryã€@DependsOnã€@Roleã€@Descriptionï¼‰ï¼Œå¹¶å°†å±æ€§è®¾ç½®åˆ°beanDefinitionä¸­</span> AnnotationConfigUtils<span class="token punctuation">.</span><span class="token function">processCommonDefinitionAnnotations</span><span class="token punctuation">(</span>abd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>qualifiers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token operator">></span> qualifier <span class="token operator">:</span> qualifiers<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>Primary<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> qualifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>             abd<span class="token punctuation">.</span><span class="token function">setPrimary</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Lazy<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> qualifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>             abd<span class="token punctuation">.</span><span class="token function">setLazyInit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">else</span> <span class="token punctuation">{</span>             abd<span class="token punctuation">.</span><span class="token function">addQualifier</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AutowireCandidateQualifier</span><span class="token punctuation">(</span>qualifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>customizers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span>BeanDefinitionCustomizer customizer <span class="token operator">:</span> customizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>         customizer<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span>abd<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> BeanDefinitionHolder definitionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>abd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span> definitionHolder <span class="token operator">=</span> AnnotationConfigUtils<span class="token punctuation">.</span><span class="token function">applyScopedProxyMode</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å°†beanDefinition æ·»åŠ åˆ°mapç¼“å­˜ä¸­</span> BeanDefinitionReaderUtils<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="refresh"><a href="#refresh" class="headerlink" title="refresh();"></a>refresh();</h3><p>åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬æƒ³è¦æ³¨å…¥çš„testServiceç±»è¿˜æ²¡æœ‰è¢«æ‰«æï¼Œåœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­åªæ³¨å†Œäº†é»˜è®¤çš„å†…ç½®beanå’Œé…ç½®ç±»ã€‚</p></li></ol><p>çœŸæ­£çš„é‡ç‚¹ä»£ç åœ¨è¿™ä¸ªrefresh()åˆ·æ–°æ–¹æ³•ä¸­ã€‚</p><h4 id="è„‘å›¾-1"><a href="#è„‘å›¾-1" class="headerlink" title="è„‘å›¾"></a>è„‘å›¾</h4><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e526a2c3158410f9f05d2394ed5073d~tplv-k3u1fbpfcp-watermark.image"></p><h4 id="prepareRefresh"><a href="#prepareRefresh" class="headerlink" title="prepareRefresh();"></a>prepareRefresh();</h4><p>å¼€å§‹åˆ·æ–°æ–¹æ³•çš„å‡†å¤‡å·¥ä½œï¼Œä¸»è¦è®°å½•å®¹å™¨å¼€å§‹æ—¶é—´ã€å¯åŠ¨æ ‡è¯†ä¹‹ç±»çš„<br>éœ€è¦æ³¨æ„çš„åªæœ‰ä¸¤è¡Œä»£ç </p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//åˆå§‹åŒ–å±æ€§ï¼Œç”±å­—ç±»è¦†ç›–å®ç°</span><span class="token function">initPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// éªŒè¯å¿…è¦å±æ€§æ˜¯å¦éƒ½å·²ç»è¢«è§£æ</span><span class="token comment" spellcheck="true">// see ConfigurablePropertyResolver#setRequiredProperties</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validateRequiredProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>initPropertySources</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿è¯¥ç±»å¹¶é‡å†™è¯¥æ–¹æ³•ï¼Œé€šè¿‡ç„¶åç»™Environmentä¸­æ·»åŠ æŸå‚æ•°ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ‰©å±•initPropertySource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//è¿™é‡Œæ·»åŠ äº†ä¸€ä¸ªusernameå±æ€§åˆ°Environmenté‡Œé¢ï¼Œä»¥æ–¹ä¾¿æˆ‘ä»¬åœ¨åé¢ç”¨åˆ°</span>    <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span><span class="token string">"bobo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//è¿™é‡Œè¦æ±‚Environmentä¸­å¿…é¡»åŒ…å«usernameå±æ€§ï¼Œå¦‚æœä¸åŒ…å«ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span>    <span class="token comment" spellcheck="true">// åœ¨è¿™é‡Œè®¾ç½®ä¼šè¢«getEnvironment().validateRequiredProperties();æ£€éªŒåˆ°ã€‚</span>    <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRequiredProperties</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>     </code></pre><h4 id="prepareBeanFactory-beanFactory"><a href="#prepareBeanFactory-beanFactory" class="headerlink" title="prepareBeanFactory(beanFactory)"></a>prepareBeanFactory(beanFactory)</h4><p>ç»™beanFactoryæ·»åŠ å¿…è¦çš„ç»„ä»¶<br>éœ€è¦å…³æ³¨çš„ä»£ç </p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// BeanFactoryæ¥å£æœªåœ¨æ™®é€šå·¥å‚ä¸­æ³¨å†Œä¸ºå¯è§£æç±»å‹ã€‚ MessageSourceæ³¨å†Œä¸ºBeanï¼ˆå¹¶å‘ç°ç”¨äºè‡ªåŠ¨è£…é…ï¼‰ã€‚</span><span class="token comment" spellcheck="true">// æ„å‘³ç€ä»¥ä¸‹4å„ç±»å¯ä»¥åœ¨ä»»æ„ç»„ä»¶ä¸­è‡ªåŠ¨è£…é…ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è‡ªåŠ¨è£…é…çš„ç±»å‹ï¼Œç¬¬äºŒä¸ªå­—æ®µæ˜¯è‡ªåŠ¨è£…é…çš„å€¼</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span>BeanFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span>ResourceLoader<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span>ApplicationEventPublisher<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span>ApplicationContext<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//æ·»åŠ ä¸€ä¸ªåç½®å¤„ç†å™¨ï¼šApplicationListenerDetectorï¼Œæ­¤åç½®å¤„ç†å™¨å®ç°äº†BeanPostProcessoræ¥å£</span>beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationListenerDetector</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="postProcessBeanFactory-beanFactory"><a href="#postProcessBeanFactory-beanFactory" class="headerlink" title="postProcessBeanFactory(beanFactory)"></a>postProcessBeanFactory(beanFactory)</h4><p>springæä¾›çš„æ‹“å±•ç‚¹ï¼Œä»¥ä¾¿å­ç±»ç»§æ‰¿åå¯¹beanFactoryè¿›è¡Œä¸ªæ€§åŒ–è®¾ç½®ã€‚</p><h4 id="invokeBeanFactoryPostProcessors-beanFactory"><a href="#invokeBeanFactoryPostProcessors-beanFactory" class="headerlink" title="invokeBeanFactoryPostProcessors(beanFactory)"></a>invokeBeanFactoryPostProcessors(beanFactory)</h4><p>éœ€å…³æ³¨å¦‚ä¸‹ä»£ç :</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>        ConfigurableListableBeanFactory beanFactory<span class="token punctuation">,</span>         List<span class="token operator">&lt;</span>BeanFactoryPostProcessor<span class="token operator">></span> beanFactoryPostProcessors<span class="token punctuation">)</span> </code></pre><p>å‚æ•°é‡Œçš„ <code>beanFactoryPostProcessors</code> ä¸æ˜¯springç®¡ç†çš„ <code>beanFactoryPostProcessor</code> è€Œæ˜¯ä»å¤–éƒ¨é€šè¿‡å¦‚ä¸‹ä»£ç æ·»åŠ çš„,å¦‚æœæ²¡æœ‰é€šè¿‡è¯¥æ–¹æ³•æ·»åŠ  é»˜è®¤ä¸ºç©º</p><pre class=" language-java"><code class="language-java">AnnotationConfigApplicationContext applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>applicationContext<span class="token punctuation">.</span><span class="token function">addBeanFactoryPostProcessor</span><span class="token punctuation">(</span>xxx<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>invokeBeanFactoryPostProcessorsæ–¹æ³•ä¸­å­˜åœ¨ä¸‰æ®µç±»ä¼¼çš„ä»£ç ï¼Œæ­¤å¤„åªç²˜è´´ä¸€æ®µè¿›è¡Œåˆ†æ</strong>  </p><p>è¿™ä¸‰æ®µç›¸ä¼¼ä»£ç æ„å‘³ç€ï¼š<code>BeanFactoryPostProcessor</code>æŒ‰ç…§ä»£ç å…ˆåé¡ºåºä¾æ¬¡æ‰§è¡Œ</p><ol><li>é¦–å…ˆæ‰§è¡Œå®ç°äº†PriorityOrderedæ¥å£çš„BeanDefinitionRegistryPostProcessorsã€‚beanå®šä¹‰åç½®æ³¨å†Œå¤„ç†å™¨</li><li>ç„¶åæ‰§è¡Œå®ç°Orderedæ¥å£çš„BeanDefinitionRegistryPostProcessorsã€‚</li><li>æœ€åæ‰§è¡Œæ™®é€šçš„beanå®šä¹‰æ³¨å†Œåç½®å¤„ç†å™¨<pre class=" language-java"><code class="language-java">String<span class="token punctuation">[</span><span class="token punctuation">]</span> postProcessorNames <span class="token operator">=</span>     beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span>BeanDefinitionRegistryPostProcessor<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>String ppName <span class="token operator">:</span> postProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> PriorityOrdered<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> BeanDefinitionRegistryPostProcessor<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     processedBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>registryProcessors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">invokeBeanDefinitionRegistryPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h6 id="invokeBeanDefinitionRegistryPostProcessors"><a href="#invokeBeanDefinitionRegistryPostProcessors" class="headerlink" title="invokeBeanDefinitionRegistryPostProcessors"></a>invokeBeanDefinitionRegistryPostProcessors</h6>ä»¥ä¸Šä»£ç å¤§è‡´é€»è¾‘ä¸ºï¼šé€‰æ‹©å‡ºå¯¹åº”ç±»å‹çš„BeanFactoryPostProcessorï¼Œç„¶åé€šè¿‡<code>invokeBeanDefinitionRegistryPostProcessors</code>æ–¹æ³•æ‰«æå‡ºéœ€è¦æ³¨å†Œçš„bean,å¹¶åŠ å…¥åˆ°æ³¨å†Œè¡¨ä¸­ã€‚</li></ol><p>è°ƒç”¨invokeBeanDefinitionRegistryPostProcessorsæ–¹æ³•æœ€ç»ˆæ˜¯è°ƒç”¨<code>processConfigBeanDefinitions</code>æ–¹æ³•</p><p>è¯¥æ–¹æ³•å¤§è‡´åšä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p><ol><li><p>æ‰«æå·²ç»æ³¨å†Œçš„beanä¸­è¢«@Configurationä¿®é¥°çš„é…ç½®ç±»ï¼Œè·å–ä»–çš„æ‰«æè·¯å¾„</p></li><li><p>å°†é…ç½®ç±»æ’åº</p></li><li><p>é€šè¿‡æ‰«æè·¯å¾„ï¼Œæ‰«æè·¯å¾„ä¸‹æ‰€æœ‰è¢«@PropertySourceã€@ComponentScanã€@Importã€@ImportResourceã€@Beanä¿®é¥°çš„ç±»å’Œæ–¹æ³•ï¼Œå¹¶æ·»åŠ åˆ°å¯¹åº”çš„é›†åˆä¸­ã€‚</p></li><li><p>ä»é›†åˆä¸­å»é™¤beanDefinition å¹¶æ³¨å†Œã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processConfigBeanDefinitions</span><span class="token punctuation">(</span>BeanDefinitionRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span> List<span class="token operator">&lt;</span>BeanDefinitionHolder<span class="token operator">></span> configCandidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// è¿™é‡Œå°±æ˜¯éœ€è¦æ³¨å†Œçš„æ‰€æœ‰bean çš„ name</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> candidateNames <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å¾ªç¯é€‰æ‹©å‡ºéœ€è¦æ³¨å†Œbeanä¸­çš„é…ç½®ç±» @Configuration </span> <span class="token keyword">for</span> <span class="token punctuation">(</span>String beanName <span class="token operator">:</span> candidateNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>     BeanDefinition beanDef <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDef<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>ConfigurationClassUtils<span class="token punctuation">.</span>CONFIGURATION_CLASS_ATTRIBUTE<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>             logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Bean definition has already been processed as a configuration class: "</span> <span class="token operator">+</span> beanDef<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>     <span class="token punctuation">}</span>     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ConfigurationClassUtils<span class="token punctuation">.</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         configCandidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// Return immediately if no @Configuration classes were found</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>configCandidates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// æ ¹æ® @Orderæ³¨è§£çš„æ’åº ï¼Œæ’ä½é å‰çš„å…ˆæ³¨å†Œ</span> configCandidates<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bd1<span class="token punctuation">,</span> bd2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token keyword">int</span> i1 <span class="token operator">=</span> ConfigurationClassUtils<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>bd1<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">int</span> i2 <span class="token operator">=</span> ConfigurationClassUtils<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>bd2<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">return</span> Integer<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>i1<span class="token punctuation">,</span> i2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Detect any custom bean name generation strategy supplied through the enclosing application context</span> SingletonBeanRegistry sbr <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯å•ä¾‹çš„</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>registry <span class="token keyword">instanceof</span> <span class="token class-name">SingletonBeanRegistry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     sbr <span class="token operator">=</span> <span class="token punctuation">(</span>SingletonBeanRegistry<span class="token punctuation">)</span> registry<span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>localBeanNameGeneratorSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>         BeanNameGenerator generator <span class="token operator">=</span> <span class="token punctuation">(</span>BeanNameGenerator<span class="token punctuation">)</span> sbr<span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span>                 AnnotationConfigUtils<span class="token punctuation">.</span>CONFIGURATION_BEAN_NAME_GENERATOR<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>generator <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">this</span><span class="token punctuation">.</span>componentScanBeanNameGenerator <span class="token operator">=</span> generator<span class="token punctuation">;</span>             <span class="token keyword">this</span><span class="token punctuation">.</span>importBeanNameGenerator <span class="token operator">=</span> generator<span class="token punctuation">;</span>         <span class="token punctuation">}</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  ConfigurationClassParser parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">(</span>         <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>problemReporter<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span>         <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentScanBeanNameGenerator<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span> Set<span class="token operator">&lt;</span>BeanDefinitionHolder<span class="token operator">></span> candidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>configCandidates<span class="token punctuation">)</span><span class="token punctuation">;</span> Set<span class="token operator">&lt;</span>ConfigurationClass<span class="token operator">></span> alreadyParsed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>configCandidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// è§£æé…ç½®ç±»ï¼Œè§£ææ‰«æè·¯å¾„ä¸‹è¢«@PropertySourceã€@ComponentScanã€@Importã€@ImportResourceã€@Beanä¿®é¥°çš„ç±»å’Œæ–¹æ³•ï¼Œå¹¶æ·»åŠ åˆ°å¯¹åº”çš„é›†åˆä¸­ã€‚</span>     parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>candidates<span class="token punctuation">)</span><span class="token punctuation">;</span>     parser<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     Set<span class="token operator">&lt;</span>ConfigurationClass<span class="token operator">></span> configClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getConfigurationClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     configClasses<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>alreadyParsed<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Read the model and create bean definitions based on its content</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationClassBeanDefinitionReader</span><span class="token punctuation">(</span>                 registry<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sourceExtractor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span>                 <span class="token keyword">this</span><span class="token punctuation">.</span>importBeanNameGenerator<span class="token punctuation">,</span> parser<span class="token punctuation">.</span><span class="token function">getImportRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>             <span class="token comment" spellcheck="true">// ä»å¯¹åº”çš„é›†åˆä¸­å–å‡ºå°†beanDefinitionæ³¨å†Œ</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>configClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>     alreadyParsed<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>configClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>     candidates<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦æœ‰æ–°çš„beanæ³¨å†Œï¼Œæœ‰å°±æ³¨å†Œ </span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> candidateNames<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>         String<span class="token punctuation">[</span><span class="token punctuation">]</span> newCandidateNames <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         Set<span class="token operator">&lt;</span>String<span class="token operator">></span> oldCandidateNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>candidateNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         Set<span class="token operator">&lt;</span>String<span class="token operator">></span> alreadyParsedClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">for</span> <span class="token punctuation">(</span>ConfigurationClass configurationClass <span class="token operator">:</span> alreadyParsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>             alreadyParsedClasses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>configurationClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">for</span> <span class="token punctuation">(</span>String candidateName <span class="token operator">:</span> newCandidateNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldCandidateNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>candidateName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                 BeanDefinition bd <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>candidateName<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span>ConfigurationClassUtils<span class="token punctuation">.</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                         <span class="token operator">!</span>alreadyParsedClasses<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                     candidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span> candidateName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>             <span class="token punctuation">}</span>         <span class="token punctuation">}</span>         candidateNames <span class="token operator">=</span> newCandidateNames<span class="token punctuation">;</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sbr <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sbr<span class="token punctuation">.</span><span class="token function">containsSingleton</span><span class="token punctuation">(</span>IMPORT_REGISTRY_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     sbr<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span>IMPORT_REGISTRY_BEAN_NAME<span class="token punctuation">,</span> parser<span class="token punctuation">.</span><span class="token function">getImportRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory <span class="token keyword">instanceof</span> <span class="token class-name">CachingMetadataReaderFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span>     <span class="token comment" spellcheck="true">// for a shared cache since it'll be cleared by the ApplicationContext.</span>     <span class="token punctuation">(</span><span class="token punctuation">(</span>CachingMetadataReaderFactory<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="registerBeanPostProcessors-beanFactory"><a href="#registerBeanPostProcessors-beanFactory" class="headerlink" title="registerBeanPostProcessors(beanFactory)"></a>registerBeanPostProcessors(beanFactory)</h4><p>å®ä¾‹åŒ–å’Œæ³¨å†ŒbeanFactoryä¸­æ‰©å±•äº†BeanPostProcessorçš„beanã€‚<br>ä¾‹å¦‚ï¼š<br><code>AutowiredAnnotationBeanPostProcessor</code>(å¤„ç†è¢«@Autowiredæ³¨è§£ä¿®é¥°çš„beanå¹¶æ³¨å…¥)<br><code>RequiredAnnotationBeanPostProcessor</code>(å¤„ç†è¢«@Requiredæ³¨è§£ä¿®é¥°çš„æ–¹æ³•)<br><code>CommonAnnotationBeanPostProcessor</code>(å¤„ç†@PreDestroyã€@PostConstructã€@Resourceç­‰å¤šä¸ªæ³¨è§£çš„ä½œç”¨)ç­‰</p></li></ol><h4 id="initMessageSource-ã€éIOCä¸»çº¿ä»£ç ã€‘"><a href="#initMessageSource-ã€éIOCä¸»çº¿ä»£ç ã€‘" class="headerlink" title="initMessageSource()ã€éIOCä¸»çº¿ä»£ç ã€‘"></a>initMessageSource()ã€éIOCä¸»çº¿ä»£ç ã€‘</h4><p>åˆå§‹åŒ–å›½é™…åŒ–èµ„æºå¤„ç†å™¨</p><h4 id="initApplicationEventMulticaster"><a href="#initApplicationEventMulticaster" class="headerlink" title="initApplicationEventMulticaster()"></a>initApplicationEventMulticaster()</h4><p>åˆå§‹åŒ–åˆ›å»ºäº‹ä»¶å¤šæ’­å™¨ã€‚</p><h4 id="registerListeners"><a href="#registerListeners" class="headerlink" title="registerListeners()"></a>registerListeners()</h4><p>æ³¨å†Œç›‘å¬å™¨</p><p>ä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•ã€<code>initApplicationEventMulticaster</code>/<code>registerListeners</code>ã€‘å’Œspringçš„äº‹ä»¶ç›‘å¬æœºåˆ¶å¯†åˆ‡ç›¸å…³ã€‚</p><h4 id="onRefresh"><a href="#onRefresh" class="headerlink" title="onRefresh()"></a>onRefresh()</h4><p>springæä¾›çš„æ‹“å±•ç‚¹ï¼Œåœ¨springbootä¸­æœ‰è¢«ä½¿ç”¨</p><h4 id="finishBeanFactoryInitialization"><a href="#finishBeanFactoryInitialization" class="headerlink" title="finishBeanFactoryInitialization()"></a>finishBeanFactoryInitialization()</h4><p>å®Œæˆä¸Šä¸‹æ–‡çš„beanå·¥å‚çš„åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–æ‰€æœ‰å‰©ä½™çš„å•ä¾‹beanã€‚<br>éœ€è¦å…³æ³¨çš„æ ¸å¿ƒä»£ç </p><ol><li><p>å°†æ‰€æœ‰beanDefinitionè®¾ç½®ä¸ºä¸å¯å˜ï¼Œé¿å…åœ¨å®ä¾‹åŒ–æ—¶ï¼Œbeanå®šä¹‰å‘ç”Ÿæ”¹å˜</p></li><li><p>å®ä¾‹åŒ–æ‰€æœ‰å•ä¾‹bean</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// å°†æ‰€æœ‰beanDefinitionè®¾ç½®ä¸ºä¸å¯å˜ï¼Œé¿å…åœ¨å®ä¾‹åŒ–æ—¶ï¼Œbeanå®šä¹‰å‘ç”Ÿæ”¹å˜</span>beanFactory<span class="token punctuation">.</span><span class="token function">freezeConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// å®ä¾‹åŒ–æ‰€æœ‰å•ä¾‹bean</span>beanFactory<span class="token punctuation">.</span><span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h5 id="DefaultListableBeanFactory-preInstantiateSingletons"><a href="#DefaultListableBeanFactory-preInstantiateSingletons" class="headerlink" title="DefaultListableBeanFactory.preInstantiateSingletons()"></a>DefaultListableBeanFactory.preInstantiateSingletons()</h5></li><li><p>è·å–ä¹‹å‰ä¿å­˜åœ¨beanDefinitionNamesä¸­çš„æ‰€æœ‰çš„beanName</p></li><li><p>å¾ªç¯beanï¼Œè·å–ä½œç”¨åŸŸä¸ºå•ä¾‹çš„bean</p></li><li><p>åˆ¤æ–­æ˜¯å¦æ˜¯factoryBeanç±»å‹ã€beanç»§æ‰¿FactoryBeanï¼Œé€šè¿‡é‡å†™getObject()ï¼Œè‡ªå®šä¹‰ä¼ å…¥beanã€‘</p></li><li><p>éfactoryBeanï¼Œé€šè¿‡getBeanå®ä¾‹åŒ–,å¹¶å°†beanå®ä¾‹ä¿å­˜åœ¨å®¹å™¨(DefaultSingletonBeanRegistry.singletonObjects)ä¸­</p></li><li><p>è°ƒç”¨æ‰€æœ‰å®ä¾‹åŒ–å®Œæˆçš„beançš„å›è°ƒæ–¹æ³•</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> BeansException <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Pre-instantiating singletons in "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// è·å–ä¹‹å‰ä¿å­˜åœ¨beanDefinitionNamesä¸­çš„beanName</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> beanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å¾ªç¯beanï¼Œè·å–å•ä¾‹bean</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>String beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>     RootBeanDefinition bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦æ˜¯factoryBean</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>             Object bean <span class="token operator">=</span> <span class="token function">getBean</span><span class="token punctuation">(</span>FACTORY_BEAN_PREFIX <span class="token operator">+</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                 FactoryBean<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> factory <span class="token operator">=</span> <span class="token punctuation">(</span>FactoryBean<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>                 <span class="token keyword">boolean</span> isEagerInit<span class="token punctuation">;</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                     isEagerInit <span class="token operator">=</span> AccessController<span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>                             <span class="token punctuation">(</span>PrivilegedAction<span class="token operator">&lt;</span>Boolean<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>SmartFactoryBean<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token operator">:</span><span class="token operator">:</span>isEagerInit<span class="token punctuation">,</span>                             <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">else</span> <span class="token punctuation">{</span>                     isEagerInit <span class="token operator">=</span> <span class="token punctuation">(</span>factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span> <span class="token operator">&amp;&amp;</span>                             <span class="token punctuation">(</span><span class="token punctuation">(</span>SmartFactoryBean<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEagerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span>isEagerInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>                     <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>             <span class="token punctuation">}</span>         <span class="token punctuation">}</span>         <span class="token keyword">else</span> <span class="token punctuation">{</span>             <span class="token comment" spellcheck="true">// æ²¡æœ‰ç»§æ‰¿FacetoryBeançš„beanï¼Œé€šè¿‡getBeanå®ä¾‹åŒ–</span>             <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// è§¦å‘æ‰€æœ‰å®ä¾‹åŒ–beançš„å›è°ƒæ–¹æ³•</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>String beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>     Object singletonInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonInstance <span class="token keyword">instanceof</span> <span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         SmartInitializingSingleton smartSingleton <span class="token operator">=</span> <span class="token punctuation">(</span>SmartInitializingSingleton<span class="token punctuation">)</span> singletonInstance<span class="token punctuation">;</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>             AccessController<span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PrivilegedAction<span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>                 smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token keyword">return</span> null<span class="token punctuation">;</span>             <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">else</span> <span class="token punctuation">{</span>             smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>     <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="finishRefresh"><a href="#finishRefresh" class="headerlink" title="finishRefresh()"></a>finishRefresh()</h4><p>å‘å¸ƒç›¸åº”çš„äº‹ä»¶</p></li><li><p>æ¸…é™¤ä¸Šä¸‹æ–‡èµ„æºç¼“å­˜ï¼ˆå¦‚æ‰«æä¸­çš„ASMå…ƒæ•°æ®ï¼‰</p></li><li><p>åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ï¼Œå¹¶åˆ·æ–°ï¼ˆæ‰¾å‡ºSpringå®¹å™¨ä¸­å®ç°äº†Lifecycleæ¥å£çš„beanå¹¶æ‰§è¡Œstart()æ–¹æ³•ï¼‰ã€‚</p></li><li><p>å‘å¸ƒContextRefreshedEventäº‹ä»¶å‘ŠçŸ¥å¯¹åº”çš„ApplicationListenerè¿›è¡Œå“åº”çš„æ“ä½œ</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// æ¸…é™¤ä¸Šä¸‹æ–‡çš„èµ„æºç¼“å­˜ï¼ˆä¾‹å¦‚æ¥è‡ªæ‰«æçš„ASMå…ƒæ•°æ®ï¼‰ã€‚</span> <span class="token function">clearResourceCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨</span> <span class="token function">initLifecycleProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// é¦–å…ˆå°†åˆ·æ–°ä¼ æ’­åˆ°ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ã€‚</span> <span class="token function">getLifecycleProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// æ¨é€ä¸Šä¸‹æ–‡åˆ·æ–°å®Œæ¯•äº‹ä»¶åˆ°ç›¸åº”çš„ç›‘å¬å™¨</span> <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextRefreshedEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Participate in LiveBeansView MBean, if active.</span> LiveBeansView<span class="token punctuation">.</span><span class="token function">registerApplicationContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è‡³æ­¤Spring IOC åˆå§‹åŒ–å’Œspring beanåŠ è½½è¿‡ç¨‹å°±ç»“æŸ.  </p></li></ol><p><strong>Spring IOC åˆå§‹åŒ–</strong>: åˆ›å»º<code>beanFactory</code>å®ä¾‹å¯¹è±¡,åˆ›å»º<code>BeanDefinitionReader</code>,åˆ›å»º<code>BeanDefinitionScanner</code>,å°†<code>ContextAnnotationAutowireCandidateResolver</code>,<code>ConfigurationClassPostProcessorã€beançš„æ‰«æå’Œæ³¨å†Œã€‘</code>,<code>CommonAnnotationBeanPostProcessor</code>,<code>AutowiredAnnotationBeanPostProcessorã€@Autowiredå±æ€§çš„è‡ªåŠ¨æ³¨å…¥ã€‘</code>,<code>PersistenceAnnotationBeanPostProcessor</code> è¿™5ä¸ªç»„ä»¶æ·»åŠ åˆ°springå®¹å™¨ä¸­ã€‚</p><p><strong>spring beanåŠ è½½è¿‡ç¨‹</strong>: </p><ul><li>é€šè¿‡<code>BeanDefinitionReader</code>å°†beané…ç½®ç±»ä»java_configä¸­è¯»å–å‡ºæ¥</li><li>å†ç”±<code>ConfigurationClassPostProcessor</code>è§£æé…ç½®ç±» </li><li>é€šè¿‡<code>BeanDefinitionScanner</code>æ‰«æé…ç½®ç±»ä¸­çš„é…ç½®çš„æ‰«æè·¯å¾„</li><li>ç”±<code>ConfigurationClassPostProcessor</code>åŒ…è£…æˆbeanDefinition,æ³¨å†Œåˆ°ï¼ˆputï¼‰beanDefinitionMapä¸­ã€‚</li><li>æœ€åé€šè¿‡<code>beanFactory</code>çš„<code>getBean</code>æ–¹æ³•å°†beanå®ä¾‹åŒ–.<ul><li>åœ¨è¿™è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨<code>registerBeanPostProcessors</code>æ–¹æ³•æ³¨å†Œçš„åç½®å¤„ç†å™¨,å¯¹beanè¿›è¡Œæ•°æ®å¡«å……</li><li><blockquote><p><code>AutowiredAnnotationBeanPostProcessor</code>(å¤„ç†è¢«@Autowiredæ³¨è§£ä¿®é¥°çš„beanå¹¶æ³¨å…¥)<br><code>RequiredAnnotationBeanPostProcessor</code>(å¤„ç†è¢«@Requiredæ³¨è§£ä¿®é¥°çš„æ–¹æ³•)<br><code>CommonAnnotationBeanPostProcessor</code>(å¤„ç†@PreDestroyã€@PostConstructã€@Resourceç­‰å¤šä¸ªæ³¨è§£çš„ä½œç”¨)ç­‰</p></blockquote></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»0åˆ°1 - å¸¦ä½ äº†è§£çº¿ç¨‹æ± </title>
      <link href="/2020/12/22/%E4%BB%8E0%E5%88%B01%20-%20%E5%B8%A6%E4%BD%A0%E4%BA%86%E8%A7%A3%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
      <url>/2020/12/22/%E4%BB%8E0%E5%88%B01%20-%20%E5%B8%A6%E4%BD%A0%E4%BA%86%E8%A7%A3%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="1-çº¿ç¨‹"><a href="#1-çº¿ç¨‹" class="headerlink" title="1. çº¿ç¨‹"></a>1. çº¿ç¨‹</h2><p>çº¿ç¨‹æ˜¯è°ƒåº¦CPUçš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ¨¡å‹åˆ†ä¸º ULT å’Œ KLTã€‚  </p><p>JVM ä½¿ç”¨çš„æ˜¯KLTæ¨¡å‹ï¼Œjavaçº¿ç¨‹å’Œæ“ä½œç³»ç»Ÿosçº¿ç¨‹ä¿æŒç€ä¸€å¯¹ä¸€çš„æ˜ å°„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯åˆ›å»ºä¸€ä¸ªjavaçº¿ç¨‹å°±æ„å‘³ç€åœ¨æ“ä½œç³»ç»Ÿé‡Œæ–°å»ºäº†ä¸€ä¸ªosçº¿ç¨‹ã€‚</p><span id="more"></span> <p> <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a70a7afd767f49fba65759ca08927bc4~tplv-k3u1fbpfcp-watermark.image"></p><p>JVMæ˜¯è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´çš„ï¼Œå¦‚æœéœ€è¦åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œéœ€è¦å°†çº¿ç¨‹ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼ˆæ¯”è¾ƒè€—æ—¶ï¼Œæ€§èƒ½è¾ƒä½ï¼‰ã€‚å¦‚æœå¹¶å‘è¯·æ±‚éå¸¸å¤šï¼Œä½†æ˜¯æ¯ä¸ªçº¿ç¨‹è¿è¡Œæ—¶é—´æ¯”è¾ƒçŸ­ã€‚è¿™æ ·å°±ä¼šé¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ã€‚å¯èƒ½ä¼šå‡ºç° <strong>åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹</strong> æ¯” <strong>å®é™…ä¸šåŠ¡å¤„ç†èŠ±è´¹</strong> çš„æ—¶é—´å’Œèµ„æº è¿˜è¦å¤šã€‚  </p><p>å› æ­¤å¼•å…¥äº†<strong>çº¿ç¨‹æ± </strong>çš„æ¦‚å¿µ</p><h2 id="2-çº¿ç¨‹æ± "><a href="#2-çº¿ç¨‹æ± " class="headerlink" title="2. çº¿ç¨‹æ± "></a>2. çº¿ç¨‹æ± </h2><p>çº¿ç¨‹æ±  é¡¾åæ€ä¹‰å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ”¾ä»»ä»£ç æ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—æœåŠ¡å™¨èµ„æºï¼Œä¹Ÿä¼šå½±å“ç³»ç»Ÿçš„ç¨³å®šã€‚å› æ­¤ JAVA æä¾›äº†çº¿ç¨‹æ± å¯¹çº¿ç¨‹çš„ç»Ÿä¸€åˆ›å»ºã€åˆ†é…ã€è°ƒä¼˜å’Œç›‘æ§ã€‚</p><h3 id="2-1-çº¿ç¨‹æ± å¦‚ä½•ä½¿ç”¨"><a href="#2-1-çº¿ç¨‹æ± å¦‚ä½•ä½¿ç”¨" class="headerlink" title="2.1 çº¿ç¨‹æ± å¦‚ä½•ä½¿ç”¨"></a>2.1 çº¿ç¨‹æ± å¦‚ä½•ä½¿ç”¨</h3><pre class=" language-java"><code class="language-java">ThreadPoolExecutor tpe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">,</span>    TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>  <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span>Runnable<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tpe<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹æ‰§è¡Œ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ‰§è¡Œç»“æŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>            exception<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>tpe<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    </code></pre><h3 id="2-2-çº¿ç¨‹æ± åˆ›å»ºçš„ä¸»è¦å‚æ•°"><a href="#2-2-çº¿ç¨‹æ± åˆ›å»ºçš„ä¸»è¦å‚æ•°" class="headerlink" title="2.2 çº¿ç¨‹æ± åˆ›å»ºçš„ä¸»è¦å‚æ•°"></a>2.2 çº¿ç¨‹æ± åˆ›å»ºçš„ä¸»è¦å‚æ•°</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>                              TimeUnit unit<span class="token punctuation">,</span>                              BlockingQueue<span class="token operator">&lt;</span>Runnable<span class="token operator">></span> workQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span>         Executors<span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultHandler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li>corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°</li><li>maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°</li><li>keepAliveTimeï¼šçº¿ç¨‹æœ€å¤§ç©ºé—²æ—¶é—´</li><li>unitï¼šæ—¶é—´å•ä½</li><li>workQueueï¼šé˜»å¡é˜Ÿåˆ—ï¼Œå­˜æ”¾æœªæ‰§è¡Œçš„ä»»åŠ¡</li><li>Executors.defaultThreadFactory()ï¼šçº¿ç¨‹åˆ›å»ºå·¥å‚æ–¹æ³•</li><li>defaultHandlerï¼šçº¿ç¨‹è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°æ—¶çš„æ‹’ç»ç­–ç•¥</li></ul><h3 id="2-3-çº¿ç¨‹æ± å·¥ä½œæµç¨‹"><a href="#2-3-çº¿ç¨‹æ± å·¥ä½œæµç¨‹" class="headerlink" title="2.3 çº¿ç¨‹æ± å·¥ä½œæµç¨‹"></a>2.3 çº¿ç¨‹æ± å·¥ä½œæµç¨‹</h3><p> <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f1f7af96f7c4fbbb7706b54a66a461d~tplv-k3u1fbpfcp-watermark.image"></p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Runnable command<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> null<span class="token punctuation">)</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ã€1ã€‘</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ã€2ã€‘</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ã€3ã€‘</span>            <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// é‡å¤æ£€éªŒï¼Œé˜²æ­¢å¹¶å‘é—®é¢˜</span>                <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// æ‹’ç»ç­–ç•¥</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">addWorker</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ã€4ã€‘</span>            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><ul><li>ã€1ã€‘ ctl ï¼šè¯¥å‚æ•°åŒ…å«çº¿ç¨‹æ± çš„ä¸¤ä¸ªé‡è¦å‚æ•°ï¼š1. çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ã€32ä½çš„å‰3ä½ã€‘ ã€2. çº¿ç¨‹æ± ä¸­è¿è¡Œçš„çº¿ç¨‹æ•°ï¼ˆæ ¸å¿ƒçº¿ç¨‹+éæ ¸å¿ƒçº¿ç¨‹ï¼‰ã€‚    é‡å¤è·å–çš„åŸå› æ˜¯ï¼šctl.get()ä¸æ˜¯åŸå­æ€§çš„ï¼Œé˜²æ­¢å¹¶å‘è®¿é—®æ—¶ï¼Œæ•°æ®çš„è„è¯»ã€‚</li></ul><pre class=" language-java"><code class="language-java">    RUNNING    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1110 0000 0000 0000 0000 0000 0000 0000</span>    SHUTDOWN   <span class="token operator">=</span>  <span class="token number">0</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 0000 0000 0000 0000 0000 0000 0000 0000</span>    STOP       <span class="token operator">=</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 0010 0000 0000 0000 0000 0000 0000 0000</span>    TIDYING    <span class="token operator">=</span>  <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 0100 0000 0000 0000 0000 0000 0000 0000</span>    TERMINATED <span class="token operator">=</span>  <span class="token number">3</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 0110 0000 0000 0000 0000 0000 0000 0000</span></code></pre><ul><li><p>workerCountOf(c)ï¼šé€šè¿‡ä½è¿ç®—è·å–çº¿ç¨‹æ± ä¸­è¿è¡Œçš„çº¿ç¨‹æ•°</p></li><li><p>ã€2ã€‘ addWorker(command, true)ï¼šå°†ä»»åŠ¡å°è£…æˆ <strong>workerå¯¹è±¡</strong>ï¼Œå¹¶åˆå§‹åŒ–å¹¶æ‰§è¡Œçº¿ç¨‹ã€‚</p></li><li><p>ã€3ã€‘ å¦‚æœæ ¸å¿ƒçº¿ç¨‹å·²ç»æ»¡äº†ï¼Œåˆ™å°†ä»»åŠ¡åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚</p></li><li><p>ã€4ã€‘ é˜»å¡é˜Ÿåˆ—åŠ å…¥å¤±è´¥ï¼Œåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ï¼Œå¦‚æœå¤±è´¥ï¼Œæ‰§è¡Œå¤±è´¥ç­–ç•¥ </p></li></ul><h4 id="2-3-1-workerå¯¹è±¡"><a href="#2-3-1-workerå¯¹è±¡" class="headerlink" title="2.3.1 workerå¯¹è±¡"></a>2.3.1 workerå¯¹è±¡</h4><p>çº¿ç¨‹æ± å¹¶ <strong>ä¸ç›´æ¥æ‰§è¡Œ</strong> æˆ‘ä»¬æäº¤çš„ä»»åŠ¡ï¼Œè€Œæ˜¯å°†ä»»åŠ¡é‡æ–°å°è£…æˆ worker å¯¹è±¡ã€‚ThreadPoolç»´æŠ¤çš„ å…¶å®æ˜¯ä¸€ç»„workerå¯¹è±¡ã€‚</p><p>workerç±»ç»§æ‰¿äº†AQSï¼Œä½¿ç”¨AQSæ¥å®ç°ç‹¬å é”çš„åŠŸèƒ½ï¼ˆä¸å¯é‡å…¥ï¼‰ã€‚   </p><p>å¹¶å®ç°äº†Runnableæ¥å£ï¼Œæ‰€ä»¥workerå¯¹è±¡æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨ å¯åŠ¨çš„æ—¶å€™ä¼šè°ƒç”¨Workerç±»ä¸­çš„runæ–¹æ³•ã€‚  </p><p>ç±»å±æ€§ï¼š</p><ul><li>firstTaskï¼šç”¨å®ƒæ¥ä¿å­˜ä¼ å…¥çš„ä»»åŠ¡</li><li>threadï¼šåœ¨è°ƒç”¨æ„é€ æ–¹æ³•æ—¶é€šè¿‡ ThreadFactory æ¥åˆ› å»ºçš„çº¿ç¨‹ï¼Œæ˜¯ç”¨æ¥å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹</li></ul><h4 id="2-3-2-addWorker-æ–¹æ³•"><a href="#2-3-2-addWorker-æ–¹æ³•" class="headerlink" title="2.3.2 addWorker æ–¹æ³•"></a>2.3.2 addWorker æ–¹æ³•</h4><p><strong>executeæ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨addWorkeræ¥åˆ›å»ºå¹¶æ‰§è¡Œçº¿ç¨‹ï¼ˆæ ¸å¿ƒ+éæ ¸å¿ƒï¼‰</strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addWorker</span><span class="token punctuation">(</span>Runnable firstTask<span class="token punctuation">,</span> <span class="token keyword">boolean</span> core<span class="token punctuation">)</span> <span class="token punctuation">{</span>        retry<span class="token operator">:</span>        <span class="token comment" spellcheck="true">/* ä¿è¯çº¿ç¨‹å®‰å…¨ä»£ç  */</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">>=</span> SHUTDOWN <span class="token operator">&amp;&amp;</span>                <span class="token operator">!</span> <span class="token punctuation">(</span>rs <span class="token operator">==</span> SHUTDOWN <span class="token operator">&amp;&amp;</span>                   firstTask <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span>                   <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">>=</span> CAPACITY <span class="token operator">||</span>                    wc <span class="token operator">>=</span> <span class="token punctuation">(</span>core <span class="token operator">?</span> corePoolSize <span class="token operator">:</span> maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndIncrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token keyword">break</span> retry<span class="token punctuation">;</span>                c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Re-read ctl</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> rs<span class="token punctuation">)</span>                    <span class="token keyword">continue</span> retry<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/*ä¸Šé¢ä»£ç æ˜¯ä¸ºäº†çº¿ç¨‹å®‰å…¨ï¼Œåˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦å­˜æ´»ã€æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦ç©ºä½™ç­‰ï¼ˆå¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šæœ‰æ ¸å¿ƒçº¿ç¨‹ç©ºä½™å‡ºæ¥ï¼‰*/</span>            <span class="token comment" spellcheck="true">/*æ–°å»ºçº¿ç¨‹å¹¶æ‰§è¡Œ*/</span>        <span class="token keyword">boolean</span> workerStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> workerAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        Worker w <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> Thread t <span class="token operator">=</span> w<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">final</span> ReentrantLock mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>                mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">/*åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å­˜æ´»çš„*/</span>                    <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&lt;</span> SHUTDOWN <span class="token operator">||</span>                        <span class="token punctuation">(</span>rs <span class="token operator">==</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// precheck that t is startable</span>                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        workers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> s <span class="token operator">=</span> workers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">></span> largestPoolSize<span class="token punctuation">)</span>                            largestPoolSize <span class="token operator">=</span> s<span class="token punctuation">;</span>                        workerAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                    mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>workerAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">/*æ‰§è¡Œä»»åŠ¡*/</span>                    t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    workerStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> workerStarted<span class="token punctuation">)</span>                <span class="token function">addWorkerFailed</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> workerStarted<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>ä»¥ä¸Šä»£ç çœŸæ­£ç”¨äºåˆ›å»ºå¹¶æ‰§è¡Œä»»åŠ¡çš„ä»£ç åªæœ‰ä¸‰è¡Œï¼Œå…¶ä½™ä»£ç éƒ½æ˜¯ä¸ºäº†ä¿è¯å¹¶å‘å®‰å…¨ã€‚</p><pre class=" language-java"><code class="language-java">w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// åˆ›å»ºworkerï¼Œå¹¶ç»‘å®šçº¿ç¨‹</span><span class="token keyword">final</span> Thread t <span class="token operator">=</span> w<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// æ‰§è¡Œçº¿ç¨‹</span></code></pre><p><strong>t.start(); æ‰§è¡Œåï¼Œworkerå¯¹è±¡ä¼šè¢«è°ƒç”¨å¹¶æ‰§è¡Œ worker.run() æ–¹æ³•</strong></p><h4 id="2-3-3-Workerç±»çš„-runWorker-æ–¹æ³•"><a href="#2-3-3-Workerç±»çš„-runWorker-æ–¹æ³•" class="headerlink" title="2.3.3 Workerç±»çš„ runWorker æ–¹æ³•"></a>2.3.3 Workerç±»çš„ runWorker æ–¹æ³•</h4><p>runWorker æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p><ul><li>å…ˆè·å–workerå¯¹è±¡ä¸­çš„ä»»åŠ¡ firstTask</li><li>å¦‚æœ firstTask ä¸ºç©ºï¼Œåˆ™å¾ªç¯ä¸­é˜Ÿåˆ—é‡Œæ‹‰å–ä»»åŠ¡ã€‚</li><li> å¦‚æœçº¿ç¨‹æ± æ­£åœ¨åœæ­¢ï¼Œé‚£ä¹ˆè¦ä¿è¯å½“å‰çº¿ç¨‹æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œå¦åˆ™è¦ä¿è¯å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸­æ–­çŠ¶æ€ï¼›</li><li>é˜Ÿåˆ—ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæˆï¼Œæ‰§è¡ŒprocessWorkerExitï¼Œç„¶åé”€æ¯çº¿ç¨‹ã€‚</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runWorker</span><span class="token punctuation">(</span>Worker w<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Thread wt <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Runnable task <span class="token operator">=</span> w<span class="token punctuation">.</span>firstTask<span class="token punctuation">;</span>    w<span class="token punctuation">.</span>firstTask <span class="token operator">=</span> null<span class="token punctuation">;</span>    w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> completedAbruptly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/**         * getTaskï¼š         *         æ ¸å¿ƒçº¿ç¨‹ï¼šé€šè¿‡takeç›´æ¥è·å–ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™é˜»å¡ç­‰å¾…è·å–ã€‚         *         éæ ¸å¿ƒçº¿ç¨‹ï¼šé€šè¿‡pollè·å–å¹¶è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè·å–æ—¶å¦‚æœè¶…è¿‡keepAliveTime         *                  åˆ™è·å–å¤±è´¥è¿”å›null         */</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>task <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            w<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/**             * åˆ¤æ–­çº¿ç¨‹å¤„äºstopçŠ¶æ€æ—¶ï¼Œçº¿ç¨‹ä¸€å®šæ˜¯ä¸­æ–­çš„             * stopçŠ¶æ€ï¼šä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä¹Ÿä¸ä»é˜Ÿåˆ—é‡Œæ‹‰å–æ–°çš„çº¿ç¨‹ï¼Œå¹¶ä¸­æ–­æ­£åœ¨å¤„ç†çš„çº¿ç¨‹             */</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span> <span class="token operator">||</span>                    <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                            <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                    <span class="token operator">!</span>wt<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                wt<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token function">beforeExecute</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ç©ºæ–¹æ³•ï¼Œå…è®¸å­ç±»é‡å†™</span>                Throwable thrown <span class="token operator">=</span> null<span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// çœŸæ­£æ‰§è¡Œä»»åŠ¡</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                    <span class="token function">afterExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> thrown<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ç©ºæ–¹æ³•ï¼Œå…è®¸å­ç±»é‡å†™</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                task <span class="token operator">=</span> null<span class="token punctuation">;</span>                w<span class="token punctuation">.</span>completedTasks<span class="token operator">++</span><span class="token punctuation">;</span>                w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        completedAbruptly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token function">processWorkerExit</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> completedAbruptly<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="2-3-4-getTask-æ–¹æ³•"><a href="#2-3-4-getTask-æ–¹æ³•" class="headerlink" title="2.3.4  getTask æ–¹æ³•"></a>2.3.4  getTask æ–¹æ³•</h4><p>æ ¸å¿ƒçº¿ç¨‹ï¼šé€šè¿‡takeç›´æ¥è·å–ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™é˜»å¡ç­‰å¾…è·å–ã€‚<br>éæ ¸å¿ƒçº¿ç¨‹ï¼šé€šè¿‡pollè·å–å¹¶è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè·å–æ—¶å¦‚æœè¶…è¿‡keepAliveTimeï¼Œåˆ™è·å–å¤±è´¥è¿”å›null</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> Runnable <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">boolean</span> timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Did the last poll() time out?</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å·²ç»stopï¼Œå¦‚æœæ˜¯å·¥ä½œçº¿ç¨‹æ•°-1ï¼Œå¹¶è¿”å›null </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">>=</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rs <span class="token operator">>=</span> STOP <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ ¸å¿ƒçº¿ç¨‹æ²¡æœ‰è¶…æ—¶è®¾ç½®ï¼Œ</span>        <span class="token comment" spellcheck="true">// éæ ¸å¿ƒçº¿ç¨‹éœ€è¦è¶…æ—¶è®¾ç½®</span>        <span class="token keyword">boolean</span> timed <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">||</span> wc <span class="token operator">></span> corePoolSize<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// wc > maximumPoolSizeï¼šå½“å‰çº¿ç¨‹æ•°>æœ€å¤§çº¿ç¨‹æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ã€‚</span>        <span class="token comment" spellcheck="true">// timed &amp;&amp; timedOut ä¸ºtrue è¡¨ç¤ºæ‰§è¡Œçš„æ˜¯éæ ¸å¿ƒçº¿ç¨‹ï¼Œä¸”å·²ç»è¶…æ—¶ï¼ˆè¶…æ—¶é™¤äº†æ€§èƒ½é—®é¢˜ï¼Œå°±æ˜¯é˜Ÿåˆ—å·²ç»ä¸ºç©ºï¼‰ã€‚</span>        <span class="token comment" spellcheck="true">// ä»¥ä¸Šä¸¤ç§æƒ…å†µè¯´æ˜ï¼šè¯¥éæ ¸å¿ƒçº¿ç¨‹å·²ç»æ²¡æœ‰å¿…è¦å­˜åœ¨ï¼Œå¯ä»¥é”€æ¯ã€‚</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wc <span class="token operator">></span> maximumPoolSize <span class="token operator">||</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> timedOut<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wc <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndDecrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> null<span class="token punctuation">;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Runnable r <span class="token operator">=</span> timed <span class="token operator">?</span>                workQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">)</span> <span class="token operator">:</span>                workQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span>                <span class="token keyword">return</span> r<span class="token punctuation">;</span>            timedOut <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> retry<span class="token punctuation">)</span> <span class="token punctuation">{</span>            timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>åœ¨æ‰§è¡Œexecuteæ–¹æ³•æ—¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡è¶…è¿‡äº†corePoolSizeä¸”å°äº maximumPoolSizeï¼Œå¹¶ä¸”workQueueå·²æ»¡æ—¶ï¼Œåˆ™å¯ä»¥å¢åŠ å·¥ä½œçº¿ç¨‹ï¼Œä½†è¿™æ—¶å¦‚æœè¶…æ—¶æ²¡ æœ‰è·å–åˆ°ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯timedOutä¸ºtrueçš„æƒ…å†µï¼Œè¯´æ˜workQueueå·²ç»ä¸ºç©ºäº†ï¼Œä¹Ÿå°±è¯´æ˜äº† å½“å‰çº¿ç¨‹æ± ä¸­ä¸éœ€è¦é‚£ä¹ˆå¤šçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡äº†ï¼Œå¯ä»¥æŠŠå¤šäºcorePoolSizeæ•°é‡çš„çº¿ç¨‹é”€æ¯æ‰ï¼Œä¿æŒçº¿ç¨‹æ•°é‡åœ¨corePoolSizeå³å¯ã€‚</p><h4 id="2-3-5-processWorkerExit-æ–¹æ³•"><a href="#2-3-5-processWorkerExit-æ–¹æ³•" class="headerlink" title="2.3.5 processWorkerExit æ–¹æ³•"></a>2.3.5 processWorkerExit æ–¹æ³•</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processWorkerExit</span><span class="token punctuation">(</span>Worker w<span class="token punctuation">,</span> <span class="token keyword">boolean</span> completedAbruptly<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¦‚æœrunWorkeræ–¹æ³•æ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œè¿™æ®µä»£ç ä¸æ‰§è¡Œ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>completedAbruptly<span class="token punctuation">)</span>             <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> ReentrantLock mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>        mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            completedTaskCount <span class="token operator">+=</span> w<span class="token punctuation">.</span>completedTasks<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ä»workersä¸­ç§»é™¤ï¼Œä¹Ÿå°±è¡¨ç¤ºç€ä»çº¿ç¨‹æ± ä¸­ç§»é™¤äº†ä¸€ä¸ªå·¥ä½œçº¿ç¨‹</span>            workers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ ¹æ®çº¿ç¨‹æ± çŠ¶æ€è¿›è¡Œåˆ¤æ–­æ˜¯å¦ç»“æŸçº¿ç¨‹æ± </span>        <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å½“çº¿ç¨‹æ± æ˜¯RUNNINGæˆ–SHUTDOWNçŠ¶æ€æ—¶ï¼Œå¦‚æœworkeræ˜¯å¼‚å¸¸ç»“æŸï¼Œé‚£ä¹ˆä¼šç›´æ¥addWorkerï¼›</span>        <span class="token comment" spellcheck="true">// å¦‚æœallowCoreThreadTimeOut=trueï¼Œå¹¶ä¸”ç­‰å¾…é˜Ÿåˆ—æœ‰ä»»åŠ¡ï¼Œè‡³å°‘ä¿ç•™ä¸€ä¸ªworkerï¼›</span>        <span class="token comment" spellcheck="true">// å¦‚æœallowCoreThreadTimeOut=falseï¼ŒworkerCountä¸å°‘äºcorePoolSizeã€‚è¿˜å­˜åœ¨éæ ¸å¿ƒçº¿ç¨‹</span>        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateLessThan</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> STOP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>completedAbruptly<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">int</span> min <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> corePoolSize<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>min <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    min <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">>=</span> min<span class="token punctuation">)</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// replacement not needed</span>            <span class="token punctuation">}</span>            <span class="token function">addWorker</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h3 id="2-3-æ‹’ç»ç­–ç•¥"><a href="#2-3-æ‹’ç»ç­–ç•¥" class="headerlink" title="2.3 æ‹’ç»ç­–ç•¥"></a>2.3 æ‹’ç»ç­–ç•¥</h3><p>å¦‚æœåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å¤±è´¥ï¼Œçº¿ç¨‹æ± æœ‰4ä¸­æ‹’ç»ç­–ç•¥</p><ul><li><p>CallerRunsPolicyï¼šè°è°ƒç”¨è°æ‰§è¡Œã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span>Runnable r<span class="token punctuation">,</span> ThreadPoolExecutor e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li><li><p>AbortPolicyï¼šæŠ›å‡º RejectedExecutionException å¼‚å¸¸</p></li><li><p>DiscardPolicyï¼šç©ºå®ç°ï¼Œç­‰å¾…å­ç±»é‡å†™</p></li><li><p>DiscardOldestPolicyï¼šä»é˜Ÿåˆ—é‡Œç§»é™¤ä¸€ä¸ªï¼Œå†åŠ å…¥</p></li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span>Runnable r<span class="token punctuation">,</span> ThreadPoolExecutor e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        e<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        e<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="2-4-æœ€ä½³çº¿ç¨‹æ•°é‡è®¾ç½®"><a href="#2-4-æœ€ä½³çº¿ç¨‹æ•°é‡è®¾ç½®" class="headerlink" title="2.4 æœ€ä½³çº¿ç¨‹æ•°é‡è®¾ç½®"></a>2.4 æœ€ä½³çº¿ç¨‹æ•°é‡è®¾ç½®</h3><p>æœ€ä½³çº¿ç¨‹æ•° = CPUæ ¸æ•°*[1+(I/Oè€—æ—¶/CPUè€—æ—¶)]</p>]]></content>
      
      
      <categories>
          
          <category> çº¿ç¨‹æ±  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€MySQLã€‘åˆ åº“è·‘è·¯ï¼Ÿäº†è§£ä¸‹bin-logï¼</title>
      <link href="/2020/12/16/%E3%80%90MySQL%E3%80%91%E5%88%A0%E5%BA%93%E8%B7%91%E8%B7%AF%EF%BC%9F%E4%BA%86%E8%A7%A3%E4%B8%8Bbin-log%EF%BC%81/"/>
      <url>/2020/12/16/%E3%80%90MySQL%E3%80%91%E5%88%A0%E5%BA%93%E8%B7%91%E8%B7%AF%EF%BC%9F%E4%BA%86%E8%A7%A3%E4%B8%8Bbin-log%EF%BC%81/</url>
      
        <content type="html"><![CDATA[<p>æ“ä½œç”Ÿäº§æ•°æ®åº“æ—¶æ¯ä¸€ä¸ªæ“ä½œéƒ½éœ€è¦åå¤å®¡æ ¸ã€‚ä»»æ„çš„å°é”™è¯¯ï¼Œéƒ½ä¼šå¯¼è‡´çº¿ä¸Šâ€œå¤§ç¾éš¾â€ï¼<br>â€œä»åˆ åº“åˆ°è·‘è·¯â€ï¼Œå¯ä»¥è¯´æ˜¯ITä¸šå†…è€æ¢—äº†ã€‚  </p><p>ä½†æ˜¯çœŸçš„ä¸å°å¿ƒè¯¯åˆ äº†ï¼ŒçœŸçš„å°±æ— æ³•æŒ½æ•‘äº†å—ï¼Ÿ  </p><p>å…¶å®ä¹Ÿæ²¡è¿™ä¹ˆå¤¸å¼ ï¼ŒçœŸå®çš„ç”Ÿäº§æ•°æ®åº“å¾€å¾€â€œçƒ­å¤‡â€å’Œâ€œå†·å¤‡â€åŒæ—¶è¿›è¡Œã€‚ä¸‡ä¸€å‡ºç°åˆ åº“çš„æƒ…å†µï¼Œè¿˜æ˜¯å¯ä»¥é€šè¿‡å¤‡ä»½æ–‡ä»¶è¿›è¡Œæ¢å¤ã€‚è¿™é‡Œæåˆ°çš„å¤‡ä»½æ–‡ä»¶å¯ä»¥æ˜¯<strong>æ•°æ®åº“æŸä¸€æ—¶åˆ»çš„å¿«ç…§</strong>ï¼Œä¹Ÿå¯ä»¥æ˜¯<strong>bin-logæ–‡ä»¶</strong>ã€‚</p><span id="more"></span><h2 id="bin-log-å½’æ¡£"><a href="#bin-log-å½’æ¡£" class="headerlink" title="bin-log å½’æ¡£"></a>bin-log å½’æ¡£</h2><h3 id="ä»€ä¹ˆæ˜¯-bin-log"><a href="#ä»€ä¹ˆæ˜¯-bin-log" class="headerlink" title="ä»€ä¹ˆæ˜¯ bin-log"></a>ä»€ä¹ˆæ˜¯ bin-log</h3><p>bin-logæ˜¯ä¸€ç§ç”±MySQLæä¾›çš„è®°å½•æ•°æ®åº“æ“ä½œï¼ˆCUDæ“ä½œï¼‰çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ã€‚<br>å®ƒæœ‰ä»¥ä¸‹ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p><blockquote><ol><li>Binlogä¸ºé€»è¾‘æ—¥å¿—,è®°å½•çš„æ˜¯ä¸€æ¡è¯­å¥çš„åŸå§‹é€»è¾‘</li><li>Binlogä¸é™å¤§å°,è¿½åŠ å†™å…¥,ä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿—</li></ol></blockquote><h3 id="å¦‚ä½•ä½¿ç”¨bin-log"><a href="#å¦‚ä½•ä½¿ç”¨bin-log" class="headerlink" title="å¦‚ä½•ä½¿ç”¨bin-log"></a>å¦‚ä½•ä½¿ç”¨bin-log</h3><p>ä¿®æ”¹mysqlé…ç½®æ–‡ä»¶/etc/my.cnf</p><pre class=" language-java"><code class="language-java">logâ€bin<span class="token operator">=</span> <span class="token operator">/</span>data<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysql<span class="token operator">-</span>bin# mysql ç‰ˆæœ¬é«˜äº<span class="token number">5.7</span> éœ€è¦é¢å¤–é…ç½®ï¼Œå”¯ä¸€idserverâ€id<span class="token operator">=</span> <span class="token number">1212</span># binlogæ ¼å¼ï¼Œæœ‰<span class="token number">3</span>ç§statement<span class="token punctuation">,</span>row<span class="token punctuation">,</span>mixedbinlogâ€format<span class="token operator">=</span>ROW# ä»€ä¹ˆæ—¶å€™è¿›è¡Œåˆ·ç›˜ï¼Œé…ç½®<span class="token number">1</span>å°±æ˜¯æ¯æ¬¡æ“ä½œéƒ½è¿›è¡Œåˆ·ç›˜å†™å…¥ï¼Œ<span class="token number">0</span> åˆ™æ˜¯å°†åˆ·ç›˜äº¤ç»™ç³»ç»Ÿå†³ä»€ä¹ˆæ—¶å€™è¿›è¡Œsyncâ€binlog<span class="token operator">=</span><span class="token number">1</span></code></pre><p>æ£€æŸ¥å¼€å¯çŠ¶æ€</p><pre class=" language-JAVA"><code class="language-JAVA">show variables like '%log_bin%';</code></pre><p>å¦‚æœå¾—åˆ°å¦‚ä¸‹ï¼ˆlog_bin | ONï¼‰è¡¨ç¤ºæ­£å¸¸å¼€å¯ï¼Œå¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">|</span> Variable_name                   <span class="token operator">|</span> Value                           <span class="token operator">|</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">|</span> log_bin                         <span class="token operator">|</span> ON                              <span class="token operator">|</span><span class="token operator">|</span> log_bin_basename                <span class="token operator">|</span> <span class="token operator">/</span>data<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysql<span class="token operator">-</span>bin       <span class="token operator">|</span><span class="token operator">|</span> log_bin_index                   <span class="token operator">|</span> <span class="token operator">/</span>data<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span>index <span class="token operator">|</span><span class="token operator">|</span> log_bin_trust_function_creators <span class="token operator">|</span> OFF                             <span class="token operator">|</span><span class="token operator">|</span> log_bin_use_v1_row_events       <span class="token operator">|</span> OFF                             <span class="token operator">|</span><span class="token operator">|</span> sql_log_bin                     <span class="token operator">|</span> ON                              <span class="token operator">|</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span></code></pre><h2 id="æ¨¡æ‹Ÿåˆ åº“"><a href="#æ¨¡æ‹Ÿåˆ åº“" class="headerlink" title="æ¨¡æ‹Ÿåˆ åº“"></a>æ¨¡æ‹Ÿåˆ åº“</h2><p>é€šè¿‡ <code>reset master;</code>å°†æ•°æ®åº“å†å²çš„binlogæ–‡ä»¶è¿˜åŸï¼Œç„¶åæ–°å¢åº“ test æ–°å¢è¡¨ test;  </p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a33201fa186e498f9fc7b1fc1a0f573e~tplv-k3u1fbpfcp-watermark.image">  </p><p>æ–°å¢ä¸€æ¡è®°å½•</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b298f4a5e374790be502b346b744337~tplv-k3u1fbpfcp-watermark.image"></p><p>æŸ¥çœ‹binlogæ—¥å¿—æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°å·²ç»è®°å½•äº†æ—¥å¿—ã€‚</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/abc10d560c1246aa9825b1bba227894f~tplv-k3u1fbpfcp-watermark.image"></p><p>ç„¶ååˆ é™¤åº“ï¼Œä¹Ÿä¼šè¿›è¡Œè®°å½•ã€‚<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa0237523e354ea69b654d955788a7c2~tplv-k3u1fbpfcp-watermark.image"><br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12679e6963844951b60e76a3c9e4ac61~tplv-k3u1fbpfcp-watermark.image"></p><h2 id="æ•°æ®æ¢å¤"><a href="#æ•°æ®æ¢å¤" class="headerlink" title="æ•°æ®æ¢å¤"></a>æ•°æ®æ¢å¤</h2><p>é€šè¿‡mysqlæä¾›çš„ mysqlbinlog å‘½ä»¤æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼Œæ‰¾åˆ°éœ€è¦æ¢å¤çš„ä½å­ã€‚</p><pre class=" language-JAVA"><code class="language-JAVA">/usr/local/mysql/bin/mysqlbinlog --no-defaults /data/mysql/bin/mysql-bin.000001</code></pre><p>å¯ä»¥çœ‹åˆ°ä¸€äº›åº“ä»¥åŠè¡¨çš„ä¿¡æ¯ã€‚</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/17d10bf3549d45b2829a5ada491d6163~tplv-k3u1fbpfcp-watermark.image"></p><p>é€‰æ‹©éœ€è¦æ¢å¤çš„å†…å®¹ï¼Œå¹¶è®°å½•è¡Œå·ã€‚<br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c30460c80ff948679081e6d40c79403b~tplv-k3u1fbpfcp-watermark.image"></p><p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œè¿›è¡Œæ¢å¤ï¼ˆæ¢å¤ä¹‹å‰éœ€è¦æ–°å»ºä¸€ä¸ªå’ŒåŸæ¥ä¸€æ ·çš„åº“ï¼‰</p><pre class=" language-JAVA"><code class="language-JAVA">## è¡Œå·/usr/local/mysql/bin/mysqlbinlog --no-defaults --start-position="1491" --stop-position="2424" /data/mysql/bin/mysql-bin.000001 |./mysql -u root -p test ## é€šè¿‡æ—¶é—´/usr/local/mysql/bin/mysqlbinlog --no-defaults /data/mysql/bin/mysql-bin.000001 --stop-date= "2020-11-24 00:00:00"  --start-date= "2020-11-24 11:55:00"| ./mysql -u root -p test## å…¨éƒ¨æ¢å¤/usr/local/mysql/bin/mysqlbinlog --no-defaults /data/mysql/bin/mysql-bin.000001 |./mysql -u root -p test</code></pre><p>æ•ˆæœå¦‚ä¸‹ï¼š   </p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/34ed0c014b6e41cb948aec2c896a3b73~tplv-k3u1fbpfcp-watermark.image"></p>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€JVMè°ƒä¼˜ã€‘è°ƒä¼˜å‘½ä»¤/çº¿ä¸Šè°ƒä¼˜åˆ†æ</title>
      <link href="/2020/12/11/%E3%80%90JVM%E8%B0%83%E4%BC%98%E3%80%91%E8%B0%83%E4%BC%98%E5%91%BD%E4%BB%A4-%E7%BA%BF%E4%B8%8A%E8%B0%83%E4%BC%98%E5%88%86%E6%9E%90/"/>
      <url>/2020/12/11/%E3%80%90JVM%E8%B0%83%E4%BC%98%E3%80%91%E8%B0%83%E4%BC%98%E5%91%BD%E4%BB%A4-%E7%BA%BF%E4%B8%8A%E8%B0%83%E4%BC%98%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h2 id="å¸¸ç”¨-JVM-è°ƒä¼˜å‘½ä»¤"><a href="#å¸¸ç”¨-JVM-è°ƒä¼˜å‘½ä»¤" class="headerlink" title="å¸¸ç”¨ JVM è°ƒä¼˜å‘½ä»¤"></a>å¸¸ç”¨ JVM è°ƒä¼˜å‘½ä»¤</h2><h3 id="JPS-â€”-æŸ¥çœ‹ç¨‹åºå¯¹åº”çš„PID"><a href="#JPS-â€”-æŸ¥çœ‹ç¨‹åºå¯¹åº”çš„PID" class="headerlink" title="JPS â€” æŸ¥çœ‹ç¨‹åºå¯¹åº”çš„PID"></a>JPS â€” æŸ¥çœ‹ç¨‹åºå¯¹åº”çš„PID</h3><pre class=" language-JAVA"><code class="language-JAVA">[root@ams_cms01 tes]# jps25841 Starter26691 jar13332 jar20134 BrokerStartup6361 jar18668 NamesrvStartup</code></pre><span id="more"></span><h3 id="JMAP-â€”æŸ¥æ‰¾çº¿ç¨‹å†…å­˜ä½¿ç”¨æƒ…å†µ"><a href="#JMAP-â€”æŸ¥æ‰¾çº¿ç¨‹å†…å­˜ä½¿ç”¨æƒ…å†µ" class="headerlink" title="JMAP â€”æŸ¥æ‰¾çº¿ç¨‹å†…å­˜ä½¿ç”¨æƒ…å†µ"></a>JMAP â€”æŸ¥æ‰¾çº¿ç¨‹å†…å­˜ä½¿ç”¨æƒ…å†µ</h3><h4 id="JMAPæ‰“å°çº¿ç¨‹å†…ç±»å®ä¾‹æ•°å’Œå†…å­˜é‡"><a href="#JMAPæ‰“å°çº¿ç¨‹å†…ç±»å®ä¾‹æ•°å’Œå†…å­˜é‡" class="headerlink" title="JMAPæ‰“å°çº¿ç¨‹å†…ç±»å®ä¾‹æ•°å’Œå†…å­˜é‡"></a>JMAPæ‰“å°çº¿ç¨‹å†…ç±»å®ä¾‹æ•°å’Œå†…å­˜é‡</h4><pre class=" language-JAVA"><code class="language-JAVA">// å¯ä»¥æŸ¥çœ‹çº¿ç¨‹ä¸­ç±»çš„å®ä¾‹æ•°å’Œå†…å­˜é‡jmap -histo 13332</code></pre><pre class=" language-JAVA"><code class="language-JAVA"> num     #instances         #bytes  class name----------------------------------------------   1:         15760       47434048  [B   2:        161343       21937496  [C   3:         48290        7713600  [Ljava.lang.Object;   4:        140621        3374904  java.lang.String   5:         29745        2617560  java.lang.reflect.Method   6:         11216        1876680  [I   7:          2418        1586208  io.netty.util.internal.shaded.org.jctools.queues.MpscArrayQueue   8:         14127        1571504  java.lang.Class   9:         47662        1525184  java.util.concurrent.ConcurrentHashMap$Node  10:         27057        1103008  [Ljava.lang.String;  11:         31809        1017888  java.lang.ref.WeakReference</code></pre><h4 id="JMAPæ‰“å°å †æ ˆä¿¡æ¯"><a href="#JMAPæ‰“å°å †æ ˆä¿¡æ¯" class="headerlink" title="JMAPæ‰“å°å †æ ˆä¿¡æ¯"></a>JMAPæ‰“å°å †æ ˆä¿¡æ¯</h4><pre class=" language-JAVA"><code class="language-JAVA">jmap -heap 13332</code></pre><pre class=" language-JAVA"><code class="language-JAVA">Attaching to process ID 13332, please wait...Debugger attached successfully.Server compiler detected.JVM version is 25.172-b11using thread-local object allocation.Parallel GC with 13 thread(s)Heap Configuration:   MinHeapFreeRatio         = 0   MaxHeapFreeRatio         = 100   MaxHeapSize              = 268435456 (256.0MB)   NewSize                  = 44564480 (42.5MB)   MaxNewSize               = 89128960 (85.0MB)   OldSize                  = 89653248 (85.5MB)   NewRatio                 = 2   SurvivorRatio            = 8   MetaspaceSize            = 21807104 (20.796875MB)   CompressedClassSpaceSize = 1073741824 (1024.0MB)   MaxMetaspaceSize         = 17592186044415 MB   G1HeapRegionSize         = 0 (0.0MB)Heap Usage:PS Young GenerationEden Space:   capacity = 41418752 (39.5MB)   used     = 15461184 (14.74493408203125MB)   free     = 25957568 (24.75506591796875MB)   37.32894704311709% usedFrom Space:   capacity = 1572864 (1.5MB)   used     = 700480 (0.66802978515625MB)   free     = 872384 (0.83197021484375MB)   44.535319010416664% usedTo Space:   capacity = 1572864 (1.5MB)   used     = 0 (0.0MB)   free     = 1572864 (1.5MB)   0.0% usedPS Old Generation   capacity = 133169152 (127.0MB)   used     = 109122936 (104.06774139404297MB)   free     = 24046216 (22.93225860595703MB)   81.94310345987635% used</code></pre><h3 id="Jstack-â€”-æŸ¥çœ‹çº¿ç¨‹æƒ…å†µ"><a href="#Jstack-â€”-æŸ¥çœ‹çº¿ç¨‹æƒ…å†µ" class="headerlink" title="Jstack â€” æŸ¥çœ‹çº¿ç¨‹æƒ…å†µ"></a>Jstack â€” æŸ¥çœ‹çº¿ç¨‹æƒ…å†µ</h3><pre class=" language-JAVA"><code class="language-JAVA">jstack 13332</code></pre><pre class=" language-JAVA"><code class="language-JAVA">"DubboServerHandler-172.10.0.7:28999-thread-79" #539 daemon prio=5 os_prio=0 tid=0x00007eff2c05e000 nid=0x1164 waiting on condition [0x00007efe3b9f8000]   java.lang.Thread.State: WAITING (parking)        at sun.misc.Unsafe.park(Native Method)        - parking to wait for  <0x00000000f25f76b8> (a java.util.concurrent.SynchronousQueue$TransferStack)        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)        at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:458)        at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)        at java.util.concurrent.SynchronousQueue.take(SynchronousQueue.java:924)        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)        at java.lang.Thread.run(Thread.java:748)"DubboServerHandler-172.10.0.7:28999-thread-78" #534 daemon prio=5 os_prio=0 tid=0x00007eff2c05d000 nid=0x939 waiting on condition [0x00007efe3bbfa000]   java.lang.Thread.State: WAITING (parking)        at sun.misc.Unsafe.park(Native Method)        - parking to wait for  <0x00000000f25f76b8> (a java.util.concurrent.SynchronousQueue$TransferStack)        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)        at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:458)        at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)        at java.util.concurrent.SynchronousQueue.take(SynchronousQueue.java:924)        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)        at java.lang.Thread.run(Thread.java:748)</code></pre><h3 id="JSTAT-â€”-è°ƒä¼˜é‡ç‚¹ï¼šæŸ¥çœ‹-GC-æƒ…å†µ"><a href="#JSTAT-â€”-è°ƒä¼˜é‡ç‚¹ï¼šæŸ¥çœ‹-GC-æƒ…å†µ" class="headerlink" title="JSTAT â€” è°ƒä¼˜é‡ç‚¹ï¼šæŸ¥çœ‹ GC æƒ…å†µ"></a>JSTAT â€” è°ƒä¼˜é‡ç‚¹ï¼šæŸ¥çœ‹ GC æƒ…å†µ</h3><pre class=" language-JAVA"><code class="language-JAVA">// ç›‘æ§pid = 13332 çš„çº¿ç¨‹ï¼Œæ¯è¿‡ 1 ç§’æ‰“å° 1 æ¬¡ï¼Œæ‰“å° 10 æ¬¡jstat -gc 13332 1000 10</code></pre><pre class=" language-JAVA"><code class="language-JAVA"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   1536.0 1536.0 448.0   0.0   40448.0   5105.7   130048.0   106565.4  79664.0 75844.2 9776.0 9048.1   4082   33.338  248    31.693   65.0321536.0 1536.0 448.0   0.0   40448.0   5109.8   130048.0   106565.4  79664.0 75844.2 9776.0 9048.1   4082   33.338  248    31.693   65.0321536.0 1536.0 448.0   0.0   40448.0   5225.4   130048.0   106565.4  79664.0 75844.2 9776.0 9048.1   4082   33.338  248    31.693   65.0321536.0 1536.0 448.0   0.0   40448.0   5225.4   130048.0   106565.4  79664.0 75844.2 9776.0 9048.1   4082   33.338  248    31.693   65.032</code></pre><p><strong>å­—æ®µæ„ä¹‰</strong></p><pre class=" language-JAVA"><code class="language-JAVA">S0Cï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„å¤§å°ï¼Œå•ä½KBS1Cï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„å¤§å°S0Uï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°S1Uï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°ECï¼šä¼Šç”¸å›­åŒºçš„å¤§å°EUï¼šä¼Šç”¸å›­åŒºçš„ä½¿ç”¨å¤§å°OCï¼šè€å¹´ä»£å¤§å°OUï¼šè€å¹´ä»£ä½¿ç”¨å¤§å°MCï¼šæ–¹æ³•åŒºå¤§å°(å…ƒç©ºé—´)MUï¼šæ–¹æ³•åŒºä½¿ç”¨å¤§å°CCSC:å‹ç¼©ç±»ç©ºé—´å¤§å°CCSU:å‹ç¼©ç±»ç©ºé—´ä½¿ç”¨å¤§å°YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°YGCTï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´ï¼Œå•ä½sFGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•°FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´ï¼Œå•ä½sGCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´ï¼Œå•ä½s</code></pre><h2 id="è°ƒç”¨å‘½ä»¤çš„ä½¿ç”¨åœºæ™¯"><a href="#è°ƒç”¨å‘½ä»¤çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="è°ƒç”¨å‘½ä»¤çš„ä½¿ç”¨åœºæ™¯"></a>è°ƒç”¨å‘½ä»¤çš„ä½¿ç”¨åœºæ™¯</h2><h3 id="JMAP"><a href="#JMAP" class="headerlink" title="JMAP"></a>JMAP</h3><p>åº”ç”¨å‡ºç°OOMç­‰å†…å­˜é—®é¢˜æ—¶ï¼Œå¯ä»¥é€šè¿‡JMAPåˆ†æ</p><h3 id="Jstack"><a href="#Jstack" class="headerlink" title="Jstack"></a>Jstack</h3><p>åº”ç”¨å‡ºç°æ­»é”ç­‰çº¿ç¨‹é—®é¢˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨</p><h2 id="çº¿ä¸Šè°ƒä¼˜åˆ†æ"><a href="#çº¿ä¸Šè°ƒä¼˜åˆ†æ" class="headerlink" title="çº¿ä¸Šè°ƒä¼˜åˆ†æ"></a>çº¿ä¸Šè°ƒä¼˜åˆ†æ</h2><p>ä¸Šä¸ªæœˆæœ‰ä¸ªæ–°é¡¹ç›®ä¸Šçº¿äº†ï¼Œä¸­é—´å¥½åƒä¹Ÿæ²¡ä»€ä¹ˆå‘Šè­¦æŠ¥é”™ã€‚<br>ä»Šå¤©ä¸Šç”Ÿäº§ç¯å¢ƒæŸ¥çœ‹è¿è¡Œæƒ…å†µæ—¶å‘ç°ï¼Œè¯¥åº”ç”¨å·²ç»è¿›è¡Œäº†è¿‘250æ¬¡ Full GC äº†ã€‚å¹³å‡3ä¸ªå°æ—¶å‘ç”Ÿä¸€æ¬¡ï¼emmmâ€¦. å¥½åœ¨è¿˜æ²¡äººæŠ•è¯‰ã€‚  </p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4548dd5e57d1408cbdddbe0d3e995421~tplv-k3u1fbpfcp-watermark.image"></p><p><strong>jmap -heap</strong>æŸ¥çœ‹ç¨‹åºå†…å­˜ï¼š</p><pre class=" language-JAVA"><code class="language-JAVA">Heap Configuration:   MinHeapFreeRatio         = 0   MaxHeapFreeRatio         = 100   MaxHeapSize              = 268435456 (256.0MB)   NewSize                  = 44564480 (42.5MB)   MaxNewSize               = 89128960 (85.0MB)   OldSize                  = 89653248 (85.5MB)   NewRatio                 = 2   SurvivorRatio            = 8   MetaspaceSize            = 21807104 (20.796875MB)   CompressedClassSpaceSize = 1073741824 (1024.0MB)   MaxMetaspaceSize         = 17592186044415 MB   G1HeapRegionSize         = 0 (0.0MB)</code></pre><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d582001ea5ea47fb82acd7586513861d~tplv-k3u1fbpfcp-watermark.image"><br>å°å°çš„è„‘è¢‹ï¼Œå¤§å¤§çš„ç–‘æƒ‘ï¼Œä¸ºå•¥åªæœ‰256Mçš„å †å†…å­˜ï¼Ÿï¼  </p><p>é€šè¿‡ <strong>JSTAT -GC</strong> å‘½ä»¤å‘ç°åœ¨æ¯æ—¥é«˜å³°æœŸï¼Œå¹³å‡æ¯åˆ†é’Ÿäº§ç”Ÿ 20M çš„å¯¹è±¡ï¼Œä¼šåœ¨2-3åˆ†é’Ÿå æ»¡EdenåŒºï¼Œå¹¶è§¦å‘Minor GCï¼Œä¼šæœ‰<strong>8M</strong>ä¸Šä¸‹çš„å­˜æ´»å¯¹è±¡è¢«ç§»åˆ°SurvivoråŒº(2 * 15M)ã€‚<br>ä¸‹æ¬¡ Minor GCæ—¶ï¼Œä¼šè¿›è¡Œ<strong>å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­</strong>ï¼Œå‘ç°ä¸Šæ¬¡ä¸€Minor GC äº§ç”Ÿçš„å¯¹è±¡å·²ç»è¶…è¿‡S1åŒºçš„**50%**ï¼Œæ­¤æ—¶ä¼šå°†ä¸Šæ¬¡Minor GCå­˜æ´»çš„å¯¹è±¡ç›´æ¥ç§»å…¥è€å¹´ä»£ï¼ˆ100Mï¼‰ã€‚<br>æ‰€ä»¥é«˜å³°æœŸï¼Œè€å¹´ä»£ä¼šåœ¨30åˆ†é’Ÿå†…è¢«å æ»¡ï¼Œå¹¶è¿›è¡Œä¸€æ¬¡ <strong>Full GC</strong>ã€‚</p><p>æ‰€ä»¥é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œé€ æˆåº”ç”¨ç¨‹åºé¢‘ç¹GCçš„åŸå› æœ‰ä¸¤ä¸ªï¼š</p><ol><li>å †å†…å­˜å¤ªå°ã€‚</li><li>å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­ï¼Œå¯¼è‡´å¯¹è±¡è¿‡æ—©çš„è¢«æ”¾è¿›è€å¹´ä»£ã€‚</li></ol><p>è§£å†³æ–¹æ¡ˆï¼š</p><ol><li>æ‰©å¤§å †å†…å­˜å¤§å°ï¼š-Xms 1024M -Xmx 1024M</li><li>ç”±äºåº”ç”¨ç¨‹åºä¸­çš„å¯¹è±¡åŸºæœ¬ä¸Šéƒ½æ˜¯ â€æœç”Ÿå¤•æ­»â€œï¼Œæ‰€ä»¥è€å¹´ä»£æ²¡æœ‰å¤ªå¤§çš„å¿…è¦ï¼Œæ‰€ä»¥ä¿®æ”¹æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¯”ä¾‹/æˆ–è€…æ‰©å¤§å¤§æ–°ç”Ÿä»£çš„å¤§å°ï¼š-XX:NewRatio=1 / -Xmn600M</li></ol>]]></content>
      
      
      <categories>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åƒåœ¾å›æ”¶ç®—æ³•å’Œå¸¸è§çš„åƒåœ¾å›æ”¶å™¨ï¼ˆCMS+G1ï¼‰</title>
      <link href="/2020/12/09/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95%E5%92%8C%E5%B8%B8%E8%A7%81%E7%9A%84%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%EF%BC%88CMS-G1%EF%BC%89/"/>
      <url>/2020/12/09/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95%E5%92%8C%E5%B8%B8%E8%A7%81%E7%9A%84%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%EF%BC%88CMS-G1%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h1 id="åƒåœ¾å›æ”¶ç®—æ³•"><a href="#åƒåœ¾å›æ”¶ç®—æ³•" class="headerlink" title="åƒåœ¾å›æ”¶ç®—æ³•"></a>åƒåœ¾å›æ”¶ç®—æ³•</h1><h2 id="åƒåœ¾å›æ”¶ç®—æ³•åˆ†ç±»"><a href="#åƒåœ¾å›æ”¶ç®—æ³•åˆ†ç±»" class="headerlink" title="åƒåœ¾å›æ”¶ç®—æ³•åˆ†ç±»"></a>åƒåœ¾å›æ”¶ç®—æ³•åˆ†ç±»</h2><p> <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9bcddca883b54b199442900c0df37c1c~tplv-k3u1fbpfcp-watermark.image">  </p><span id="more"></span><h3 id="åˆ†ä»£æ”¶é›†ç†è®º"><a href="#åˆ†ä»£æ”¶é›†ç†è®º" class="headerlink" title="åˆ†ä»£æ”¶é›†ç†è®º"></a>åˆ†ä»£æ”¶é›†ç†è®º</h3><p>ç°åœ¨å¸‚é¢ä¸Šå¸¸è§çš„åƒåœ¾å›æ”¶å™¨éƒ½é‡‡ç”¨äº†åˆ†ä»£æ”¶é›†ç†è®ºã€‚<br>æ‰€è°“åˆ†ä»£æ”¶é›†å°±æ˜¯æ ¹æ®å¯¹è±¡çš„å­˜æ´»å‘¨æœŸå°†å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚è¯¦ç»†å¯æŸ¥çœ‹<a href="https://juejin.im/post/6894122672645472270">JAVAå†…å­˜æ¨¡å‹</a><br>åœ¨<strong>æ–°ç”Ÿä»£</strong>å¯¹è±¡â€œæœç”Ÿå¤•æ­»â€ï¼Œæ¯æ¬¡æ”¶é›†éƒ½æœ‰å¤§é‡å¯¹è±¡ï¼ˆ99%ï¼‰æ­»å»ï¼Œæ‰€ä»¥å¯ä»¥é€‰æ‹©<strong>æ ‡è®°-å¤åˆ¶ç®—æ³•</strong>ï¼Œåªéœ€è¦ä»˜å‡ºå°‘é‡å¯¹è±¡çš„å¤åˆ¶æˆæœ¬å°±å¯ä»¥å®Œæˆæ¯æ¬¡åƒåœ¾æ”¶é›†ã€‚<br>è€Œ<strong>è€å¹´ä»£</strong>å¯¹è±¡ç”Ÿå­˜å‡ ç‡æ¯”è¾ƒé«˜ï¼Œå­˜æ´»å¯¹è±¡æ¯”è¾ƒå¤šï¼Œå¦‚æœé€‰æ‹©å¤åˆ¶ç®—æ³•éœ€è¦ä»˜å‡ºè¾ƒé«˜çš„IOæˆæœ¬ï¼Œè€Œä¸”æ²¡ç”¨é¢å¤–çš„ç©ºé—´å¯ä»¥ç”¨äºå¤åˆ¶ï¼Œæ­¤æ—¶é€‰æ‹©<strong>æ ‡è®°-æ¸…é™¤</strong>æˆ–è€…<strong>æ ‡è®°-æ•´ç†</strong>å°±æ¯”è¾ƒåˆç†ã€‚</p><h3 id="æ ‡è®°-å¤åˆ¶ç®—æ³•"><a href="#æ ‡è®°-å¤åˆ¶ç®—æ³•" class="headerlink" title="æ ‡è®°-å¤åˆ¶ç®—æ³•"></a>æ ‡è®°-å¤åˆ¶ç®—æ³•</h3><p>æ ‡è®°-å¤åˆ¶ç®—æ³•å°†å†…å­˜åˆ†ä¸ºä¸¤å—ç›¸åŒå¤§å°çš„åŒºåŸŸï¼ˆæ¯”å¦‚æ–°ç”Ÿä»£çš„SurvivoråŒºï¼‰ï¼Œæ¯æ¬¡åœ¨å…¶ä¸­ä¸€å—åŒºåŸŸåˆ†é…å…ƒç´ ï¼Œå½“è¿™å—åŒºåŸŸå†…å­˜å æ»¡æ—¶ï¼Œå°±ä¼šå°†å­˜æ´»ä¸‹æ¥çš„å…ƒç´ å¤åˆ¶åˆ°å¦ä¸€å—å†…å­˜åŒºåŸŸå¹¶æ¸…ç©ºå½“å‰å†…å­˜åŒºåŸŸã€‚  </p><ul><li>ç¼ºç‚¹ï¼šæµªè´¹ä¸€åŠçš„å†…å­˜ç©ºé—´ã€‚  </li><li>ä¼˜ç‚¹ï¼šç®€å•é«˜æ•ˆã€‚</li></ul><p><strong>JVMåœ¨EdenåŒºä¿å­˜æ–°å¯¹è±¡ï¼Œåœ¨GCæ—¶ï¼Œå°†Edenå’ŒSurvivorä¸­å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°Survivorçš„å¦ä¸€ä¸ªåˆ†åŒºã€‚è¿™æ˜¯JVMå¯¹å¤åˆ¶ç®—æ³•çš„ä¸€ä¸ªä¼˜åŒ–ã€‚åªæµªè´¹äº†1/10çš„å†…å­˜ç©ºé—´ã€JVMçš„EdenåŒºå’ŒSurvivoråŒºçš„æ¯”ä¾‹ä¸º 8:2ã€‘</strong><br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/111e7e24c3904dfd98f7210c23b3b484~tplv-k3u1fbpfcp-watermark.image">  </p><h3 id="æ ‡è®°-æ¸…é™¤ç®—æ³•"><a href="#æ ‡è®°-æ¸…é™¤ç®—æ³•" class="headerlink" title="æ ‡è®°-æ¸…é™¤ç®—æ³•"></a>æ ‡è®°-æ¸…é™¤ç®—æ³•</h3><p>ç®—æ³•åŒ…æ‹¬<strong>æ ‡è®°</strong>å’Œ<strong>æ¸…é™¤</strong>ä¸¤ä¸ªé˜¶æ®µï¼Œæ ‡è®°å­˜æ´»çš„å¯¹è±¡ï¼Œç»Ÿä¸€å›æ”¶æœªæ ‡è®°çš„å¯¹è±¡ï¼ˆä¸€èˆ¬æƒ…å†µæ˜¯è¿™ç§ï¼‰ï¼Œä¹Ÿå¯ä»¥åè¿‡æ¥ï¼Œæ ‡è®°æ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡å¹¶å›æ”¶ï¼ˆæ ‡è®°æˆæœ¬ç›¸å¯¹è¾ƒå¤§ï¼‰ã€‚</p><ul><li>ä¼˜ç‚¹ï¼šæœ€åŸºç¡€çš„æ”¶é›†ç®—æ³•ï¼Œæ¯”è¾ƒç®€å•</li><li>ç¼ºç‚¹ï¼šæ•ˆç‡ä¸é«˜ï¼ˆå¦‚æœéœ€è¦æ ‡è®°çš„å¯¹è±¡æ¯”è¾ƒå¤šï¼‰ï¼Œç©ºé—´é—®é¢˜ï¼ˆæ ‡è®°æ¸…é™¤åä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç©ºé—´ï¼‰</li></ul><p><strong>ç©ºé—´é—®é¢˜å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼šåœ¨å‘ç”ŸGCä¹‹åï¼Œå†…å­˜å›æ”¶äº†å¤§é‡æ­»äº¡å¯¹è±¡ï¼Œå‡ºç°å¤§é‡ç©ºä½™å†…å­˜ï¼Œæ­¤æ—¶ç³»ç»Ÿç”Ÿæˆä¸€ä¸ªè¾ƒå¤§çš„å¯¹è±¡ï¼Œå¯èƒ½ç”±äºæ²¡æœ‰è¶³å¤Ÿå¤§çš„è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå¯¼è‡´å¯¹è±¡ç”Ÿæˆå¤±è´¥ã€‚ã€ç©ºé—´è¶³å¤Ÿå¤šï¼Œä½†æ˜¯æ²¡æœ‰è¶³å¤Ÿå¤§çš„è¿ç»­ç©ºé—´ã€‘</strong><br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/310249cbb25747f1ba4f531022e65e03~tplv-k3u1fbpfcp-watermark.image"></p><h3 id="æ ‡è®°-æ•´ç†ç®—æ³•"><a href="#æ ‡è®°-æ•´ç†ç®—æ³•" class="headerlink" title="æ ‡è®°-æ•´ç†ç®—æ³•"></a>æ ‡è®°-æ•´ç†ç®—æ³•</h3><p><strong>è§£å†³äº†æ ‡è®°æ¸…é™¤ä¸­çš„ç©ºé—´é—®é¢˜ã€‚</strong><br>æ ‡è®°è¿‡ç¨‹ä»ç„¶ä¸â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ä¸€æ ·ï¼Œä½†åç»­æ­¥éª¤ä¸æ˜¯ç›´æ¥å¯¹å¯å›æ”¶å¯¹è±¡å›æ”¶ï¼Œè€Œæ˜¯è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡å‘ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†æ‰ç«¯è¾¹ç•Œä»¥å¤–çš„å†…å­˜ã€‚<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3b4599b60a944fbebbb020f92e8044c1~tplv-k3u1fbpfcp-watermark.image"></p><h1 id="åƒåœ¾æ”¶é›†å™¨"><a href="#åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="åƒåœ¾æ”¶é›†å™¨"></a>åƒåœ¾æ”¶é›†å™¨</h1><p>ç›®å‰å¸‚é¢ä¸Šä¸»æµçš„åƒåœ¾æ”¶é›†å™¨æœ‰ï¼šSerialæ”¶é›†å™¨ã€<strong>Parallel Scavengeæ”¶é›†å™¨</strong>ã€JDK8 é»˜è®¤æ”¶é›†å™¨ã€‘ã€ParNewæ”¶é›†å™¨ã€<strong>CMSæ”¶é›†å™¨</strong>ã€<strong>G1æ”¶é›†å™¨</strong>ã€‚</p><h2 id="Serial-æ”¶é›†å™¨-XX-UseSerialGC-XX-UseSerialOldGC"><a href="#Serial-æ”¶é›†å™¨-XX-UseSerialGC-XX-UseSerialOldGC" class="headerlink" title="Serial æ”¶é›†å™¨ | -XX:+UseSerialGC -XX:+UseSerialOldGC"></a>Serial æ”¶é›†å™¨ | -XX:+UseSerialGC -XX:+UseSerialOldGC</h2><p>å•çº¿ç¨‹åƒåœ¾æ”¶é›†å™¨ï¼Œæœ€å¤è€çš„çš„åƒåœ¾æ”¶é›†å™¨ï¼Œåœ¨Serialæ”¶é›†å™¨æ‰§è¡ŒæœŸé—´ä¼š â€œSTOP THE WORLDâ€<br><strong>STOP THE WORLD</strong>ï¼šåªè¿è¡ŒGCçº¿ç¨‹ï¼Œæš‚åœå…¶ä»–çº¿ç¨‹ã€‚  </p><p><strong>æ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚</strong><br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d7c3ee470e3e441a89a8dc95c7ad34c0~tplv-k3u1fbpfcp-watermark.image"><br>å®ƒç®€å•è€Œé«˜æ•ˆï¼ˆä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹ç›¸æ¯”ï¼‰ã€‚Serialæ”¶é›†å™¨ç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œå¯ä»¥è·å¾—å¾ˆé«˜çš„å•çº¿ç¨‹æ”¶é›†æ•ˆç‡ã€‚</p><h2 id="Parallel-Scavenge-æ”¶é›†å™¨-XX-UseParallelGC-XX-UseParallelOldGC"><a href="#Parallel-Scavenge-æ”¶é›†å™¨-XX-UseParallelGC-XX-UseParallelOldGC" class="headerlink" title="Parallel Scavenge æ”¶é›†å™¨ | -XX:+UseParallelGC -XX:+UseParallelOldGC"></a>Parallel Scavenge æ”¶é›†å™¨ | -XX:+UseParallelGC -XX:+UseParallelOldGC</h2><p>ç›¸å½“ä¸Serialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œé»˜è®¤å¼€å¯çš„GCçº¿ç¨‹æ•°ï¼Œå’ŒCPUæ ¸æ•°ä¸€è‡´ï¼ˆ-XX:ParallelGCThreads å¯ä»¥ä¿®æ”¹GCçº¿ç¨‹æ•°ï¼Œä½†<strong>ä¸æ¨èä¿®æ”¹</strong>ï¼‰<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e8c61e2e78fb455fa2dc565592a727b1~tplv-k3u1fbpfcp-watermark.image"><br><strong>Parallel Scavengeæ”¶é›†å™¨çš„æ³¨ç‚¹æ˜¯ååé‡ï¼ˆé«˜æ•ˆç‡çš„åˆ©ç”¨CPUï¼‰ã€‚CMSç­‰åƒåœ¾æ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ›´å¤šçš„æ˜¯ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ï¼ˆæé«˜ç”¨æˆ·ä½“éªŒï¼‰ã€‚æ‰€è°“ååé‡å°±æ˜¯CPUä¸­ç”¨äºè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´ä¸CPUæ€»æ¶ˆè€—æ—¶é—´çš„æ¯”å€¼ã€‚</strong></p><h2 id="ParNew-æ”¶é›†å™¨-XX-UseParNewGC"><a href="#ParNew-æ”¶é›†å™¨-XX-UseParNewGC" class="headerlink" title="ParNew æ”¶é›†å™¨ | -XX:+UseParNewGC"></a>ParNew æ”¶é›†å™¨ | -XX:+UseParNewGC</h2><p>ParNew å’Œ Parallel Scavengeæ”¶é›†å™¨æå…¶ç›¸è¯†ï¼Œå¯ä»¥ç†è§£ä¸ºParNewæ˜¯ä¸ºé…åˆ<strong>CMSæ”¶é›†å™¨</strong>å¼€å‘çš„æ–°ä¸€ä»£ Parallel Scaengeæ”¶é›†å™¨ã€‚</p><h2 id="CMS-æ”¶é›†å™¨-XX-UseConcMarkSweepGC"><a href="#CMS-æ”¶é›†å™¨-XX-UseConcMarkSweepGC" class="headerlink" title="CMS æ”¶é›†å™¨ | -XX:+UseConcMarkSweepGC"></a>CMS æ”¶é›†å™¨ | -XX:+UseConcMarkSweepGC</h2><p>CMSæ”¶é›†å™¨æ˜¯ä¸€ç§è€å¹´ä»£åŒºåŸŸçš„åƒåœ¾æ”¶é›†å™¨ï¼Œå¾€å¾€é…åˆParNew æ”¶é›†å™¨æ¥ä½¿ç”¨ã€‚<br>å®ƒé€‚åˆåœ¨æ³¨é‡ç”¨æˆ·ä½“éªŒçš„åº”ç”¨ä¸Šä½¿ç”¨ï¼Œå®ç°äº†GCçº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹å¹¶å‘è¿›è¡Œï¼ˆéƒ¨åˆ†æ­¥éª¤ï¼‰ã€‚<br>é‡‡ç”¨äº†<strong>æ ‡è®°-æ¸…é™¤</strong>ç®—æ³•ã€‚å›æ”¶è¿‡ç¨‹å¤§è‡´åˆ†ä¸º5ä¸ªæ­¥éª¤ï¼š  </p><ol><li><strong>åˆå§‹æ ‡è®°</strong>ï¼šæš‚åœå…¶ä»–çº¿ç¨‹ï¼ˆSTWï¼‰ï¼Œæ ‡è®°GC roots ç›´æ¥å¼•ç”¨çš„å¯¹è±¡ã€‚<strong>è¿‡ç¨‹å¾ˆå¿«</strong></li><li><strong>å¹¶å‘æ ‡è®°</strong>ï¼šä»GC roots ç›´æ¥å¼•ç”¨çš„å¯¹è±¡å‡ºå‘å‘ä¸‹æŸ¥æ‰¾æ‰€æœ‰å¼•ç”¨çš„å¯¹è±¡ã€‚è¿™ä¸ªè¿‡ç¨‹æœ€è€—æ—¶ï¼Œå’Œç”¨æˆ·çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚ã€è¿™ä¸ªè¿‡ç¨‹å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼šç”¨æˆ·çº¿ç¨‹æ‰§è¡Œä¸­å¯èƒ½äº§ç”Ÿæ–°çš„åƒåœ¾ï¼ˆæµ®åŠ¨åƒåœ¾ï¼‰ï¼Œæ— æ³•è¢«æ ‡è®°ã€‚ã€‘</li><li><strong>é‡æ–°æ ‡è®°</strong>ï¼šä¸ºä¿®æ­£ <strong>å¹¶å‘æ ‡è®°</strong> ä¸­äº§ç”Ÿå˜åŠ¨çš„å¯¹è±¡æ ‡è¯†ï¼Œä¸»è¦ç”¨<strong>ä¸‰è‰²æ ‡è®°</strong>ä¸­çš„å¢é‡æ›´æ–°ç®—æ³•æ¥è¿›è¡Œæ ‡è®°ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šæš‚åœå…¶ä»–è¿›ç¨‹ï¼ˆSTWï¼‰ã€‚</li><li><strong>å¹¶å‘æ¸…é™¤</strong>ï¼šå°†æ ‡è®°ä¸ºå¯å›æ”¶çš„å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œå’Œç”¨æˆ·çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚ã€*è¿™ä¸ªè¿‡ç¨‹ä¹Ÿä¼šäº§ç”Ÿæ–°åƒåœ¾å¯¹è±¡ï¼ˆæµ®åŠ¨åƒåœ¾ï¼‰ï¼Œè¿™äº›å¯¹è±¡å°†åœ¨ä¸‹æ¬¡GCæ—¶å›æ”¶ã€‘</li><li><strong>å¹¶å‘é‡ç½®</strong>ï¼šå°†æ ‡è®°ä¸ºä¸å¯å›æ”¶çš„å¯¹è±¡çš„æ ‡å¿—æ¸…é™¤ã€‚</li></ol><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e5b33257ec9145658c1b1f2e770c887a~tplv-k3u1fbpfcp-watermark.image"></p><h2 id="G1-æ”¶é›†å™¨-XX-UseG1GC-å®˜ç½‘"><a href="#G1-æ”¶é›†å™¨-XX-UseG1GC-å®˜ç½‘" class="headerlink" title="G1 æ”¶é›†å™¨ | -XX:+UseG1GC å®˜ç½‘"></a>G1 æ”¶é›†å™¨ | -XX:+UseG1GC <sub><a href="https://www.oracle.com/technetwork/tutorials/tutorials-1876574.html">å®˜ç½‘</a></sub></h2><h3 id="å †ç»“æ„"><a href="#å †ç»“æ„" class="headerlink" title="å †ç»“æ„"></a>å †ç»“æ„</h3><p>G1 æ”¶é›†å™¨é‡‡ç”¨äº†å’Œæ­¤å‰å®Œå…¨ä¸åŒçš„å †å†…å­˜åˆ†é…æ–¹å¼ï¼Œä»–å°†å †å†…å­˜åˆ†ä¸º2048ä¸ªç›¸åŒå¤§å°çš„region(<strong>å•ä¸ªå¤§å°ä¸º1MB~32MB</strong>)ã€‚</p><h3 id="å †å†…å­˜çš„åˆ†é…"><a href="#å †å†…å­˜çš„åˆ†é…" class="headerlink" title="å †å†…å­˜çš„åˆ†é…"></a>å †å†…å­˜çš„åˆ†é…</h3><p>è¿™äº›regionsåœ¨é€»è¾‘ä¸Šè¢«åŠ¨æ€çš„åˆ†ä¸ºEdenã€Survivorï¼ˆæ–°ç”Ÿä»£ï¼‰ã€old generationï¼ˆè€å¹´ä»£ï¼‰ã€‚è¿™äº›åŒºåŸŸä¸ä¸€å®šæ˜¯è¿ç»­çš„ã€‚  </p><p>é™¤äº†è¿™ä¸‰ç§ä¹‹å¤–ï¼ŒG1è¿˜æ–°å¢ä¸€ç§æ–°çš„ç±»å‹ï¼šHumongous regionsã€‚å¦‚æœå¯¹è±¡è¶…è¿‡æ‰€åœ¨regionsçš„50%ï¼Œå°±ä¼šè¢«ç§»å…¥è¿™ä¸ªç±»å‹çš„regionã€‚<strong>è¿™ç§å¤§å¯¹è±¡åº”å°½é‡é¿å…åˆ›å»º</strong><br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/068d73bcdf5743d9925f1c470f7a85b4~tplv-k3u1fbpfcp-watermark.image" alt="G1 oracleå®˜ç½‘å›¾ç‰‡"></p><h3 id="æœŸæœ›GC-STWæ—¶é—´"><a href="#æœŸæœ›GC-STWæ—¶é—´" class="headerlink" title="æœŸæœ›GC-STWæ—¶é—´"></a>æœŸæœ›GC-STWæ—¶é—´</h3><p>G1 æ–°å¢ä¸€ä¸ªé…ç½®ï¼ˆ-XX:MaxGCPauseMillis=200ï¼‰ï¼Œæ¥è®¾ç½®æˆ‘ä»¬æœŸæœ›æ¯æ¬¡GC-STWçš„æ—¶é—´ã€‚è¿™æ˜¯ä¸€ä¸ªç›¸å¯¹å€¼ï¼Œä¸ä¼šä¸¥æ ¼æŒ‰ç…§è¿™ä¸ªæ—¶é—´æ‰§è¡Œï¼Œjvm ä¼šè¯„ä¼°GCæ€»çš„æ—¶é—´ï¼Œå¦‚æœä¸èƒ½æ»¡è¶³è¿™ä¸ªæœŸæœ›æ—¶é—´ï¼ŒJVM ä¼šé€šè¿‡ä¸€å®šçš„ç®—æ³•ï¼Œåªå›æ”¶éƒ¨åˆ†æ€§ä»·æ¯”é«˜çš„å†…å­˜ç©ºé—´ï¼Œæ¥è¾¾åˆ°è¿™ä¸ªç›®æ ‡ã€‚</p><h3 id="Young-GC"><a href="#Young-GC" class="headerlink" title="Young GC"></a>Young GC</h3><p>æ–°ç”Ÿä»£å†…å­˜åˆå§‹åŒ–é»˜è®¤åˆ†é…å †å†…å­˜çš„5%ï¼Œå½“æ–°ç”Ÿä»£å†…å­˜è¢«å æ»¡æ—¶ï¼ŒJVMä¼šè¯„ä¼°å›æ”¶æ–°ç”Ÿä»£æ‰€éœ€è¦çš„æ—¶é—´ï¼Œå¦‚æœæ¯”æœŸæœ›GC-STWæ—¶é—´çŸ­ï¼Œä¸ä¼šé©¬ä¸Šè§¦å‘Young GCï¼Œè€Œæ˜¯å¯¹æ–°ç”Ÿä»£è¿›è¡Œæ‰©å®¹ã€‚å¦åˆ™è§¦å‘Young GCã€‚</p><p>young GC é€šè¿‡å¤åˆ¶ç®—æ³•å°†å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°Survivor regionã€‚å¹¶æ¸…ç©ºåŸæ¥çš„regionã€‚  </p><ul><li>**è¿™ä¸ªè¿‡ç¨‹ä¼š â€œstop the worldâ€**ï¼Œå¹¶ä¸”é‡æ–°è®¡ç®—å¹¶ä¿å­˜æ–°ç”Ÿä»£çš„å¤§å°ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡GCå¿«é€Ÿè¿›è¡Œã€‚</li><li>young GC æ˜¯å¤šçº¿ç¨‹çš„.<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62ae69ac601344f9a91895012185b46a~tplv-k3u1fbpfcp-zoom-1.image"><br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cf06e44617874f4eb712311e3d8d7a45~tplv-k3u1fbpfcp-zoom-1.image"></li></ul><h3 id="Mixed-GC"><a href="#Mixed-GC" class="headerlink" title="Mixed GC"></a>Mixed GC</h3><p>æ•´ä¸ªå †å ç”¨ç‡è¾¾åˆ°(-XX:InitiatingHeapOccupancyPercent=45)æ—¶,è§¦å‘Mixed GC  </p><h4 id="Mixed-GC-è¿‡ç¨‹"><a href="#Mixed-GC-è¿‡ç¨‹" class="headerlink" title="Mixed GC è¿‡ç¨‹"></a>Mixed GC è¿‡ç¨‹</h4><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c4cd6ac8424840f39b34841f8682b7a0~tplv-k3u1fbpfcp-watermark.image"></p><ol><li><strong>åˆå§‹æ ‡è®°</strong>ï¼šæš‚åœå…¶ä»–çº¿ç¨‹ï¼ˆSTWï¼‰ï¼Œæ ‡è®°GC roots ç›´æ¥å¼•ç”¨çš„å¯¹è±¡ã€‚<strong>è¿‡ç¨‹å¾ˆå¿«</strong></li><li><strong>å¹¶å‘æ ‡è®°</strong>ï¼šä»GC roots ç›´æ¥å¼•ç”¨çš„å¯¹è±¡å‡ºå‘å‘ä¸‹æŸ¥æ‰¾æ‰€æœ‰å¼•ç”¨çš„å¯¹è±¡ã€‚è¿™ä¸ªè¿‡ç¨‹æœ€è€—æ—¶ï¼Œå’Œç”¨æˆ·çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚ã€å®˜ç½‘è¯´è¿™é‡Œä¼šæ ‡è®°ç©ºç™½çš„region â€”- æš‚æ—¶æ— æ³•ç†è§£,æœŸå¾…äº†è§£çš„å¤§ä½¬èµæ•™~~~ã€‘</li><li><strong>é‡æ–°æ ‡è®°</strong>ï¼šä¸ºä¿®æ­£ <strong>å¹¶å‘æ ‡è®°</strong> ä¸­äº§ç”Ÿå˜åŠ¨çš„å¯¹è±¡æ ‡è¯†ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæš‚åœå…¶ä»–è¿›ç¨‹ï¼ˆSTWï¼‰ã€‚ã€ç„¶ååœ¨è¿™ä¸€æ­¥ç©ºç™½çš„regionè¢«å›æ”¶ã€‘</li><li><strong>å¹¶å‘æ¸…é™¤</strong>ï¼šè¿™ä¸ªé˜¶æ®µG1ä¼šå¯¹<strong>è€å¹´ä»£</strong>å„ä¸ªregionåŒºåŸŸè¿›è¡Œæ¯”è¾ƒ,å…¶ä¸­â€æ´»æ€§â€ä½çš„regionä¼šè¢«ä¼˜å…ˆå›æ”¶(<strong>æ´»æ€§:å­˜æ´»å¯¹è±¡æœ€å°‘çš„,å¤åˆ¶æˆæœ¬ä½,å›æ”¶æ›´å¿«</strong>)ã€‚è€å¹´ä»£å’Œæ–°ç”Ÿä»£ä¸€èµ·å›æ”¶.</li><li><strong>å¤åˆ¶å¹¸å­˜è€…å¯¹è±¡</strong>ï¼šå°†ä¹‹å‰å›æ”¶åŒºåŸŸå¹¸å­˜çš„å¯¹è±¡å¤åˆ¶åˆ°ä¸€ä¸ªæœªä½¿ç”¨çš„regionåŒº,å¹¶å‹ç¼©.</li></ol><h3 id="G1çš„å®˜æ–¹æ¨è"><a href="#G1çš„å®˜æ–¹æ¨è" class="headerlink" title="G1çš„å®˜æ–¹æ¨è"></a>G1çš„å®˜æ–¹æ¨è</h3><ol><li><strong>ä¸è¦è®¾ç½®å¹´è½»ä»£å¤§å°</strong><ul><li>è®¾ç½®å¹´è½»ä¸€ä»£çš„å¤§å°ä¼šç¦ç”¨æœŸæœ›GC-STWæ—¶é—´çš„ç›®æ ‡ã€‚</li><li>G1ä¸å†èƒ½å¤Ÿæ ¹æ®éœ€è¦æ‰©å±•å’Œç¼©å°å¹´è½»ä¸€ä»£çš„ç©ºé—´ã€‚ç”±äºå°ºå¯¸æ˜¯å›ºå®šçš„ï¼Œå› æ­¤æ— æ³•æ›´æ”¹å°ºå¯¸ã€‚</li></ul></li><li><strong>æœŸæœ›GC-STWæ—¶é—´</strong><ul><li>æœ€å¥½ä¸è¦è®¾ç½®å¹³å‡GCæ—¶é—´,è€Œæ˜¯ä½¿ç”¨ 90% çš„GCæ—¶é—´.</li></ul></li><li><strong>Mixed GC ä¸­ Evacuation Failure</strong><ul><li>å½“æ²¡æœ‰æ›´å¤šçš„ç©ºé—²regionè¢«æå‡åˆ°è€ä¸€ä»£æˆ–è€…å¤åˆ¶åˆ°å¹¸å­˜ç©ºé—´æ—¶ï¼Œå¹¶ä¸”ç”±äºå †å·²ç»è¾¾åˆ°æœ€å¤§å€¼ï¼Œå †ä¸èƒ½æ‰©å±•ï¼Œä»è€Œå‘ç”ŸEvacuation Failureã€‚æ­¤æ—¶ä¼šè§¦å‘full GC ï¼Œ<strong>ç±»ä¼¼ä¸ Serial æ”¶é›†å™¨çš„å•çº¿ç¨‹åƒåœ¾å›æ”¶,éå¸¸è€—æ—¶</strong></li><li>å¢åŠ (-XX:G1ReservePercent=10)çš„å¤§å°</li><li>é™ä½(-XX:InitiatingHeapOccupancyPercent=45)çš„å¤§å°</li><li>å¢åŠ (-XX:ConcGCThreads=n)å¹¶å‘æ ‡è®°çº¿ç¨‹æ•°</li></ul></li></ol><p><a href="https://www.oracle.com/technetwork/tutorials/tutorials-1876574.html">G1 JVMå‚æ•°è¯·å‚ç…§å®˜ç½‘</a></p>]]></content>
      
      
      <categories>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVMå¯¹è±¡åˆ›å»ºå’Œå†…å­˜åˆ†é…æœºåˆ¶</title>
      <link href="/2020/12/08/JVM%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E5%92%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6/"/>
      <url>/2020/12/08/JVM%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E5%92%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="JVMå¯¹è±¡åˆ›å»º"><a href="#JVMå¯¹è±¡åˆ›å»º" class="headerlink" title="JVMå¯¹è±¡åˆ›å»º"></a>JVMå¯¹è±¡åˆ›å»º</h1><h2 id="JVMå¯¹è±¡åˆ›å»ºçš„ä¸»æµç¨‹"><a href="#JVMå¯¹è±¡åˆ›å»ºçš„ä¸»æµç¨‹" class="headerlink" title="JVMå¯¹è±¡åˆ›å»ºçš„ä¸»æµç¨‹"></a>JVMå¯¹è±¡åˆ›å»ºçš„ä¸»æµç¨‹</h2><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bac452bdc6b4453b839112afbd5975d1~tplv-k3u1fbpfcp-watermark.image"></p><span id="more"></span><ol><li>ç±»åŠ è½½æ£€æŸ¥ï¼š<ul><li>è™šæ‹Ÿæœºåœ¨æ¥æ”¶åˆ°ä¸€æ¡new æŒ‡ä»¤æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥å¯¹è±¡æ˜¯å¦è¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¦‚æœæ²¡æœ‰è¿›å…¥<a href="https://juejin.im/post/6893401741736280072">ç±»åŠ è½½æµç¨‹</a></li></ul></li><li>åˆ†é…å†…å­˜ï¼š<ul><li>åœ¨ç±»åŠ è½½å®Œæˆæ—¶ï¼Œç±»å¯¹è±¡æ‰€éœ€çš„å†…å­˜å¤§å°å°±å·²ç»ç¡®è®¤ä¸‹æ¥ï¼Œæ‰€ä»¥è™šæ‹Ÿæœºåªéœ€è¦åœ¨javaå †ä¸­åˆ’åˆ†ä¸€å—å›ºå®šå¤§å°çš„åŒºåŸŸæ¥ä¿å­˜å¯¹è±¡ã€‚</li><li>å†…å­˜åˆ†é…æ–¹å¼ï¼š<ul><li>æŒ‡é’ˆç¢°æ’ï¼šåœ¨å†…å­˜ç©ºé—´ä¸­ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆï¼Œæ¯æ¬¡æŒ‡é’ˆå‘åç§»åŠ¨ä¸€æ®µä¸å¯¹è±¡å¤§å°ä¸€è‡´çš„è·ç¦»ã€‚è¿™ç§æ–¹æ³•ä¿è¯å†…å­˜ç©ºé—´æ—¶è§„æ•´çš„ï¼Œå·²ç»ä½¿ç”¨çš„åœ¨æŒ‡é’ˆå‰é¢ï¼Œæœªä½¿ç”¨çš„åœ¨æŒ‡é’ˆåé¢ã€‚</li><li>ç©ºé—²åˆ—è¡¨ï¼šå¦‚æœå†…å­˜ç©ºé—´æ˜¯æ•£ä¹±çš„ï¼Œå·²ä½¿ç”¨å’Œæœªä½¿ç”¨çš„åŒºåŸŸç›¸äº’äº¤é”™ï¼Œè™šæ‹Ÿæœºå°±ä¼šç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨æ¥è®°å½•å“ªäº›åŒºåŸŸæ˜¯å¯ç”¨çš„ã€‚åœ¨ä¿å­˜å¯¹è±¡æ—¶ï¼Œä¼šæŸ¥æ‰¾ä¸€å—è¶³å¤Ÿå¤§çš„å†…å­˜ç©ºé—´æ¥ä¿å­˜å¯¹è±¡ï¼Œå¹¶æ›´æ–°ç©ºé—²åˆ—è¡¨ã€‚</li></ul></li><li>é«˜å¹¶å‘ä¸‹å†…å­˜äº‰æŠ¢é—®é¢˜:<ul><li>CASï¼šé‡‡ç”¨CASç®—æ³•ï¼Œè®©çº¿ç¨‹Aå°è¯•è·å–ä¿å­˜å¯¹è±¡ï¼Œå¦‚æœä¿å­˜ä¸æˆåŠŸï¼Œåˆ™é‡è¯•ï¼Œç›´åˆ°æˆåŠŸã€‚</li><li>æœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†²ï¼ˆThread Local Allocation Buffer,TLABï¼‰ï¼šjavaçº¿ç¨‹å¼€å¯æ—¶ï¼Œåœ¨å†…å­˜ç©ºé—²åˆ’åˆ†ä¸€å—åŒºåŸŸæ¥ä¿å­˜è¯¥çº¿ç¨‹äº§ç”Ÿçš„å¯¹è±¡ã€‚å¯ä»¥é€šè¿‡ <strong>-XX:+UseTLAB</strong>ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œé€šè¿‡ <strong>-XX:TLABSize=4k</strong> è®¾ç½®åˆ†é…åŒºåŸŸå¤§å°ã€‚</li></ul></li></ul></li><li>åˆå§‹åŒ–ï¼š<ul><li>å°†åˆ†é…åˆ°çš„å†…å­˜éƒ½è®¾ç½®ä¸º0å€¼ï¼ˆäºŒçº§åˆ¶ç éƒ½æ˜¯0/1ï¼‰ï¼Œè¿™ä¿è¯äº†javaä»£ç åœ¨ä¸èµ‹äºˆåˆå€¼çš„æƒ…å†µä¸‹ä¹Ÿèƒ½è¢«ä½¿ç”¨ã€‚</li></ul></li><li>è®¾ç½®<a href="">å¯¹è±¡å¤´</a>ï¼š<ul><li>åˆå§‹åŒ–é›¶å€¼ä¹‹åï¼Œè™šæ‹Ÿæœºè¦å¯¹å¯¹è±¡è¿›è¡Œå¿…è¦çš„è®¾ç½®ï¼Œä¾‹å¦‚è¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€å¦‚ä½•æ‰èƒ½æ‰¾åˆ°ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ã€å¯¹è±¡çš„å“ˆå¸Œç ã€å¯¹è±¡çš„GCåˆ†ä»£å¹´é¾„ç­‰ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨å¯¹è±¡çš„å¯¹è±¡å¤´Object Headerä¹‹ä¸­ã€‚</li></ul></li><li>æ‰§è¡Œinitæ–¹æ³•ï¼š<ul><li>ç»™å¯¹è±¡çš„å±æ€§èµ‹å€¼ã€‚</li></ul></li></ol><h1 id="å¯¹è±¡å†…å­˜åˆ†é…"><a href="#å¯¹è±¡å†…å­˜åˆ†é…" class="headerlink" title="å¯¹è±¡å†…å­˜åˆ†é…"></a>å¯¹è±¡å†…å­˜åˆ†é…</h1><h2 id="å¯¹è±¡å†…å­˜åˆ†é…æµç¨‹"><a href="#å¯¹è±¡å†…å­˜åˆ†é…æµç¨‹" class="headerlink" title="å¯¹è±¡å†…å­˜åˆ†é…æµç¨‹"></a>å¯¹è±¡å†…å­˜åˆ†é…æµç¨‹</h2><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/707c62c19d094ba7a8b4fc29234ed924~tplv-k3u1fbpfcp-watermark.image"></p><h3 id="å¯¹è±¡æ ˆå†…åˆ†é…"><a href="#å¯¹è±¡æ ˆå†…åˆ†é…" class="headerlink" title="å¯¹è±¡æ ˆå†…åˆ†é…"></a><strong>å¯¹è±¡æ ˆå†…åˆ†é…</strong></h3><p>æˆ‘ä»¬çŸ¥é“å¯¹è±¡æ˜¯åœ¨å †å†…è¿›è¡Œåˆ†é…å†…å­˜çš„ï¼Œå½“å¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¾é  GC è¿›è¡Œå›æ”¶ï¼Œå½“ä¸´æ—¶å¯¹è±¡è¿‡å¤šæ—¶ï¼Œä¼šå¯¹ GC é€ æˆå¾ˆå¤§çš„å‹åŠ›ï¼Œä»è€Œå½±å“åº”ç”¨çš„æ€§èƒ½ï¼ˆGC ä¼šå¯¼è‡´STOP THE WORLDï¼‰ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼ŒJVMé€šè¿‡ <strong>é€ƒé€¸åˆ†æ</strong> æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦åœ¨æ–¹æ³•å¤–è¢«å¼•ç”¨ã€‚<br>å¦‚æœå¯¹è±¡æ²¡æœ‰é€ƒé€¸ä¸”æ ˆå¸§ç©ºé—´è¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼ŒJVMä¼šå°†å¯¹è±¡ä¿å­˜åœ¨æ ˆå¸§ä¸­ï¼Œè¿™æ ·åœ¨æ–¹æ³•ç»“æŸæ—¶ï¼Œè¯¥å¯¹è±¡ä¼šéšç€æ ˆå¸§çš„å‡ºæ ˆè€Œè¢«é”€æ¯ï¼Œè¿›è€Œå‡è½» GC çš„å‹åŠ›ã€‚<br>é€šè¿‡å¼€å¯é€ƒé€¸åˆ†æå‚æ•°(-XX:+DoEscapeAnalysis)ï¼Œ<strong>JDK7ä¹‹åé»˜è®¤å¼€å¯é€ƒé€¸åˆ†æ</strong></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// å¯¹è±¡æ²¡æœ‰é€ƒé€¸</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    Something st <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    st<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    st<span class="token punctuation">.</span><span class="token function">setThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ä¿å­˜æ•°æ®æ“ä½œ</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// å¯¹è±¡é€ƒé€¸</span><span class="token keyword">public</span> Something <span class="token function">getSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    Something st <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    st<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    st<span class="token punctuation">.</span><span class="token function">setThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> st<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="æ ‡é‡æ›¿æ¢"><a href="#æ ‡é‡æ›¿æ¢" class="headerlink" title="æ ‡é‡æ›¿æ¢"></a><strong>æ ‡é‡æ›¿æ¢</strong></h3><p>åœ¨é€šè¿‡é€ƒé€¸åˆ†æåˆ¤æ–­å¯¹è±¡æ²¡æœ‰è¢«å¤–éƒ¨å¼•ç”¨æ—¶ï¼Œä¼šå°†å¯¹è±¡è¿›è¡Œåˆ†è§£ï¼Œä¸åœ¨æ ˆå¸§ä¸­åˆ›å»ºï¼Œè€Œæ˜¯å°†è¯¥å¯¹è±¡æˆå‘˜å˜é‡åˆ†è§£è‹¥å¹²ä¸ªè¢«è¿™ä¸ªæ–¹æ³•ä½¿ç”¨çš„æˆå‘˜å˜é‡æ‰€ä»£æ›¿ã€‚<br>åœ¨JVMå°†å¯¹è±¡ä¿å­˜åˆ°æ ˆå¸§ä¸­æ—¶ï¼Œå¯èƒ½å‡ºç°æ ˆå¸§ä¸­å­˜åœ¨è¶³å¤Ÿçš„ç©ºé—´ä½†æ˜¯ç©ºé—´ä¸è¿ç»­çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦æˆ‘ä»¬å¼€å¯JVMçš„æ ‡é‡æ›¿æ¢åŠŸèƒ½ã€‚<br>å¼€å¯æ ‡é‡æ›¿æ¢å‚æ•°(-XX:+EliminateAllocations)ï¼Œ<strong>JDK7ä¹‹åé»˜è®¤å¼€å¯</strong>ã€‚</p><h3 id="å¤§å¯¹è±¡"><a href="#å¤§å¯¹è±¡" class="headerlink" title="å¤§å¯¹è±¡"></a><strong>å¤§å¯¹è±¡</strong></h3><p>JVMåœ¨åˆ¤æ–­å¤§å¯¹è±¡æ—¶ï¼Œä¼šå°†å¤§å¯¹è±¡ç›´æ¥æ”¾å…¥è€å¹´ä»£ã€‚<br><strong>å¦‚ä½•åˆ¤æ–­å¤§å¯¹è±¡ï¼Ÿ</strong><br>JVMå‚æ•° -XX:PretenureSizeThreshold å¯ä»¥è®¾ç½®å¤§å¯¹è±¡çš„é˜ˆå€¼ã€‚<br><strong>ä¸ºä»€ä¹ˆè®¾ç½®å¤§å¯¹è±¡ï¼Ÿ</strong><br>é¿å…åœ¨minor GC è¿‡ç¨‹ä¸­ï¼Œå¤§å¯¹è±¡çš„å¤åˆ¶æ“ä½œå¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚  </p><h3 id="å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­"><a href="#å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­" class="headerlink" title="å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­"></a>å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­</h3><p>å¦‚æœå¯¹è±¡å¹´é¾„n1+n2+â€¦+n<sub>x</sub>çš„å¤§å°è¶…è¿‡S0/S1çš„**50%**ï¼Œé‚£ä¹ˆå¹´é¾„ <strong>x</strong> åŠä»¥ä¸Šçš„å¯¹è±¡ä¼šè¢«ç›´æ¥ç§»å…¥è€å¹´ä»£ã€‚è¿™ä¸ªè§„åˆ™å…¶å®æ˜¯å¸Œæœ›é‚£äº›å¯èƒ½æ˜¯é•¿æœŸå­˜æ´»çš„å¯¹è±¡ï¼Œå°½æ—©è¿›å…¥è€å¹´ä»£ã€‚<br>å¯ä»¥é€šè¿‡-XX:TargetSurvivorRatio æŒ‡å®šå¤§å°ã€‚</p><h3 id="è€å¹´ä»£ç©ºé—´åˆ†é…æ‹…ä¿æœºåˆ¶"><a href="#è€å¹´ä»£ç©ºé—´åˆ†é…æ‹…ä¿æœºåˆ¶" class="headerlink" title="è€å¹´ä»£ç©ºé—´åˆ†é…æ‹…ä¿æœºåˆ¶"></a>è€å¹´ä»£ç©ºé—´åˆ†é…æ‹…ä¿æœºåˆ¶</h3><p>å¹´è½»ä»£æ¯æ¬¡minor gcä¹‹å‰JVMéƒ½ä¼šè®¡ç®—ä¸‹è€å¹´ä»£å‰©ä½™å¯ç”¨ç©ºé—´ã€‚<br>å¦‚æœè¿™ä¸ªå¯ç”¨ç©ºé—´å°äºå¹´è½»ä»£é‡Œç°æœ‰çš„æ‰€æœ‰å¯¹è±¡å¤§å°ä¹‹å’Œ(åŒ…æ‹¬åƒåœ¾å¯¹è±¡)ï¼Œå°±ä¼šçœ‹ä¸€ä¸ªâ€œ-XX:-HandlePromotionFailureâ€(jdk1.8é»˜è®¤å°±è®¾ç½®äº†)çš„å‚æ•°æ˜¯å¦è®¾ç½®äº†ã€‚<br>å¦‚æœæœ‰è¿™ä¸ªå‚æ•°ï¼Œå°±ä¼šçœ‹çœ‹è€å¹´ä»£çš„å¯ç”¨å†…å­˜å¤§å°ï¼Œæ˜¯å¦å¤§äºä¹‹å‰æ¯ä¸€æ¬¡minor gcåè¿›å…¥è€å¹´ä»£çš„å¯¹è±¡çš„å¹³å‡å¤§å°ã€‚<br>å¦‚æœä¸Šä¸€æ­¥ç»“æœæ˜¯å°äºæˆ–è€…ä¹‹å‰è¯´çš„å‚æ•°æ²¡æœ‰è®¾ç½®ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘ä¸€æ¬¡Full gcï¼Œå¯¹è€å¹´ä»£å’Œå¹´è½»ä»£ä¸€èµ·å›æ”¶ä¸€æ¬¡åƒåœ¾ï¼Œå¦‚æœå›æ”¶å®Œè¿˜æ˜¯æ²¡æœ‰è¶³å¤Ÿç©ºé—´å­˜æ”¾æ–°çš„å¯¹è±¡å°±ä¼šå‘ç”Ÿâ€OOMâ€<br>å½“ç„¶ï¼Œå¦‚æœminor gcä¹‹åå‰©ä½™å­˜æ´»çš„éœ€è¦æŒªåŠ¨åˆ°è€å¹´ä»£çš„å¯¹è±¡å¤§å°è¿˜æ˜¯å¤§äºè€å¹´ä»£å¯ç”¨ç©ºé—´ï¼Œé‚£ä¹ˆä¹Ÿä¼šè§¦å‘full gcï¼Œfull gcå®Œä¹‹åå¦‚æœè¿˜æ˜¯æ²¡æœ‰ç©ºé—´æ”¾minor gcä¹‹åçš„å­˜æ´»å¯¹è±¡ï¼Œåˆ™ä¹Ÿä¼šå‘ç”Ÿâ€œOOMâ€</p>]]></content>
      
      
      <categories>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVMå†…å­˜æ¨¡å‹å’Œåƒåœ¾å›æ”¶æœºåˆ¶</title>
      <link href="/2020/12/07/JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/"/>
      <url>/2020/12/07/JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="JVMå†…å­˜æ¨¡å‹"><a href="#JVMå†…å­˜æ¨¡å‹" class="headerlink" title="JVMå†…å­˜æ¨¡å‹"></a>JVMå†…å­˜æ¨¡å‹</h1><h2 id="å›¾ç¤º"><a href="#å›¾ç¤º" class="headerlink" title="å›¾ç¤º"></a>å›¾ç¤º</h2><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ee3daff157d243b9822781a475bc5219~tplv-k3u1fbpfcp-watermark.image">  </p><span id="more"></span><p><strong>JVMå†…å­˜å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªåŒºåŸŸ</strong>  </p><ol><li>å †ï¼šä¿å­˜å¯¹è±¡ï¼ˆå­˜æ”¾ä½¿ç”¨newåˆ›å»ºçš„å¯¹è±¡ï¼Œå…¨å±€å˜é‡ï¼Œæ–¹æ³•ä¸­ä½¿ç”¨finalä¿®é¥°çš„å±€éƒ¨å˜é‡ï¼‰</li><li>æ ˆï¼šçº¿ç¨‹è¿è¡Œæ—¶åˆ›å»ºï¼Œä¸»è¦ç”¨äºå­˜æ”¾å±€éƒ¨å˜é‡ã€‚<ul><li>å †å¸§ï¼šç¨‹åºè¿è¡Œæ—¶çš„æ¯ä¸ªæ–¹æ³•éƒ½ä¼šåˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„ å †å¸§ ï¼Œæ¯ä¸ªæ–¹æ³•çš„å±€éƒ¨å˜é‡éƒ½ä¿å­˜åœ¨å¯¹åº”çš„å †å¸§ä¸­ï¼Œæ–¹æ³•ç»“æŸï¼Œè¯¥åŒºåŸŸåˆ™é”€æ¯<ul><li>å±€éƒ¨è¡¨é‡è¡¨ï¼šç¨‹åºè¿è¡Œæ—¶ï¼Œå±€éƒ¨å˜é‡çš„ä¿å­˜ç©ºé—´ï¼ˆint a = 1 ä¸­ï¼Œa å°±æ˜¯å±€éƒ¨å˜é‡ï¼‰</li><li>æ“ä½œæ•°æ ˆï¼šç¨‹åºåœ¨è¿è¡Œæ—¶ï¼Œæ“ä½œæ•°ä¿å­˜çš„ä¸´æ—¶ç©ºé—´ï¼ˆint a = 1 ä¸­ï¼Œ1å°±æ˜¯æ“ä½œæ•°ï¼‰</li><li>åŠ¨æ€é“¾æ¥ï¼šç¨‹åºè¿è¡Œæ—¶å°†ç¬¦å·å¼•ç”¨è½¬æ¢æˆç›´æ¥å¼•ç”¨ï¼ˆå°†æ–¹æ³•åŒºã€æ ˆä¸­çš„å¼•ç”¨æŒ‡å‘å †ä¸­çš„å®é™…åœ°å€ï¼‰</li><li>æ–¹æ³•å‡ºå£ï¼šä¸»çº¿ç¨‹è°ƒç”¨æ–¹æ³•æ—¶ï¼Œç»™æ–¹æ³•åˆ†é…ä¸€ä¸ªæ–¹æ³•å‡ºå£ï¼Œè®°å½•ç€è¯¥æ–¹æ³•ç»“æŸæ—¶ï¼Œæ‰§è¡Œä¸»çº¿ç¨‹çš„å“ªè¡Œä»£ç </li></ul></li></ul></li><li>æœ¬åœ°æ–¹æ³•åŒºï¼šç¨‹åºè¿è¡Œæ—¶ï¼Œå­˜åœ¨  é€šè¿‡æœ¬åœ°æ–¹æ³•ï¼ˆnativeï¼‰ ä¸ åº•å±‚Cäº¤äº’æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæœ¬åœ°æ–¹æ³•æ ˆã€‚</li><li>æ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰ï¼šå¸¸é‡ã€é™æ€å˜é‡ã€ç±»ä¿¡æ¯ï¼ˆå­˜æ”¾åŸºæœ¬ç±»å‹çš„å˜é‡æ•°æ®å’Œå¯¹è±¡çš„å¼•ç”¨ï¼‰</li><li>ç¨‹åºè®¡æ•°å™¨ï¼šè®°å½•ä»£ç è¿è¡Œçš„ä½ç½®/è¡Œå·ã€‚<pre class=" language-!"><code class="language-!">å…¶ä¸­æ ˆã€ç¨‹åºè®¡æ•°å™¨ã€æœ¬åœ°æ–¹æ³•åŒº æ˜¯æ¯ä¸ªçº¿ç¨‹ç§æœ‰çš„å †ã€å…ƒç©ºé—´ æ˜¯å…¬ç”¨çš„</code></pre></li></ol><p><strong>é€šè¿‡ä»£ç è¯´æ˜å„å†…å­˜çš„ä½œç”¨</strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>yanhua<span class="token punctuation">.</span>standard<span class="token punctuation">.</span>mq<span class="token punctuation">.</span>util<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> c<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> d <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        Solution sl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Solution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> convert <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>convert<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b3e444571c04fb488b5e9ce07be7908~tplv-k3u1fbpfcp-watermark.image"></p><p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ jdk æä¾› javap å‘½ä»¤ <strong>javap -c Solution.class</strong>æˆ–è€…<strong>javap -v Solution.class</strong> ï¼ˆ-v å¯ä»¥è·å–æ›´åŠ è¯¦ç»†çš„å‘½ä»¤é›†ï¼‰ï¼Œå°†å®ƒç¼–è¯‘æˆJVMæ±‡ç¼–å‘½ä»¤é›†  </p><p>é€šè¿‡ <strong>javap -v Solution.class</strong> è·å–çš„ä»£ç ï¼š<br>1ã€åŠ¨æ€é“¾æ¥ï¼šä»£ç ä¸­çš„#XXï¼Œä¼šåœ¨ç¨‹åºè¿è¡Œæ—¶è¢«æ›¿æ¢æˆæŒ‡å‘å †ä¸­å®é™…åœ°å€ã€‚<br>2ã€æ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰ï¼šä»£ç ä¸­çš„ç±»ä¿¡æ¯ã€å’Œå¸¸é‡æ± ï¼ˆConstant poolï¼‰</p><pre class=" language-java"><code class="language-java">Classfile <span class="token operator">/</span>D<span class="token operator">:</span><span class="token operator">/</span>PROJECT<span class="token operator">/</span>cmhk<span class="token operator">-</span>ams<span class="token operator">/</span>ams<span class="token operator">-</span>parent<span class="token operator">/</span>ams<span class="token operator">-</span>service<span class="token operator">-</span>mq<span class="token operator">/</span>target<span class="token operator">/</span>classes<span class="token operator">/</span>com<span class="token operator">/</span>yanhua<span class="token operator">/</span>standard<span class="token operator">/</span>mq<span class="token operator">/</span>util<span class="token operator">/</span>Solution<span class="token punctuation">.</span><span class="token keyword">class</span>  <span class="token class-name">Last</span> modified <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">;</span> size <span class="token number">879</span> bytes  MD5 checksum 7e0c624f3f4d194e32d2a3f642ad844b  Compiled from <span class="token string">"Solution.java"</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">com<span class="token punctuation">.</span>yanhua<span class="token punctuation">.</span>standard<span class="token punctuation">.</span>mq<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Solution</span>  minor version<span class="token operator">:</span> <span class="token number">0</span>  major version<span class="token operator">:</span> <span class="token number">52</span>  flags<span class="token operator">:</span> ACC_PUBLIC<span class="token punctuation">,</span> ACC_SUPERConstant pool<span class="token operator">:</span>   #<span class="token number">1</span> <span class="token operator">=</span> Methodref          #<span class="token number">8</span><span class="token punctuation">.</span>#<span class="token number">33</span>         <span class="token comment" spellcheck="true">// java/lang/Object."&lt;init>":()V</span>   #<span class="token number">2</span> <span class="token operator">=</span> Class              #<span class="token number">34</span>            <span class="token comment" spellcheck="true">// com/yanhua/standard/mq/util/Solution</span>   #<span class="token number">3</span> <span class="token operator">=</span> Methodref          #<span class="token number">2</span><span class="token punctuation">.</span>#<span class="token number">33</span>         <span class="token comment" spellcheck="true">// com/yanhua/standard/mq/util/Solution."&lt;init>":()V</span>   #<span class="token number">4</span> <span class="token operator">=</span> Methodref          #<span class="token number">2</span><span class="token punctuation">.</span>#<span class="token number">35</span>         <span class="token comment" spellcheck="true">// com/yanhua/standard/mq/util/Solution.convert:()I</span>   #<span class="token number">5</span> <span class="token operator">=</span> Fieldref           #<span class="token number">36</span><span class="token punctuation">.</span>#<span class="token number">37</span>        <span class="token comment" spellcheck="true">// java/lang/System.out:Ljava/io/PrintStream;</span>   #<span class="token number">6</span> <span class="token operator">=</span> Methodref          #<span class="token number">38</span><span class="token punctuation">.</span>#<span class="token number">39</span>        <span class="token comment" spellcheck="true">// java/io/PrintStream.println:(I)V</span>   #<span class="token number">7</span> <span class="token operator">=</span> Fieldref           #<span class="token number">2</span><span class="token punctuation">.</span>#<span class="token number">40</span>         <span class="token comment" spellcheck="true">// com/yanhua/standard/mq/util/Solution.num:I</span>   #<span class="token number">8</span> <span class="token operator">=</span> Class              #<span class="token number">41</span>            <span class="token comment" spellcheck="true">// java/lang/Object</span>   #<span class="token number">9</span> <span class="token operator">=</span> Utf8               num  #<span class="token number">10</span> <span class="token operator">=</span> Utf8               I  #<span class="token number">11</span> <span class="token operator">=</span> Utf8               <span class="token operator">&lt;</span>init<span class="token operator">></span>  #<span class="token number">12</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span><span class="token punctuation">)</span>V  #<span class="token number">13</span> <span class="token operator">=</span> Utf8               Code  #<span class="token number">14</span> <span class="token operator">=</span> Utf8               LineNumberTable  #<span class="token number">15</span> <span class="token operator">=</span> Utf8               LocalVariableTable  #<span class="token number">16</span> <span class="token operator">=</span> Utf8               <span class="token keyword">this</span>  #<span class="token number">17</span> <span class="token operator">=</span> Utf8               Lcom<span class="token operator">/</span>yanhua<span class="token operator">/</span>standard<span class="token operator">/</span>mq<span class="token operator">/</span>util<span class="token operator">/</span>Solution<span class="token punctuation">;</span>  #<span class="token number">18</span> <span class="token operator">=</span> Utf8               convert  #<span class="token number">19</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span><span class="token punctuation">)</span>I  #<span class="token number">20</span> <span class="token operator">=</span> Utf8               a  #<span class="token number">21</span> <span class="token operator">=</span> Utf8               b  #<span class="token number">22</span> <span class="token operator">=</span> Utf8               c  #<span class="token number">23</span> <span class="token operator">=</span> Utf8               main  #<span class="token number">24</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span><span class="token punctuation">)</span>V  #<span class="token number">25</span> <span class="token operator">=</span> Utf8               args  #<span class="token number">26</span> <span class="token operator">=</span> Utf8               <span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span>  #<span class="token number">27</span> <span class="token operator">=</span> Utf8               d  #<span class="token number">28</span> <span class="token operator">=</span> Utf8               sl  #<span class="token number">29</span> <span class="token operator">=</span> Utf8               MethodParameters  #<span class="token number">30</span> <span class="token operator">=</span> Utf8               <span class="token operator">&lt;</span>clinit<span class="token operator">></span>  #<span class="token number">31</span> <span class="token operator">=</span> Utf8               SourceFile  #<span class="token number">32</span> <span class="token operator">=</span> Utf8               Solution<span class="token punctuation">.</span>java  #<span class="token number">33</span> <span class="token operator">=</span> NameAndType        #<span class="token number">11</span><span class="token operator">:</span>#<span class="token number">12</span>        <span class="token comment" spellcheck="true">// "&lt;init>":()V</span>  #<span class="token number">34</span> <span class="token operator">=</span> Utf8                  #<span class="token number">35</span> <span class="token operator">=</span> NameAndType        #<span class="token number">18</span><span class="token operator">:</span>#<span class="token number">19</span>        <span class="token comment" spellcheck="true">// convert:()I</span>  #<span class="token number">36</span> <span class="token operator">=</span> Class              #<span class="token number">42</span>            <span class="token comment" spellcheck="true">// java/lang/System</span>  #<span class="token number">37</span> <span class="token operator">=</span> NameAndType        #<span class="token number">43</span><span class="token operator">:</span>#<span class="token number">44</span>        <span class="token comment" spellcheck="true">// out:Ljava/io/PrintStream;</span>  #<span class="token number">38</span> <span class="token operator">=</span> Class              #<span class="token number">45</span>            <span class="token comment" spellcheck="true">// java/io/PrintStream</span>  #<span class="token number">39</span> <span class="token operator">=</span> NameAndType        #<span class="token number">46</span><span class="token operator">:</span>#<span class="token number">47</span>        <span class="token comment" spellcheck="true">// println:(I)V</span>  #<span class="token number">40</span> <span class="token operator">=</span> NameAndType        #<span class="token number">9</span><span class="token operator">:</span>#<span class="token number">10</span>         <span class="token comment" spellcheck="true">// num:I</span>  #<span class="token number">41</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>lang<span class="token operator">/</span>Object  #<span class="token number">42</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>lang<span class="token operator">/</span>System  #<span class="token number">43</span> <span class="token operator">=</span> Utf8               out  #<span class="token number">44</span> <span class="token operator">=</span> Utf8               Ljava<span class="token operator">/</span>io<span class="token operator">/</span>PrintStream<span class="token punctuation">;</span>  #<span class="token number">45</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>io<span class="token operator">/</span>PrintStream  #<span class="token number">46</span> <span class="token operator">=</span> Utf8               println  #<span class="token number">47</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span>I<span class="token punctuation">)</span>V<span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> num<span class="token punctuation">;</span>    descriptor<span class="token operator">:</span> I    flags<span class="token operator">:</span> ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC  <span class="token keyword">public</span> com<span class="token punctuation">.</span>yanhua<span class="token punctuation">.</span>standard<span class="token punctuation">.</span>mq<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">Solution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>V    flags<span class="token operator">:</span> ACC_PUBLIC    Code<span class="token operator">:</span>      stack<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>         <span class="token number">0</span><span class="token operator">:</span> aload_0         <span class="token number">1</span><span class="token operator">:</span> invokespecial #<span class="token number">1</span>                  <span class="token comment" spellcheck="true">// Method java/lang/Object."&lt;init>":()V</span>         <span class="token number">4</span><span class="token operator">:</span> <span class="token keyword">return</span>      LineNumberTable<span class="token operator">:</span>        line <span class="token number">3</span><span class="token operator">:</span> <span class="token number">0</span>      LocalVariableTable<span class="token operator">:</span>        Start  Length  Slot  Name   Signature            <span class="token number">0</span>       <span class="token number">5</span>     <span class="token number">0</span>  <span class="token keyword">this</span>   Lcom<span class="token operator">/</span>yanhua<span class="token operator">/</span>standard<span class="token operator">/</span>mq<span class="token operator">/</span>util<span class="token operator">/</span>Solution<span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>I    flags<span class="token operator">:</span> ACC_PUBLIC    Code<span class="token operator">:</span>      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>         <span class="token number">0</span><span class="token operator">:</span> iconst_1         <span class="token number">1</span><span class="token operator">:</span> istore_1         <span class="token number">2</span><span class="token operator">:</span> iconst_2         <span class="token number">3</span><span class="token operator">:</span> istore_2         <span class="token number">4</span><span class="token operator">:</span> iload_1         <span class="token number">5</span><span class="token operator">:</span> iload_2         <span class="token number">6</span><span class="token operator">:</span> iadd         <span class="token number">7</span><span class="token operator">:</span> iconst_2         <span class="token number">8</span><span class="token operator">:</span> imul         <span class="token number">9</span><span class="token operator">:</span> istore_3        <span class="token number">10</span><span class="token operator">:</span> iload_3        <span class="token number">11</span><span class="token operator">:</span> ireturn      LineNumberTable<span class="token operator">:</span>        line <span class="token number">6</span><span class="token operator">:</span> <span class="token number">0</span>        line <span class="token number">7</span><span class="token operator">:</span> <span class="token number">2</span>        line <span class="token number">8</span><span class="token operator">:</span> <span class="token number">4</span>        line <span class="token number">9</span><span class="token operator">:</span> <span class="token number">10</span>      LocalVariableTable<span class="token operator">:</span>        Start  Length  Slot  Name   Signature            <span class="token number">0</span>      <span class="token number">12</span>     <span class="token number">0</span>  <span class="token keyword">this</span>   Lcom<span class="token operator">/</span>yanhua<span class="token operator">/</span>standard<span class="token operator">/</span>mq<span class="token operator">/</span>util<span class="token operator">/</span>Solution<span class="token punctuation">;</span>            <span class="token number">2</span>      <span class="token number">10</span>     <span class="token number">1</span>     a   I            <span class="token number">4</span>       <span class="token number">8</span>     <span class="token number">2</span>     b   I           <span class="token number">10</span>       <span class="token number">2</span>     <span class="token number">3</span>     c   I  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span><span class="token punctuation">)</span>V    flags<span class="token operator">:</span> ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC    Code<span class="token operator">:</span>      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>         <span class="token number">0</span><span class="token operator">:</span> iconst_1         <span class="token number">1</span><span class="token operator">:</span> istore_1         <span class="token number">2</span><span class="token operator">:</span> <span class="token keyword">new</span>           #<span class="token number">2</span>                  <span class="token comment" spellcheck="true">// class com/yanhua/standard/mq/util/Solution</span>         <span class="token number">5</span><span class="token operator">:</span> dup         <span class="token number">6</span><span class="token operator">:</span> invokespecial #<span class="token number">3</span>                  <span class="token comment" spellcheck="true">// Method "&lt;init>":()V</span>         <span class="token number">9</span><span class="token operator">:</span> astore_2        <span class="token number">10</span><span class="token operator">:</span> aload_2        <span class="token number">11</span><span class="token operator">:</span> invokevirtual #<span class="token number">4</span>                  <span class="token comment" spellcheck="true">// Method convert:()I</span>        <span class="token number">14</span><span class="token operator">:</span> istore_3        <span class="token number">15</span><span class="token operator">:</span> getstatic     #<span class="token number">5</span>                  <span class="token comment" spellcheck="true">// Field java/lang/System.out:Ljava/io/PrintStream;</span>        <span class="token number">18</span><span class="token operator">:</span> iload_3        <span class="token number">19</span><span class="token operator">:</span> invokevirtual #<span class="token number">6</span>                  <span class="token comment" spellcheck="true">// Method java/io/PrintStream.println:(I)V</span>        <span class="token number">22</span><span class="token operator">:</span> <span class="token keyword">return</span>      LineNumberTable<span class="token operator">:</span>        line <span class="token number">13</span><span class="token operator">:</span> <span class="token number">0</span>        line <span class="token number">14</span><span class="token operator">:</span> <span class="token number">2</span>        line <span class="token number">15</span><span class="token operator">:</span> <span class="token number">10</span>        line <span class="token number">16</span><span class="token operator">:</span> <span class="token number">15</span>        line <span class="token number">17</span><span class="token operator">:</span> <span class="token number">22</span>      LocalVariableTable<span class="token operator">:</span>        Start  Length  Slot  Name   Signature            <span class="token number">0</span>      <span class="token number">23</span>     <span class="token number">0</span>  args   <span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span>            <span class="token number">2</span>      <span class="token number">21</span>     <span class="token number">1</span>     d   I           <span class="token number">10</span>      <span class="token number">13</span>     <span class="token number">2</span>    sl   Lcom<span class="token operator">/</span>yanhua<span class="token operator">/</span>standard<span class="token operator">/</span>mq<span class="token operator">/</span>util<span class="token operator">/</span>Solution<span class="token punctuation">;</span>           <span class="token number">15</span>       <span class="token number">8</span>     <span class="token number">3</span> convert   I    MethodParameters<span class="token operator">:</span>      Name                           Flags      args  <span class="token keyword">static</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>V    flags<span class="token operator">:</span> ACC_STATIC    Code<span class="token operator">:</span>      stack<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">0</span>         <span class="token number">0</span><span class="token operator">:</span> iconst_4         <span class="token number">1</span><span class="token operator">:</span> putstatic     #<span class="token number">7</span>                  <span class="token comment" spellcheck="true">// Field num:I</span>         <span class="token number">4</span><span class="token operator">:</span> <span class="token keyword">return</span>      LineNumberTable<span class="token operator">:</span>        line <span class="token number">4</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span>SourceFile<span class="token operator">:</span> <span class="token string">"Solution.java"</span></code></pre><p>å¯¹ä»¥ä¸Šä»£ç å­˜åœ¨ç–‘é—®çš„è¯·æŸ¥é˜… <a href="https://juejin.im/post/6894055000033460238/">JVMæŒ‡ä»¤æŒ‡å—</a>  </p><h1 id="åƒåœ¾å›æ”¶æœºåˆ¶"><a href="#åƒåœ¾å›æ”¶æœºåˆ¶" class="headerlink" title="åƒåœ¾å›æ”¶æœºåˆ¶"></a>åƒåœ¾å›æ”¶æœºåˆ¶</h1><h2 id="GCå†…å­˜ç¤ºæ„å›¾"><a href="#GCå†…å­˜ç¤ºæ„å›¾" class="headerlink" title="GCå†…å­˜ç¤ºæ„å›¾"></a>GCå†…å­˜ç¤ºæ„å›¾</h2><p>åƒåœ¾å›æ”¶åŒºåŸŸåˆ†ä¸º<strong>æ–°ç”Ÿä»£</strong>å’Œ<strong>è€å¹´ä»£</strong>ï¼Œå…¶ä¸­æ–°ç”Ÿä»£åˆåˆ† <strong>EdenåŒº</strong> å’Œ <strong>SurvivoråŒº</strong> ï¼ŒSurvivor åˆå‡åˆ†ä¸ºä¸¤ä¸ªåŒºï¼ˆè¿™ä¸¤ä¸ªåŒºæ— å·®åˆ«ï¼‰ã€‚<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b7f1dd2c0de1457cbe8abc204b9707e6~tplv-k3u1fbpfcp-watermark.image">  </p><h3 id="æ–°ç”Ÿä»£-minor-GC-è¿‡ç¨‹"><a href="#æ–°ç”Ÿä»£-minor-GC-è¿‡ç¨‹" class="headerlink" title="æ–°ç”Ÿä»£ minor GC è¿‡ç¨‹"></a>æ–°ç”Ÿä»£ minor GC è¿‡ç¨‹</h3><p>å½“ç¨‹åºæ–°å¢å¯¹è±¡æ—¶ï¼Œé»˜è®¤æ”¾å…¥EdenåŒºï¼Œå½“EdenåŒºå†…å­˜å æ»¡æ—¶ï¼Œä¼šè§¦å‘minor GCï¼Œå°†Edenå’Œå…¶ä¸­ä¸€å—SurvivoråŒºï¼ˆS0ï¼‰ä» â€œå­˜æ´»â€ çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—SurvivoråŒºï¼ˆS1ï¼‰ï¼ŒåŒæ—¶å¯¹è±¡çš„åˆ†ä»£å¹´é¾„+1ï¼Œå¹¶å°† Eden åŒº å’Œ S0 åŒºå…¨é‡åˆ é™¤ï¼Œä¸‹æ¬¡å†è§¦å‘minor GC æ—¶ï¼Œåˆ™å¤åˆ¶EdenåŒºå’ŒS1åŒº â€œå­˜æ´»â€ çš„å¯¹è±¡åˆ° S0 åŒºï¼Œåˆ é™¤Edenå’ŒS1åŒºï¼Œå¦‚æ­¤å¾€å¤ï¼Œç›´åˆ°S0/S1è¢«å æ»¡ æˆ–è€… å¯¹è±¡çš„åˆ†ä»£å¹´é¾„è¾¾åˆ°15ï¼Œå°†å¯¹è±¡ç§»å…¥è€å¹´ä»£ã€‚</p><h3 id="è€å¹´ä»£-full-GC-è¿‡ç¨‹"><a href="#è€å¹´ä»£-full-GC-è¿‡ç¨‹" class="headerlink" title="è€å¹´ä»£ full GC è¿‡ç¨‹"></a>è€å¹´ä»£ full GC è¿‡ç¨‹</h3><p>å½“è€å¹´ä»£å†…å­˜å æ»¡æ—¶ï¼Œä¼šè§¦å‘ full GCï¼Œä¼šå°†æ–°ç”Ÿä»£å’Œè€å¹´ä»£æ‰€æœ‰çš„å¯¹è±¡è¿›è¡Œåˆ¤æ–­ï¼Œå¤±æ´»çš„å¯¹è±¡å°†è¢«åˆ é™¤ã€‚</p><h3 id="å¯è¾¾æ€§åˆ†æç®—æ³•"><a href="#å¯è¾¾æ€§åˆ†æç®—æ³•" class="headerlink" title="å¯è¾¾æ€§åˆ†æç®—æ³•"></a>å¯è¾¾æ€§åˆ†æç®—æ³•</h3><p>JVM ä¼šåœ¨å †ã€æ ˆã€æ–¹æ³•åŒºä¸­æŸ¥æ‰¾GC Rootså¯¹è±¡ï¼Œå¹¶ä»è¿™äº›å¯¹è±¡å¼€å§‹å¾€ä¸‹æœç´¢ï¼Œèƒ½æœç´¢åˆ°çš„å¯¹è±¡éƒ½æ˜¯å¯è¾¾å¯¹è±¡ï¼Œä¸èƒ½è¢«æœç´¢åˆ°çš„å¯¹è±¡ä¼šè¢«æ ‡è®°å¯å›æ”¶å¯¹è±¡ã€‚å½“ä¸¤æ¬¡æŸ¥æ‰¾éƒ½è¢«æ ‡è®°ä¸ºå¯å›æ”¶å¯¹è±¡æ—¶ï¼Œè¯¥å¯¹è±¡å°±ä¼šè¢«GCå›æ”¶æ‰ã€‚</p><p><em><strong>æ— è®ºæ–°ç”Ÿä»£GCï¼Œè¿˜æ˜¯è€å¹´ä»£GCéƒ½ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºåœæ­¢ç­‰å¾…GCç»“æŸï¼ˆSTOP THE WORLDï¼‰ï¼Œæ‰€ä»¥åº”è¯¥å°½é‡é¿å…GCï¼Œç‰¹åˆ«æ˜¯Full GC</strong></em></p>]]></content>
      
      
      <categories>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVMç±»åŠ è½½æœºåˆ¶å’ŒåŒäº²å§”æ´¾æœºåˆ¶</title>
      <link href="/2020/12/07/JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%E5%92%8C%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%9C%BA%E5%88%B6/"/>
      <url>/2020/12/07/JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%E5%92%8C%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h3 id="JVM-ç±»åŠ è½½æµç¨‹"><a href="#JVM-ç±»åŠ è½½æµç¨‹" class="headerlink" title="JVM ç±»åŠ è½½æµç¨‹"></a>JVM ç±»åŠ è½½æµç¨‹</h3><p> <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0dea772073bf4552987860f7af1da3b9~tplv-k3u1fbpfcp-watermark.image">  </p><span id="more"></span><p> å…¶ä¸­classLoader.loadClass åˆ†å¦‚ä¸‹7æ­¥ï¼š<br> åŠ è½½&gt;éªŒè¯&gt;å‡†å¤‡&gt;è§£æ&gt;åˆå§‹åŒ–&gt;ä½¿ç”¨&gt;å¸è½½  </p><ol><li>åŠ è½½ï¼šå†ç¡¬ç›˜ä¸Šé€šè¿‡ioè¯»å…¥å­—èŠ‚ç æ–‡ä»¶ï¼Œä½¿ç”¨ç±»æ—¶æ‰ä¼šåŠ è½½ã€‚æ¯”å¦‚ï¼šè°ƒç”¨mainæ–¹æ³•\newä¸€ä¸ªå¯¹è±¡ç­‰ã€‚åŠ è½½è¿‡ç¨‹ä¸­ä¼šåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªclasså¯¹è±¡ï¼Œä½œä¸ºåç»­æ“ä½œçš„å…¥å£ã€‚</li><li>éªŒè¯ï¼šéªŒè¯å­—èŠ‚ç æ–‡ä»¶çš„æ˜¯å¦æ­£ç¡®</li><li>å‡†å¤‡ï¼šç»™ç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ç©ºé—´ï¼Œå¹¶èµ‹äºˆé»˜è®¤å€¼</li><li>è§£æï¼šå°†ç¬¦å·å¼•ç”¨æ›¿æ¢æˆç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚ï¼ˆå°†ä¸€äº›é™æ€æ–¹æ³•æ›¿æ¢æˆæŒ‡å‘å†…å­˜çš„æŒ‡é’ˆæˆ–å¥æŸ„ï¼‰ã€‚</li><li>åˆå§‹åŒ–ï¼šç»™ç±»çš„é™æ€å˜é‡èµ‹å€¼ï¼ŒåŠ è½½é™æ€æ–¹æ³•ã€‚  </li></ol><p><em>ç±»è¢«åŠ è½½åˆ°æ–¹æ³•åŒºä¸­åä¸»è¦åŒ…å« è¿è¡Œæ—¶å¸¸é‡æ± ã€ç±»å‹ä¿¡æ¯ã€å­—æ®µä¿¡æ¯ã€æ–¹æ³•ä¿¡æ¯ã€ç±»åŠ è½½å™¨çš„å¼•ç”¨ã€å¯¹åº”classå®ä¾‹çš„å¼•ç”¨ç­‰ä¿¡æ¯ã€‚</em>  </p><p><strong>ä¸»ç±»åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¦‚æœä½¿ç”¨åˆ°å…¶å®ƒç±»ï¼Œä¼šé€æ­¥åŠ è½½è¿™äº›ç±»ã€‚jaråŒ…æˆ–waråŒ…é‡Œçš„ç±»ä¸æ˜¯ä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½çš„ï¼Œæ˜¯ä½¿ç”¨åˆ°æ—¶æ‰åŠ è½½ã€‚</strong>  </p><h3 id="ç±»åŠ è½½å™¨å’ŒåŒäº²å§”æ´¾æœºåˆ¶"><a href="#ç±»åŠ è½½å™¨å’ŒåŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="ç±»åŠ è½½å™¨å’ŒåŒäº²å§”æ´¾æœºåˆ¶"></a>ç±»åŠ è½½å™¨å’ŒåŒäº²å§”æ´¾æœºåˆ¶</h3><h4 id="ç±»åŠ è½½å™¨"><a href="#ç±»åŠ è½½å™¨" class="headerlink" title="ç±»åŠ è½½å™¨"></a>ç±»åŠ è½½å™¨</h4><ol><li>å¼•å¯¼ç±»åŠ è½½å™¨ï¼šè´Ÿè´£åŠ è½½æ”¯æ’‘jvmè¿è¡Œçš„æ ¸å¿ƒç±»ï¼ˆjdk libç›®å½•ä¸‹çš„æ ¸å¿ƒåŒ…ï¼‰</li><li>æ‹“å±•ç±»åŠ è½½å™¨ï¼šè´Ÿè´£åŠ è½½jdk ä¸‹çš„ lib/extç›®å½•ä¸‹çš„jarã€‚</li><li>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼šè´Ÿè´£åŠ è½½è‡ªå·±å¼•å…¥çš„ jar å’Œ é¡¹ç›®ä¸­è‡ªå®šä¹‰çš„ç±»ã€‚</li></ol><h4 id="åŒäº²å§”æ´¾æœºåˆ¶"><a href="#åŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="åŒäº²å§”æ´¾æœºåˆ¶"></a>åŒäº²å§”æ´¾æœºåˆ¶</h4><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef0038f66b8b49e5a503587a1b545b52~tplv-k3u1fbpfcp-watermark.image"></p><h5 id="æºç "><a href="#æºç " class="headerlink" title="*æºç "></a>*æºç </h5><p>ClassLoader.loadClass() æ–¹æ³•</p><pre class=" language-java"><code class="language-java"> <span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">loadClass</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>        <span class="token keyword">throws</span> ClassNotFoundException    <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// é¦–å…ˆæ£€æŸ¥è¿™ä¸ªclassæ˜¯å¦è¢«å½“å‰åŠ è½½å™¨åŠ è½½è¿‡ã€‚</span>            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">long</span> t0 <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰ï¼Œæ£€æŸ¥çˆ¶åŠ è½½å™¨æ˜¯å¦åŠ è½½è¿‡</span>                        c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// ç”±äºå¼•å¯¼ç±»åŠ è½½å™¨ ç”±c++å®ç°ï¼Œæ‰€ä»¥æ‹“å±•ç±»åŠ è½½å™¨çš„parent æ— æ³•è¯†åˆ«ï¼Œå…¶å®å°±æ˜¯å¼•å¯¼ç±»åŠ è½½å™¨ã€‚ </span>                        c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// ClassNotFoundException thrown if class not found</span>                    <span class="token comment" spellcheck="true">// from the non-null parent class loader</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// å¦‚æœæ‰€æœ‰åŠ è½½å™¨éƒ½æ²¡æœ‰åŠ è½½è¿‡ï¼Œåˆ™å…ˆç”±å¼•å¯¼ç±»åŠ è½½å™¨å°è¯•åŠ è½½</span>                    <span class="token comment" spellcheck="true">// åŠ è½½é¡ºåºï¼šå¼•å¯¼ç±»åŠ è½½å™¨ã€‹æ‹“å±•ç±»åŠ è½½å™¨ã€‹åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‹è‡ªå®šä¹‰ç±»åŠ è½½å™¨</span>                    <span class="token keyword">long</span> t1 <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// this is the defining class loader; record the stats</span>                    sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getParentDelegationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTime</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>                    sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>                    sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> c<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>ä»¥ä¸Šä»£ç ä¸€å¥è¯å½’ç»“å°±æ˜¯ï¼šå…ˆæ‰¾çˆ¶äº²åŠ è½½ï¼Œå¤±è´¥å†ç”±å„¿å­åŠ è½½ã€‚</p><p>å¦‚æœæƒ³è¦åˆ†ç‰ˆæœ¬åŠ è½½å…¨é™å®šåç›¸åŒçš„ç±»ï¼Œéœ€è¦æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå¦‚åŒä¸€ä¸ªå®¹å™¨ä¸­ï¼Œéœ€è¦åŠ è½½ä¸åŒç‰ˆæœ¬çš„springã€‚</p><p>å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Ÿ</p><p>ç»§æ‰¿ ClassLoader å¹¶é‡å†™ loadClass æ–¹æ³•</p><p>ä¾‹å¦‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">loadClass</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>            <span class="token keyword">throws</span> ClassNotFoundException <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// First, check if the class has already been loaded</span>            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">long</span> t0 <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// If still not found, then invoke findClass in order</span>                <span class="token comment" spellcheck="true">// to find the class.</span>                <span class="token keyword">long</span> t1 <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// this is the defining class loader; record the stats</span>                sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getParentDelegationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTime</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>                sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>                sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> c<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>è¿™æ ·å¯ä»¥ç®€å•çš„æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶  </p><h5 id="åŒäº²å§”æ´¾æœºåˆ¶å­˜åœ¨çš„æ„ä¹‰"><a href="#åŒäº²å§”æ´¾æœºåˆ¶å­˜åœ¨çš„æ„ä¹‰" class="headerlink" title="åŒäº²å§”æ´¾æœºåˆ¶å­˜åœ¨çš„æ„ä¹‰"></a>åŒäº²å§”æ´¾æœºåˆ¶å­˜åœ¨çš„æ„ä¹‰</h5><ol><li>æ²™ç®±å®‰å…¨ï¼šè‡ªå®šä¹‰çš„æ ¸å¿ƒç±»ä¸ä¼šåŠ è½½ï¼Œæœ‰æ•ˆé˜²æ­¢æ ¸å¿ƒAPIåº“è¢«ç¯¡æ”¹ï¼Œä¿è¯äº†ä»£ç çš„å®‰å…¨æ€§ã€‚</li><li>é¿å…ä¸å¿…è¦çš„ç±»è¢«é‡å¤åŠ è½½ï¼šå½“çˆ¶ç±»åŠ è½½è¿‡æŸä¸ªç±»ï¼Œå­ç±»ä¸éœ€è¦å†åŠ è½½ï¼Œç¡®ä¿å†…å­˜ä¸­åªå­˜åœ¨ä¸€ä¸ªå®ä¾‹ã€‚</li></ol><h4 id="å…¨ç›˜è´Ÿè´£å§”æ‰˜æœºåˆ¶"><a href="#å…¨ç›˜è´Ÿè´£å§”æ‰˜æœºåˆ¶" class="headerlink" title="å…¨ç›˜è´Ÿè´£å§”æ‰˜æœºåˆ¶"></a>å…¨ç›˜è´Ÿè´£å§”æ‰˜æœºåˆ¶</h4><p>å½“ä¸€ä¸ªclassLoaderè£…è½½äº†ä¸€ä¸ªç±»ï¼Œè¯¥ç±»çš„æ‰€ä¾èµ–å’Œå¼•å…¥çš„ç±»éƒ½ç”¨è¿™ä¸ªåŠ è½½å™¨åŠ è½½ã€‚é™¤éæ˜¾ç¤ºçš„é€šè¿‡å…¶ä»–åŠ è½½å™¨æ‰‹åŠ¨åŠ è½½ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>QuickSort</title>
      <link href="/2020/10/22/QuickSort/"/>
      <url>/2020/10/22/QuickSort/</url>
      
        <content type="html"><![CDATA[<p>åšæŒå­¦ä¹ ï¼ŒåšæŒå†™åšå®¢ï¼ŒåŠªåŠ›å‘å¤§ä½¬å‰è¿›ï¼ QAQ â€¦â€¦â€¦<br>ä¹‹å‰é¢è¯•è¢«ç®—æ³•è™æƒ¨äº†ï¼Œæ‰€ä»¥å†³å®šå¼€ä¸€ä¸ªç®—æ³•çš„åˆ†ç±»ï¼Œè®°å½•ä¸€äº›æ—¥å¸¸ç®—æ³•</p><h2 id="å¿«é€Ÿæ’åº"><a href="#å¿«é€Ÿæ’åº" class="headerlink" title="å¿«é€Ÿæ’åº"></a>å¿«é€Ÿæ’åº</h2><p>æˆ‘ä»¬å…ˆé€šè¿‡å›¾ç‰‡çœ‹ä¸‹å¿«æ’åˆ°åº•æ˜¯æ€æ ·å®ç°çš„<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ca1d4110f7d4f69a03ff1dd60dea204~tplv-k3u1fbpfcp-zoom-1.image"></p><span id="more"></span><p>ç„¶åå°±æ˜¯ä¸Šä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>util<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/** * @author zhouxh */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuickSort</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> num <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">78</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">arrayToString</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span><span class="token string">"æ’åºå‰"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">QuickSort</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>num<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">arrayToString</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span><span class="token string">"æ’åºå"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * å¿«é€Ÿæ’åº     * @param num    æ’åºçš„æ•°ç»„     * @param left    æ•°ç»„çš„å‰é’ˆ     * @param right æ•°ç»„åé’ˆ     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">QuickSort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> num<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ’é™¤ æ­»å¾ªç¯çš„å¯èƒ½</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>left<span class="token operator">></span>right<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> left<span class="token punctuation">;</span>        <span class="token keyword">int</span> j <span class="token operator">=</span> right<span class="token punctuation">;</span>        <span class="token keyword">int</span> key <span class="token operator">=</span> num<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">&lt;</span>j<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å€’åº æ‰¾ä¸€ä¸ªæ¯” key å°çš„</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>num<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">>=</span>key<span class="token operator">&amp;&amp;</span>i<span class="token operator">&lt;</span>j<span class="token punctuation">)</span><span class="token punctuation">{</span>                j<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// æ­£åº æ‰¾ä¸€ä¸ªæ¯” key å¤§çš„</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>num<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;=</span>key<span class="token operator">&amp;&amp;</span>i<span class="token operator">&lt;</span>j<span class="token punctuation">)</span><span class="token punctuation">{</span>                i<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// å¦‚æœå¤§çš„åœ¨å°çš„å³è¾¹ï¼Œäº¤æ¢ä½å­</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>j<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">int</span> temp <span class="token operator">=</span> num<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                num<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> num<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                num<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// ä»¥ä¸Šå¾ªç¯æ›¿æ¢ç›´åˆ°æ‰€ä»¥æ¯”keyå€¼å°çš„ éƒ½åœ¨å³è¾¹ å¤§çš„éƒ½åœ¨å³è¾¹æ—¶ ç»“æŸ</span>        <span class="token comment" spellcheck="true">// å°†ä¹‹åä¸€ä¸ªå°çš„ å’Œ keyäº’æ¢ï¼Œä»¥è¾¾åˆ° keyå·¦è¾¹éƒ½æ¯”keyå°ï¼Œå³è¾¹éƒ½æ¯”keyå¤§</span>        num<span class="token punctuation">[</span>left<span class="token punctuation">]</span> <span class="token operator">=</span> num<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        num<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> key<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ­¤æ—¶æ ¹æ® key åˆ†æˆçš„å·¦å³ä¸¤è¾¹åˆ†åˆ«æ’åº</span>        <span class="token function">QuickSort</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span>left<span class="token punctuation">,</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">QuickSort</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * å°†ä¸€ä¸ªintç±»å‹æ•°ç»„è½¬åŒ–ä¸ºå­—ç¬¦ä¸²     * @param arr     * @param flag     * @return     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> String <span class="token function">arrayToString</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">,</span>String flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>        String str <span class="token operator">=</span> <span class="token string">"æ•°ç»„ä¸º("</span><span class="token operator">+</span>flag<span class="token operator">+</span><span class="token string">")ï¼š"</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> a <span class="token operator">:</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>            str <span class="token operator">+=</span> a <span class="token operator">+</span> <span class="token string">"\t"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> str<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Markdown è¯­æ³•æ•´ç†</title>
      <link href="/2020/10/21/Markdown/"/>
      <url>/2020/10/21/Markdown/</url>
      
        <content type="html"><![CDATA[<h2 id="Markdown-åŸºæœ¬è¯­æ³•"><a href="#Markdown-åŸºæœ¬è¯­æ³•" class="headerlink" title="Markdown åŸºæœ¬è¯­æ³•"></a>Markdown åŸºæœ¬è¯­æ³•</h2><hr><p>æœ€è¿‘å†™åšæ–‡çš„æ—¶å€™ï¼Œç»å¸¸éœ€è¦ google Markdownçš„è¯­æ³•ï¼Œå°±è§‰å¾—å¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥è‡ªå·±æ¥æ•´ç†ä¸€ä¸‹ï¼Œmdå¸¸ç”¨çš„è¯­æ³•ã€‚</p><h3 id="æ ‡é¢˜"><a href="#æ ‡é¢˜" class="headerlink" title="æ ‡é¢˜"></a>æ ‡é¢˜</h3><hr><pre class=" language-Markdown"><code class="language-Markdown">æœ€å¤šæ”¯æŒ6çº§æ ‡é¢˜ï¼Œå­—ä½“é€æ¸è¡¨å°# date## date### date#### date##### date###### date</code></pre><h3 id="æ®µè½æ ¼å¼"><a href="#æ®µè½æ ¼å¼" class="headerlink" title="æ®µè½æ ¼å¼"></a>æ®µè½æ ¼å¼</h3><hr><p><strong>æ¢è¡Œ</strong><br>æ®µå°¾ä¸¤ä¸ªç©ºæ ¼åŠ å›è½¦</p><span id="more"></span><pre class=" language-Markdown"><code class="language-Markdown">æ¢è¡Œ  // æ­¤å¤„å­˜åœ¨ä¸¤ä¸ªç©ºæ ¼æ®µå°¾ä¸¤ä¸ªç©ºæ ¼åŠ å›è½¦</code></pre><p><strong>å¼€å§‹æ–°çš„æ®µè½</strong>  </p><p>ä¸­é—´ç©ºä¸€è¡Œæ¥è¡¨ç¤ºé‡æ–°å¼€å§‹ä¸€ä¸ªæ®µè½</p><pre class=" language-Markdown"><code class="language-Markdown">**å¼€å§‹æ–°çš„æ®µè½**  ä¸­é—´ç©ºä¸€è¡Œæ¥è¡¨ç¤ºé‡æ–°å¼€å§‹ä¸€ä¸ªæ®µè½</code></pre><h3 id="å­—ä½“"><a href="#å­—ä½“" class="headerlink" title="å­—ä½“"></a>å­—ä½“</h3><hr><p><strong>åŠ ç²—</strong></p><pre class=" language-Markdown"><code class="language-Markdown">**åŠ ç²—**__åŠ ç²—__</code></pre><p><em>æ–œä½“</em></p><pre class=" language-Markdown"><code class="language-Markdown">*æ–œä½“*_æ–œä½“_</code></pre><p><em><strong>æ–œä½“åŠ ç²—</strong></em></p><pre class=" language-Markdown"><code class="language-Markdown">***æ–œä½“åŠ ç²—***___æ–œä½“åŠ ç²—___</code></pre><p><font face="åæ–‡å½©äº‘" >å­—ä½“æ ·å¼</font></p><pre class=" language-Markdown"><code class="language-Markdown">// ç›´æ¥åœ¨faceä¸­æ³¨æ˜å­—ä½“<font face="å¾®è½¯é›…é»‘" >å¾®è½¯é›…é»‘</font><font face="åæ–‡å½©äº‘" >åæ–‡å½©äº‘</font></code></pre><p><font color=#FF000 >å­—ä½“é¢œè‰²</font></p><pre class=" language-Markdown"><code class="language-Markdown"><font color=#FF000 >çº¢è‰²</font><font color=#008000 >ç»¿è‰²</font><font color=#FFFF00 >é»„è‰²</font></code></pre><p>å­—ä½“å¤§å°</p><pre class=" language-Markdown"><code class="language-Markdown">// size 1-7 é»˜è®¤ï¼š3<font size=5 >å­—ä½“å¤§å°</font></code></pre><h3 id="å¸¸ç”¨çš„çº¿"><a href="#å¸¸ç”¨çš„çº¿" class="headerlink" title="å¸¸ç”¨çš„çº¿"></a>å¸¸ç”¨çš„çº¿</h3><hr><p><strong>åˆ†éš”çº¿</strong></p><hr><pre class=" language-Markdown"><code class="language-Markdown">// éœ€3ä¸ªä»¥ä¸Šå‡å·çº¿ï¼š---æ˜Ÿå·ï¼š***ä¸‹åˆ’çº¿ï¼š___</code></pre><p><strong><del>åˆ é™¤çº¿</del></strong>  </p><pre class=" language-Markdown"><code class="language-Markdown">~~åˆ é™¤çº¿~~</code></pre><p><u>ä¸‹åˆ’çº¿</u></p><pre class=" language-Markdown"><code class="language-Markdown"><u>ä¸‹åˆ’çº¿</u></code></pre><h3 id="è„šæ³¨"><a href="#è„šæ³¨" class="headerlink" title="è„šæ³¨"></a>è„šæ³¨</h3><hr><p>hexo <strong>hexo-renderer-markdown</strong> æ’ä»¶ä¸æ”¯æŒ<em>è„šæ³¨</em><br>è¯·å®‰è£… <strong>hexo-renderer-markdown-it</strong><br>è¯­æ³•å¦‚ä¸‹ï¼š</p><pre class=" language-Markdown"><code class="language-Markdown">åˆ›å»ºè„šæ³¨æ ¼å¼ç±»ä¼¼è¿™æ ·  [^è„šæ³¨]ã€‚[^è„šæ³¨]: èœé¸Ÿæ•™ç¨‹ -- å­¦çš„ä¸ä»…æ˜¯æŠ€æœ¯ï¼Œæ›´æ˜¯æ¢¦æƒ³ï¼ï¼ï¼</code></pre><h3 id="åˆ—è¡¨"><a href="#åˆ—è¡¨" class="headerlink" title="åˆ—è¡¨"></a>åˆ—è¡¨</h3><hr><p><strong>æ— åºåˆ—è¡¨</strong></p><ul><li>ç¬¬ä¸€</li><li>ç¬¬äºŒ</li></ul><pre class=" language-Markdown"><code class="language-Markdown">// å¯ä»¥ç”¨ * + - * ç¬¬ä¸€* ç¬¬äºŒ</code></pre><p><strong>æœ‰åºåˆ—è¡¨</strong></p><ol><li>ç¬¬ä¸€é¡¹ã€</li><li>ç¬¬äºŒé¡¹ã€</li></ol><pre class=" language-Markdown"><code class="language-Markdown">// å¿…é¡»æ—¶è‹±æ–‡çŠ¶æ€ä¸‹çš„.+ç©ºæ ¼1. ç¬¬ä¸€é¡¹ã€2. ç¬¬äºŒé¡¹ã€</code></pre><p>æœ‰åºå’Œæ— åºåˆ—è¡¨<strong>å¯æ··åˆä½¿ç”¨</strong><br>æ•ˆæœå¦‚ä¸‹ï¼š</p><ol><li>ç¬¬ä¸€é¡¹<ul><li>ç¬¬ä¸€é¡¹çš„ç¬¬ä¸€å…ƒç´ </li></ul></li><li>ç¬¬äºŒé¡¹<ul><li>ç¬¬äºŒé¡¹çš„ç¬¬ä¸€å…ƒç´ </li></ul></li></ol><pre class=" language-Markdown"><code class="language-Markdown">1. ç¬¬ä¸€é¡¹    - ç¬¬ä¸€é¡¹çš„ç¬¬ä¸€å…ƒç´ 2. ç¬¬äºŒé¡¹    - ç¬¬äºŒé¡¹çš„ç¬¬ä¸€å…ƒç´ </code></pre><h3 id="åŒºå—"><a href="#åŒºå—" class="headerlink" title="åŒºå—"></a>åŒºå—</h3><hr><blockquote><p>åŒºå—å¼•ç”¨<br>åŒºå—å±•ç¤º<br>ä»£ç å¦‚ä¸‹</p><blockquote><p>å¯ä»¥å¤šå±‚ï¼Œæœ€å6å±‚</p></blockquote></blockquote><pre class=" language-Markdown"><code class="language-Markdown">> åŒºå—å¼•ç”¨> åŒºå—å±•ç¤º> ä»£ç å¦‚ä¸‹>> å¯ä»¥å¤šå±‚ï¼Œæœ€å6å±‚</code></pre><p><strong>åŒºå—å¯ä»¥å’Œåˆ—è¡¨é…åˆä½¿ç”¨</strong></p><ul><li>ç¬¬ä¸€å±‚<blockquote><p>ç¬¬ä¸€å±‚å†…å®¹<br>å±•ç¤ºå¦‚ä¸‹</p></blockquote></li><li>ç¬¬äºŒå±‚<blockquote><p>ä»£ç å¦‚ä¸‹</p></blockquote></li></ul><pre class=" language-Markdown"><code class="language-Markdown">- ç¬¬ä¸€å±‚    > ç¬¬ä¸€å±‚å†…å®¹    > å±•ç¤ºå¦‚ä¸‹- ç¬¬äºŒå±‚    > ä»£ç å¦‚ä¸‹</code></pre><h3 id="ä»£ç å—"><a href="#ä»£ç å—" class="headerlink" title="ä»£ç å—"></a>ä»£ç å—</h3><hr><p><strong><code>å•è¡Œä»£ç å—</code></strong>  </p><pre class=" language-Markdown"><code class="language-Markdown">` å•è¡Œä»£ç å— `</code></pre><pre class=" language-Markdown"><code class="language-Markdown">å¤šè¡Œä»£ç å— </code></pre><pre class=" language-Markdown"><code class="language-Markdown">```å¤šè¡Œä»£ç å— â€‹```</code></pre><h3 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h3><hr><p><a href="wwww.baidu.com">ç™¾åº¦</a></p><pre class=" language-Markdown"><code class="language-Markdown">[ç™¾åº¦](wwww.baidu.com)</code></pre><p><strong>é«˜çº§ç”¨æ³•</strong><br>æˆ‘ä»¬å¯ä»¥é€šè¿‡å˜é‡æ¥è®¾ç½®ä¸€ä¸ªé“¾æ¥ï¼Œå˜é‡èµ‹å€¼åœ¨æ–‡æ¡£æœ«å°¾è¿›è¡Œï¼š</p><p>è¿™ä¸ªé“¾æ¥ç”¨ 1 ä½œä¸ºç½‘å€å˜é‡ <a href="http://www.google.com/">Google</a><br>è¿™ä¸ªé“¾æ¥ç”¨ runoob ä½œä¸ºç½‘å€å˜é‡ <a href="https://baidu.com/">ç™¾åº¦</a><br>ç„¶ååœ¨æ–‡æ¡£çš„ç»“å°¾ä¸ºå˜é‡èµ‹å€¼ï¼ˆç½‘å€ï¼‰</p><pre class=" language-Markdown"><code class="language-Markdown">è¿™ä¸ªé“¾æ¥ç”¨ 1 ä½œä¸ºç½‘å€å˜é‡ [Google][1]è¿™ä¸ªé“¾æ¥ç”¨ runoob ä½œä¸ºç½‘å€å˜é‡ [ç™¾åº¦][baidu]ç„¶ååœ¨æ–‡æ¡£çš„ç»“å°¾ä¸ºå˜é‡èµ‹å€¼ï¼ˆç½‘å€ï¼‰[1]: http://www.google.com/[baidu]: https://wwww.baidu.com/</code></pre><h3 id="å›¾ç‰‡"><a href="#å›¾ç‰‡" class="headerlink" title="å›¾ç‰‡"></a>å›¾ç‰‡</h3><hr><p><img src="http://static.runoob.com/images/runoob-logo.png" alt="RUNOOB å›¾æ ‡"></p><pre class=" language-Markdown"><code class="language-Markdown">![RUNOOB å›¾æ ‡](http://static.runoob.com/images/runoob-logo.png)</code></pre>]]></content>
      
      
      <categories>
          
          <category> Markdown </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis_è¯¦è§£</title>
      <link href="/2020/10/20/redis/"/>
      <url>/2020/10/20/redis/</url>
      
        <content type="html"><![CDATA[<p>åšæŒå­¦ä¹ ï¼ŒåšæŒå†™åšå®¢ï¼ŒåŠªåŠ›å‘å¤§ä½¬å‰è¿›ï¼ QAQ â€¦â€¦â€¦</p><h2 id="redis-æ¦‚è¿°"><a href="#redis-æ¦‚è¿°" class="headerlink" title="redis æ¦‚è¿°"></a><strong>redis</strong> æ¦‚è¿°</h2><hr><p>åœ¨webåº”ç”¨å‘å±•åˆæœŸï¼Œwebç«™ç‚¹è®¿é—®é‡ä¸é«˜ï¼Œä¸ç”¨æˆ·äº¤äºˆè¾ƒå°‘ï¼Œå› æ­¤å…³ç³»å‹æ•°æ®åº“å—åˆ°å¹¿æ³›çš„åº”ç”¨ã€‚ä½†æ˜¯éšç€äº’è”ç½‘çš„å‘å±•ï¼Œwebç«™ç‚¹çš„è®¿é—®é‡æå‡ï¼Œä½¿ç”¨å…³ç³»å‹æ•°æ®åº“ï¼ˆåŸºäºç£ç›˜çš„è¯»å†™æ“ä½œï¼‰åœ¨æ€§èƒ½ä¸Šå‡ºç°äº†I/Oä¸Šçš„ç“¶é¢ˆã€‚åœ¨ä¸€ç¬é—´å¤§é‡è¯·æ±‚åŒæ—¶å‘½ä¸­æ•°æ®åº“æ—¶ï¼Œå¤æ‚çš„I/Oæ“ä½œä½¿å¾—æ•°æ®åº“å¾ˆéš¾æ‰¿å—è¿™æ ·é«˜é€Ÿè¯»å†™çš„å‹åŠ›ï¼Œæ­¤æ—¶å¿…é¡»æœ‰ä¸€ä¸ªæ›´é«˜æ•ˆçš„ä¸­é—´ä»¶ï¼Œæ¥ç¼“è§£æ•°æ®åº“çš„å‹åŠ›ã€‚</p><span id="more"></span><h2 id="redis-æ˜¯ä»€ä¹ˆ"><a href="#redis-æ˜¯ä»€ä¹ˆ" class="headerlink" title="redis æ˜¯ä»€ä¹ˆ"></a>redis æ˜¯ä»€ä¹ˆ</h2><hr><p>ä¸ºè§£å†³æ•°æ®åº“åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹çš„å‹åŠ›ï¼Œéå…³ç³»å‹æ•°æ®ï¼ˆNoSQLï¼‰ä¹Ÿå°±è¿›å…¥æˆ‘ä»¬çš„è§†é‡ã€‚Redisæ˜¯ç°åœ¨æœ€å—æ¬¢è¿çš„NoSQLæ•°æ®åº“ä¹‹ä¸€</p><h2 id="redis-çš„è‡ªæœ‰æ•°æ®ç»“æ„"><a href="#redis-çš„è‡ªæœ‰æ•°æ®ç»“æ„" class="headerlink" title="redis çš„è‡ªæœ‰æ•°æ®ç»“æ„"></a>redis çš„è‡ªæœ‰æ•°æ®ç»“æ„</h2><hr><ul><li>String<ul><li>å®ƒæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²ï¼Œä¸ä»…èƒ½å¤Ÿå­˜å‚¨å­—ç¬¦ä¸²ã€è¿˜èƒ½å­˜å‚¨å›¾ç‰‡ã€è§†é¢‘ç­‰ã€‚å•ä¸ªæœ€å¤§512M</li></ul></li><li>Hash</li><li>è¯¥ç±»å‹æ˜¯ç”±fieldå’Œå…³è”çš„valueç»„æˆçš„mapã€‚å…¶ä¸­ï¼Œfieldå’Œvalueéƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹çš„ã€‚</li><li>List<ul><li>æ’å…¥é¡ºåºæ’åºçš„å­—ç¬¦ä¸²å…ƒç´ é›†åˆï¼ŒåŸºäºåŒå‘é“¾è¡¨</li></ul></li><li>Set<ul><li>æ— åºé›†åˆï¼Œæ•°æ®å”¯ä¸€ï¼Œå¯ç”¨äºå»é‡</li></ul></li><li>Zset<ul><li>æœ‰åºé›†åˆç±»å‹ï¼Œæ¯ä¸ªå…ƒç´ éƒ½ä¼šå…³è”ä¸€ä¸ªdoubleç±»å‹çš„åˆ†æ•°æƒå€¼ï¼Œé€šè¿‡è¿™ä¸ªæƒå€¼æ¥ä¸ºé›†åˆä¸­çš„æˆå‘˜è¿›è¡Œä»å°åˆ°å¤§çš„æ’åºã€‚<pre class=" language-java"><code class="language-java">  <span class="token comment" spellcheck="true">// keyName ç”¨ä½œä¸»é”®id</span>  <span class="token comment" spellcheck="true">// orderNum1 ç”¨ä½œå°±æ˜¯åˆ†æ•°id ç”¨äºæ’åº</span>  zadd keyName orderNum1  v1 orderNum1 v2 orderNum1 v3</code></pre>æ›´å¤šè¯·æŸ¥çœ‹<a href="http://www.redis.cn/topics/data-types-intro.html">redisä¸­æ–‡ç½‘ç«™ - æ•°æ®ç±»å‹</a></li></ul></li></ul><h2 id="redis-çš„ä½¿ç”¨åœºæ™¯"><a href="#redis-çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="redis çš„ä½¿ç”¨åœºæ™¯"></a>redis çš„ä½¿ç”¨åœºæ™¯</h2><hr><ul><li>ç¼“å­˜ç³»ç»Ÿçƒ­ç‚¹æ•°æ®<ul><li>å¦‚ï¼šç³»ç»Ÿä¸­é¢‘ç¹è¢«è¯·æ±‚çš„é™æ€æ•°æ®</li></ul></li><li>è®¡æ•°å™¨<ul><li>å¦‚ï¼šåŸºäºredisçš„ä¸»é”®ç”Ÿæˆç­–ç•¥ã€åˆ†å¸ƒå¼è®¡æ•°ã€‚</li></ul></li><li>æ’è¡Œæ¦œï¼Œæ¶ˆæ¯é˜Ÿåˆ—<ul><li>å¦‚ï¼šè®¡ç®—æ—¥æ’è¡Œã€æœˆæ’è¡Œç­‰ï¼Œå¯ä»¥é€šè¿‡zsetç±»å‹æ·»åŠ ã€‚</li><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè®¢é˜…å‘å¸ƒæ¨¡å¼ï¼‰ï¼š<pre class=" language-java"><code class="language-java">  å‘å¸ƒï¼š  publish channel message  ä¾‹å¦‚ï¼špublish msg1 å‘é€å†…å®¹  è®¢é˜…ï¼š  subscribe channel <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>  ä¾‹å¦‚ï¼šsubscribe msg1 </code></pre></li></ul></li><li>åˆ†å¸ƒå¼é”ï¼Œå…±äº«session<ul><li>åˆ†å¸ƒå¼é”ï¼šé€šè¿‡setnxå®ç°<br><code>setnx(key,value,time,&#39;æ—¶é—´ç±»å‹ã€æ—¶/åˆ†/ç§’/æ¯«ç§’/å¾®ç§’ç­‰ã€‘&#39;)</code></li></ul></li></ul><h2 id="redis-çš„æŒä¹…åŒ–"><a href="#redis-çš„æŒä¹…åŒ–" class="headerlink" title="redis çš„æŒä¹…åŒ–"></a>redis çš„æŒä¹…åŒ–</h2><hr><p>RedisæŒä¹…åŒ–åˆ†ä¸ºRDBæŒä¹…åŒ–å’ŒAOFæŒä¹…åŒ–</p><h4 id="RDBæŒä¹…åŒ–"><a href="#RDBæŒä¹…åŒ–" class="headerlink" title="RDBæŒä¹…åŒ–"></a>RDBæŒä¹…åŒ–</h4><p>RDB å…¶å®å°±æ˜¯åœ¨æŒ‡å®šæ—¶é—´é—´éš”ä¸­å°†å†…å­˜ä¸­çš„æ•°æ®é›†å¿«ç…§å†™å…¥ç£ç›˜ã€‚è¿™æ˜¯redis é»˜è®¤å¼€å¯çš„æŒä¹…åŒ–æ–¹å¼ã€‚</p><p><strong>RDB æŒä¹…åŒ–è¿‡ç¨‹</strong><br>å½“ Redis éœ€è¦ä¿å­˜ dump.rdb æ–‡ä»¶æ—¶ï¼Œ æœåŠ¡å™¨æ‰§è¡Œä»¥ä¸‹æ“ä½œ:</p><ul><li>Redis è°ƒç”¨forks. åŒæ—¶æ‹¥æœ‰çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ã€‚</li><li>å­è¿›ç¨‹å°†æ•°æ®é›†å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶ RDB æ–‡ä»¶ä¸­ã€‚</li><li>å½“å­è¿›ç¨‹å®Œæˆå¯¹æ–° RDB æ–‡ä»¶çš„å†™å…¥æ—¶ï¼ŒRedis ç”¨æ–° RDB æ–‡ä»¶æ›¿æ¢åŸæ¥çš„ RDB æ–‡ä»¶ï¼Œå¹¶åˆ é™¤æ—§çš„ RDB æ–‡ä»¶ã€‚  </li></ul><p><strong>RDBçš„ä¼˜ç‚¹</strong>  </p><ul><li>rdb æ˜¯ä¸€ä¸ªéå¸¸ç´§å‡‘çš„å•ä¸€æ–‡ä»¶ï¼Œ,éå¸¸é€‚ç”¨äºæ•°æ®é›†çš„å¤‡ä»½ï¼ˆæ¯”å¦‚æ¯ä¸ªå°æ—¶æŠ¥ä¿å­˜ä¸€ä¸‹è¿‡å»24å°æ—¶å†…çš„æ•°æ®,åŒæ—¶æ¯å¤©ä¿å­˜è¿‡å»30å¤©çš„æ•°æ®ï¼‰ï¼Œè¿™æ ·å³ä½¿å‡ºç°é—®é¢˜ä¹Ÿå¯ä»¥æ ¹æ®æŸæ—¶åˆ»çš„å¤‡ä»½æ¢å¤åˆ°ä¹‹å‰çš„ç‰ˆæœ¬ã€‚</li><li>ç”±äºrdbç”Ÿæˆçš„æ–‡ä»¶æ—¶å•ä¸€çš„ï¼Œè¿™ä¹Ÿå¾ˆæ–¹ä¾¿ç”¨äºåŒæ­¥æ•°æ®ï¼ˆæ¯”å¦‚ï¼Œé›†ç¾¤æƒ…å†µä¸‹ï¼ŒæŸå°redisä¸»æœºå®•æœºï¼Œå¯ä»¥é€šè¿‡rdbæ–‡ä»¶æ¢å¤ï¼‰ </li><li>rdb åŒæ­¥æ—¶æ˜¯ä»çˆ¶çº¿ç¨‹forkä¸€ä¸ªå­çº¿ç¨‹æ¥å®Œæˆè¿™ä¸ªæ“ä½œï¼Œè¿™æ„å‘³ç€çˆ¶çº¿ç¨‹ä¸éœ€è¦åšå…¶ä»–é¢å¤–çš„I/Oæ“ä½œï¼Œæœ€å¤§çš„å‘æŒ¥redisçš„æ€§èƒ½ã€‚</li><li>å’ŒAOFç›¸æ¯”ï¼Œåœ¨å¤§æ•°æ®é›†çš„ä¿å­˜ä¸Šï¼ŒRDB æœ‰æ˜æ˜¾çš„æ€§èƒ½ä¼˜åŠ¿ã€‚  </li></ul><p>*<strong>RDBçš„ç¼ºç‚¹</strong>      </p><ul><li>ç”±äºRDB ä¿å­˜çš„æ•°æ®æ˜¯æŸä¸ªæ—¶åˆ»çš„å¿«ç…§ï¼Œè¿™æ„å‘³ç€åœ¨ä¿å­˜å¿«ç…§æ“ä½œå¼€å§‹åˆ°ä¸‹æ¬¡ä¿å­˜å¿«ç…§ä¹‹é—´æ–°å¢çš„æ•°æ®é›†ï¼Œæ˜¯æœ‰å¯èƒ½ä¸¢å¤±çš„ï¼Œæ¯”å¦‚åœ¨ä¸‹æ¬¡ä¿å­˜ä¹‹å‰æ„å¤–æ–­ç”µæˆ–å®•æœºã€‚</li><li>ç”±äºRDBæ˜¯ä¿å­˜æŸä¸€æ—¶åˆ»çš„å…¨é‡æ•°æ®ï¼Œå³ä½¿æ˜¯ä»çˆ¶çº¿ç¨‹ fork ä¸€ä¸ªå­çº¿ç¨‹ï¼Œä¹Ÿéš¾å…æ¶ˆè€—æ€§èƒ½ã€‚</li></ul><h4 id="AOFæŒä¹…åŒ–"><a href="#AOFæŒä¹…åŒ–" class="headerlink" title="AOFæŒä¹…åŒ–"></a>AOFæŒä¹…åŒ–</h4><p>AOFæŒä¹…åŒ–æ–¹å¼è®°å½•æ¯æ¬¡å¯¹æœåŠ¡å™¨å†™çš„æ“ä½œ,å½“æœåŠ¡å™¨é‡å¯çš„æ—¶å€™ä¼šé‡æ–°æ‰§è¡Œè¿™äº›å‘½ä»¤æ¥æ¢å¤åŸå§‹çš„æ•°æ®,AOFå‘½ä»¤ä»¥redisåè®®è¿½åŠ ä¿å­˜æ¯æ¬¡å†™çš„æ“ä½œåˆ°æ–‡ä»¶æœ«å°¾.Redisè¿˜èƒ½å¯¹AOFæ–‡ä»¶è¿›è¡Œåå°é‡å†™,ä½¿å¾—AOFæ–‡ä»¶çš„ä½“ç§¯ä¸è‡³äºè¿‡å¤§.<br><strong>å¦‚ä½•å¼€å¯AOF</strong><br>åœ¨é…ç½®æ–‡ä»¶ä¸­æ‰“å¼€AOFæ–¹å¼</p><pre class=" language-xml"><code class="language-xml">appendonly yes</code></pre><p><strong>æŒä¹…åŒ–ç­–ç•¥</strong></p><ul><li>æ¯æ¬¡æœ‰æ–°å‘½ä»¤è¿½åŠ åˆ° AOF æ–‡ä»¶æ—¶å°±æ‰§è¡Œä¸€æ¬¡ fsync ï¼šéå¸¸æ…¢ï¼Œä¹Ÿéå¸¸å®‰å…¨</li><li>æ¯ç§’ fsync ä¸€æ¬¡ï¼šè¶³å¤Ÿå¿«ï¼ˆå’Œä½¿ç”¨ RDB æŒä¹…åŒ–å·®ä¸å¤šï¼‰ï¼Œå¹¶ä¸”åœ¨æ•…éšœæ—¶åªä¼šä¸¢å¤± 1 ç§’é’Ÿçš„æ•°æ®ã€‚</li><li>ä»ä¸ fsync ï¼šå°†æ•°æ®äº¤ç»™æ“ä½œç³»ç»Ÿæ¥å¤„ç†ã€‚æ›´å¿«ï¼Œä¹Ÿæ›´ä¸å®‰å…¨çš„é€‰æ‹©ã€‚</li><li>æ¨èï¼ˆå¹¶ä¸”ä¹Ÿæ˜¯é»˜è®¤ï¼‰çš„æªæ–½ä¸ºæ¯ç§’ fsync ä¸€æ¬¡ï¼Œ è¿™ç§ fsync ç­–ç•¥å¯ä»¥å…¼é¡¾é€Ÿåº¦å’Œå®‰å…¨æ€§ã€‚</li></ul><p>*<strong>AOFæŒä¹…åŒ–è¿‡ç¨‹</strong>  </p><ul><li>Redis æ‰§è¡Œ fork() ï¼ŒåŒæ—¶æ‹¥æœ‰çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ã€‚</li><li>å­è¿›ç¨‹å¼€å§‹å°†æ–° AOF æ–‡ä»¶çš„å†…å®¹å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ã€‚</li><li>å¯¹äºæ‰€æœ‰æ–°æ‰§è¡Œçš„å†™å…¥å‘½ä»¤ï¼Œçˆ¶è¿›ç¨‹ä¸€è¾¹å°†å®ƒä»¬ç´¯ç§¯åˆ°ä¸€ä¸ªå†…å­˜ç¼“å­˜ä¸­ï¼Œä¸€è¾¹å°†è¿™äº›æ”¹åŠ¨è¿½åŠ åˆ°ç°æœ‰ AOF æ–‡ä»¶çš„æœ«å°¾,è¿™æ ·æ ·å³ä½¿åœ¨é‡å†™çš„ä¸­é€”å‘ç”Ÿåœæœºï¼Œç°æœ‰çš„ AOF æ–‡ä»¶ä¹Ÿè¿˜æ˜¯å®‰å…¨çš„ã€‚</li><li>å½“å­è¿›ç¨‹å®Œæˆé‡å†™å·¥ä½œæ—¶ï¼Œå®ƒç»™çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œçˆ¶è¿›ç¨‹åœ¨æ¥æ”¶åˆ°ä¿¡å·ä¹‹åï¼Œå°†å†…å­˜ç¼“å­˜ä¸­çš„æ‰€æœ‰æ•°æ®è¿½åŠ åˆ°æ–° AOF æ–‡ä»¶çš„æœ«å°¾ã€‚</li><li>Redis åŸå­åœ°ç”¨æ–°æ–‡ä»¶æ›¿æ¢æ—§æ–‡ä»¶ï¼Œä¹‹åæ‰€æœ‰å‘½ä»¤éƒ½ä¼šç›´æ¥è¿½åŠ åˆ°æ–° AOF æ–‡ä»¶çš„æœ«å°¾ã€‚</li></ul><p><strong>AOFçš„ä¼˜ç‚¹</strong></p><ul><li>AOF æ–‡ä»¶æ˜¯ä¸€ä¸ªåªè¿›è¡Œè¿½åŠ çš„æ—¥å¿—æ–‡ä»¶ï¼Œä¸éœ€è¦å†™å…¥seek,,å³ä½¿ç”±äºæŸäº›åŸå› (ç£ç›˜ç©ºé—´å·²æ»¡ï¼Œå†™çš„è¿‡ç¨‹ä¸­å®•æœºç­‰ç­‰)æœªæ‰§è¡Œå®Œæ•´çš„å†™å…¥å‘½ä»¤,ä½ ä¹Ÿä¹Ÿå¯ä½¿ç”¨redis-check-aofå·¥å…·ä¿®å¤è¿™äº›é—®é¢˜.</li><li>Redis å¯ä»¥åœ¨ AOF æ–‡ä»¶ä½“ç§¯å˜å¾—è¿‡å¤§æ—¶ï¼Œè‡ªåŠ¨åœ°åœ¨åå°å¯¹ AOF è¿›è¡Œé‡å†™ï¼Œæ•´ä¸ªé‡å†™æ“ä½œæ˜¯ç»å¯¹å®‰å…¨çš„ï¼Œå› ä¸º Redis åœ¨åˆ›å»ºæ–° AOF æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œä¼šç»§ç»­å°†å‘½ä»¤è¿½åŠ åˆ°ç°æœ‰çš„ AOF æ–‡ä»¶é‡Œé¢ï¼Œå³ä½¿é‡å†™è¿‡ç¨‹ä¸­å‘ç”Ÿåœæœºï¼Œç°æœ‰çš„ AOF æ–‡ä»¶ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚ è€Œä¸€æ—¦æ–° AOF æ–‡ä»¶åˆ›å»ºå®Œæ¯•ï¼ŒRedis å°±ä¼šä»æ—§ AOF æ–‡ä»¶åˆ‡æ¢åˆ°æ–° AOF æ–‡ä»¶ï¼Œå¹¶å¼€å§‹å¯¹æ–° AOF æ–‡ä»¶è¿›è¡Œè¿½åŠ æ“ä½œã€‚</li><li>AOF æ–‡ä»¶æœ‰åºåœ°ä¿å­˜äº†å¯¹æ•°æ®åº“æ‰§è¡Œçš„æ‰€æœ‰å†™å…¥æ“ä½œ</li><li>AOF æä¾›äº†å¤šç§åŒæ­¥ç­–ç•¥ï¼šæ— fsync,æ¯ç§’fsync,æ¯æ¬¡å†™çš„æ—¶å€™fsyncã€‚é»˜è®¤ä½¿ç”¨æ¯ç§’åŒæ­¥ã€‚è¿™æ ·å³ä½¿å‡ºç°å¼‚å¸¸ï¼ˆå¦‚æ–­ç”µã€å®•æœºï¼‰ï¼Œä¹Ÿåªä¸¢å¤±ä¸€ç§’çš„æ•°æ®ã€‚</li><li>é€šå¸¸æƒ…å†µä¸‹AOFæ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†è¦æ¯”RDBæ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†è¦å®Œæ•´.</li></ul><p>*<strong>AOFçš„ç¼ºç‚¹</strong></p><ul><li>ç›¸åŒçš„æ•°æ®é›†ï¼ŒAOFæ–‡ä»¶çš„ä½“ç§¯è¦æ¯”RDBæ›´å¤§ã€‚</li><li>å³ä½¿é€‰æ‹©æ¯ç§’åŒæ­¥ï¼ŒAOFçš„é€Ÿåº¦è¿˜æ˜¯æ¯”RDBæ…¢</li></ul><p><strong>åœ¨RDBå’ŒAOFåŒæ—¶å¼€å¯çš„æƒ…å†µä¸‹ï¼Œå½“redisé‡å¯çš„æ—¶å€™ä¼šä¼˜å…ˆè½½å…¥AOFæ–‡ä»¶æ¥æ¢å¤åŸå§‹çš„æ•°æ®</strong></p><h2 id="redis-åœ¨sprinBootä¸­çš„ä½¿ç”¨"><a href="#redis-åœ¨sprinBootä¸­çš„ä½¿ç”¨" class="headerlink" title="redis åœ¨sprinBootä¸­çš„ä½¿ç”¨"></a>redis åœ¨sprinBootä¸­çš„ä½¿ç”¨</h2><hr><h3 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h3><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.redis.cluster.max-redirects</span><span class="token punctuation">=</span><span class="token attr-value">3</span><span class="token attr-name">spring.redis.cluster.nodes</span><span class="token punctuation">=</span><span class="token attr-value">127.0.0.1:6590,127.0.0.1:6591</span><span class="token attr-name">spring.redis.password</span><span class="token punctuation">=</span><span class="token attr-value">Pass_123</span><span class="token attr-name">spring.redis.timeout</span><span class="token punctuation">=</span><span class="token attr-value">5000</span></code></pre><h3 id="ä»£ç ä¸­çš„ä½¿ç”¨"><a href="#ä»£ç ä¸­çš„ä½¿ç”¨" class="headerlink" title="ä»£ç ä¸­çš„ä½¿ç”¨"></a>ä»£ç ä¸­çš„ä½¿ç”¨</h3><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Resource</span><span class="token keyword">private</span> StringRedisTemplate stringRedisTemplate<span class="token punctuation">;</span>ValueOperations<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> ops <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// åˆ†å¸ƒå¼é”</span>ops<span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>msgId<span class="token punctuation">,</span>msgId<span class="token punctuation">,</span>1800L<span class="token punctuation">,</span>TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span></code></pre><h2 id="redis-å¸¸è§é¢è¯•é¢˜"><a href="#redis-å¸¸è§é¢è¯•é¢˜" class="headerlink" title="redis å¸¸è§é¢è¯•é¢˜"></a>redis å¸¸è§é¢è¯•é¢˜</h2><ol><li><strong>redisä¸ºä»€ä¹ˆå¯ä»¥å¿«é€Ÿæ‰§è¡Œ?</strong><ul><li>ç»å¤§å¤šæ•°è¯·æ±‚éƒ½æ˜¯åŸºäºå†…å­˜æ“ä½œçš„</li><li>é‡‡ç”¨å•çº¿ç¨‹ï¼Œé¿å…ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¸éœ€è¦å„ç§é”çš„æ€§èƒ½æ¶ˆè€—ã€‚</li><li>éé˜»å¡IO-IOå¤šè·¯å¤ç”¨ï¼ˆå¤šç½‘ç»œè¿æ¥ï¼Œå¤ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼‰</li><li>Redisé‡‡ç”¨è‡ªå·±å®ç°çš„äº‹ä»¶åˆ†ç¦»å™¨</li></ul></li><li><strong>ç¼“å­˜é›ªå´©</strong><ul><li>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨æŸå°ç¼“å­˜ä¸»æœºå®•æœºæ—¶ï¼Œæ‰€æœ‰è¯·æ±‚ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“å®•æœºçš„è¯·å†µã€‚</li><li>è§£å†³æ–¹æ¡ˆï¼š<ul><li>ç¡®ä¿redisçš„é«˜å¯ç”¨ï¼šå¤šå° redis ä¸»æœºåŒæ—¶å·¥ä½œï¼Œäº’ä¸ºä¸»å¤‡ï¼ŒåŠæ­å»º redis é›†ç¾¤ã€‚</li><li>é™æµé™çº§ï¼šåªå…è®¸ä¸€ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æ•°æ®åº“ï¼ˆåˆ†å¸ƒå¼é”ï¼‰ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…ã€‚</li><li>æ•°æ®é¢„çƒ­ï¼šåœ¨æ­£å¼ä¸Šçº¿ä¹‹å‰ï¼Œå…ˆå¯¹å¯èƒ½å¤§é‡è®¿é—®çš„æ•°æ®è¿›è¡Œé¢„å…ˆè®¿é—®ï¼Œä½¿å…¶å­˜åœ¨ç¼“å­˜ä¸­ï¼ŒåŒæ—¶è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä½¿ç¼“å­˜å¤±æ•ˆæ—¶é—´å°½é‡åˆ†å¸ƒå‡åŒ€</li></ul></li></ul></li><li><strong>ç¼“å­˜ç©¿é€</strong><ul><li>æ˜¯ç›´æ¥è®¿é—®ä¸€ä¸ª redis ä¸­ä¸å­˜åœ¨çš„keyï¼Œç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œç›´æ¥è®¿é—®æ•°æ®åº“ã€‚åœ¨è¿™ç§è¯·æ±‚ä¸‹å¤§é‡è®¿é—®ç±»ä¼¼çš„keyï¼Œä¹Ÿä¼šå‡ºç°æ•°æ®åº“å®•æœºçš„è¯·å†µã€‚</li><li>è§£å†³æ–¹æ¡ˆï¼š<ul><li>å¸ƒéš†è¿‡æ»¤å™¨ï¼šå°†æ•°æ®åº“å¯ä»¥æŸ¥è¯¢çš„key ä»¥hashçš„ç±»å‹ç¼“å­˜åˆ° bitmapä¸­ï¼Œå½“ä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„keyè®¿é—®æ—¶ï¼Œä¼šè¢«ç›´æ¥æ‹¦æˆª</li><li>ç¼“å­˜ç©ºå¯¹è±¡ï¼šå¦‚æœkeyå€¼åœ¨ç¼“å­˜å’Œæ•°æ®åº“éƒ½æ²¡æœ‰å‘½ä¸­çš„æƒ…å†µä¸‹ï¼Œç›´æ¥ç¼“å­˜ä¸€ä¸ªç©ºå¯¹è±¡ï¼ˆéœ€è¦è®¾ç½®è¶…æ—¶æ—¶é—´ï¼‰ï¼Œä¸‹æ¬¡è®¿é—®è¿™ä¸ªkeyå°±ä¸ä¼šå‘½ä¸­æ•°æ®åº“ã€‚</li></ul></li></ul></li><li><strong>ç¼“å­˜å‡»ç©¿</strong><ul><li>æŒ‡æŸä¸ªçƒ­ç‚¹keyï¼Œåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹çªç„¶å¤±æ•ˆï¼Œå¹¶å‘ç›´æ¥è¯·æ±‚æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“å®•æœºçš„è¯·æ±‚</li><li>è§£å†³æ–¹æ¡ˆï¼š<ul><li>äº’æ–¥é”(mutex key)ï¼šåœ¨å‡ºç°çƒ­ç‚¹key å¤±æ•ˆæ—¶ï¼Œé€šè¿‡redisçš„setnxï¼ˆkeyï¼Œvalueï¼Œtimeoutï¼‰æ–¹æ³•ï¼Œå®ç°å•ä¸€çº¿ç¨‹è¿›è¡Œè¯»å†™æ“ä½œã€‚<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//è®¾ç½®ä¸€ä¸ªç¼“å­˜ï¼ˆå­˜åœ¨è¶…æ—¶æ—¶é—´ï¼‰è¡¨ç¤ºï¼Œç›®å‰æœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è¯»å†™æ“ä½œ</span><span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">setnx</span><span class="token punctuation">(</span>key_mutex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>value <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>redis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expire_secs<span class="token punctuation">)</span><span class="token punctuation">;</span>redis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//çƒ­ç‚¹keyè®¾ç½®å®Œæˆåï¼Œå°†ä¹‹å‰key_mutexåˆ é™¤ï¼Œé˜²æ­¢ä¸‹æ¬¡å‡»ç©¿æ—¶ï¼Œæ— æ³•è¿›è¡Œè¯»å–db</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//è¿™ä¸ªæ—¶å€™ä»£è¡¨åŒæ—¶æœŸçš„çº¿ç¨‹è¿›å…¥ç­‰å¾…ï¼Œç­‰å¾…ç»“æŸå†æ¬¡è¿›è¡Œè¯»å–æ“ä½œ</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//é‡è¯•</span><span class="token punctuation">}</span> </code></pre>```java</li></ul></li><li>æ°¸è¿œä¸è¿‡æœŸï¼š<br>  ç‰©ç†ä¸è¿‡æœŸï¼šä¸è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä¹Ÿå°±ä¸å­˜åœ¨è¿‡æœŸé—®é¢˜ã€‚ä½†æ˜¯ä¼šå‡ºç°æ•°æ®ä¸è‡ªåŠ¨æ›´æ–°ï¼Œæ— æ³•ä¿è¯ä¸€è‡´æ€§ã€‚<br>  å¼‚æ­¥ä¸è¿‡æœŸï¼šè®¾ç½®è¶…æ—¶æ—¶é—´ï¼ŒåŒæ—¶æ·»åŠ å¼‚æ­¥çº¿ç¨‹ï¼Œå‘ç°çƒ­ç‚¹keyå¿«è¿‡æœŸçš„æ—¶å€™ï¼Œé‡æ–°è®¾ç½®çƒ­ç‚¹keyï¼Œä½†æ˜¯ä¼šå‡ºç°å¼‚æ­¥çº¿ç¨‹æ›´æ–°keyæ—¶ï¼Œå…¶ä»–çº¿ç¨‹è®¿é—®çš„è¿˜æ˜¯è€æ•°æ®ã€‚<br>```</li></ul></li><li><strong>è¿‡æœŸæœºåˆ¶</strong><ul><li>åœ¨å†…å­˜å……è¶³çš„æƒ…å†µä¸‹ï¼Œredis å¯¹å·²ç»è¿‡æœŸçš„ key è¿›è¡Œæ¸…ç†</li><li>å¸¸è§çš„è¿‡æœŸæœºåˆ¶æœ‰ä¸‰ç§ï¼š<ul><li>å®šæ—¶è¿‡æœŸï¼šè®¾ç½®å¯¹æ¯ä¸ªè®¾ç½®è¿‡æœŸæ—¶é—´çš„ key åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œå†keyä¸€åˆ°è¿‡æœŸæ—¶é—´ï¼Œå°±ä¼šç«‹å³åˆ é™¤ã€‚è¯¥ç­–ç•¥å¯¹å†…å­˜å‹å¥½ï¼Œä½†æ˜¯å¯¹CPUæ¶ˆè€—æå¤§ï¼Œå½±å“redisçš„å“åº”æ—¶é—´å’Œååé‡ã€‚</li><li>æƒ°æ€§è¿‡æœŸï¼šè®¿é—® key çš„æ—¶å€™ï¼Œé‡‡å–æ ¡éªŒæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤ã€‚è¯¥ç­–ç•¥å¯¹CPUå‹å¥½ï¼Œä½†æ˜¯å¯¹å†…å­˜æä¸å‹å¥½ã€‚</li><li>å®šæœŸè¿‡æœŸï¼šæ¯éš”ä¸€æ®µæ—¶é—´ï¼Œæ£€æŸ¥æ•°æ®åº“ expireså­—å…¸ä¸­çš„ key ï¼Œæ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸåˆ™åˆ é™¤ã€‚</li></ul></li><li>redisé‡‡ç”¨<strong>æƒ°æ€§è¿‡æœŸå’Œå®šæœŸè¿‡æœŸ</strong>ï¼Œä¼˜åŒ–å†…å­˜å’ŒCPUçš„æ€§èƒ½ï¼Œä½¿å…¶è¾¾åˆ°å¹³è¡¡ã€‚ </li></ul></li><li><strong>æ·˜æ±°æœºåˆ¶</strong><ul><li>æ˜¯æŒ‡å†redis ç¼“å­˜å†…å­˜ä¸è¶³æ—¶çš„ï¼Œå¦‚ä½•å¤„ç†æ–°å…¥åº“çš„æ•°æ®çš„è§£å†³æ–¹æ¡ˆã€‚</li><li>æ·˜æ±°æœºåˆ¶åˆ†6ç§ï¼š<ul><li>noeviction:ä¸åˆ é™¤ç­–ç•¥ï¼Œè¾¾åˆ°æœ€å¤§å†…å­˜é™åˆ¶æ—¶ï¼Œå¦‚æœéœ€è¦æ›´å¤šå†…å­˜ï¼Œç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯ã€‚</li><li>allkeys-lru:æ‰€æœ‰keyé€šç”¨ï¼Œä¼˜å…ˆåˆ é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„(less recently used,LRU)key.</li><li>allkeys-random:æ‰€æœ‰keyé€šç”¨ï¼Œéšæœºåˆ é™¤ä¸€éƒ¨åˆ†key.</li><li>volatile-random:åªé™äºè®¾ç½®äº†expireçš„éƒ¨åˆ†ï¼Œåˆ é™¤ä¸€éƒ¨åˆ†expireçš„key.</li><li>volatile-ttl:åªé™äºè®¾ç½®äº†expireçš„éƒ¨åˆ†ï¼Œä¼˜å…ˆåˆ é™¤å‰©ä½™æ—¶é—´(time to live,TTL)çŸ­çš„key.</li><li>volatile-lruï¼šåªé™äºè®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼Œä¼˜å…ˆåˆ é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</li><li><ul><li>å¦‚ä½•é…ç½® æ·˜æ±°ç­–ç•¥ï¼šredis.conf ä¸­maxmemory è®¾ç½®æœ€å¤§å†…å­˜ï¼Œè¶…å‡ºæ—¶ï¼Œè‡ªåŠ¨è§¦å‘ maxmemory-policy ä¸­é…ç½®çš„ç­–ç•¥</li></ul></li></ul></li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaé›†åˆ_è¯¦è§£(HashMapæºç å‰–æ)</title>
      <link href="/2020/10/10/Collection/"/>
      <url>/2020/10/10/Collection/</url>
      
        <content type="html"><![CDATA[<p>æœ‰ç”Ÿä»¥æ¥ï¼Œç¬¬ä¸€æ¬¡å†™è‡ªå·±çš„åšå®¢ï¼Œå¸Œæœ›è‡ªä¸ªåšæŒå­¦ä¹ ï¼ŒåšæŒå†™åšå®¢ï¼ŒåŠªåŠ›å‘å¤§ä½¬å‰è¿›ï¼ QAQ â€¦â€¦â€¦</p><p>åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥å¼€æ’¸ï¼</p><h2 id="é›†åˆæ¡†æ¶å›¾"><a href="#é›†åˆæ¡†æ¶å›¾" class="headerlink" title="é›†åˆæ¡†æ¶å›¾"></a><strong>é›†åˆæ¡†æ¶å›¾</strong></h2><p><img src="https://www.runoob.com/wp-content/uploads/2014/01/2243690-9cd9c896e0d512ed.gif" alt="ps.å›¾ç‰‡æ¥è‡ªèœé¸Ÿæ•™ç¨‹" title="collection"></p><p>å¦‚ä¸Šå›¾æ‰€è§ï¼Œé›†åˆä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼ŒCollection å’Œ Mapï¼Œå…¶ä¸­Collectionåˆåˆ†ä¸ºListã€Setå’ŒQueueã€‚æœ¬æ¬¡æˆ‘ä»¬ä¸»è¦æ¥è¯´è¯´Listã€Set å’Œ Mapã€‚</p><span id="more"></span> <h3 id="1ã€Collection-ä¸‹çš„å­ç±»-List-å’Œ-Set"><a href="#1ã€Collection-ä¸‹çš„å­ç±»-List-å’Œ-Set" class="headerlink" title="1ã€Collection ä¸‹çš„å­ç±» List å’Œ Set"></a><strong>1ã€Collection ä¸‹çš„å­ç±» List å’Œ Set</strong></h3><p>ä¸Šé¢çš„æ¶æ„å›¾ç›¸å¯¹å¤æ‚ï¼Œå’±ç®€åŒ–ä¸€ä¸‹ã€‚ï¼ˆä»¥ä¸‹ç®­å¤´å¹¶éä¸¥æ ¼çš„çˆ¶å­å…³ç³» ^-^ï¼‰<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b35234760cc045ee950566edf2ee3f19~tplv-k3u1fbpfcp-zoom-1.image"></p><h4 id="1-1ã€List"><a href="#1-1ã€List" class="headerlink" title="1.1ã€List"></a><strong>1.1ã€List</strong></h4><p>List ä¸‹æœ‰ ArrayListã€LinkedListã€Vectorã€‚</p><ul><li>ArrayList<ul><li>ç‰¹ç‚¹ï¼šåº•å±‚æ•°æ®ç»“æ„æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥æŸ¥è¯¢å¿«</li><li>ç¼ºç‚¹ï¼šä¹Ÿå› ä¸ºæ˜¯æ•°ç»„ï¼Œæ‰€ä»¥å¢åˆ æ…¢ï¼Œçº¿ç¨‹ä¸å®‰å…¨(æ•ˆç‡ç›¸å¯¹è¾ƒé«˜)</li></ul></li><li>LinkedList<ul><li>ç‰¹ç‚¹ï¼šåº•å±‚æ•°æ®ç»“æ„æ˜¯åŒå‘é“¾è¡¨ï¼Œå¢åˆ å¿«ã€‚</li><li>ç¼ºç‚¹ï¼šçº¿ç¨‹ä¸å®‰å…¨(æ•ˆç‡ç›¸å¯¹é«˜),åº•å±‚æ˜¯é“¾è¡¨,å¯¼è‡´æŸ¥è¯¢è¾ƒæ…¢.</li></ul></li><li>Vector<ul><li>ç‰¹ç‚¹ï¼šçº¿ç¨‹å®‰å…¨ï¼Œåº•å±‚æ•°æ®ç»“æ„æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥æŸ¥è¯¢å¿«ã€‚</li><li>ç¼ºç‚¹ï¼šæ•ˆç‡ä½</li></ul></li></ul><p><em>æ•°ç»„å’Œé“¾è¡¨çš„åŒºåˆ«</em></p><pre class=" language-java"><code class="language-java">æ•°ç»„ï¼š <span class="token number">1</span>ã€åœ¨å†…å­˜ä¸­åˆ†é…ä¸€ä¸ªè¿ç»­çš„åŒºåŸŸæ¥ä¿å­˜æ•°æ®ï¼Œå¹¶ä¸”æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå°±è¦ç¡®å®šç©ºé—´å¤§å°ï¼ŒåŒæ—¶åœ¨è¿è¡Œé˜¶æ®µæ˜¯ä¸å…è®¸æ”¹å˜çš„<span class="token punctuation">(</span>ä¸å¯æ‰©å®¹<span class="token punctuation">)</span>ã€‚ <span class="token number">2</span>ã€åœ¨æŸ¥æ‰¾æ—¶ï¼Œç›´æ¥ä»æ•°ç»„çš„é¦–åœ°å€å‘ååç§»å°±å¯ä»¥è®¿é—®åˆ°äº†ï¼Œæ‰€ä»¥ä»–çš„æ—¶é—´å¤æ‚åº¦ä¸º <span class="token function">O</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>ã€‚ <span class="token number">3</span>ã€æ–°å¢æ—¶ï¼Œå¤´æ’æ³•éœ€è¦å°†æ‰€æœ‰å…ƒç´ åç§»ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º<span class="token function">O</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>ã€‚å°¾æ’æ³•ï¼Œç›´æ¥æ’å…¥ï¼Œæ— éœ€ç§»åŠ¨ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º <span class="token function">O</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>åˆ é™¤ä¹Ÿä¸€æ ·ã€‚ <span class="token number">4</span>ã€æ‰©å®¹æ—¶ï¼Œæ•°ç»„æ˜¯æ— æ³•åœ¨è¿è¡ŒæœŸé—´ä¿®æ”¹å®¹é‡çš„ï¼Œæ‰€ä»¥åœ¨æ‰©å®¹æ—¶ï¼Œæ–°ç”³è¯·ä¸€ä¸ªæ›´å¤§å®¹é‡çš„æ•°ç»„ï¼Œå†å°†åŸæ•°ç»„çš„æ•°æ® COPY è¿‡å»ã€‚é“¾è¡¨ï¼š <span class="token number">1</span>ã€å†…å­˜ä¸­åˆ†é…çš„åŒºåŸŸéè¿ç»­ã€éé¡ºåºï¼Œé“¾è¡¨ä¸­çš„èŠ‚ç‚¹ï¼Œå­˜åœ¨ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚ï¼ˆå•å‘é“¾è¡¨ï¼‰ã€‚ç»“ç‚¹å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆ<span class="token punctuation">(</span>å¯æ‰©å®¹<span class="token punctuation">)</span>ã€‚ <span class="token number">2</span>ã€æŸ¥æ‰¾æ—¶ï¼Œç”±äºé“¾è¡¨çš„ç©ºé—´æ˜¯åˆ†æ•£çš„ï¼Œæ‰€ä»¥ä¸å…·æœ‰éšæœºè®¿é—®æ€§ï¼Œå¦‚æœè¦æŸ¥æ‰¾ï¼Œå¿…é¡»ä»ç¬¬ä¸€ä¸ªå¼€å§‹ï¼Œå‘ä¸‹æŸ¥æ‰¾ï¼Œæ‰€ä»¥å®ƒçš„æ—¶é—´å¤æ‚åº¦ä¸º<span class="token function">O</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>ã€‚ <span class="token number">3</span>ã€æ–°å¢æ—¶ï¼Œç”±äºç©ºé—´åˆ†æ•£ï¼Œæ— éœ€ç§»åŠ¨ï¼Œå¯ç›´æ¥æ’å…¥ï¼Œåªéœ€å°†ä¸Šä¸€èŠ‚ç‚¹æŒ‡é’ˆï¼ŒæŒ‡å‘æ–°å…ƒç´ ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦ä¸º<span class="token function">O</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>ã€‚ <span class="token number">4</span>ã€æ‰©å®¹æ—¶ï¼ŒåŠ¨æ€ç”³è¯·ï¼ŒåŠ¨æ€ç§»é™¤ï¼Œæ‰©å®¹æ–¹ä¾¿ï¼Œä¸”åˆ©ç”¨ç‡é«˜ã€‚</code></pre><h4 id="1-2ã€Set"><a href="#1-2ã€Set" class="headerlink" title="1.2ã€Set"></a><strong>1.2ã€Set</strong></h4><p>Set ä¸‹æœ‰ HashSetã€linkedHashSetã€TreeSetã€‚</p><ul><li>HashSet<ul><li>ç‰¹ç‚¹ï¼šåº•å±‚æ•°æ®ç»“æ„ä¸º HashMapã€è®¾ç½®key-valueé”®å€¼å¯¹ï¼Œå…¶ä¸­valueä¸ºnew object()ã€‘ï¼Œå…ƒç´ æ— åºä¸”å”¯ä¸€ï¼Œæ•ˆç‡é«˜</li><li>ç¼ºç‚¹ï¼šçº¿ç¨‹ä¸å®‰å…¨</li></ul></li><li>linkedHashSet<ul><li>ç‰¹ç‚¹ï¼šåº•å±‚æ•°æ®ç»“æ„ä¸º linkedHashMapï¼Œå…ƒç´ æœ‰åºä¸”å”¯ä¸€ã€æŒ‰æ’å…¥é¡ºåºã€‘</li><li>ç¼ºç‚¹ï¼šçº¿ç¨‹ä¸å®‰å…¨    </li></ul></li><li>TreeSet<ul><li>ç‰¹ç‚¹ï¼šåº•å±‚æ•°æ®ç»“æ„ä¸º TreeMapï¼Œå…ƒç´ é»˜è®¤è‡ªç„¶æ’åºã€è¿˜å¯ä»¥è‡ªå®šä¹‰æ’åºè§„åˆ™ï¼šå¯ä»¥åœ¨è‡ªå®šä¹‰çš„å¯¹è±¡ç±»ä¸­ç»§æ‰¿Comparableï¼Œå¹¶é‡å†™compareToæ–¹æ³•ã€‘</li><li>ç¼ºç‚¹ï¼šçº¿ç¨‹ä¸å®‰å…¨    </li></ul></li></ul><p>ç”±äº set é›†åˆï¼Œåº•å±‚åŸºæœ¬ä¸Šé€šè¿‡ Map å®ç°ï¼Œæ­¤æ¬¡ä¸å±•å¼€èµ˜è¿°ã€‚ä¼šåœ¨ä¸‹é¢ Map ä¸­å±•å¼€ï¼ </p><h3 id="2ã€é‡ä¸­ä¹‹é‡çš„-Map"><a href="#2ã€é‡ä¸­ä¹‹é‡çš„-Map" class="headerlink" title="2ã€é‡ä¸­ä¹‹é‡çš„ Map"></a><strong>2ã€é‡ä¸­ä¹‹é‡çš„ Map</strong></h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9b3ac614c06948d8b6cf10f19079ac39~tplv-k3u1fbpfcp-zoom-1.image"></p><p>Map ä¸‹æœ‰ HasMapã€LinkedHashMapã€HashTableã€TreeMapï¼Œ</p><ul><li>HashMap<ul><li>ç‰¹ç‚¹ï¼šåº•å±‚æ•°æ®ç»“æ„ä¸º æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ã€jdk1.8æ–°ç‰¹æ€§ã€‘</li><li>ç¼ºç‚¹ï¼šçº¿ç¨‹ä¸å®‰å…¨</li></ul></li><li>LinkedHashMap<ul><li>ç‰¹ç‚¹ï¼šåº•å±‚æ•°æ®ç»“æ„ä¸º HashMap+åŒå‘é“¾è¡¨ï¼Œæœ‰åºï¼Œå‡ºå…¥ä¸€è‡´</li><li>ç¼ºç‚¹ï¼šçº¿ç¨‹ä¸å®‰å…¨</li></ul></li><li>HashTable <ul><li>ç‰¹ç‚¹ï¼šåº•å±‚æ•°æ®ç»“æ„ä¸º æ•°ç»„+é“¾è¡¨ï¼Œçº¿ç¨‹å®‰å…¨</li><li>ç¼ºç‚¹ï¼šæ— åº</li></ul></li><li>TreeMap<ul><li>ç‰¹ç‚¹ï¼šåº•å±‚æ•°æ®ç»“æ„ä¸ºçº¢é»‘æ ‘ï¼Œæœ‰åºï¼Œå…ƒç´ é»˜è®¤è‡ªç„¶æ’åºã€è¿˜å¯ä»¥è‡ªå®šä¹‰æ’åºè§„åˆ™ï¼šå¯ä»¥åœ¨è‡ªå®šä¹‰çš„å¯¹è±¡ç±»ä¸­ç»§æ‰¿Comparableï¼Œå¹¶é‡å†™compareToæ–¹æ³•ã€‘</li><li>ç¼ºç‚¹ï¼šçº¿ç¨‹ä¸å®‰å…¨</li></ul>  <strong>é¢è¯•å¿…é—®ä¹‹HashMap</strong><br>  <em>HashMap</em> <em>putè¿‡ç¨‹æºç è§£æã€ä»¥ä¸‹ä¸ºjdk1.8 æºç ã€‘</em></li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> V <span class="token function">put</span><span class="token punctuation">(</span>K key<span class="token punctuation">,</span> V value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// é€šè¿‡ hash æ–¹æ³•è·å–keyçš„ hash å€¼ ï¼Œè§ä¸‹æ–¹keyçš„ hash ç®—æ³•</span>    <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">final</span> V <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> K key<span class="token punctuation">,</span> V value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">,</span>               <span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> p<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­Mapæ˜¯å¦åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œè¿›è¡Œç¬¬ä¸€æ¬¡æ‰©å®¹ï¼Œé•¿åº¦ä¸º16</span>        <span class="token comment" spellcheck="true">// æ‰©å®¹è¯¦ç»† è§ä¸‹æ–¹æ‰©å®¹æœºåˆ¶</span>        n <span class="token operator">=</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// n = map çš„é•¿åº¦ï¼Œ&amp; ç›¸å½“äº hash å¯¹ n-1 æ±‚ä¸</span>    <span class="token comment" spellcheck="true">// è®¡ç®—å¯¹åº”keyåœ¨ HashMap æ•°ç»„ä¸­çš„ä¸‹æ ‡ä½ç½®</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­ä¸‹æ ‡ä½ç½®æ˜¯å¦å­˜åœ¨å€¼</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¦‚æœè¯¥ä¸‹æ ‡ä¸º nullï¼Œæ–°å¢ä¸€ä¸ªé“¾è¡¨ï¼Œå¹¶å°†é“¾è¡¨çš„ç¬¬ä¸€ä½æŒ‡å‘æ•°ç»„å¯¹åº”ä¸‹æ ‡å¤„</span>        tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ä¸‹æ ‡ä½ç½®å·²ç»å­˜åœ¨å€¼æ—¶ </span>        Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e<span class="token punctuation">;</span> K k<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­æ–°å¢çš„ key çš„ hash å’Œ equals ï¼Œå’Œå½“å‰å·²å­˜åœ¨çš„ key çš„ hash å’Œ equals æ˜¯å¦ä¸€è‡´</span>        <span class="token comment" spellcheck="true">// è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ è‡ªå®šä¹‰å¯¹è±¡é‡å†™equalsæ–¹æ³•æ—¶ï¼Œå¿…é¡»é‡å†™hashæ–¹æ³•ã€‚</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¦‚æœkeyå€¼çš„hash å’Œ equals éƒ½ä¸€è‡´ï¼Œç›´æ¥æ›¿æ¢ã€‚</span>            e <span class="token operator">=</span> p<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// åˆ¤æ–­å½“å‰èŠ‚ç‚¹ç±»å‹æ˜¯å¦ä¸ºçº¢é»‘æ ‘</span>            <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯ç›´æ¥æ’å…¥</span>            e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tab<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯é“¾è¡¨</span>            <span class="token comment" spellcheck="true">// å¾ªç¯æŸ¥æ‰¾é“¾è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// æŸ¥æ‰¾åˆ°ä¹‹åï¼Œæ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶å°†ä¸Šä¸€èŠ‚ç‚¹çš„nextå±æ€§ï¼Œè®¾ç½®ä¸ºæ–°å¢èŠ‚ç‚¹</span>                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">>=</span> TREEIFY_THRESHOLD <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// -1 for 1st</span>                        <span class="token comment" spellcheck="true">// å¦‚æœé“¾è¡¨é•¿åº¦è¶…è¿‡ 8 ï¼Œåˆ™è½¬æ¢æˆçº¢é»‘æ ‘</span>                        <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">//treeifyBin æ–¹æ³•ä¸­ä¼šåˆ¤æ–­mapçš„é•¿åº¦ï¼Œå¦‚æœå°äº64ï¼Œåˆ™è¿›è¡Œæ‰©å®¹ï¼Œè€Œä¸æ ‘åŒ–</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>                    <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                p <span class="token operator">=</span> e<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯é“¾è¡¨ä¸­çš„å­˜åœ¨çš„key ç›´æ¥æ›¿æ¢valueå€¼ï¼Œå¹¶è¿”å› æ—§çš„valueå€¼//</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// existing mapping for key</span>            V oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent <span class="token operator">||</span> oldValue <span class="token operator">==</span> null<span class="token punctuation">)</span>                e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>            <span class="token function">afterNodeAccess</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token operator">++</span>modCount<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>size <span class="token operator">></span> threshold<span class="token punctuation">)</span>        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">afterNodeInsertion</span><span class="token punctuation">(</span>evict<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ä¸€å¥è¯æ¦‚æ‹¬hashMapçš„putæ“ä½œï¼š</p><pre class=" language-java"><code class="language-java">é¦–å…ˆåˆ¤æ–­Mapæ˜¯å¦åˆå§‹åŒ–ï¼Œæ²¡æœ‰åˆ™æ–°å»ºä¸€ä¸ªã€‚    ç„¶ååˆ¤æ–­æ˜¯å¦å­˜åœ¨æ–°å¢çš„keyå€¼ï¼Œå¦‚æœå­˜åœ¨å°±æ›¿æ¢ã€‚    å¦åˆ™åˆ¤æ–­æ–°å¢keyå¯¹åº”èŠ‚ç‚¹çš„æ•°æ®ç±»å‹ã€‚        å¦‚æœçº¢é»‘æ ‘ç›´æ¥æ’å…¥ã€‚        å¦‚æœæ˜¯é“¾è¡¨ï¼Œå°¾éƒ¨æ’å…¥ï¼Œæ’å…¥ååˆ¤æ–­é“¾è¡¨é•¿åº¦ã€‚            å¦‚æœè¶…è¿‡<span class="token number">8</span>ä½ï¼Œåˆ™è½¬æ¢æˆçº¢é»‘æ ‘ã€‚</code></pre><p><em>HashMap</em> <em>hashç®—æ³•æºç è§£æã€ä»¥ä¸‹ä¸ºjdk1.8 æºç ã€‘</em></p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span>Object key<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> h<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**      * å–keyçš„hashå€¼ ä¸ å®ƒçš„é«˜16ä½ è¿›è¡Œå¼‚æˆ–è¿ç®—ã€ç¡®è®¤keyåœ¨mapä¸­çš„ä½ç½®æ—¶ï¼Œ     * hashå€¼ä¼šå¯¹Mapçš„é•¿åº¦è¿›è¡Œå–ä½™ï¼Œå’Œé«˜16ä½å¼‚æˆ–è®¡ç®—ï¼Œå¯ä»¥ä½¿é«˜16ä½ä¹Ÿå‚ä¸åˆ°å–ä½™è®¡ç®—ä¸­ã€‘     * ç›®çš„ï¼šä½¿keyçš„æ•£åˆ—æ€§æ›´å¥½ï¼Œå°½é‡é¿å…hashç¢°æ’ï¼Œã€å¯é™ä½é“¾è¡¨é•¿åº¦ å’Œ çº¢é»‘æ ‘æ·±åº¦ã€‘,è®©hashMapæ›´åŠ é«˜æ•ˆ     */</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><em>HashMap</em> <em>æ‰©å®¹æœºåˆ¶æºç è§£æã€ä»¥ä¸‹ä¸ºjdk1.8 æºç ã€‘</em></p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldTab <span class="token operator">=</span> table<span class="token punctuation">;</span>    <span class="token keyword">int</span> oldCap <span class="token operator">=</span> <span class="token punctuation">(</span>oldTab <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> oldTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">int</span> oldThr <span class="token operator">=</span> threshold<span class="token punctuation">;</span>    <span class="token keyword">int</span> newCap<span class="token punctuation">,</span> newThr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// newCapè¡¨ç¤ºæ–°mapçš„å¤§å°ï¼ŒnewThrè¡¨ç¤ºæ–°mapçš„æ‰©å®¹é˜ˆå€¼ </span>    <span class="token comment" spellcheck="true">// å¦‚æœmapå·²ç»å®ä¾‹åŒ–</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¦‚æœmapé•¿åº¦å¤§äºæœ€å¤§é•¿åº¦ï¼Œä¸æ‰©å®¹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">>=</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span> <span class="token punctuation">{</span>            threshold <span class="token operator">=</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>            <span class="token keyword">return</span> oldTab<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newCap <span class="token operator">=</span> oldCap <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MAXIMUM_CAPACITY <span class="token operator">&amp;&amp;</span>                 oldCap <span class="token operator">>=</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// double threshold</span>            <span class="token comment" spellcheck="true">// æ‰©å¤§1å€</span>            newThr <span class="token operator">=</span> oldThr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldThr <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// initial capacity was placed in threshold</span>        newCap <span class="token operator">=</span> oldThr<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>           <span class="token comment" spellcheck="true">// zero initial threshold signifies using defaults</span>        <span class="token comment" spellcheck="true">// æœªåˆå§‹åŒ–æ—¶ï¼Œé‡æ–°å‚æ•°åˆå§‹åŒ–</span>        newCap <span class="token operator">=</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">;</span>        newThr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DEFAULT_LOAD_FACTOR <span class="token operator">*</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>newThr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">float</span> ft <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>newCap <span class="token operator">*</span> loadFactor<span class="token punctuation">;</span>        newThr <span class="token operator">=</span> <span class="token punctuation">(</span>newCap <span class="token operator">&lt;</span> MAXIMUM_CAPACITY <span class="token operator">&amp;&amp;</span> ft <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>MAXIMUM_CAPACITY <span class="token operator">?</span>                  <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>ft <span class="token operator">:</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    threshold <span class="token operator">=</span> newThr<span class="token punctuation">;</span>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"rawtypes"</span><span class="token punctuation">,</span><span class="token string">"unchecked"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTab <span class="token operator">=</span> <span class="token punctuation">(</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">[</span>newCap<span class="token punctuation">]</span><span class="token punctuation">;</span>    table <span class="token operator">=</span> newTab<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTab <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldCap<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>next <span class="token operator">==</span> null<span class="token punctuation">)</span>                    <span class="token comment" spellcheck="true">// é‡æ–°è®¡ç®—æ•°ç»„ä¸‹æ ‡ä½ç½®ï¼š</span>                    <span class="token comment" spellcheck="true">// è¦ä¹ˆåœ¨åŸä½ç½®ï¼Œè¦ä¹ˆåœ¨åŸä½ç½®+æ–°æ•°ç»„é•¿åº¦/2 ä¸‹æ ‡ä½ç½®</span>                    newTab<span class="token punctuation">[</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> <span class="token punctuation">(</span>newCap <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>                    <span class="token comment" spellcheck="true">// é¦–å…ˆç”±äºæ‰©å®¹å¯¼è‡´ hash &amp; ï¼ˆnewCap - 1ï¼‰å€¼å‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥ä¼šè¿›è¡Œæ‹†æ ‘</span>                    <span class="token comment" spellcheck="true">// è¦ä¹ˆåœ¨åŸä½ç½® å’Œ åœ¨åŸä½ç½®+æ–°æ•°ç»„é•¿åº¦/2 ä¸‹æ ‡ä½ç½®ï¼Œç”Ÿæˆä¸¤ä¸ªçº¢é»‘æ ‘</span>                    <span class="token comment" spellcheck="true">// åœ¨åˆ¤æ–­çº¢é»‘æ ‘çš„é•¿åº¦æ˜¯å¦å°äº 6 ï¼ˆçº¢é»‘æ ‘çš„é˜ˆå€¼*æ‰©å®¹ç³»æ•°ï¼‰ï¼Œå°äºåˆ™è½¬æ¢æˆé“¾è¡¨ï¼ˆå»æ ‘åŒ–ï¼‰</span>                    <span class="token punctuation">(</span><span class="token punctuation">(</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">)</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newTab<span class="token punctuation">,</span> j<span class="token punctuation">,</span> oldCap<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">else</span> <span class="token punctuation">{</span>                     <span class="token comment" spellcheck="true">// preserve order</span>                    å½“é“¾è¡¨ä¸­å­˜åœ¨å€¼æ—¶ï¼Œé€šè¿‡å¾ªç¯è¿›è¡Œå°¾æ’æ³•ï¼ˆjdk1<span class="token number">.7</span>ä¸ºå¤´æ’æ³•ï¼‰                    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> loHead <span class="token operator">=</span> null<span class="token punctuation">,</span> loTail <span class="token operator">=</span> null<span class="token punctuation">;</span>                    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> hiHead <span class="token operator">=</span> null<span class="token punctuation">,</span> hiTail <span class="token operator">=</span> null<span class="token punctuation">;</span>                    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> next<span class="token punctuation">;</span>                    <span class="token keyword">do</span> <span class="token punctuation">{</span>                        next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> oldCap<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">==</span> null<span class="token punctuation">)</span>                                loHead <span class="token operator">=</span> e<span class="token punctuation">;</span>                            <span class="token keyword">else</span>                                loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>                            loTail <span class="token operator">=</span> e<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token keyword">else</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">==</span> null<span class="token punctuation">)</span>                                hiHead <span class="token operator">=</span> e<span class="token punctuation">;</span>                            <span class="token keyword">else</span>                                hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>                            hiTail <span class="token operator">=</span> e<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span>                        newTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> loHead<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span>                        newTab<span class="token punctuation">[</span>j <span class="token operator">+</span> oldCap<span class="token punctuation">]</span> <span class="token operator">=</span> hiHead<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> newTab<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
