<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="ä»å®¢æˆ·ç«¯å‘é€createæ¶ˆæ¯åˆ°èŠ‚ç‚¹åˆ›å»ºï¼Œæºç åˆ†æ, ç–¯ç‹‚å°å‘¨">
    <meta name="description" content="æ‹’ç»åªåš CRUD ï¼">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>ä»å®¢æˆ·ç«¯å‘é€createæ¶ˆæ¯åˆ°èŠ‚ç‚¹åˆ›å»ºï¼Œæºç åˆ†æ | ç–¯ç‹‚å°å‘¨</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">ç–¯ç‹‚å°å‘¨</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>é¦–é¡µ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>æ ‡ç­¾</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>åˆ†ç±»</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>å½’æ¡£</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>å…³äº</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>ç•™è¨€æ¿</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>å‹æƒ…é“¾æ¥</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">ç–¯ç‹‚å°å‘¨</div>
        <div class="logo-desc">
            
            æ‹’ç»åªåš CRUD ï¼
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			é¦–é¡µ
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			æ ‡ç­¾
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			åˆ†ç±»
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			å½’æ¡£
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			å…³äº
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			ç•™è¨€æ¿
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			å‹æƒ…é“¾æ¥
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/zhouxh-z/zhouxh-z.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/zhouxh-z/zhouxh-z.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cef7966384cd4b479514c795fef81857~tplv-k3u1fbpfcp-zoom-crop-mark:1304:1304:1304:734.awebp?')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">ä»å®¢æˆ·ç«¯å‘é€createæ¶ˆæ¯åˆ°èŠ‚ç‚¹åˆ›å»ºï¼Œæºç åˆ†æ</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="container content">

    
    <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/zookeeper/">
                                <span class="chip bg-color">zookeeper</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%BA%90%E7%A0%81%E7%A0%94%E8%AF%BB/" class="post-category">
                                æºç ç ”è¯»
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2021-09-23
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡è¾ƒç¡¬ï¼Œç»“åˆzookeeperæºç é£Ÿç”¨æ›´ä½³å“¦ï¼zookeeper æºç å¯ä»¥ç›´æ¥ä»<a target="_blank" rel="noopener" href="https://github.com/apache/zookeeper">github</a>ä¸‹è½½ç¼–è¯‘ï¼</p>
<p>zookeeper æœ‰ä¸¤ç§é€šä¿¡æ–¹å¼ï¼šnettyã€Nioï¼›æœ¬æ–‡æ˜¯åŸºäº Netty æºç è¿›è¡Œçš„è§£è¯»ï¼</p>
<p>å»ºè®®å…ˆé˜…è¯»<a target="_blank" rel="noopener" href="https://juejin.cn/post/6996844613377982494"># é›†ç¾¤æ¨¡å¼ zookeeper å¯åŠ¨æ—¶åšäº†è¿™äº›äº‹ï¼</a></p>
<h2 id="zk-å’‹ä¿è¯é›†ç¾¤å„å‰¯æœ¬çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ"><a href="#zk-å’‹ä¿è¯é›†ç¾¤å„å‰¯æœ¬çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ" class="headerlink" title="zk å’‹ä¿è¯é›†ç¾¤å„å‰¯æœ¬çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ"></a>zk å’‹ä¿è¯é›†ç¾¤å„å‰¯æœ¬çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ</h2><p>zookeeper åŸºäº <strong>ZAB åè®®</strong> å®ç°äº†ä¸€ç§ä¸»å¤‡æ¨¡å¼çš„ç³»ç»Ÿæ¶æ„æ¥ä¿è¯é›†ç¾¤å„å‰¯æœ¬çš„æ•°æ®ä¸€è‡´æ€§ï¼</p>
<p><strong>ZAB åè®®</strong>ï¼šä¸º Zookeeper ä¸“é—¨è®¾è®¡çš„ä¸€ç§æ”¯æŒ <strong>å´©æºƒæ¢å¤</strong> å’Œ <strong>åŸå­å¹¿æ’­</strong> çš„åè®®ï¼</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c25afebb02a4560a483e2cff4495212~tplv-k3u1fbpfcp-watermark.image" alt="ZAB.png"></p>
<p>å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ°zkæœåŠ¡ç«¯æ—¶ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯å†™å…¥æ•°æ®éƒ½æ˜¯å†™å…¥åˆ°LeaderèŠ‚ç‚¹ï¼ˆå¦‚æœè¯·æ±‚è¢«å‘åˆ° follower èŠ‚ç‚¹ï¼Œä¼šè¢«è½¬å‘åˆ° leader èŠ‚ç‚¹ï¼‰ï¼Œç”±leaderèŠ‚ç‚¹å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šï¼Œä»è€Œä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼›</p>
<p>ä»leaderå¤åˆ¶åˆ°followerçš„è¿‡ç¨‹æœ‰ç‚¹ç±»ä¼¼ ä¸¤é˜¶æ®µæäº¤(2PC)ï¼ŒleaderèŠ‚ç‚¹å‘é€æ•°æ®åŒ…ç»™å…¶ä»–followerèŠ‚ç‚¹ï¼ŒfollowerèŠ‚ç‚¹ç¡®è®¤æ¥æ”¶åè¿”å›ACKï¼Œå¦‚æœfollowè¿”å›çš„ACK + leaderæœ¬èº«çš„ACKï¼Œè¶…è¿‡æ‰€æœ‰æŠ•ç¥¨èŠ‚ç‚¹çš„ä¸€åŠï¼Œè¿™ä¸ªè¯·æ±‚å°±ä¼šè¢«commitï¼Œå¹¶å†™å…¥zkå†…å­˜ä¸­ï¼</p>
<h2 id="zk-åŸå­å¹¿æ’­è¯¦ç»†æµç¨‹"><a href="#zk-åŸå­å¹¿æ’­è¯¦ç»†æµç¨‹" class="headerlink" title="zk åŸå­å¹¿æ’­è¯¦ç»†æµç¨‹"></a>zk <strong>åŸå­å¹¿æ’­</strong>è¯¦ç»†æµç¨‹</h2><p>ZAB åè®®çš„æ¶ˆæ¯å¹¿æ’­è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªåŸå­å¹¿æ’­åè®®ï¼Œç±»ä¼¼ä¸€ä¸ª ä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹<br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a31ea85092640a78d5d31b613f705f6~tplv-k3u1fbpfcp-watermark.image" alt="zk åŸå­å¹¿æ’­.png"></p>
<blockquote>
<p>æºç åˆ†ææ˜¯æŒ‰ä»£ç é¡ºåºåˆ†æçš„ï¼Œã€ã€‘ä¸ºæœ¬æ–‡çš„æºç ç ”è¯»å†…å®¹ç›®å½•ç¼–å·ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡é€»è¾‘è·³è½¬å­¦ä¹ </p>
<ol>
<li>å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯æ—¶ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯å†™å…¥æ•°æ®éƒ½æ˜¯å†™å…¥åˆ°LeaderèŠ‚ç‚¹ï¼ˆå¦‚æœè¯·æ±‚è¢«å‘åˆ° follower èŠ‚ç‚¹ï¼Œä¼šè¢«è½¬å‘åˆ° leader èŠ‚ç‚¹ï¼‰ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼šä¸€ &lt;1ã€2&gt; + 2.2.1 ã€‘  </li>
<li>leader æ¥æ”¶åˆ°è¯·æ±‚ï¼Œå°†è¯·æ±‚å°è£…æˆä¸€ä¸ªäº‹åŠ¡ proposal ï¼Œå¹¶å‘é€ç»™æ‰€æœ‰ follower èŠ‚ç‚¹ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.1.1 + 2.1.2 + 2.1.3&lt;2.1.3.1ã€2.1.3.2&gt;ã€‘</li>
<li>leader å°†æ•°æ®å†™å…¥è‡ªèº«çš„æœ¬åœ°æ–‡ä»¶ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.1.3.3ã€‘</li>
<li>leader ç»™è‡ªå·±è®°ä¸€æ¬¡ACKç¡®è®¤ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.1.3.3ã€‘</li>
<li>follower æ¥æ”¶åˆ° leader å‘é€çš„ proposal åï¼Œå°†æ•°æ®å†™å…¥è‡ªèº«çš„æœ¬åœ°æ–‡ä»¶ä¸­ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.2.1 + 2.2.2 + 2.2.3ã€‘</li>
<li>follower å†™å…¥æˆåŠŸåç»™ leader èŠ‚ç‚¹å‘é€ä¸€ä¸ªACKç¡®è®¤è¯·æ±‚ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.2.5ã€‘</li>
<li>leader æ¥æ”¶åˆ°ACKç¡®è®¤è¯·æ±‚æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦æ”¶åˆ°äº†è¿‡åŠçš„æŠ•ç¥¨èŠ‚ç‚¹ï¼ˆleader+followerï¼‰çš„ACKç¡®è®¤è¯·æ±‚ï¼›å¦‚æœè¿‡åŠï¼Œå‘é€commitè¯·æ±‚ç»™followerèŠ‚ç‚¹ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.1.4ã€‘</li>
<li>leader èŠ‚ç‚¹å°†æ•°æ®å†™å…¥ observer èŠ‚ç‚¹ä¿å­˜ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.1.4ã€‘</li>
<li>leader èŠ‚ç‚¹å°†æ•°æ®å†™å…¥å†…å­˜ä¸­ï¼›<br> ã€æºç ç ”è¯»ç›®å½•ï¼š2.1.4ã€‘</li>
<li>follower èŠ‚ç‚¹æ¥æ”¶åˆ° leader çš„ commit è¯·æ±‚åï¼Œå°†æ•°æ®å†™å…¥å†…å­˜ï¼›<br>ã€æºç ç ”è¯»ç›®å½•ï¼š2.2.2 + 2.2.3ã€‘ï¼›</li>
</ol>
</blockquote>
<h2 id="æµ‹è¯•ç±»"><a href="#æµ‹è¯•ç±»" class="headerlink" title="æµ‹è¯•ç±»"></a>æµ‹è¯•ç±»</h2><p>çŸ¥é“åŸºæœ¬æµç¨‹åï¼Œæˆ‘ä»¬ä»å¦‚ä¸‹å•å…ƒæµ‹è¯•æ–¹æ³•å¼€å§‹åˆ†ææºç ï¼Œçœ‹çœ‹ zookeeper ä»å®¢æˆ·ç«¯å‘é€createæ¶ˆæ¯åˆ°èŠ‚ç‚¹åˆ›å»ºåˆ°åº•æ€ä¹ˆå®ç°çš„ï¼</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException<span class="token punctuation">,</span> KeeperException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    ZooKeeper zk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token number">2183</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    zk<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/foo_2"</span><span class="token punctuation">,</span> <span class="token string">"foobar1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> CreateMode<span class="token punctuation">.</span>PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="ä¸€ã€å®¢æˆ·ç«¯å‘é€è¯·æ±‚"><a href="#ä¸€ã€å®¢æˆ·ç«¯å‘é€è¯·æ±‚" class="headerlink" title="ä¸€ã€å®¢æˆ·ç«¯å‘é€è¯·æ±‚"></a>ä¸€ã€å®¢æˆ·ç«¯å‘é€è¯·æ±‚</h2><h3 id="1-åˆå§‹åŒ–-zk"><a href="#1-åˆå§‹åŒ–-zk" class="headerlink" title="1. åˆå§‹åŒ– zk"></a>1. åˆå§‹åŒ– zk</h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/828efb16094543abac5b863b1671d3f9~tplv-k3u1fbpfcp-watermark.image" alt="zk å®¢æˆ·ç«¯å‘é€æ•°æ®åˆ°æœåŠ¡ç«¯ (1).png"></p>
<pre class=" language-java"><code class="language-java">ZooKeeper zk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token number">2183</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ğŸ‘‡ğŸ‘‡ğŸ‘‡
<span class="token keyword">public</span> <span class="token function">ZooKeeper</span><span class="token punctuation">(</span>Â·Â·Â·Â·<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    cnxn <span class="token operator">=</span> <span class="token function">createConnection</span><span class="token punctuation">(</span>
        connectStringParser<span class="token punctuation">.</span><span class="token function">getChrootPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        hostProvider<span class="token punctuation">,</span>
        sessionTimeout<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clientConfig<span class="token punctuation">,</span>
        watcher<span class="token punctuation">,</span>
        <span class="token function">getClientCnxnSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        canBeReadOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cnxn<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>zookeeper åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡è°ƒç”¨ <strong>createConnection</strong>åˆå§‹åŒ–äº†ä¸€ä¸ª zk è¿æ¥å¯¹è±¡<strong>ClientCnxn</strong><br>ï¼Œ<strong>ClientCnxn</strong>åœ¨åˆå§‹åŒ–æ—¶ new äº†ä¸¤ä¸ªçº¿ç¨‹ï¼ˆSendThreadã€EventThreadï¼‰ï¼›</p>
<p>å¹¶åœ¨ <strong>cnxn.start()</strong> å¯åŠ¨è¿™ä¸¤ä¸ªçº¿ç¨‹ï¼›</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">this</span><span class="token punctuation">.</span>sendThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendThread</span><span class="token punctuation">(</span>clientCnxnSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>eventThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="2-å‘é€è¯·æ±‚"><a href="#2-å‘é€è¯·æ±‚" class="headerlink" title="2. å‘é€è¯·æ±‚"></a>2. å‘é€è¯·æ±‚</h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d76b63fd10f4fbd9f2925e2c85d700e~tplv-k3u1fbpfcp-watermark.image" alt="zk å®¢æˆ·ç«¯å‘é€æ•°æ®åˆ°æœåŠ¡ç«¯.png"> </p>
<p><strong>å‘é€è¿‡ç¨‹</strong></p>
<ol>
<li><p>zookeeper å°†create æ–¹æ³•çš„å‚æ•°å°è£…æˆ <strong>Request</strong> ;</p>
<pre class=" language-java"><code class="language-java">zk<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/foo_2"</span><span class="token punctuation">,</span> <span class="token string">"foobar1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Ids<span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> CreateMode<span class="token punctuation">.</span>PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
ğŸ‘‡ğŸ‘‡ğŸ‘‡
<span class="token keyword">public</span> String <span class="token function">create</span><span class="token punctuation">(</span>Â·Â·Â·<span class="token punctuation">)</span> <span class="token keyword">throws</span> KeeperException<span class="token punctuation">,</span> InterruptedException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// å°è£… CreateRequest</span>
    RequestHeader h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    h<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>createMode<span class="token punctuation">.</span><span class="token function">isContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> ZooDefs<span class="token punctuation">.</span>OpCode<span class="token punctuation">.</span>createContainer <span class="token operator">:</span> ZooDefs<span class="token punctuation">.</span>OpCode<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CreateRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CreateResponse response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>createMode<span class="token punctuation">.</span><span class="token function">toFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>serverPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">setAcl</span><span class="token punctuation">(</span>acl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// é€šè¿‡è¿æ¥å™¨å‘é€ CreateRequest</span>
    ReplyHeader r <span class="token operator">=</span> cnxn<span class="token punctuation">.</span><span class="token function">submitRequest</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cnxn<span class="token punctuation">.</span>chrootPath <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>cnxn<span class="token punctuation">.</span>chrootPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li><p>é€šè¿‡ submitRequest() è°ƒç”¨ queuePacket() å°† Request åŠ å…¥åˆ° <strong>ClientCnxn.outgoingQueue</strong> é˜Ÿåˆ—ä¸­;</p>
</li>
<li><p>å‘ç®¡é“å†™ä¸€ä¸ªå­—èŠ‚ï¼Œä»è€Œå”¤é†’é˜»å¡åœ¨selectorä¸Šçš„çº¿ç¨‹ï¼Œè¯¥å­—èŠ‚åªä¸ºè§¦å‘ netty/nio çš„å†™äº‹ä»¶ï¼Œä»è€Œè®© sendThread() è¯»å–é˜Ÿåˆ—ä¸­çš„æ•°æ®åŒ…ã€zk åº•å±‚ä½¿ç”¨netty/Nioé€šä¿¡ï¼Œå¦‚æœæ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œnetty/Nio ä¼šé˜»å¡åœ¨selectorä¸Šç­‰å¾…äº‹ä»¶å‘ç”Ÿï¼Œæ­¤å¤„å‘é€ä¸€ä¸ªç©ºå­—èŠ‚ï¼Œå°±æ˜¯ä¸ºäº†å”¤é†’netty/Nioçš„selectorã€‘ </p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> ReplyHeader <span class="token function">submitRequest</span><span class="token punctuation">(</span>Â·Â·Â·<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    ReplyHeader r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplyHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Packet packet <span class="token operator">=</span> <span class="token function">queuePacket</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>r<span class="token punctuation">,</span>request<span class="token punctuation">,</span>response<span class="token punctuation">,</span> null<span class="token punctuation">,</span>null<span class="token punctuation">,</span>null<span class="token punctuation">,</span>null<span class="token punctuation">,</span>
        watchRegistration<span class="token punctuation">,</span>watchDeregistration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// çœç•¥éä¸»çº¿ä»£ç </span>
    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
ğŸ‘‡ğŸ‘‡ğŸ‘‡
<span class="token keyword">public</span> Packet <span class="token function">queuePacket</span><span class="token punctuation">(</span>Â·Â·Â·<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    Packet packet <span class="token operator">=</span> null<span class="token punctuation">;</span>
    packet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Packet</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> r<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> watchRegistration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    packet<span class="token punctuation">.</span>cb <span class="token operator">=</span> cb<span class="token punctuation">;</span>
    packet<span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
    packet<span class="token punctuation">.</span>clientPath <span class="token operator">=</span> clientPath<span class="token punctuation">;</span>
    packet<span class="token punctuation">.</span>serverPath <span class="token operator">=</span> serverPath<span class="token punctuation">;</span>
    packet<span class="token punctuation">.</span>watchDeregistration <span class="token operator">=</span> watchDeregistration<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†ä»£ç  </span>
        <span class="token comment" spellcheck="true">// å°† Request åŠ å…¥åˆ° outgoingQueue é˜Ÿåˆ—ä¸­;</span>
       outgoingQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// å‘channel ä¸­å†™ä¸€ä¸ªç©ºå­—èŠ‚ï¼Œå”¤é†’ SendThread ä¸­çš„ selector</span>
    sendThread<span class="token punctuation">.</span><span class="token function">getClientCnxnSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">packetAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> packet<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li><p>zookeeper åˆå§‹åŒ–ä¸­ç”Ÿæˆçš„ <strong>SendThread</strong> çº¿ç¨‹ä¼šä»è¿™ä¸ªé˜Ÿåˆ—ä¸­è¯»å– Request å‘é€åˆ°æœåŠ¡ç«¯ï¼›</p>
<p> SendThread.run() æ–¹æ³•ä¸­æœ‰æ¯”è¾ƒå¤šçš„åˆ†æ”¯ä»£ç ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹è¿™ä¸¤ä¸ªå…³é”®æ–¹æ³•ï¼›</p>
<pre class=" language-java"><code class="language-java">clientCnxnSocket<span class="token punctuation">.</span><span class="token function">introduce</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> sessionId<span class="token punctuation">,</span> outgoingQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
clientCnxnSocket<span class="token punctuation">.</span><span class="token function">doTransport</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> pendingQueue<span class="token punctuation">,</span> ClientCnxn<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p> åœ¨<strong>2</strong>ä¸­æˆ‘ä»¬å‘é€çš„è¯·æ±‚è¢«åŠ å…¥åˆ° <strong>outgoingQueue</strong> é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ—¶å±äº ClientCnxn å¯¹è±¡ï¼›<br>  introduce æ–¹æ³•å°†è¿™ä¸ªé˜Ÿåˆ—èµ‹å€¼ç»™ clientCnxnSocketï¼Œä»¥ä¾¿åç»­åœ¨ doTransport æ–¹æ³•ä¸­è°ƒç”¨ï¼›</p>
<pre class=" language-java"><code class="language-java">clientCnxnSocket<span class="token punctuation">.</span><span class="token function">introduce</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> sessionId<span class="token punctuation">,</span> outgoingQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
ğŸ‘‡ğŸ‘‡ğŸ‘‡
<span class="token keyword">void</span> <span class="token function">introduce</span><span class="token punctuation">(</span>ClientCnxn<span class="token punctuation">.</span>SendThread sendThread<span class="token punctuation">,</span> <span class="token keyword">long</span> sessionId<span class="token punctuation">,</span> LinkedBlockingDeque<span class="token operator">&lt;</span>Packet<span class="token operator">></span> outgoingQueue<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sendThread <span class="token operator">=</span> sendThread<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sessionId <span class="token operator">=</span> sessionId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>outgoingQueue <span class="token operator">=</span> outgoingQueue<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p> doTransport æ–¹æ³•ï¼Œæ˜¯çœŸæ­£å°†è¯·æ±‚é€šè¿‡ Netty/NIO å†™ç»™æœåŠ¡ç«¯çš„æ–¹æ³•ï¼›ï¼ˆä»¥ä¸‹æ˜¯ClientCnxnSocketNettyæºç ï¼‰</p>
<pre class=" language-java"><code class="language-java">clientCnxnSocket<span class="token punctuation">.</span><span class="token function">doTransport</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> pendingQueue<span class="token punctuation">,</span> ClientCnxn<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ğŸ‘‡ğŸ‘‡ğŸ‘‡
<span class="token keyword">void</span> <span class="token function">doTransport</span><span class="token punctuation">(</span><span class="token keyword">int</span> waitTimeOut<span class="token punctuation">,</span>Queue<span class="token operator">&lt;</span>Packet<span class="token operator">></span> pendingQueue<span class="token punctuation">,</span>ClientCnxn cnxn<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// çœç•¥éä¸»çº¿ä»£ç </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>head <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">doWrite</span><span class="token punctuation">(</span>pendingQueue<span class="token punctuation">,</span> head<span class="token punctuation">,</span> cnxn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">finally</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">updateNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
ğŸ‘‡ğŸ‘‡ğŸ‘‡
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span>Queue<span class="token operator">&lt;</span>Packet<span class="token operator">></span> pendingQueue<span class="token punctuation">,</span> Packet p<span class="token punctuation">,</span> ClientCnxn cnxn<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">updateNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> anyPacketsSent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> WakeupPacket<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>requestHeader <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ZooDefs<span class="token punctuation">.</span>OpCode<span class="token punctuation">.</span>ping<span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ZooDefs<span class="token punctuation">.</span>OpCode<span class="token punctuation">.</span>auth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ç»™è¯·æ±‚è®¾ç½® Xid</span>
                p<span class="token punctuation">.</span>requestHeader<span class="token punctuation">.</span><span class="token function">setXid</span><span class="token punctuation">(</span>cnxn<span class="token punctuation">.</span><span class="token function">getXid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>pendingQueue<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    pendingQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å‘é€è¯·æ±‚</span>
            <span class="token function">sendPktOnly</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            anyPacketsSent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p> æœ€ç»ˆé€šè¿‡Nettyçš„ channel å°†æ•°æ®å‘é€åˆ°å®¢æˆ·ç«¯<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/15a667bde76f4911b98ff03445c5452d~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
</li>
</ol>
<h2 id="äºŒã€æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚"><a href="#äºŒã€æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚" class="headerlink" title="äºŒã€æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚"></a>äºŒã€æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚</h2><h3 id="1-å¦‚ä½•æ¥æ”¶è¯·æ±‚ï¼Ÿ"><a href="#1-å¦‚ä½•æ¥æ”¶è¯·æ±‚ï¼Ÿ" class="headerlink" title="1. å¦‚ä½•æ¥æ”¶è¯·æ±‚ï¼Ÿ"></a>1. å¦‚ä½•æ¥æ”¶è¯·æ±‚ï¼Ÿ</h3><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fcefe84b37d84d6ea14afbdcdca29829~tplv-k3u1fbpfcp-watermark.image" alt="æœåŠ¡ç«¯æ¥æ”¶æ¶ˆæ¯.png"><br>åœ¨<a target="_blank" rel="noopener" href="https://juejin.cn/post/6996844613377982494"># é›†ç¾¤æ¨¡å¼ zookeeper å¯åŠ¨æ—¶åšäº†è¿™äº›äº‹ï¼</a>è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è¯´è¿‡ zookeeper æœåŠ¡ç«¯åœ¨å¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ–å¹¶å¯åŠ¨äº†ä¸€ä¸ªNettyæœåŠ¡å™¨ã€NettyServerCnxnFactoryã€‘ï¼Œç”¨äºæ¥æ”¶å®¢æˆ·ç«¯/å…¶ä»–èŠ‚ç‚¹çš„è¯·æ±‚ã€Netty å¤„ç†è¯·æ±‚ç±»ï¼šCnxnChannelHandlerã€‘</p>
<ol>
<li>zkå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼Œé€šè¿‡æœåŠ¡ç«¯ CnxnChannelHandler.channelRead() æ–¹æ³•ï¼Œé€šè¿‡cnxn.processMessage((ByteBuf) msg) â†’ receiveMessage(buf) â†’ zks.processPacket(this, bb) â†’ submitRequest(si) â†’ enqueueRequest(si) â†’ requestThrottler.submitRequest(si);<br> ä»¥ä¸Šè¿™æ®µä»£ç ä¸»è¦æ˜¯å¯¹requestçš„è§£æå¹¶æ²¡æœ‰è¿‡äºå¤æ‚çš„é€»è¾‘ï¼Œè¿™è¾¹åªåšè®°å½•å°±ä¸èµ˜è¿°äº†ï¼›</li>
<li>æœåŠ¡ç«¯è·å–è¯·æ±‚ä¹‹åï¼Œä¼šé€šè¿‡ requestThrottler.submitRequest(si) æ–¹æ³•å°†è§£æå‡ºæ¥çš„è¯·æ±‚åŠ å…¥åˆ° RequestThrottler.<strong>submittedRequests</strong> ;<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submitRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stopping<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Shutdown in progress. Request cannot be processed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dropRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>requestThrottleQueueTime <span class="token operator">=</span> Time<span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        submittedRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li>RequestThrottler çº¿ç¨‹çš„ run æ–¹æ³•ä¼šä»<strong>2</strong>ä¸­è®¾ç½®çš„<strong>submittedRequests</strong>é˜Ÿåˆ—ä¸­è·å–è¯·æ±‚ï¼Œå¹¶é€šè¿‡<strong>submitRequestNow</strong>æ–¹æ³•ï¼Œå°†è¯·æ±‚æäº¤ç»™zkè¯·æ±‚å¤„ç†è´£ä»»é“¾<strong>RequestProcessor</strong> <strong>RequestThrottler çº¿ç¨‹</strong>ï¼šzkæœåŠ¡ç«¯åœ¨é€‰ä¸¾å®Œ leader ä¹‹åï¼Œleader / followerèŠ‚ç‚¹ åˆ†åˆ«åœ¨ leader.lead() / follower.followLeader()æ–¹æ³•ä¸­è°ƒç”¨ <strong>zk.startup()</strong> å®ä¾‹åŒ–å¹¶å¯åŠ¨ RequestThrottler çº¿ç¨‹ï¼›<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// çœç•¥éä¸»çº¿ä»£ç </span>
            Request request <span class="token operator">=</span> submittedRequests<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// çœç•¥éä¸»çº¿ä»£ç </span>
                zks<span class="token punctuation">.</span><span class="token function">submitRequestNow</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
</li>
</ol>
<h3 id="2-å¦‚ä½•å¤„ç†è¯·æ±‚ï¼Ÿ"><a href="#2-å¦‚ä½•å¤„ç†è¯·æ±‚ï¼Ÿ" class="headerlink" title="2. å¦‚ä½•å¤„ç†è¯·æ±‚ï¼Ÿ"></a>2. å¦‚ä½•å¤„ç†è¯·æ±‚ï¼Ÿ</h3><p>zookeeper åœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå°†è¯·æ±‚æäº¤åˆ°è´£ä»»é“¾<strong>RequestProcessor</strong>å¤„ç†ï¼›ä¸”ä¸åŒå±æ€§çš„èŠ‚ç‚¹ï¼ˆleader/followerï¼‰å®ä¾‹åŒ–äº†ä¸åŒçš„è´£ä»»é“¾ï¼›</p>
<p>zkæœåŠ¡ç«¯åœ¨é€‰ä¸¾å®Œ leader ä¹‹åï¼Œleader / followerèŠ‚ç‚¹ åˆ†åˆ«åœ¨ leader.lead() / follower.followLeader()æ–¹æ³•ä¸­è°ƒç”¨ **zk.startup()**ï¼Œstartup()è°ƒç”¨äº† ZooKeeperServer.<strong>setupRequestProcessors()</strong> ;</p>
<p>ZooKeeperServer æ ¹æ®èŠ‚ç‚¹ä¸åŒå­˜åœ¨ä¸åŒå®ç°ï¼›<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af0c23ac63884364b7505bd55bc10e3f~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<h4 id="2-1-leader-èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ"><a href="#2-1-leader-èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ" class="headerlink" title="2.1_ leader èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ"></a>2.1_ leader èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ</h4><pre class=" language-java"><code class="language-java">LeaderZooKeeperServer
ğŸ‘‡ğŸ‘‡ğŸ‘‡
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    RequestProcessor finalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RequestProcessor toBeAppliedProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Leader<span class="token punctuation">.</span>ToBeAppliedRequestProcessor</span><span class="token punctuation">(</span>finalProcessor<span class="token punctuation">,</span> <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    commitProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitProcessor</span><span class="token punctuation">(</span>toBeAppliedProcessor<span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function">getZooKeeperServerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    commitProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ProposalRequestProcessor proposalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProposalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> commitProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    proposalProcessor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    prepRequestProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrepRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> proposalProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    prepRequestProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    firstProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LeaderRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> prepRequestProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setupContainerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5fbe40ed919e4fe7ab504cdd8be71d8b~tplv-k3u1fbpfcp-watermark.image" alt="leaderè´£ä»»é“¾.png"></p>
<p>leader èŠ‚ç‚¹æ„å»ºäº†ä»¥ä¸Šè´£ä»»é“¾ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è´£ä»»é“¾çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½åšäº†ä»€ä¹ˆï¼›</p>
<h5 id="2-1-1-LeaderRequestProcessor"><a href="#2-1-1-LeaderRequestProcessor" class="headerlink" title="2.1.1_ LeaderRequestProcessor"></a>2.1.1_ LeaderRequestProcessor</h5><p>LeaderRequestProcessor çš„ä»»åŠ¡æ¯”è¾ƒç®€å•ï¼š</p>
<ol>
<li><p>åˆ¤æ–­è¯·æ±‚ä¼šè¯æ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸçš„è¯æŠ›å‡ºå¼‚å¸¸ï¼›</p>
</li>
<li><p>è°ƒç”¨è´£ä»»é“¾çš„ä¸‹ä¸€ä¸ªæ–¹æ³•ï¼›</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RequestProcessorException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lzks<span class="token punctuation">.</span><span class="token function">authWriteRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
 Request upgradeRequest <span class="token operator">=</span> null<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
     upgradeRequest <span class="token operator">=</span> lzks<span class="token punctuation">.</span><span class="token function">checkUpgradeSession</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> ke<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
 <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ie<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradeRequest <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
     nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>upgradeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

 nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="2-1-2-PrepRequestProcessor"><a href="#2-1-2-PrepRequestProcessor" class="headerlink" title="2.1.2_ PrepRequestProcessor"></a>2.1.2_ PrepRequestProcessor</h5><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/157ddcc8c9c240589caf10b7a6a20b1c~tplv-k3u1fbpfcp-watermark.image" alt="æœªå‘½åæ–‡ä»¶ (2).png"><br>è´£ä»»é“¾çš„ processRequest æ–¹æ³•ï¼Œåªæ˜¯å°†è¯·æ±‚åŠ å…¥åˆ° submittedRequests é˜Ÿåˆ—ä¸­ï¼›</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
 request<span class="token punctuation">.</span>prepQueueStartTime <span class="token operator">=</span> Time<span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 submittedRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 ServerMetrics<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>PREP_PROCESSOR_QUEUED<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>ä½†æ˜¯PrepRequestProcessor æœ¬è´¨æ˜¯ä¸€ä¸ª Threadï¼Œåœ¨åˆ›å»ºè´£ä»»é“¾æ—¶ï¼Œå¯åŠ¨äº†è¯¥çº¿ç¨‹ï¼›</p>
</li>
</ol>
<p>PrepRequestProcessor.run() å°†ä» submittedRequests é˜Ÿåˆ—ä¸­è·å–è¯·æ±‚å¹¶å¤„ç†ï¼›</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// çœç•¥äº†éƒ¨åˆ†éä¸»çº¿ä»£ç </span>
            Request request <span class="token operator">=</span> submittedRequests<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span>prepStartTime <span class="token operator">=</span> Time<span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
ğŸ‘‡ğŸ‘‡ğŸ‘‡
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">pRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RequestProcessorException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">setHdr</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">setTxn</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">isThrottled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// æ ¹æ®è¯·æ±‚ç±»å‹çš„ä¸åŒï¼ˆcreate/delete/updateï¼‰ï¼Œå¯¹è¯·æ±‚è¿›è¡Œå°è£…å’Œç‰¹æ®Šå¤„ç†</span>
      <span class="token comment" spellcheck="true">// æœ€ç»ˆå°†è¯·æ±‚æ”¾å…¥zks.outstandingChanges</span>
      <span class="token function">pRequestHelper</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ç»™è¯·æ±‚è®¾ç½®ä¸€ä¸ª zxid </span>
    request<span class="token punctuation">.</span>zxid <span class="token operator">=</span> zks<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// è°ƒç”¨ä¸‹ä¸€ä¸ªæ¥å£</span>
    nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>pRequestHelperï¼š</p>
<ol>
<li>æ ¹æ®è¯·æ±‚ç±»å‹çš„ä¸åŒï¼ˆcreate/delete/updateï¼‰ï¼Œå¯¹è¯·æ±‚è¿›è¡Œå°è£…</li>
<li>æ ¡éªŒè¯·æ±‚æ˜¯å¦åˆç†ï¼šæœªå®šä¹‰çš„è¯·æ±‚ã€å‚æ•°ä¸åˆç†</li>
<li>æ£€æŸ¥ä¸Šçº§è·¯å¾„æ˜¯å¦å­˜åœ¨</li>
<li>æ£€æŸ¥ACL</li>
<li> æ£€æŸ¥è·¯å¾„æ˜¯å¦åˆæ³•</li>
<li> å°†è¯·æ±‚è£…å…¥ <strong>outstandingChanges</strong> é˜Ÿåˆ—<br>ç„¶åç»™è¯·æ±‚è®¾ç½®Zxidï¼Œå¹¶è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨<h5 id="2-1-3-proposalProcessor-ï¼ˆé‡ç‚¹-ï¼‰"><a href="#2-1-3-proposalProcessor-ï¼ˆé‡ç‚¹-ï¼‰" class="headerlink" title="2.1.3_ proposalProcessor ï¼ˆé‡ç‚¹*ï¼‰"></a>2.1.3_ proposalProcessor ï¼ˆé‡ç‚¹*ï¼‰</h5>è¿™ä¸ªå¤„ç†å™¨æ˜¯zookeeperæ•°æ®æ–‡ä»¶åŒæ­¥å’Œæœ¬åœ°äº‹åŠ¡å†™å…¥çš„å…³é”®ï¼ˆå¯ä»¥ç†è§£ä¸ºä¸¤é˜¶æ®µæäº¤çš„ç¬¬ä¸€é˜¶æ®µï¼‰<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/202884eb804740a0847b0b1ba4cadb75~tplv-k3u1fbpfcp-watermark.image" alt="ProposalRequestProcessor (2).png"></li>
<li>è°ƒç”¨è´£ä»»é“¾çš„ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼›</li>
<li>é€šè¿‡ LearnerHandler å°†è¯·æ±‚å‘é€åˆ° follower èŠ‚ç‚¹</li>
<li>å¯ç”¨ SyncRequestProcessor -&gt; AckRequestProcessor è´£ä»»é“¾å°†æ•°æ®å†™å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶åˆ¤æ–­æ˜¯å¦åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹è¿”å›ACKç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æœè¶…è¿‡åŠæ•°ï¼Œåˆ™æäº¤æ•°æ®å†™å…¥å†…å­˜ï¼›</li>
</ol>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RequestProcessorException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦æ˜¯leaderçš„åŒæ­¥è¯·æ±‚</span>
    <span class="token comment" spellcheck="true">// ç”±äºæœ¬æ¬¡æˆ‘ä»¬å®¢æˆ·ç«¯ç›´æ¥å‘é€æ¶ˆæ¯åˆ°leaderèŠ‚ç‚¹ï¼Œ</span>
    <span class="token comment" spellcheck="true">// æ‰€ä»¥ request instanceof LearnerSyncRequest = falseï¼›</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token keyword">instanceof</span> <span class="token class-name">LearnerSyncRequest</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        zks<span class="token punctuation">.</span><span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LearnerSyncRequest<span class="token punctuation">)</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ˜¯å¦éœ€è¦è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldForwardToNextProcessor</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getHdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¤„ç†è¯·æ±‚</span>
                zks<span class="token punctuation">.</span><span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">propose</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XidRolloverException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å†™æœ¬åœ°æ–‡ä»¶åŒæ­¥</span>
            syncProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h6 id="2-1-3-1-shouldForwardToNextProcessor-request"><a href="#2-1-3-1-shouldForwardToNextProcessor-request" class="headerlink" title="2.1.3.1_ shouldForwardToNextProcessor(request)"></a>2.1.3.1_ shouldForwardToNextProcessor(request)</h6><p>shouldForwardToNextProcessor(request) é»˜è®¤æƒ…å†µä¸‹ä¸ºtrueï¼›</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// forwardLearnerRequestsToCommitProcessorDisabled é»˜è®¤ä¸ºfalseï¼Œ </span>
<span class="token comment" spellcheck="true">// éœ€è¦é…ç½® zookeeper.forward_learner_requests_to_commit_processor_disabled = true æ‰èƒ½æ›´æ”¹</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">shouldForwardToNextProcessor</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forwardLearnerRequestsToCommitProcessorDisabled<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">LearnerHandler</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        ServerMetrics<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>REQUESTS_NOT_FORWARDED_TO_COMMIT_PROCESSOR<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>nextProcessor.processRequest(request)è°ƒç”¨ä¸‹ä¸€ä¸ª CommitProcessor å¤„ç†å™¨ï¼›</p>
<h6 id="2-1-3-2-zks-getLeader-propose-request"><a href="#2-1-3-2-zks-getLeader-propose-request" class="headerlink" title="2.1.3.2_ zks.getLeader().propose(request);"></a>2.1.3.2_ zks.getLeader().propose(request);</h6><p>é€šè¿‡ LearnerHandler å°†è¯·æ±‚å‘é€åˆ° follower èŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†è¯·æ±‚åŠ å…¥åˆ° outstandingProposals é˜Ÿåˆ—ä¸­ï¼›</p>
<ul>
<li><p>å°†è¯·æ±‚å°è£…æˆ QuorumPacketï¼Œå¹¶é€šè¿‡å¾ªç¯å°†è¯·æ±‚å‘é€åˆ° LearnerHandler.queuedPackets é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†ï¼› </p>
<p>  å¹¶å°†è¯·æ±‚åŠ å…¥åˆ° outstandingProposals é˜Ÿåˆ—ä¸­</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Proposal <span class="token function">propose</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> XidRolloverException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> SerializeUtils<span class="token punctuation">.</span><span class="token function">serializeRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  proposalStats<span class="token punctuation">.</span><span class="token function">setLastBufferSize</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  QuorumPacket pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span>Leader<span class="token punctuation">.</span>PROPOSAL<span class="token punctuation">,</span> request<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> data<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Proposal p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proposal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token punctuation">.</span>packet <span class="token operator">=</span> pp<span class="token punctuation">;</span>
  p<span class="token punctuation">.</span>request <span class="token operator">=</span> request<span class="token punctuation">;</span>

  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      p<span class="token punctuation">.</span><span class="token function">addQuorumVerifier</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// çœç•¥éƒ¨åˆ†éä¸»çº¿ä»£ç </span>
      lastProposed <span class="token operator">=</span> p<span class="token punctuation">.</span>packet<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      outstandingProposals<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lastProposed<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">sendPacket</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
ğŸ‘‡ğŸ‘‡ğŸ‘‡
<span class="token keyword">void</span> <span class="token function">sendPacket</span><span class="token punctuation">(</span>QuorumPacket qp<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>forwardingFollowers<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>LearnerHandler f <span class="token operator">:</span> forwardingFollowers<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
          f<span class="token punctuation">.</span><span class="token function">queuePacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
ğŸ‘‡ğŸ‘‡ğŸ‘‡
<span class="token keyword">void</span> <span class="token function">queuePacket</span><span class="token punctuation">(</span>QuorumPacket p<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  queuedPackets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li><p>LearnerHandler æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼ŒLearnerHandler.run() æ–¹æ³•ä¸­è°ƒç”¨äº† startSendingPackets() å°†æ•°æ®ä» LearnerHandler.queuedPackets é˜Ÿåˆ—å–å‡ºï¼Œå¹¶å‘é€åˆ° follower èŠ‚ç‚¹ï¼›<br>``` java<br>protected void startSendingPackets() {<br>  if (!sendingThreadStarted) {</p>
<pre><code>  new Thread() &#123;
      public void run() &#123;
          try &#123;
              // å‘é€è¯·æ±‚æ•°æ®åŒ…åˆ°followerèŠ‚ç‚¹
              sendPackets();
          &#125; catch (InterruptedException e) &#123;&#125;
      &#125;
  &#125;.start();
  sendingThreadStarted = true;
</code></pre>
<p>  }<br>}<br>ğŸ‘‡ğŸ‘‡ğŸ‘‡<br>private void sendPackets() throws InterruptedException {<br>  while (true) {</p>
<pre><code>  try &#123;
      QuorumPacket p;
      p = queuedPackets.poll();
      if (p == null) &#123;
          bufferedOutput.flush();
          p = queuedPackets.take();
      &#125;
      if (p.getType() == Leader.PROPOSAL) &#123;
          syncLimitCheck.updateProposal(p.getZxid(), System.nanoTime());
      &#125;
      // çœç•¥éƒ¨åˆ†éä¸»çº¿ä»£ç 
      if (p.getZxid() &gt; 0) &#123;
          lastZxid = p.getZxid();
      &#125;
      oa.writeRecord(p, &quot;packet&quot;);
      packetsSent.incrementAndGet();
      messageTracker.trackSent(p.getType());
  &#125; catch (IOException e) &#123;&#125;
</code></pre>
<p>  }<br>}</p>
</li>
</ul>
<pre><code>###### 2.1.3.3 syncProcessor.processRequest(request);  
å¯ç”¨ SyncRequestProcessor -&gt; AckRequestProcessor è´£ä»»é“¾ï¼›
- SyncRequestProcessor å°†æ•°æ®å†™å…¥æ–‡ä»¶ç³»ç»Ÿï¼›
  - processRequest æ–¹æ³•å°†è¯·æ±‚å†™å…¥åˆ° queuedRequests é˜Ÿåˆ—ä¸­
    ``` java
    public void processRequest(final Request request) &#123;
    queuedRequests.add(request);
    &#125;
    ```
  - SyncRequestProcessor.run(); 
            
    zks.getZKDatabase().append(si) å°†æ•°æ®å†™å…¥å¿«ç…§å¯¹è±¡ï¼› 
    
    zks.takeSnapshot() å°†æ•°æ®åºåˆ—åŒ–åˆ°zkåº•å±‚çš„DataTreeå¯¹è±¡ä¸­ï¼›  
    
    flush() ä¸­æœ‰ä¸ªcommitæ–¹æ³•ï¼ŒçœŸæ­£å°†æ•°æ®å†™å…¥æ–‡ä»¶ï¼›ç„¶åè°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨ AckRequestProcessorï¼›
    ``` java
    // çœç•¥å¤§é‡éä¸»çº¿ä»£ç 
    public void run() &#123;
        try &#123;
            while (true) &#123;
                Request si = queuedRequests.poll(pollTime, TimeUnit.MILLISECONDS);
                // zks.getZKDatabase().append(si) æŠŠè¯·æ±‚append åˆ°å¿«ç…§å¯¹è±¡ä¸­
                if (!si.isThrottled() &amp;&amp; zks.getZKDatabase().append(si)) &#123;
                    if (shouldSnapshot()) &#123;
                        resetSnapshotStats();
                        zks.getZKDatabase().rollLog();
                        if (!snapThreadMutex.tryAcquire()) &#123;
                        &#125; else &#123;
                            new ZooKeeperThread(&quot;Snapshot Thread&quot;) &#123;
                                public void run() &#123;
                                    try &#123;
                                        // è¿™é‡Œå°†æ•°æ®åºåˆ—åŒ–åˆ°zkåº•å±‚çš„DataTreeå¯¹è±¡ä¸­
                                        zks.takeSnapshot();
                                    &#125; catch (Exception e) &#123;
                                        LOG.warn(&quot;Unexpected exception&quot;, e);
                                    &#125; finally &#123;
                                        snapThreadMutex.release();
                                    &#125;
                                &#125;
                            &#125;.start();
                        &#125;
                    &#125;
                &#125;
                toFlush.add(si);
                if (shouldFlush()) &#123;
                    flush();
                &#125;
            &#125;
        &#125;
    &#125;
    ğŸ‘‡ğŸ‘‡ğŸ‘‡
    private void flush() throws IOException, RequestProcessorException &#123;
        // æäº¤å†™å¿«ç…§æ–‡ä»¶
        zks.getZKDatabase().commit();
        if (this.nextProcessor == null) &#123;
            this.toFlush.clear();
        &#125; else &#123;
            while (!this.toFlush.isEmpty()) &#123;
                final Request i = this.toFlush.remove();
                this.nextProcessor.processRequest(i);
            &#125;
            if (this.nextProcessor instanceof Flushable) &#123;
                ((Flushable) this.nextProcessor).flush();
            &#125;
        &#125;
    &#125;
    ```
- AckRequestProcessor åˆ¤æ–­æ˜¯å¦åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹è¿”å›ACKç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æœè¶…è¿‡åŠæ•°ï¼Œåˆ™æäº¤æ•°æ®å†™å…¥å†…å­˜
    ``` java
    public void processRequest(Request request) &#123;
        QuorumPeer self = leader.self;
        if (self != null) &#123;
            leader.processAck(self.getId(), request.zxid, null);
        &#125; else &#123;&#125;
    &#125;
    ```
    ä»è¿‡ç¨‹ **2** è®¾ç½®çš„ outstandingProposals ä¸­è·å–è¯·æ±‚ï¼Œå°è¯•æäº¤ï¼› 
    
    åˆ¤æ–­æ”¶åˆ°çš„ACKæ¶ˆæ¯æ˜¯å¦è¶…è¿‡é›†ç¾¤èŠ‚ç‚¹çš„ä¸€åŠï¼›  
    
    å¦‚æœè¶…è¿‡ä¸€åŠåˆ™æäº¤ï¼›
    ``` java
    public synchronized void processAck(long sid, long zxid, SocketAddress followerAddr) &#123;
        Proposal p = outstandingProposals.get(zxid);
        p.addAck(sid);
        // å°è¯•æäº¤
        boolean hasCommitted = tryToCommit(p, zxid, followerAddr);
        if (hasCommitted &amp;&amp; p.request != null &amp;&amp; p.request.getHdr().getType() == OpCode.reconfig) &#123;
            long curZxid = zxid;
            while (allowedToCommit &amp;&amp; hasCommitted &amp;&amp; p != null) &#123;
                curZxid++;
                p = outstandingProposals.get(curZxid);
                if (p != null) &#123;
                    hasCommitted = tryToCommit(p, curZxid, null);
                &#125;
            &#125;
        &#125;
    &#125;
    ğŸ‘‡ğŸ‘‡ğŸ‘‡
    public synchronized boolean tryToCommit(Proposal p, long zxid, SocketAddress followerAddr) &#123;
        // åˆ¤æ–­æ”¶åˆ°çš„ACKæ¶ˆæ¯æ˜¯å¦è¶…è¿‡é›†ç¾¤èŠ‚ç‚¹çš„ä¸€åŠ
        // ç”±äºfollowerèŠ‚ç‚¹è¿˜æ²¡æœ‰è¿”å›ACKæ¶ˆæ¯æ‰€ä»¥æ­¤å¤„ç›´æ¥è¿”å›ï¼›
        if (!p.hasAllQuorums()) &#123;
            return false;
        &#125;
        outstandingProposals.remove(zxid);
        if (p.request != null) &#123;
            toBeApplied.add(p);
        &#125;
        if (p.request == null) &#123;
        &#125; else if (p.request.getHdr().getType() == OpCode.reconfig) &#123;
            // çœç•¥éƒ¨åˆ†éæœ¬æ¬¡ä¸»çº¿ä»£ç 
        &#125; else &#123;
            p.request.logLatency(ServerMetrics.getMetrics().QUORUM_ACK_LATENCY);
            commit(zxid);
            inform(p);
        &#125;
        // å°†è¯·æ±‚å‘é€åˆ° commitProcessor çš„ committedRequests é˜Ÿåˆ—ä¸­ï¼›
        zk.commitProcessor.commit(p.request);
        return true;
    &#125;
    ```
    æ­¤æ—¶ç”±äº follower èŠ‚ç‚¹æ”¶åˆ° proposal è¯·æ±‚ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è¿”å›ACKæ¶ˆæ¯ï¼Œæ‰€ä»¥ tryToCommit è¿”å›falseï¼›è¿™è¾¹é€»è¾‘ä¹Ÿå°±ç»“æŸäº†ï¼›ç­‰å¾… follower èŠ‚ç‚¹è¿”å›ACKåä¼šå†æ¬¡è°ƒç”¨è¯¥æ–¹æ³•ï¼›
    
    å¦‚æœ follower èŠ‚ç‚¹+ leader èŠ‚ç‚¹ è¶…è¿‡åŠæ•°ï¼Œåˆ™ p.hasAllQuorums() = trueï¼Œåç»­é€»è¾‘ç»§ç»­æ‰§è¡Œï¼Œæˆ‘ä»¬å‘é€çš„æ˜¯create è¯·æ±‚ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œ **commit(zxid); inform(p)** ä»¥åŠ zk.commitProcessor.commit(p.request)ï¼›  
        
    commit(zxid)ï¼šleader ä¼šå‘é€ä¸€ä¸ª commit è¯·æ±‚ï¼Œæºå¸¦zxidï¼Œåˆ° follower èŠ‚ç‚¹ï¼ŒfollowerèŠ‚ç‚¹æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œä¼šå°†ä¹‹å‰åœ¨**2. zks.getLeader().propose(request);** ä¸­ leader å‘é€ç»™ follower èŠ‚ç‚¹çš„æ•°æ®å†™å…¥åˆ°è‡ªå·±çš„å†…å­˜ä¸­ï¼ˆè¯¥é€»è¾‘åœ¨åç»­followerèŠ‚ç‚¹å¤„ç†è¿‡ç¨‹ä¸­ä¼šè®²åˆ°ï¼‰
    ``` java
    public void commit(long zxid) &#123;
        synchronized (this) &#123;
            lastCommitted = zxid;
        &#125;
        QuorumPacket qp = new QuorumPacket(Leader.COMMIT, zxid, null, null);
        sendPacket(qp);
        ServerMetrics.getMetrics().COMMIT_COUNT.add(1);
    &#125;
    ```
    inform(p)ï¼šä¼šå°†è¯·æ±‚å‘é€åˆ°obseverèŠ‚ç‚¹ä¿å­˜èµ·æ¥ï¼›
    ``` java
    public void inform(Proposal proposal) &#123;
        QuorumPacket qp = new QuorumPacket(Leader.INFORM, proposal.request.zxid, 
            proposal.packet.getData(), null);
        sendObserverPacket(qp);
    &#125;
    ```
    zk.commitProcessor.commit(p.request)ï¼šå°†è¯·æ±‚å‘é€åˆ° commitProcessor çš„ committedRequests é˜Ÿåˆ—ä¸­ï¼›è¯¥é˜Ÿåˆ—ä¼šåœ¨ commitProcessorçš„ run æ–¹æ³•ä¸­æ¶ˆè´¹ï¼›
##### 2.1.4_ CommitProcessor 
![CommitProcessor.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44bb14257b874e4786b18dea617dad4b~tplv-k3u1fbpfcp-watermark.image?)
æ€»çš„æ¥è¯´ CommitProcessor åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼ŒCommitProcessor æ¥æ”¶åˆ° leader è®¤ä¸ºå¯ä»¥æäº¤çš„è¯·æ±‚ï¼Œå°†è¯·æ±‚è¿›è¡Œç®€å•å¤„ç†åï¼Œè½¬å‘ç»™ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼›

ä½†æ˜¯ç”±äº zk è¿½æ±‚æ•ˆç‡ï¼Œä»£ç ä¸­å­˜åœ¨å¤§é‡çš„çº¿ç¨‹å’Œé˜Ÿåˆ—ï¼Œå¯¼è‡´æ¯”è¾ƒéš¾è¯»ï¼›

1. LearnerHandler çº¿ç¨‹çš„ run æ–¹æ³• ä¸­å­˜åœ¨ä¸€ä¸ªæ­»å¾ªç¯ï¼Œæ— é™ç­‰å¾…æ¥æ”¶ SendAckRequestProcessor å‘é€çš„ ACK æ¶ˆæ¯ï¼›

   å½“æ¥æ”¶åˆ° ACK è¯·æ±‚æ—¶ï¼Œä¼šè°ƒç”¨ processAck()ï¼› åç»­é€»è¾‘ä¸ **2.1.3.3** ä¸­çš„ AckRequestProcessor å¤„ç†å™¨ç›¸åŒï¼›
    ``` java
    while (true) &#123;
        qp = new QuorumPacket();
        ia.readRecord(qp, &quot;packet&quot;);
        messageTracker.trackReceived(qp.getType());
        ByteBuffer bb;
        long sessionId;
        int cxid;
        int type;
        switch (qp.getType()) &#123;
        case Leader.ACK:
            if (this.learnerType == LearnerType.OBSERVER) &#123;
                LOG.debug(&quot;Received ACK from Observer &#123;&#125;&quot;, this.sid);
            &#125;
            syncLimitCheck.updateAck(qp.getZxid());
            learnerMaster.processAck(this.sid, qp.getZxid(), sock.getLocalSocketAddress());
            break;
        // çœç•¥å…¶ä»–ä¸ç›¸å¹²çš„ case
        &#125;
    &#125;
    ```
    åœ¨åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹æ¥æ”¶åˆ°è¯·æ±‚å¹¶å‘é€ ACK åï¼Œä¼šå°†è¯·æ±‚é€šè¿‡ zk.commitProcessor.commit(p.request); å†™å…¥åˆ° CommitProcessor.committedRequests é˜Ÿåˆ—ä¸­ï¼›

2. CommitProcessor.processRequest(); 

   å°†è¯·æ±‚åŠ å…¥ queuedRequests å’Œ queuedWriteRequests é˜Ÿåˆ—
    ``` java
    public void processRequest(Request request) &#123;
        queuedRequests.add(request);
        // å¦‚æœæ˜¯å†™è¯·æ±‚
        if (needCommit(request)) &#123;
            queuedWriteRequests.add(request);
            numWriteQueuedRequests.incrementAndGet();
        &#125; else &#123;
            numReadQueuedRequests.incrementAndGet();
        &#125;
        wakeup();
    &#125;
    ```
3. CommitProcessor ä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œrun() æ–¹æ³•æ¯”è¾ƒé•¿ï¼Œç¯‡å¹…åŸå› ç›´æ¥ç»™å‡ºå¤§è‡´é€»è¾‘ï¼›
    1. é˜Ÿåˆ—ä¸ºç©ºï¼Œçº¿ç¨‹ wait()ï¼›ã€CommitProcessor.processRequest() ä¸­çš„ wakeup() å”¤é†’ã€‘
    2. è¯·æ±‚ä¸ºå†™è¯·æ±‚ï¼Œå°†è¯·æ±‚å†™å…¥ pendingRequests ä¸­ï¼›ã€ç±»å‹Map&lt;sessionId,Queue&gt;ã€‘  
        å¦åˆ™ç›´æ¥è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼›
    3. æ ¹æ®committedRequests æ˜¯å¦ç©ºï¼Œè®¾ç½® commitIsWaiting å±æ€§ï¼›  
        ç©º falseï¼Œéç©º trueï¼›
    4. ä» committedRequests å’Œ queuedWriteRequests ä¸­å–å‡ºä¸€ä¸ªè¯·æ±‚ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªè¯·æ±‚ï¼›  
        æ˜¯ç»§ç»­ï¼Œå¦ breakï¼›
    5. ä» pendingRequests ä¸­æ ¹æ® request.sessionId è·å–ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¹¶ä»è¯¥é˜Ÿåˆ—å¤´éƒ¨å–å‡ºä¸€ä¸ª requestï¼›
    6. æœ€åé€šè¿‡ processWrite(request) å°†è¯·æ±‚å‘é€ç»™ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼›

##### 2.1.5_ ToBeAppliedRequestProcessor 
è¯¥å¤„ç†å™¨ä¸»è¦åŠŸèƒ½å°±æ˜¯ï¼Œå°†å¤„ç†è¿‡çš„è¯·æ±‚ä»é˜Ÿåˆ— toBeApplied ä¸­åˆ é™¤ï¼›å¹¶è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼›

toBeApplied é˜Ÿåˆ—ä¸­çš„è¯·æ±‚æ˜¯åœ¨ tryCommit() æ–¹æ³•ä¸­ï¼Œleaderåˆ¤æ–­å¯ä»¥æäº¤åå†™å…¥çš„ï¼›

``` java
public void processRequest(Request request) throws RequestProcessorException &#123;
    // è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨
    next.processRequest(request);
    if (request.getHdr() != null) &#123;
        long zxid = request.getHdr().getZxid();
        Iterator&lt;Proposal&gt; iter = leader.toBeApplied.iterator();
        if (iter.hasNext()) &#123;
            Proposal p = iter.next();
            if (p.request != null &amp;&amp; p.request.zxid == zxid) &#123;
                iter.remove();
                return;
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>
<h5 id="2-1-6-FinalRequestProcessor"><a href="#2-1-6-FinalRequestProcessor" class="headerlink" title="2.1.6_ FinalRequestProcessor"></a>2.1.6_ FinalRequestProcessor</h5><p>å°†è¯·æ±‚å†™å…¥åˆ°zk è‡ªå¸¦çš„æ•°æ®ç»“æ„ DataTree ä¸­ï¼Œå¹¶æ ¹æ®è¯·æ±‚ç±»å‹è¿”å›ä¸ä¸€æ ·çš„å“åº”å†…å®¹ï¼›</p>
<h4 id="2-2-follower-èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ"><a href="#2-2-follower-èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ" class="headerlink" title="2.2_ follower èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ"></a>2.2_ follower èŠ‚ç‚¹è´£ä»»é“¾æ¥æ”¶è¯·æ±‚å¦‚ä½•å¤„ç†ï¼Ÿ</h4><p>follower èŠ‚ç‚¹åˆå§‹åŒ–äº†ä¸¤ä¸ªè°ƒç”¨é“¾ï¼›<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/838dce21beb943b48e258ca39b7ac0ee~tplv-k3u1fbpfcp-watermark.image" alt="æœªå‘½åæ–‡ä»¶ (3).png"></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6904213790c74002802c6e3df5ff94b9~tplv-k3u1fbpfcp-watermark.image" alt="æœªå‘½åæ–‡ä»¶ (4).png"></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    RequestProcessor finalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    commitProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitProcessor</span><span class="token punctuation">(</span>finalProcessor<span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function">getZooKeeperServerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    commitProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    firstProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FollowerRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> commitProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>FollowerRequestProcessor<span class="token punctuation">)</span> firstProcessor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syncProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendAckRequestProcessor</span><span class="token punctuation">(</span><span class="token function">getFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syncProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="2-2-1-FollowerRequestProcessor"><a href="#2-2-1-FollowerRequestProcessor" class="headerlink" title="2.2.1_ FollowerRequestProcessor"></a>2.2.1_ FollowerRequestProcessor</h5><ol>
<li><p>FollowerRequestProcessor.processRequest() å°†è¯·æ±‚å†™å…¥ queuedRequests é˜Ÿåˆ—ä¸­</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request request<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkForUpgrade<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>finished<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>checkForUpgrade<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            Request upgradeRequest <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                upgradeRequest <span class="token operator">=</span> zks<span class="token punctuation">.</span><span class="token function">checkUpgradeSession</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> ke<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ie<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradeRequest <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                queuedRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>upgradeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        queuedRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li><p>FollowerRequestProcessor.run()</p>
<p>follower èŠ‚ç‚¹åœ¨è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨å‰ï¼Œä¼šåˆ¤æ–­æ˜¯å¦æ˜¯ leader èŠ‚ç‚¹å‘é€è¿‡æ¥çš„æ¶ˆæ¯ï¼›å¦‚æœä¸æ˜¯ï¼Œå°†è¯·æ±‚è½¬å‘ç»™ leader èŠ‚ç‚¹ï¼›å¦åˆ™è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨ CommitProcessor</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>finished<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            Request request <span class="token operator">=</span> queuedRequests<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å°è¯•è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†å™¨</span>
            <span class="token function">maybeSendRequestToNextProcessor</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®è¯·æ±‚çš„ç±»å‹ï¼Œå°†è¯·æ±‚è½¬å‘ç»™ leader</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>sync<span class="token operator">:</span>
                zks<span class="token punctuation">.</span>pendingSyncs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                zks<span class="token punctuation">.</span><span class="token function">getFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>create<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>create2<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>createTTL<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>createContainer<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>delete<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>deleteContainer<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>setData<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>reconfig<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>setACL<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>multi<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>check<span class="token operator">:</span>
                zks<span class="token punctuation">.</span><span class="token function">getFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>createSession<span class="token operator">:</span>
            <span class="token keyword">case</span> OpCode<span class="token punctuation">.</span>closeSession<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">isLocalSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    zks<span class="token punctuation">.</span><span class="token function">getFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
ğŸ‘‡ğŸ‘‡ğŸ‘‡
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">maybeSendRequestToNextProcessor</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RequestProcessorException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>skipLearnerRequestToNextProcessor <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span><span class="token function">isFromLearner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        ServerMetrics<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>SKIP_LEARNER_REQUEST_TO_NEXT_PROCESSOR_COUNT<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        nextProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="2-2-2-CommitProcessor"><a href="#2-2-2-CommitProcessor" class="headerlink" title="2.2.2_ CommitProcessor"></a>2.2.2_ CommitProcessor</h5><p>åŒ leader èŠ‚ç‚¹çš„ CommitProcessor ä¸€è‡´</p>
</li>
</ol>
<h5 id="2-2-3-FinalRequestProcessor"><a href="#2-2-3-FinalRequestProcessor" class="headerlink" title="2.2.3_ FinalRequestProcessor"></a>2.2.3_ FinalRequestProcessor</h5><p>åŒ leader èŠ‚ç‚¹çš„ FinalRequestProcessor ä¸€è‡´</p>
<h5 id="2-2-4-SyncRequestProcessor"><a href="#2-2-4-SyncRequestProcessor" class="headerlink" title="2.2.4_ SyncRequestProcessor"></a>2.2.4_ SyncRequestProcessor</h5><p>åŒ leader èŠ‚ç‚¹çš„ SyncRequestProcessor ä¸€è‡´</p>
<h5 id="2-2-5-SendAckRequestProcessor"><a href="#2-2-5-SendAckRequestProcessor" class="headerlink" title="2.2.5_ SendAckRequestProcessor"></a>2.2.5_ SendAckRequestProcessor</h5><p>leader èŠ‚ç‚¹çš„AckRequestProcessor æ˜¯ç›´æ¥è°ƒç”¨leader èŠ‚ç‚¹çš„tryToCommit() æ–¹æ³•ï¼›</p>
<p>follower èŠ‚ç‚¹ SendAckRequestProcessor éœ€è¦å°†Ackæ¶ˆæ¯å‘é€åˆ°leaderèŠ‚ç‚¹è¿›è¡Œç»Ÿè®¡å¤„ç†ï¼›</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>Request si<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">.</span>type <span class="token operator">!=</span> OpCode<span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        QuorumPacket qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span>Leader<span class="token punctuation">.</span>ACK<span class="token punctuation">,</span> si<span class="token punctuation">.</span><span class="token function">getHdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            learner<span class="token punctuation">.</span><span class="token function">writePacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// çœç•¥å¼‚å¸¸å¤„ç†ä»£ç </span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>åœ¨çº¿è¹²èµç¯èŠ‚ </p>
<p>è€æ¿ï¼ç‚¹ä¸ªèµå‘—ï¼ï¼<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3179ae7cb2248c887f59094056ace83~tplv-k3u1fbpfcp-watermark.image" alt="1631955135(1).png"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        æ–‡ç« ä½œè€…:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">zhouxh-z</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        æ–‡ç« é“¾æ¥:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://zhouxh-z.github.io/2021/09/23/%E4%BB%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E9%80%81create%E6%B6%88%E6%81%AF%E5%88%B0%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BA%EF%BC%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">https://zhouxh-z.github.io/2021/09/23/%E4%BB%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E9%80%81create%E6%B6%88%E6%81%AF%E5%88%B0%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BA%EF%BC%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        ç‰ˆæƒå£°æ˜:
                    </i>
                </span>
                <span class="reprint-info">
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                    <a href="/about" target="_blank">zhouxh-z</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/zookeeper/">
                                    <span class="chip bg-color">zookeeper</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;æœ¬ç¯‡
            </div>
            <div class="card">
                <a href="/2021/09/23/%E4%BB%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E9%80%81create%E6%B6%88%E6%81%AF%E5%88%B0%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BA%EF%BC%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
                    <div class="card-image">
                        
                        <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cef7966384cd4b479514c795fef81857~tplv-k3u1fbpfcp-zoom-crop-mark:1304:1304:1304:734.awebp?" class="responsive-img" alt="ä»å®¢æˆ·ç«¯å‘é€createæ¶ˆæ¯åˆ°èŠ‚ç‚¹åˆ›å»ºï¼Œæºç åˆ†æ">
                        
                        <span class="card-title">ä»å®¢æˆ·ç«¯å‘é€createæ¶ˆæ¯åˆ°èŠ‚ç‚¹åˆ›å»ºï¼Œæºç åˆ†æ</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-09-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%BA%90%E7%A0%81%E7%A0%94%E8%AF%BB/" class="post-category">
                                    æºç ç ”è¯»
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/zookeeper/">
                        <span class="chip bg-color">zookeeper</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/08/16/zookeeper/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/medias/featureimages/6.jpg" class="responsive-img" alt="zookeeper å¯åŠ¨è¿‡ç¨‹/leader é€‰ä¸¾">
                        
                        <span class="card-title">zookeeper å¯åŠ¨è¿‡ç¨‹/leader é€‰ä¸¾</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-08-16
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%BA%90%E7%A0%81%E7%A0%94%E8%AF%BB/" class="post-category">
                                    æºç ç ”è¯»
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/zookeeper/">
                        <span class="chip bg-color">zookeeper</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- ä»£ç å—æ”¶ç¼© -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/codeBlock/codeShrink.js"></script>


    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">zhouxh-z</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;æ€»è®¿é—®é‡:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;æ¬¡
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;æ€»è®¿é—®äººæ•°:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;äºº
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zhouxh-z/" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:17826808007@163.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQè”ç³»æˆ‘: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>









</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/zhouxh-z/zhouxh-z.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
